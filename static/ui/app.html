<!doctype html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mina ‚Äî Meeting Intelligence Platform</title>
  <meta name="theme-color" content="#111827" />
  <link rel="manifest" href="/static/manifest.webmanifest" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config={theme:{extend:{colors:{brand:{from:'var(--brand-from)',to:'var(--brand-to)'}}}}}</script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    :root{--brand-from:#6366f1;--brand-to:#d946ef;--text-scale:1}
    html{font-size:calc(16px * var(--text-scale))}
    .kbd{padding:.15rem .4rem;border:1px solid rgba(255,255,255,.15);border-bottom-width:2px;border-radius:.375rem;font-size:.75rem}
    .chip{padding:.35rem .7rem;border-radius:9999px;background-color:rgb(30 41 59/.8);border:1px solid rgb(255 255 255/.06)}
    .btn{padding:.5rem .85rem;border-radius:.8rem;background:#0f172a;border:1px solid rgba(255,255,255,.06)}
    .btn:hover{background:#111827}
    .selbar{backdrop-filter:blur(6px)}
    @keyframes shimmer{100%{translate:100% 0}}
    .shimmer{position:relative;overflow:hidden}
    .shimmer::after{content:"";position:absolute;inset:0;translate:-100% 0;background:linear-gradient(120deg,transparent 0%,rgba(255,255,255,.15) 50%,transparent 100%);animation:shimmer 1.6s infinite}
  </style>
  <!-- Service Worker registration -->
  <script>
    (function(){
      if ('serviceWorker' in navigator && location.protocol==='https:') {
        navigator.serviceWorker.register('/static/sw.js').catch(()=>{});
      }
    })();
  </script>
  <!-- Socket.IO and WebSocket configuration -->
  <script>
    window.__MINA_USE_MOCK_SOCKET = false; // Use real Socket.IO server
  </script>
  <!-- Load configuration first -->
  <script src="/static/js/mina.config.js" defer></script>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-950 via-slate-900 to-slate-950 text-slate-100">
  <div id="app" class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="hidden md:flex md:w-64 flex-col gap-2 p-3 border-r border-white/5">
      <div class="flex items-center gap-3 px-2 py-2">
        <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-[var(--brand-from)] to-[var(--brand-to)] shadow"></div>
        <div>
          <div class="font-semibold">Mina</div>
          <div class="text-xs text-slate-400">Meeting AI</div>
        </div>
      </div>
      <nav id="nav" class="mt-3 grid gap-1"></nav>
    </aside>
    
    <!-- Main -->
    <main class="flex-1 min-w-0 pt-12 md:pt-0">
      <header class="hidden md:flex items-center justify-between px-5 h-14 border-b border-white/5 sticky top-0 backdrop-blur bg-slate-900/60 z-10">
        <div class="text-xs md:text-sm text-slate-400">Press <span class="kbd">Space</span> start/stop ¬∑ <span class="kbd">M</span> marker ¬∑ <span class="kbd">/</span> search</div>
        <div id="status" class="text-xs text-slate-400"></div>
      </header>
      <section id="page" class="p-4 md:p-6 max-w-6xl mx-auto">
        <div class="text-slate-300">Loading‚Ä¶</div>
      </section>
    </main>
  </div>

  <!-- Selection floating bar -->
  <div id="selBar" class="hidden selbar fixed z-40 px-2 py-1 rounded-xl bg-slate-900/80 border border-white/10 shadow-lg text-sm"></div>
  <div id="toasts" class="fixed bottom-4 right-4 z-50 space-y-2"></div>
  
  <script>
    // ===== Utilities
    const $=(q,el=document)=>el.querySelector(q); 
    const $$=(q,el=document)=>Array.from(el.querySelectorAll(q));
    function toast(msg,kind='info'){ 
      const el=document.createElement('div'); 
      el.className=`rounded-xl px-3 py-2 text-sm shadow-lg ${kind==='error'?'bg-rose-600/90':'bg-slate-800/90'}`; 
      el.textContent=msg; 
      $('#toasts').appendChild(el); 
      setTimeout(()=>el.remove(),3500) 
    }

    // ===== Router & navigation
    const routes=[
      {id:'live',label:'üéôÔ∏è Live'},
      {id:'meetings',label:'üìÖ Meetings'},
      {id:'conversation',label:'üí¨ Conversation'},
      {id:'upload',label:'üì§ Upload'},
      {id:'summaries',label:'üìã Summaries'},
      {id:'tasks',label:'‚úÖ Tasks'},
      {id:'settings',label:'‚öôÔ∏è Settings'}
    ];
    
    function renderNav(container){ 
      container.innerHTML=''; 
      routes.forEach(r=>{ 
        const b=document.createElement('button'); 
        b.className='flex items-center gap-2 px-3 py-2 rounded-xl hover:bg-slate-800 text-left w-full transition-colors'; 
        b.dataset.route=r.id; 
        b.innerHTML=`<span>${r.label}</span>`; 
        b.addEventListener('click',()=>go(r.id)); 
        container.appendChild(b) 
      }) 
    }
    
    function go(route){ location.hash=route; renderPage() }

    // ===== Data store
    const Store={
      get all(){ try{return JSON.parse(localStorage.getItem('mina_conversations')||'[]')}catch{return[]} },
      set all(v){ localStorage.setItem('mina_conversations', JSON.stringify(v)) },
      save(conv){ const list=Store.all.filter(x=>x.id!==conv.id); list.unshift(conv); Store.all=list },
      byId(id){ return Store.all.find(x=>x.id===id) }
    };

    // ===== Pages registry
    const pages={
      live:{render:renderLive},
      meetings:{render:renderMeetings},
      conversation:{render:renderConversation},
      upload:{render:renderUpload},
      summaries:{render:renderSummaries},
      tasks:{render:renderTasks},
      settings:{render:renderSettings},
      share:{render:renderShare}
    };

    // ====== LIVE ======
    function renderLive(){
      $('#page').innerHTML=`
        <div class="space-y-5">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2 text-sm text-slate-300">
              <span id="live_ws" class="px-3 py-1 rounded-full bg-slate-700/80">Disconnected</span>
              <span id="live_mic" class="px-3 py-1 rounded-full bg-slate-700/80">Idle</span>
              <span id="live_sess" class="px-3 py-1 rounded-full bg-slate-700/80">‚Äî</span>
            </div>
            <div class="hidden md:flex items-center gap-2">
              <button id="btnToggle" class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-gradient-to-r from-[var(--brand-from)] to-[var(--brand-to)] hover:opacity-95 shadow-lg"><span>Start</span></button>
            </div>
          </div>

          <div class="h-2 rounded-full bg-slate-800 overflow-hidden">
            <div id="meterFill" class="h-full transition-[width] duration-150 bg-gradient-to-r from-cyan-400 via-[var(--brand-from)] to-[var(--brand-to)]" style="width:0%"></div>
          </div>
          <canvas id="wave" height="90" class="w-full rounded-xl bg-slate-900/60 border border-white/5"></canvas>

          <div class="rounded-2xl bg-slate-900/60 border border-white/5 p-4">
            <div class="flex items-center justify-between mb-2 gap-2">
              <div class="flex-1 flex items-center gap-2">
                <h2 class="text-lg font-semibold">Transcript</h2>
                <div class="relative flex items-center">
                  <input id="txSearch" placeholder="Search ( / )" class="px-2 py-1 rounded-lg bg-slate-800 text-sm border border-white/10" />
                  <div id="txCounter" class="ml-2 text-xs text-slate-400"></div>
                  <div class="ml-2 hidden md:flex gap-1">
                    <button id="txPrev" class="btn text-xs">Prev</button>
                    <button id="txNext" class="btn text-xs">Next</button>
                  </div>
                </div>
              </div>
              <div><span id="modeBadge" class="px-2 py-0.5 rounded-full text-xs bg-emerald-600/60">Live</span></div>
            </div>
            <div id="noteBar" class="hidden mb-3 px-3 py-2 rounded-xl bg-yellow-500/10 text-yellow-200 text-sm border border-yellow-500/20"></div>
            <div id="transcriptBox" class="min-h-[260px] whitespace-pre-wrap text-slate-100 shimmer"></div>
          </div>

          <div class="flex flex-wrap items-center gap-3 pb-16 md:pb-0">
            <button id="btnCopy" class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700">Copy</button>
            <button id="btnExport" class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700">Export .txt</button>
            <button id="btnClear" class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700">Clear</button>
            <button id="btnMarker" class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700">Add marker (M)</button>
            <button id="btnCopy15" class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700">Copy last 15s</button>
            <button id="btnSaveConv" class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500">Save as conversation</button>
          </div>
        </div>

        <div class="fixed md:hidden left-0 right-0 bottom-3 flex justify-center">
          <button id="btnToggleMobile" class="px-6 py-3 rounded-full text-base font-medium bg-gradient-to-r from-[var(--brand-from)] to-[var(--brand-to)] shadow-xl">Start</button>
        </div>
      `;

      const els={ 
        ws:$('#live_ws'), 
        mic:$('#live_mic'), 
        sess:$('#live_sess'), 
        meter:$('#meterFill'), 
        wave:$('#wave'), 
        transcript:$('#transcriptBox'), 
        badge:$('#modeBadge'), 
        note:$('#noteBar') 
      };
      
      let mediaRecorder=null, analyser=null, raf=null; 
      let interimStream=''; 
      let lastChunkAt=0;

      function ensureIO(){ 
        if(window.io) return Promise.resolve(true); 
        return new Promise(res=>{ 
          const s=document.createElement('script'); 
          s.src='/socket.io/socket.io.js'; 
          s.onload=()=>res(true); 
          s.onerror=()=>{ 
            const cdn=document.createElement('script'); 
            cdn.src='https://cdn.socket.io/4.7.5/socket.io.min.js'; 
            cdn.onload=()=>res(true); 
            cdn.onerror=()=>res(false); 
            document.head.appendChild(cdn) 
          }; 
          document.head.appendChild(s) 
        }) 
      }

      function startWave(){ 
        const c=els.wave, ctx=c.getContext('2d'); 
        const W=c.width=c.clientWidth, H=c.height; 
        const data=new Uint8Array(256); 
        (function draw(){ 
          if(!analyser){
            ctx.clearRect(0,0,W,H); 
            raf=requestAnimationFrame(draw); 
            return
          } 
          analyser.getByteTimeDomainData(data); 
          ctx.clearRect(0,0,W,H); 
          ctx.beginPath(); 
          ctx.moveTo(0,H/2); 
          for(let x=0;x<W;x++){ 
            const i=Math.floor((x/W)*data.length); 
            const v=(data[i]-128)/128; 
            const y=H/2+v*(H/2-6); 
            ctx.lineTo(x,y) 
          } 
          ctx.strokeStyle='rgba(148,163,184,0.9)'; 
          ctx.lineWidth=2; 
          ctx.stroke(); 
          raf=requestAnimationFrame(draw) 
        })() 
      }
      
      function stopWave(){ if(raf) cancelAnimationFrame(raf), raf=null }

      // Display transcription results in real-time
      function displayTranscriptionResult(result) {
        try {
          // Find or create the live transcript container
          let transcriptContainer = $('#live-transcript');
          if (!transcriptContainer) {
            // Create container if it doesn't exist
            const pageSection = $('#page');
            transcriptContainer = document.createElement('div');
            transcriptContainer.id = 'live-transcript';
            transcriptContainer.className = 'mt-6 space-y-2 p-4 border border-white/10 rounded-xl bg-slate-900/30';
            transcriptContainer.innerHTML = '<h3 class="text-sm font-medium text-slate-300 mb-3">Live Transcription</h3>';
            pageSection.appendChild(transcriptContainer);
          }
          
          // Create transcript segment
          const segment = document.createElement('div');
          segment.className = 'transcript-segment p-3 rounded-lg bg-slate-800/40 border border-white/5';
          segment.innerHTML = `
            <div class="flex justify-between items-start mb-2">
              <span class="text-xs text-slate-400">Chunk ${result.chunk_id}</span>
              <div class="flex gap-2">
                <span class="text-xs px-2 py-1 rounded bg-emerald-600/20 text-emerald-400">${(result.confidence * 100).toFixed(1)}%</span>
                <span class="text-xs text-slate-500">${new Date().toLocaleTimeString()}</span>
              </div>
            </div>
            <div class="text-slate-100">${result.text}</div>
            ${result.segments && result.segments.length > 0 ? 
              '<div class="mt-2 text-xs text-slate-400">Processing time: ' + result.processing_time.toFixed(2) + 's</div>' : ''}
          `;
          
          transcriptContainer.appendChild(segment);
          
          // Auto-scroll to bottom
          transcriptContainer.scrollTop = transcriptContainer.scrollHeight;
          
          // Emit via WebSocket for any connected clients
          if (currentSocket) {
            currentSocket.emit('transcription_update', result);
          }
          
        } catch (error) {
          console.error('‚ùå Failed to display transcription result:', error);
        }
      }

      let isRecording = false;
      let currentSocket = null;
      let currentSessionId = null;

      function bindStart(btn){ 
        btn.addEventListener('click', async ()=>{
          if(isRecording){ 
            // Stop recording
            stopRecording();
            return 
          }
          if(!(await ensureIO())){ 
            els.note.classList.remove('hidden'); 
            els.note.textContent='Socket.IO client missing'; 
            return 
          }
          
          currentSocket=window.io({path:'/socket.io',transports:['polling'],upgrade:false,reconnection:true});
          currentSocket.on('connect',()=>{ 
            els.ws.textContent='Connected'; 
            els.ws.className='px-3 py-1 rounded-full bg-green-600/80';
            currentSessionId=String(Date.now()); 
            els.sess.textContent=currentSessionId; 
            currentSocket.emit('join_session',{session_id:currentSessionId}) 
          });
          
          currentSocket.on('server_hello',()=>{});
          currentSocket.on('interim_transcript',(data)=>{
            if(!data||!data.text) return;
            console.log('üìù Interim transcript:', data.text.substring(0, 50) + '...');
            interimStream += ' ' + data.text;
            els.transcript.textContent=interimStream;
            // Auto-scroll to bottom
            els.transcript.scrollTop = els.transcript.scrollHeight;
          });
          
          currentSocket.on('final_transcript',(data)=>{
            if(!data||!data.text) return;
            console.log('‚úÖ Final transcript received:', data.text.substring(0, 50) + '...');
            const finalText = interimStream + ' ' + data.text;
            els.transcript.textContent=finalText;
            Store.save({id:Date.now(),text:finalText,created:new Date().toISOString()});
            els.transcript.scrollTop = els.transcript.scrollHeight;
            toast('Transcription completed');
          });

          currentSocket.on('session_joined',(data)=>{
            console.log('‚úÖ Session joined successfully:', data);
            toast('Session connected and ready for transcription');
          });
          
          currentSocket.on('session_error',(data)=>{
            console.error('‚ùå Session error:', data);
            els.note.classList.remove('hidden');
            els.note.textContent='Session error: ' + (data.error || 'Failed to start session');
            toast('Failed to start session: ' + (data.error || 'Unknown error'), 'error');
          });

          currentSocket.on('transcription_error',(data)=>{
            console.error('üö® Transcription error received:', data);
            els.note.classList.remove('hidden');
            els.note.textContent='Transcription error: ' + (data.error || 'Unknown error');
            if(data.detail) {
              console.error('Error details:', data.detail);
            }
            // Show error notification
            toast('Transcription failed: ' + (data.error || 'Unknown error'), 'error');
          });

          try{
            const stream=await navigator.mediaDevices.getUserMedia({audio:true});
            els.mic.textContent='Recording';
            els.mic.className='px-3 py-1 rounded-full bg-red-600/80';
            
            const ctx=new AudioContext();
            const src=ctx.createMediaStreamSource(stream);
            analyser=ctx.createAnalyser();
            src.connect(analyser);
            startWave();
            
            // Use WAV format instead of WebM for better streaming compatibility
            let options = {mimeType: 'audio/wav'};
            
            // Fallback options if WAV is not supported
            if (!MediaRecorder.isTypeSupported('audio/wav')) {
                console.log('üéµ WAV not supported, trying WebM...');
                if (MediaRecorder.isTypeSupported('audio/webm')) {
                    options = {mimeType: 'audio/webm'};
                } else {
                    console.log('üéµ Using default MediaRecorder format');
                    options = {};
                }
            }
            
            console.log('üéµ Using MediaRecorder with:', options);
            mediaRecorder = new MediaRecorder(stream, options);
            
            // Track chunks for HTTP POST transcription
            let chunkId = 0;
            const sessionId = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            
            mediaRecorder.ondataavailable=async (e)=>{
              if(e.data.size>0) {
                chunkId++;
                try {
                  console.log(`üéµ Sending audio chunk ${chunkId}: ${e.data.size} bytes`);
                  
                  // Send audio chunk via HTTP POST (proven working method)
                  const formData = new FormData();
                  formData.append('audio', e.data, `chunk_${chunkId}.wav`);
                  formData.append('session_id', sessionId);
                  formData.append('chunk_id', chunkId.toString());
                  
                  const response = await fetch('/api/transcribe_streaming', {
                    method: 'POST',
                    body: formData
                  });
                  
                  const result = await response.json();
                  
                  if (result.text && result.text.trim()) {
                    console.log(`‚úÖ Transcription chunk ${chunkId}: "${result.text}"`);
                    // Display transcription result in real-time
                    displayTranscriptionResult(result);
                  } else {
                    console.log(`‚è≥ Chunk ${chunkId} processed, waiting for speech...`);
                  }
                  
                } catch(error) {
                  console.error(`‚ùå Failed to transcribe chunk ${chunkId}:`, error);
                }
              }
            };
            
            mediaRecorder.onstop = () => {
              console.log('üõë Recording stopped - session finalized');
              chunkId = 0; // Reset for next session
            };
            
            const timeslice = window.MINA_FEATURES?.RECORDER_TIMESLICE_MS || 250;
            mediaRecorder.start(timeslice);
            isRecording = true;
            btn.textContent='Stop';
            $('#btnToggleMobile').textContent='Stop';
            
          }catch(e){
            els.note.classList.remove('hidden');
            els.note.textContent='Microphone access denied or unavailable';
          }
        })
      }

      function stopRecording() {
        if(mediaRecorder && mediaRecorder.state !== 'inactive') {
          try {
            mediaRecorder.stop();
          } catch(e) {
            console.error('Error stopping recorder:', e);
          }
        }
        
        // Stop audio analysis
        if(analyser) {
          stopWave();
          analyser = null;
        }
        
        // Update UI
        isRecording = false;
        els.mic.textContent = 'Idle';
        els.mic.className = 'px-3 py-1 rounded-full bg-slate-700/80';
        $('#btnToggle').textContent = 'Start';
        $('#btnToggleMobile').textContent = 'Start';
        
        // Disconnect socket after a delay to allow finalization
        if(currentSocket) {
          setTimeout(() => {
            if(currentSocket) {
              currentSocket.disconnect();
              currentSocket = null;
            }
            els.ws.textContent = 'Disconnected';
            els.ws.className = 'px-3 py-1 rounded-full bg-slate-700/80';
          }, 1000);
        }
        
        currentSessionId = null;
        
        toast('Recording stopped and session finalized');
      }

      bindStart($('#btnToggle'));
      bindStart($('#btnToggleMobile'));

      // Additional functionality
      $('#btnCopy').addEventListener('click',()=>{
        navigator.clipboard.writeText(els.transcript.textContent);
        toast('Copied to clipboard');
      });

      $('#btnExport').addEventListener('click',()=>{
        const blob=new Blob([els.transcript.textContent],{type:'text/plain'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url;
        a.download=`transcript-${new Date().toISOString().slice(0,10)}.txt`;
        a.click();
        URL.revokeObjectURL(url);
      });

      $('#btnClear').addEventListener('click',()=>{
        els.transcript.textContent='';
        interimStream='';
      });

      $('#btnMarker').addEventListener('click',()=>{
        const time=new Date().toLocaleTimeString();
        els.transcript.textContent+=`\n[${time} MARKER]\n`;
      });

      $('#btnSaveConv').addEventListener('click',()=>{
        const text=els.transcript.textContent;
        if(!text.trim()) return toast('No content to save','error');
        Store.save({id:Date.now(),text,created:new Date().toISOString()});
        toast('Conversation saved');
      });

      // Keyboard shortcuts
      document.addEventListener('keydown',(e)=>{
        if(e.code==='Space' && !e.target.matches('input,textarea')) {
          e.preventDefault();
          $('#btnToggle').click();
        }
        if(e.code==='KeyM' && !e.target.matches('input,textarea')) {
          e.preventDefault();
          $('#btnMarker').click();
        }
        if(e.code==='Slash' && !e.target.matches('input,textarea')) {
          e.preventDefault();
          $('#txSearch').focus();
        }
      });
    }

    // ====== MEETINGS ======
    function renderMeetings(){
      $('#page').innerHTML=`
        <div class="space-y-5">
          <div class="flex items-center justify-between">
            <h1 class="text-2xl font-bold">Meetings</h1>
            <button id="btnNewMeeting" class="btn bg-indigo-600 hover:bg-indigo-500">+ New Meeting</button>
          </div>
          <div id="meetingsList" class="space-y-3">
            <div class="text-slate-400">Loading meetings...</div>
          </div>
        </div>
      `;

      const conversations = Store.all;
      const list = $('#meetingsList');
      
      if(conversations.length === 0) {
        list.innerHTML = `
          <div class="text-center py-12 text-slate-400">
            <div class="text-4xl mb-4">üìÖ</div>
            <h3 class="text-lg font-medium mb-2">No meetings yet</h3>
            <p class="text-sm">Start your first meeting to see it here</p>
          </div>
        `;
      } else {
        list.innerHTML = conversations.map(conv => `
          <div class="bg-slate-900/60 rounded-xl p-4 border border-white/5 hover:bg-slate-800/60 cursor-pointer transition-colors" onclick="go('conversation'); renderConversation('${conv.id}')">
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-semibold">${conv.title || 'Untitled Meeting'}</h3>
              <span class="text-xs text-slate-400">${new Date(conv.created).toLocaleDateString()}</span>
            </div>
            <p class="text-sm text-slate-300 line-clamp-2">${conv.text.slice(0,120)}...</p>
          </div>
        `).join('');
      }

      $('#btnNewMeeting').addEventListener('click', () => go('live'));
    }

    // ====== CONVERSATION ======
    function renderConversation(id){
      const conv = Store.byId(id);
      if(!conv) {
        $('#page').innerHTML = '<div class="text-red-400">Conversation not found</div>';
        return;
      }

      $('#page').innerHTML=`
        <div class="space-y-5">
          <div class="flex items-center gap-4">
            <button onclick="go('meetings')" class="btn">‚Üê Back</button>
            <h1 class="text-2xl font-bold flex-1">${conv.title || 'Untitled Conversation'}</h1>
            <button class="btn">Share</button>
            <button class="btn">Export</button>
          </div>
          
          <div class="bg-slate-900/60 rounded-xl p-6 border border-white/5">
            <div class="whitespace-pre-wrap text-slate-100">${conv.text}</div>
          </div>
          
          <div class="grid md:grid-cols-2 gap-4">
            <div class="bg-slate-900/60 rounded-xl p-4 border border-white/5">
              <h3 class="font-semibold mb-3">Highlights</h3>
              <div class="text-slate-400 text-sm">No highlights yet</div>
            </div>
            <div class="bg-slate-900/60 rounded-xl p-4 border border-white/5">
              <h3 class="font-semibold mb-3">Action Items</h3>
              <div class="text-slate-400 text-sm">No action items yet</div>
            </div>
          </div>
        </div>
      `;
    }

    // ====== UPLOAD ======
    function renderUpload(){
      $('#page').innerHTML=`
        <div class="space-y-5">
          <h1 class="text-2xl font-bold">Upload Audio</h1>
          
          <div id="uploadArea" class="border-2 border-dashed border-slate-700 rounded-2xl p-12 text-center hover:border-slate-600 transition-colors cursor-pointer">
            <div class="text-4xl mb-4">üìÅ</div>
            <h3 class="text-lg font-semibold mb-2">Drop audio files here</h3>
            <p class="text-slate-400 mb-4">Or click to browse</p>
            <input type="file" id="fileInput" accept="audio/*" class="hidden">
            <button id="browseBtn" class="btn bg-indigo-600 hover:bg-indigo-500">Browse Files</button>
          </div>
          
          <div id="uploadProgress" class="hidden">
            <div class="bg-slate-900/60 rounded-xl p-4 border border-white/5">
              <div class="flex items-center justify-between mb-2">
                <span class="font-medium">Uploading...</span>
                <span id="progressText">0%</span>
              </div>
              <div class="w-full bg-slate-800 rounded-full h-2">
                <div id="progressBar" class="bg-indigo-600 h-2 rounded-full transition-all" style="width: 0%"></div>
              </div>
            </div>
          </div>
        </div>
      `;

      const uploadArea = $('#uploadArea');
      const fileInput = $('#fileInput');
      
      $('#browseBtn').addEventListener('click', () => fileInput.click());
      uploadArea.addEventListener('click', () => fileInput.click());
      
      fileInput.addEventListener('change', handleFileUpload);
      
      // Drag and drop
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('border-indigo-500');
      });
      
      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('border-indigo-500');
      });
      
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('border-indigo-500');
        fileInput.files = e.dataTransfer.files;
        handleFileUpload();
      });

      async function handleFileUpload() {
        const file = fileInput.files[0];
        if (!file) return;

        $('#uploadProgress').classList.remove('hidden');
        
        const formData = new FormData();
        formData.append('file', file);
        
        try {
          const response = await fetch('/api/uploads', {
            method: 'POST',
            body: formData
          });
          
          if (response.ok) {
            const result = await response.json();
            toast('Upload successful!');
            setTimeout(() => {
              go('conversation');
              renderConversation(result.id);
            }, 1000);
          } else {
            throw new Error('Upload failed');
          }
        } catch (error) {
          toast('Upload failed', 'error');
          $('#uploadProgress').classList.add('hidden');
        }
      }
    }

    // ====== SUMMARIES ======
    function renderSummaries(){
      $('#page').innerHTML=`
        <div class="space-y-5">
          <h1 class="text-2xl font-bold">Summaries</h1>
          <div class="text-center py-12 text-slate-400">
            <div class="text-4xl mb-4">üìã</div>
            <h3 class="text-lg font-medium mb-2">AI Summaries</h3>
            <p class="text-sm">Automatic summaries will appear here</p>
          </div>
        </div>
      `;
    }

    // ====== TASKS ======
    function renderTasks(){
      $('#page').innerHTML=`
        <div class="space-y-5">
          <div class="flex items-center justify-between">
            <h1 class="text-2xl font-bold">Tasks</h1>
            <button class="btn bg-indigo-600 hover:bg-indigo-500">+ Add Task</button>
          </div>
          <div class="text-center py-12 text-slate-400">
            <div class="text-4xl mb-4">‚úÖ</div>
            <h3 class="text-lg font-medium mb-2">No tasks yet</h3>
            <p class="text-sm">Action items from meetings will appear here</p>
          </div>
        </div>
      `;
    }

    // ====== SETTINGS ======
    function renderSettings(){
      $('#page').innerHTML=`
        <div class="space-y-5">
          <h1 class="text-2xl font-bold">Settings</h1>
          
          <div class="space-y-4">
            <div class="bg-slate-900/60 rounded-xl p-4 border border-white/5">
              <h3 class="font-semibold mb-3">Audio Settings</h3>
              <div class="space-y-3">
                <label class="flex items-center justify-between">
                  <span>Microphone</span>
                  <select class="bg-slate-800 rounded px-3 py-1 text-sm">
                    <option>Default</option>
                  </select>
                </label>
                <label class="flex items-center justify-between">
                  <span>Audio Quality</span>
                  <select class="bg-slate-800 rounded px-3 py-1 text-sm">
                    <option>High</option>
                    <option>Medium</option>
                    <option>Low</option>
                  </select>
                </label>
              </div>
            </div>
            
            <div class="bg-slate-900/60 rounded-xl p-4 border border-white/5">
              <h3 class="font-semibold mb-3">Transcription Settings</h3>
              <div class="space-y-3">
                <label class="flex items-center justify-between">
                  <span>Language</span>
                  <select class="bg-slate-800 rounded px-3 py-1 text-sm">
                    <option>English</option>
                    <option>Spanish</option>
                    <option>French</option>
                  </select>
                </label>
                <label class="flex items-center justify-between">
                  <span>Real-time transcription</span>
                  <input type="checkbox" checked class="rounded">
                </label>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ====== SHARE ======
    function renderShare(){
      $('#page').innerHTML=`
        <div class="space-y-5">
          <h1 class="text-2xl font-bold">Share</h1>
          <div class="text-center py-12 text-slate-400">
            <div class="text-4xl mb-4">üîó</div>
            <h3 class="text-lg font-medium mb-2">Share Conversations</h3>
            <p class="text-sm">Generate shareable links for your conversations</p>
          </div>
        </div>
      `;
    }

    // ===== Page rendering
    function renderPage(){
      const hash = location.hash.slice(1) || 'live';
      const page = pages[hash];
      if(page && page.render) {
        page.render();
        // Update navigation
        $$('#nav button').forEach(b => {
          b.classList.remove('bg-slate-800');
          if(b.dataset.route === hash) {
            b.classList.add('bg-slate-800');
          }
        });
      } else {
        $('#page').innerHTML = '<div class="text-red-400">Page not found</div>';
      }
    }

    // ===== Init
    document.addEventListener('DOMContentLoaded', () => {
      renderNav($('#nav'));
      renderPage();
      window.addEventListener('hashchange', renderPage);
    });
  </script>
  
  <!-- Load additional scripts -->
  <script src="/static/js/mina.api.js" defer></script>
  <script src="/static/js/mina.socket.js" defer></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" defer></script>
</body>
</html>