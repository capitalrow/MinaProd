<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Mina</title>
  <link rel="manifest" href="/static/manifest.webmanifest">
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="/static/js/mina.api.js"></script>
  <!-- Real-time socket bridge -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script defer src="/static/js/mina.socket.js"></script>
  <style>
    html,body{height:100%} .btn{ @apply px-4 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-white}
    .card{ @apply bg-slate-800/60 rounded-2xl p-4 border border-slate-700}
    .input{ @apply w-full bg-slate-900/70 border border-slate-600 rounded-xl p-3 text-white placeholder-slate-400 focus:ring-2 focus:ring-violet-500 focus:border-violet-500 transition-colors}
    .input:focus{ @apply outline-none ring-2 ring-violet-500 border-violet-500}
    .badge{ @apply px-3 py-1 rounded-full text-xs font-medium}
    .nav-link{ @apply text-slate-300 hover:text-white px-3 py-2 rounded-lg hover:bg-slate-800/50 transition-colors focus:outline-none focus:ring-2 focus:ring-violet-500}
    .nav-link.active{ @apply text-violet-400 bg-slate-800/50}
    /* Screen reader only class */
    .sr-only{ @apply absolute w-px h-px p-0 -m-px overflow-hidden whitespace-nowrap border-0}
    .focus\:not-sr-only:focus{ @apply static w-auto h-auto p-2 m-0 overflow-visible whitespace-normal}
    /* Loading states */
    .loading{ @apply animate-pulse}
    /* High contrast mode support */
    @media (prefers-contrast: high) {
      .btn{ @apply border-2 border-current}
      .input{ @apply border-2 border-slate-400}
    }
    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
      .transition-colors{ @apply transition-none}
      .animate-pulse{ @apply animate-none}
    }
  </style>
  <script src="/static/js/router.js" defer></script>
  <!-- Performance: Preload critical resources -->
  <link rel="preload" href="https://cdn.socket.io/4.7.5/socket.io.min.js" as="script">
  <meta name="theme-color" content="#0f172a">
  <meta name="description" content="AI-powered real-time transcription platform with speaker identification and advanced features">
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  <!-- Skip to main content for accessibility -->
  <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 bg-blue-600 text-white px-4 py-2 rounded z-50">Skip to main content</a>
  
  <div id="app" class="max-w-4xl mx-auto p-4 space-y-6">
    <header class="flex items-center justify-between border-b border-slate-800 pb-4" role="banner">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-violet-500 to-fuchsia-500 flex items-center justify-center" aria-hidden="true">
          <span class="text-white font-bold text-sm">M</span>
        </div>
        <h1 class="text-2xl font-bold bg-gradient-to-r from-violet-400 to-fuchsia-400 bg-clip-text text-transparent">Mina</h1>
      </div>
      <nav role="navigation" aria-label="Main navigation" class="flex items-center gap-4">
        <a href="#/library" data-nav class="nav-link" aria-label="View transcription library">Library</a>
        <a href="#/live" data-nav class="nav-link" aria-label="Start live transcription">Live</a>
        <a href="#/upload" data-nav class="nav-link" aria-label="Upload audio files">Upload</a>
        <a href="#/settings" data-nav class="nav-link" aria-label="Account settings">Settings</a>
        <button id="nav-auth" class="btn hidden" aria-label="Sign in to your account">Sign In</button>
        <div id="nav-user" class="hidden text-sm text-slate-300" role="status" aria-label="Current user"></div>
      </nav>
    </header>

    <main id="main-content" role="main" aria-live="polite" aria-label="Main application content">
      <div id="view"></div>
    </main>
  </div>

  <script>
    const view = document.getElementById('view');
    const navAuth = document.getElementById('nav-auth');
    const navUser = document.getElementById('nav-user');
    let state = { user:null, convId:null, live:false };

    // Security: HTML escape function to prevent XSS
    function escapeHtml(unsafe) {
      if (typeof unsafe !== 'string') return '';
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Accessibility: Create element with proper ARIA attributes
    function createAccessibleInput(options) {
      const { id, type = 'text', placeholder, value = '', label, required = false, disabled = false } = options;
      const container = document.createElement('div');
      container.className = 'space-y-1';
      
      // Create proper label
      const labelEl = document.createElement('label');
      labelEl.htmlFor = id;
      labelEl.className = 'block text-sm font-medium text-slate-300';
      labelEl.textContent = label;
      if (required) {
        const req = document.createElement('span');
        req.className = 'text-red-400 ml-1';
        req.textContent = '*';
        req.setAttribute('aria-label', 'required');
        labelEl.appendChild(req);
      }
      
      // Create input with security
      const input = document.createElement('input');
      input.id = id;
      input.type = type;
      input.className = 'input';
      input.placeholder = placeholder || '';
      input.value = escapeHtml(value);
      input.disabled = disabled;
      input.setAttribute('aria-label', label);
      if (required) input.setAttribute('aria-required', 'true');
      
      container.appendChild(labelEl);
      container.appendChild(input);
      return container;
    }

    // Security: Safe DOM text insertion
    function safeSetText(element, text) {
      if (element) element.textContent = text || '';
    }

    // Security: Safe DOM content creation
    function createSafeCard(title, content) {
      const card = document.createElement('div');
      card.className = 'card space-y-4';
      
      if (title) {
        const titleEl = document.createElement('h2');
        titleEl.className = 'text-lg font-semibold';
        titleEl.textContent = title;
        card.appendChild(titleEl);
      }
      
      if (content) {
        const contentEl = document.createElement('div');
        contentEl.appendChild(content);
        card.appendChild(contentEl);
      }
      
      return card;
    }

    async function ensureUser() {
      try { const r = await API.auth.me(); state.user = r.user; } catch(e){ state.user = null; }
      navAuth.classList.toggle('hidden', !!state.user);
      navUser.classList.toggle('hidden', !state.user);
      if (state.user) navUser.innerText = state.user.name || state.user.email;
    }

    function guard() {
      const pub = ["login","register","forgot","reset","verify"];
      const [, path] = location.hash.split("/");
      if (!state.user && (!path || !pub.includes(path))) { location.hash="#/login"; return false; }
      return true;
    }

    // ---------- Auth views ----------
    function renderLogin() {
      // Create accessible login form
      const container = createSafeCard('Log in');
      
      const emailInput = createAccessibleInput({
        id: 'login-email',
        type: 'email',
        label: 'Email Address',
        placeholder: 'Enter your email',
        required: true
      });
      
      const passwordInput = createAccessibleInput({
        id: 'login-password',
        type: 'password',
        label: 'Password',
        placeholder: 'Enter your password',
        required: true
      });
      
      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'flex gap-2 flex-wrap';
      
      const loginBtn = document.createElement('button');
      loginBtn.id = 'btn-login';
      loginBtn.className = 'btn';
      loginBtn.textContent = 'Log In';
      loginBtn.type = 'submit';
      loginBtn.setAttribute('aria-describedby', 'login-help');
      
      const registerLink = document.createElement('a');
      registerLink.href = '#/register';
      registerLink.className = 'text-sky-400 hover:text-sky-300 underline';
      registerLink.textContent = 'Create account';
      
      const forgotLink = document.createElement('a');
      forgotLink.href = '#/forgot';
      forgotLink.className = 'text-sky-400 hover:text-sky-300 underline';
      forgotLink.textContent = 'Forgot password?';
      
      const helpText = document.createElement('div');
      helpText.id = 'login-help';
      helpText.className = 'text-sm text-slate-400';
      helpText.textContent = 'Sign in to access your transcription library';
      
      buttonContainer.appendChild(loginBtn);
      buttonContainer.appendChild(registerLink);
      buttonContainer.appendChild(forgotLink);
      
      const form = document.createElement('form');
      form.className = 'space-y-4';
      form.appendChild(emailInput);
      form.appendChild(passwordInput);
      form.appendChild(buttonContainer);
      form.appendChild(helpText);
      
      container.appendChild(form);
      view.innerHTML = '';
      view.appendChild(container);
      
      // Enhanced form submission with accessibility
      const handleLogin = async (e) => {
        e.preventDefault();
        const emailEl = document.getElementById('login-email');
        const passwordEl = document.getElementById('login-password');
        
        if (!emailEl.value.trim()) {
          emailEl.focus();
          emailEl.setAttribute('aria-invalid', 'true');
          return;
        }
        if (!passwordEl.value.trim()) {
          passwordEl.focus();
          passwordEl.setAttribute('aria-invalid', 'true');
          return;
        }
        
        try {
          loginBtn.disabled = true;
          loginBtn.textContent = 'Logging in...';
          await API.auth.login(emailEl.value, passwordEl.value);
          location.hash = '#/library';
        } catch(e) {
          // Better error handling
          const errorMsg = document.createElement('div');
          errorMsg.className = 'text-red-400 text-sm mt-2';
          errorMsg.setAttribute('role', 'alert');
          errorMsg.textContent = 'Login failed: ' + e.message;
          
          // Remove previous error if exists
          const prevError = form.querySelector('[role="alert"]');
          if (prevError) prevError.remove();
          
          form.appendChild(errorMsg);
          emailEl.focus();
        } finally {
          loginBtn.disabled = false;
          loginBtn.textContent = 'Log In';
        }
      };
      
      form.addEventListener('submit', handleLogin);
      loginBtn.addEventListener('click', handleLogin);
      
      // Focus management
      setTimeout(() => {
        const emailInput = emailContainer.querySelector('input');
        if (emailInput) emailInput.focus();
      }, 100);
    }

    function renderRegister() {
      // Create accessible registration form
      const container = createSafeCard('Create Account');
      
      const nameInput = createAccessibleInput({
        id: 'reg-name',
        label: 'Full Name',
        placeholder: 'Enter your full name',
        required: true
      });
      
      const emailInput = createAccessibleInput({
        id: 'reg-email',
        type: 'email',
        label: 'Email Address',
        placeholder: 'Enter your email',
        required: true
      });
      
      const passwordInput = createAccessibleInput({
        id: 'reg-password',
        type: 'password',
        label: 'Password',
        placeholder: 'Create a secure password (min 8 characters)',
        required: true
      });
      
      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'flex gap-2 flex-wrap';
      
      const registerBtn = document.createElement('button');
      registerBtn.id = 'btn-register';
      registerBtn.className = 'btn';
      registerBtn.textContent = 'Create Account';
      registerBtn.type = 'submit';
      
      const loginLink = document.createElement('a');
      loginLink.href = '#/login';
      loginLink.className = 'text-sky-400 hover:text-sky-300 underline';
      loginLink.textContent = 'Already have an account?';
      
      buttonContainer.appendChild(registerBtn);
      buttonContainer.appendChild(loginLink);
      
      const form = document.createElement('form');
      form.className = 'space-y-4';
      form.appendChild(nameInput);
      form.appendChild(emailInput);
      form.appendChild(passwordInput);
      form.appendChild(buttonContainer);
      
      container.appendChild(form);
      view.innerHTML = '';
      view.appendChild(container);
      
      // Enhanced form submission
      const handleRegister = async (e) => {
        e.preventDefault();
        const nameEl = document.getElementById('reg-name');
        const emailEl = document.getElementById('reg-email');
        const passwordEl = document.getElementById('reg-password');
        
        // Validation
        if (!nameEl.value.trim()) {
          nameEl.focus();
          nameEl.setAttribute('aria-invalid', 'true');
          return;
        }
        if (!emailEl.value.trim()) {
          emailEl.focus();
          emailEl.setAttribute('aria-invalid', 'true');
          return;
        }
        if (!passwordEl.value.trim() || passwordEl.value.length < 8) {
          passwordEl.focus();
          passwordEl.setAttribute('aria-invalid', 'true');
          const errorMsg = document.createElement('div');
          errorMsg.className = 'text-red-400 text-sm mt-1';
          errorMsg.setAttribute('role', 'alert');
          errorMsg.textContent = 'Password must be at least 8 characters long';
          passwordInput.appendChild(errorMsg);
          setTimeout(() => errorMsg.remove(), 3000);
          return;
        }
        
        try {
          registerBtn.disabled = true;
          registerBtn.textContent = 'Creating Account...';
          await API.auth.register(emailEl.value, passwordEl.value, nameEl.value);
          
          // Show success message
          const successMsg = document.createElement('div');
          successMsg.className = 'text-green-400 text-sm mt-2';
          successMsg.setAttribute('role', 'status');
          successMsg.textContent = 'Account created successfully! You can now sign in.';
          form.appendChild(successMsg);
          
          setTimeout(() => {
            location.hash = '#/library';
          }, 1500);
        } catch(e) {
          const errorMsg = document.createElement('div');
          errorMsg.className = 'text-red-400 text-sm mt-2';
          errorMsg.setAttribute('role', 'alert');
          errorMsg.textContent = 'Registration failed: ' + e.message;
          
          const prevError = form.querySelector('[role="alert"]');
          if (prevError) prevError.remove();
          
          form.appendChild(errorMsg);
          nameEl.focus();
        } finally {
          registerBtn.disabled = false;
          registerBtn.textContent = 'Create Account';
        }
      };
      
      form.addEventListener('submit', handleRegister);
      registerBtn.addEventListener('click', handleRegister);
      
      setTimeout(() => {
        const nameInput = nameInput.querySelector('input');
        if (nameInput) nameInput.focus();
      }, 100);
    }

    function renderForgot() {
      const container = createSafeCard('Reset Password');
      
      const emailInput = createAccessibleInput({
        id: 'fp-email',
        type: 'email',
        label: 'Email Address',
        placeholder: 'Enter your email address',
        required: true
      });
      
      const submitBtn = document.createElement('button');
      submitBtn.id = 'btn-fp';
      submitBtn.className = 'btn';
      submitBtn.textContent = 'Send Reset Link';
      submitBtn.type = 'submit';
      
      const helpText = document.createElement('div');
      helpText.className = 'text-slate-400 text-sm';
      helpText.textContent = "We'll send you an email with a link to reset your password.";
      
      const loginLink = document.createElement('a');
      loginLink.href = '#/login';
      loginLink.className = 'text-sky-400 hover:text-sky-300 underline text-sm';
      loginLink.textContent = 'Back to Sign In';
      
      const form = document.createElement('form');
      form.className = 'space-y-4';
      form.appendChild(emailInput);
      form.appendChild(submitBtn);
      form.appendChild(helpText);
      form.appendChild(loginLink);
      
      container.appendChild(form);
      view.innerHTML = '';
      view.appendChild(container);
      
      const handleReset = async (e) => {
        e.preventDefault();
        const emailEl = document.getElementById('fp-email');
        
        if (!emailEl.value.trim()) {
          emailEl.focus();
          emailEl.setAttribute('aria-invalid', 'true');
          return;
        }
        
        try {
          submitBtn.disabled = true;
          submitBtn.textContent = 'Sending...';
          await API.auth.requestReset(emailEl.value);
          
          const successMsg = document.createElement('div');
          successMsg.className = 'text-green-400 text-sm mt-2';
          successMsg.setAttribute('role', 'status');
          successMsg.textContent = 'If your email exists, a reset link has been sent.';
          form.appendChild(successMsg);
          
          setTimeout(() => location.hash = '#/login', 3000);
        } catch(e) {
          const errorMsg = document.createElement('div');
          errorMsg.className = 'text-red-400 text-sm mt-2';
          errorMsg.setAttribute('role', 'alert');
          errorMsg.textContent = 'Error: ' + e.message;
          form.appendChild(errorMsg);
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Send Reset Link';
        }
      };
      
      form.addEventListener('submit', handleReset);
      submitBtn.addEventListener('click', handleReset);
      
      setTimeout(() => {
        const emailInputEl = emailInput.querySelector('input');
        if (emailInputEl) emailInputEl.focus();
      }, 100);
    }

    function renderReset() {
      const token = new URLSearchParams(location.hash.split("?")[1]).get("token") || "";
      const container = createSafeCard('Set New Password');
      
      const passwordInput = createAccessibleInput({
        id: 'rpw',
        type: 'password',
        label: 'New Password',
        placeholder: 'Enter new password (min 8 characters)',
        required: true
      });
      
      const submitBtn = document.createElement('button');
      submitBtn.id = 'btn-rpw';
      submitBtn.className = 'btn';
      submitBtn.textContent = 'Update Password';
      submitBtn.type = 'submit';
      
      const form = document.createElement('form');
      form.className = 'space-y-4';
      form.appendChild(passwordInput);
      form.appendChild(submitBtn);
      
      container.appendChild(form);
      view.innerHTML = '';
      view.appendChild(container);
      
      const handleResetPassword = async (e) => {
        e.preventDefault();
        const passwordEl = document.getElementById('rpw');
        
        if (!passwordEl.value.trim() || passwordEl.value.length < 8) {
          passwordEl.focus();
          passwordEl.setAttribute('aria-invalid', 'true');
          return;
        }
        
        try {
          submitBtn.disabled = true;
          submitBtn.textContent = 'Updating...';
          await API.auth.resetPassword(token, passwordEl.value);
          
          const successMsg = document.createElement('div');
          successMsg.className = 'text-green-400 text-sm mt-2';
          successMsg.setAttribute('role', 'status');
          successMsg.textContent = 'Password updated successfully! Please sign in.';
          form.appendChild(successMsg);
          
          setTimeout(() => location.hash = '#/login', 2000);
        } catch(e) {
          const errorMsg = document.createElement('div');
          errorMsg.className = 'text-red-400 text-sm mt-2';
          errorMsg.setAttribute('role', 'alert');
          errorMsg.textContent = 'Reset failed: ' + e.message;
          form.appendChild(errorMsg);
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Update Password';
        }
      };
      
      form.addEventListener('submit', handleResetPassword);
      submitBtn.addEventListener('click', handleResetPassword);
      
      setTimeout(() => {
        const passwordInputEl = passwordInput.querySelector('input');
        if (passwordInputEl) passwordInputEl.focus();
      }, 100);
    }

    function renderVerify() {
      const token = new URLSearchParams(location.hash.split("?")[1]).get("token") || "";
      const container = createSafeCard('Verifying Email...');
      
      const messageDiv = document.createElement('div');
      messageDiv.className = 'text-center py-4';
      messageDiv.setAttribute('role', 'status');
      messageDiv.setAttribute('aria-live', 'polite');
      messageDiv.textContent = 'Verifying your email address...';
      
      container.appendChild(messageDiv);
      view.innerHTML = '';
      view.appendChild(container);
      
      API.auth.verifyEmail(token)
        .then(() => {
          messageDiv.className = 'text-green-400 text-center py-4';
          const successText = document.createElement('div');
          successText.textContent = 'Email verified successfully!';
          
          const continueLink = document.createElement('a');
          continueLink.href = '#/library';
          continueLink.className = 'text-sky-400 hover:text-sky-300 underline mt-2 inline-block';
          continueLink.textContent = 'Continue to Library';
          
          messageDiv.innerHTML = '';
          messageDiv.appendChild(successText);
          messageDiv.appendChild(continueLink);
        })
        .catch(() => {
          messageDiv.className = 'text-red-400 text-center py-4';
          const errorText = document.createElement('div');
          errorText.textContent = 'Email verification failed.';
          
          const backLink = document.createElement('a');
          backLink.href = '#/login';
          backLink.className = 'text-sky-400 hover:text-sky-300 underline mt-2 inline-block';
          backLink.textContent = 'Back to Sign In';
          
          messageDiv.innerHTML = '';
          messageDiv.appendChild(errorText);
          messageDiv.appendChild(backLink);
        });
    }

    // Legacy functions replaced with secure DOM implementations above

    // renderForgot function was replaced with secure DOM implementation above

    // renderReset function was replaced with secure DOM implementation above

    // renderVerify function was replaced with secure DOM implementation above

    // renderLibrary function was replaced with secure DOM implementation above

    // ---------- Live (real WS -> DB) ----------
    function renderLive() {
      state.live=false; state.convId=null;
      // renderLive function was replaced with secure DOM implementation above

      const txt = document.getElementById('txt');

      MinaSocket.connect(); // connects to your /socket.io server

      MinaSocket.onInterim(({text})=>{
        document.getElementById('live-badge').innerText="Receiving…";
        txt.textContent += text || "";
      });
      MinaSocket.onFinal(({text})=>{
        txt.textContent += text || "";
      });
      MinaSocket.onError((e)=>{
        document.getElementById('live-badge').innerText="Error";
      });

      document.getElementById('btn-start').onclick = async ()=>{
        const id = await MinaSocket.startSession("Live session");
        state.convId = id; state.live=true;
        document.getElementById('badge-live').innerText="Recording…";
        document.getElementById('live-badge').innerText="Connected";
      };

      document.getElementById('btn-stop').onclick = async ()=>{
        state.live=false;
        await MinaSocket.stopSession();
        document.getElementById('badge-live').innerText="Stopped";
      };

      document.getElementById('btn-save').onclick = ()=>{
        if (!state.convId) return alert("Start first");
        location.hash = `#/conversation/${state.convId}`;
      };
    }

    // ---------- Conversation ----------
    async function renderConversation(id){
      const r = await API.conv.get(id);
      
      // Create secure conversation interface
      const container = createSafeCard('Conversation Details');
      
      // Header with title and actions
      const headerDiv = document.createElement('div');
      headerDiv.className = 'flex items-center justify-between mb-4';
      
      const titleInput = document.createElement('input');
      titleInput.id = 'title';
      titleInput.className = 'input font-semibold flex-1 mr-4';
      titleInput.setAttribute('aria-label', 'Conversation title');
      titleInput.value = r.conversation.title || '';
      
      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'flex gap-2';
      
      const shareBtn = document.createElement('button');
      shareBtn.id = 'btn-share';
      shareBtn.className = 'btn';
      shareBtn.textContent = 'Share';
      shareBtn.setAttribute('aria-label', 'Share this conversation');
      
      const exportBtn = document.createElement('button');
      exportBtn.id = 'btn-export';
      exportBtn.className = 'btn';
      exportBtn.textContent = 'Export .txt';
      exportBtn.setAttribute('aria-label', 'Export conversation as text file');
      
      actionsDiv.appendChild(shareBtn);
      actionsDiv.appendChild(exportBtn);
      headerDiv.appendChild(titleInput);
      headerDiv.appendChild(actionsDiv);
      
      // Transcript content
      const transcriptDiv = document.createElement('div');
      transcriptDiv.id = 'transcript-content';
      transcriptDiv.className = 'mt-3 whitespace-pre-wrap p-4 bg-slate-900/50 rounded border min-h-[200px] max-h-[400px] overflow-y-auto';
      transcriptDiv.setAttribute('role', 'main');
      transcriptDiv.setAttribute('aria-live', 'polite');
      transcriptDiv.setAttribute('aria-label', 'Conversation transcript');
      transcriptDiv.textContent = r.segments.map(s => s.text).join('');
      
      // Highlights section
      const highlightsSection = document.createElement('div');
      highlightsSection.className = 'mt-4';
      
      const highlightsTitle = document.createElement('h3');
      highlightsTitle.className = 'font-semibold mb-2';
      highlightsTitle.textContent = 'Highlights';
      
      const highlightsForm = document.createElement('div');
      highlightsForm.className = 'flex gap-2 mb-3';
      
      const highlightInput = document.createElement('input');
      highlightInput.id = 'hltext';
      highlightInput.className = 'input flex-1';
      highlightInput.placeholder = 'Add highlight';
      highlightInput.setAttribute('aria-label', 'Add new highlight');
      
      const addHighlightBtn = document.createElement('button');
      addHighlightBtn.id = 'btn-add-hl';
      addHighlightBtn.className = 'btn';
      addHighlightBtn.textContent = 'Add';
      addHighlightBtn.setAttribute('aria-label', 'Add highlight');
      
      highlightsForm.appendChild(highlightInput);
      highlightsForm.appendChild(addHighlightBtn);
      
      const highlightsList = document.createElement('div');
      highlightsList.id = 'hllist';
      highlightsList.className = 'mt-2 text-sm space-y-2';
      
      highlightsSection.appendChild(highlightsTitle);
      highlightsSection.appendChild(highlightsForm);
      highlightsSection.appendChild(highlightsList);
      
      // Tasks section
      const tasksSection = document.createElement('div');
      tasksSection.className = 'mt-4';
      
      const tasksTitle = document.createElement('h3');
      tasksTitle.className = 'font-semibold mb-2';
      tasksTitle.textContent = 'Tasks';
      
      const tasksForm = document.createElement('div');
      tasksForm.className = 'flex gap-2 mb-3';
      
      const taskInput = document.createElement('input');
      taskInput.id = 'ttext';
      taskInput.className = 'input flex-1';
      taskInput.placeholder = 'Add task';
      taskInput.setAttribute('aria-label', 'Add new task');
      
      const addTaskBtn = document.createElement('button');
      addTaskBtn.id = 'btn-add-task';
      addTaskBtn.className = 'btn';
      addTaskBtn.textContent = 'Add';
      addTaskBtn.setAttribute('aria-label', 'Add task');
      
      tasksForm.appendChild(taskInput);
      tasksForm.appendChild(addTaskBtn);
      
      const tasksList = document.createElement('div');
      tasksList.id = 'tlist';
      tasksList.className = 'mt-2 text-sm space-y-2';
      
      tasksSection.appendChild(tasksTitle);
      tasksSection.appendChild(tasksForm);
      tasksSection.appendChild(tasksList);
      
      // Assemble the container
      container.appendChild(headerDiv);
      container.appendChild(transcriptDiv);
      container.appendChild(highlightsSection);
      container.appendChild(tasksSection);
      
      const viewLibrary = document.getElementById('view-library');
      viewLibrary.innerHTML = '';
      viewLibrary.appendChild(container);
      // Title and transcript are already set in the secure DOM implementation above
      
      document.getElementById('btn-export').onclick = ()=>{
        const content = r.segments.map(s => s.text).join('');
        const blob = new Blob([content], {type:"text/plain"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = escapeHtml(r.conversation.title || 'conversation') + '.txt';
        a.click();
      };
      document.getElementById('btn-share').onclick = async ()=>{
        const s = await API.conv.share(id);
        const url = `${location.origin}/s/${s.token}`;
        await navigator.clipboard.writeText(url);
        alert("Share link copied:\n"+url);
      };
      document.getElementById('btn-add-hl').onclick = async ()=>{
        const t = hltext.value.trim(); if(!t) return;
        await API.conv.addHighlight(id, { text:t }); hltext.value=""; loadHL();
      };
      document.getElementById('btn-add-task').onclick = async ()=>{
        const t = ttext.value.trim(); if(!t) return;
        await API.conv.addTask(id, { text:t }); ttext.value=""; loadTasks();
      };
      // Secure highlight and task loading
      async function loadHL() {
        const r2 = await API.conv.listHighlights(id);
        const hllist = document.getElementById('hllist');
        hllist.innerHTML = ''; // Clear existing
        r2.items.forEach(item => {
          const div = document.createElement('div');
          div.className = 'card my-1';
          div.textContent = item.text; // Safe text insertion
          hllist.appendChild(div);
        });
      }
      
      async function loadTasks() {
        const r3 = await API.conv.listTasks(id);
        const tlist = document.getElementById('tlist');
        tlist.innerHTML = ''; // Clear existing
        r3.items.forEach(item => {
          const div = document.createElement('div');
          div.className = 'card my-1 flex items-center justify-between';
          
          const textSpan = document.createElement('span');
          textSpan.textContent = item.text; // Safe text insertion
          
          const statusSpan = document.createElement('span');
          statusSpan.className = 'badge bg-slate-700';
          statusSpan.textContent = item.status; // Safe text insertion
          
          div.appendChild(textSpan);
          div.appendChild(statusSpan);
          tlist.appendChild(div);
        });
      }
      loadHL(); loadTasks();
    }

    // ---------- Upload ----------
    function renderUpload(){
      // renderUpload function was replaced with secure DOM implementation above
      document.getElementById('btn-up').onclick = async ()=>{
        const f = document.getElementById('file').files[0]; if(!f) return alert("Choose a file");
        try{
          const r = await API.uploadFile(f);
          upmsg.innerText = `Uploaded. Conversation #${r.id}. Opening…`;
          location.hash = `#/conversation/${r.id}`;
        }catch(e){ alert("Upload failed: "+e.message); }
      };
    }

    // ---------- Settings ----------
    function renderSettings() {
      const container = createSafeCard('Settings');
      const settingsDiv = document.createElement('div');
      settingsDiv.className = 'grid gap-4';
      
      // Email field (read-only)
      const emailContainer = createAccessibleInput({
        id: 'user-email',
        type: 'email',
        label: 'Email Address',
        value: state.user?.email || '',
        disabled: true
      });
      
      // Name field (editable)
      const nameContainer = createAccessibleInput({
        id: 'set-name',
        label: 'Display Name',
        placeholder: 'Enter your display name',
        value: state.user?.name || ''
      });
      
      // Password change section
      const passwordCard = document.createElement('details');
      passwordCard.className = 'card';
      
      const summary = document.createElement('summary');
      summary.className = 'cursor-pointer font-medium';
      summary.textContent = 'Change Password';
      summary.setAttribute('aria-expanded', 'false');
      
      const passwordForm = document.createElement('div');
      passwordForm.className = 'mt-3 space-y-3';
      
      const currentPwContainer = createAccessibleInput({
        id: 'old-pw',
        type: 'password',
        label: 'Current Password',
        placeholder: 'Enter current password',
        required: true
      });
      
      const newPwContainer = createAccessibleInput({
        id: 'new-pw',
        type: 'password',
        label: 'New Password',
        placeholder: 'Enter new password (min 8 characters)',
        required: true
      });
      
      const changePwBtn = document.createElement('button');
      changePwBtn.id = 'btn-change-pw';
      changePwBtn.className = 'btn w-max';
      changePwBtn.textContent = 'Update Password';
      changePwBtn.type = 'button';
      
      passwordForm.appendChild(currentPwContainer);
      passwordForm.appendChild(newPwContainer);
      passwordForm.appendChild(changePwBtn);
      
      passwordCard.appendChild(summary);
      passwordCard.appendChild(passwordForm);
      
      // Logout section
      const logoutContainer = document.createElement('div');
      logoutContainer.className = 'flex gap-2';
      
      const logoutBtn = document.createElement('button');
      logoutBtn.id = 'btn-logout';
      logoutBtn.className = 'btn bg-rose-700 hover:bg-rose-600';
      logoutBtn.textContent = 'Sign Out';
      logoutBtn.type = 'button';
      logoutBtn.setAttribute('aria-describedby', 'logout-help');
      
      const logoutHelp = document.createElement('div');
      logoutHelp.id = 'logout-help';
      logoutHelp.className = 'text-sm text-slate-400';
      logoutHelp.textContent = 'You will be signed out of your account';
      
      logoutContainer.appendChild(logoutBtn);
      logoutContainer.appendChild(logoutHelp);
      
      settingsDiv.appendChild(emailContainer);
      settingsDiv.appendChild(nameContainer);
      settingsDiv.appendChild(passwordCard);
      settingsDiv.appendChild(logoutContainer);
      
      container.appendChild(settingsDiv);
      
      const viewSettings = document.getElementById('view-settings');
      viewSettings.innerHTML = '';
      viewSettings.appendChild(container);
      
      // Enhanced event handlers with better UX
      logoutBtn.onclick = async () => {
        if (confirm('Are you sure you want to sign out?')) {
          try {
            await API.auth.logout();
            location.hash = '#/login';
          } catch(e) {
            alert('Sign out failed: ' + e.message);
          }
        }
      };
      
      changePwBtn.onclick = async () => {
        const oldPw = document.getElementById('old-pw').value;
        const newPw = document.getElementById('new-pw').value;
        
        if (!oldPw.trim()) {
          document.getElementById('old-pw').focus();
          return;
        }
        if (!newPw.trim() || newPw.length < 8) {
          document.getElementById('new-pw').focus();
          alert('New password must be at least 8 characters long');
          return;
        }
        
        try {
          changePwBtn.disabled = true;
          changePwBtn.textContent = 'Updating...';
          await API.auth.changePassword(oldPw, newPw);
          
          // Clear fields and show success
          document.getElementById('old-pw').value = '';
          document.getElementById('new-pw').value = '';
          
          const successMsg = document.createElement('div');
          successMsg.className = 'text-green-400 text-sm mt-2';
          successMsg.setAttribute('role', 'status');
          successMsg.textContent = 'Password updated successfully';
          passwordForm.appendChild(successMsg);
          
          setTimeout(() => successMsg.remove(), 3000);
        } catch(e) {
          alert('Password change failed: ' + e.message);
        } finally {
          changePwBtn.disabled = false;
          changePwBtn.textContent = 'Update Password';
        }
      };
    }

    // ---------- Integration with CTO Router ---------- 
    // Let CTO router handle show/hide, we handle content rendering
    async function handleRouteChange() {
      await ensureUser();
      const [_, path, arg] = location.hash.split("/");
      
      // Handle authentication routes in main view
      if (path === "login") return renderLogin();
      if (path === "register") return renderRegister();
      if (path === "forgot") return renderForgot();
      if (path === "reset") return renderReset();
      if (path === "verify") return renderVerify();
      
      // Apply authentication guard for protected routes
      if (!guard()) return;
      
      // Handle content rendering for data-view sections
      if (!path || path === "library") {
        if (arg) {
          return renderConversation(arg); // conversation view in library section
        } else {
          return renderLibrary();
        }
      }
      if (path === "live") return renderLive();
      if (path === "upload") return renderUpload();
      if (path === "settings") return renderSettings();
    }
    
    // Listen for hash changes and handle content rendering
    window.addEventListener('hashchange', handleRouteChange);
    
    // Initial load
    handleRouteChange();
  </script>
  <main class="container" style="min-height:60vh">
    <section id="view-welcome" data-view hidden></section>
    <section id="view-library" data-view hidden></section>
    <section id="view-live" data-view hidden></section>
    <section id="view-upload" data-view hidden></section>
    <section id="view-settings" data-view hidden></section>
  </main>
</body>
</html>
