<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Recording - Mina</title>
    
    <!-- Core CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/design-tokens.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/typography.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    
    <!-- External Dependencies -->
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽ¤</text></svg>">
    
    <style>
        /* Premium Recording Interface Styles */
        .recording-layout {
            min-height: 100vh;
            background: var(--mina-bg-app);
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: var(--mina-space-8);
            padding: var(--mina-space-8);
        }
        
        /* Control Panel */
        .control-panel {
            background: var(--glass-bg-strong);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--mina-radius-xl);
            padding: var(--mina-space-8);
            height: fit-content;
            position: sticky;
            top: var(--mina-space-8);
            transition: all var(--mina-transition-base);
        }
        
        .control-panel:hover {
            transform: translateY(-2px);
            box-shadow: var(--elevation-4);
        }
        
        /* Premium Record Button */
        .record-button-container {
            text-align: center;
            margin: var(--mina-space-8) 0;
        }
        
        .record-button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, var(--mina-primary), var(--mina-secondary));
            color: white;
            font-size: 2.5rem;
            cursor: pointer;
            transition: all var(--mina-transition-base);
            position: relative;
            overflow: hidden;
            box-shadow: var(--elevation-3);
        }
        
        .record-button:hover {
            transform: scale(1.05);
            box-shadow: var(--elevation-4);
        }
        
        .record-button.recording {
            background: linear-gradient(135deg, var(--mina-danger), var(--mina-warning));
            animation: recording-pulse 2s infinite;
        }
        
        .record-button.recording::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: radial-gradient(circle, transparent 60%, rgba(239, 68, 68, 0.3) 70%);
            border-radius: 50%;
            animation: recording-ring 2s infinite;
        }
        
        @keyframes recording-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        @keyframes recording-ring {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(1.2); opacity: 0; }
        }
        
        /* Status Indicators */
        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--mina-space-4);
            margin-bottom: var(--mina-space-6);
        }
        
        .status-card {
            background: var(--mina-bg-primary);
            border: 1px solid var(--mina-border-primary);
            border-radius: var(--mina-radius-lg);
            padding: var(--mina-space-4);
            text-align: center;
            transition: all var(--mina-transition-fast);
        }
        
        .status-card:hover {
            border-color: var(--mina-primary);
            transform: translateY(-1px);
        }
        
        .status-value {
            font-size: var(--mina-font-size-xl);
            font-weight: var(--mina-font-weight-bold);
            color: var(--mina-primary);
            font-family: var(--mina-font-family-display);
        }
        
        .status-label {
            font-size: var(--mina-font-size-sm);
            color: var(--mina-text-muted);
            margin-top: var(--mina-space-1);
        }
        
        /* Audio Visualizer */
        .audio-visualizer {
            background: var(--mina-bg-secondary);
            border-radius: var(--mina-radius-lg);
            padding: var(--mina-space-4);
            margin-bottom: var(--mina-space-6);
        }
        
        .waveform {
            display: flex;
            align-items: end;
            gap: 2px;
            height: 60px;
            justify-content: center;
        }
        
        .waveform-bar {
            width: 4px;
            background: linear-gradient(180deg, var(--mina-primary), var(--mina-secondary));
            border-radius: 2px;
            transition: height 100ms ease-out;
        }
        
        /* Transcription Window */
        .transcription-panel {
            background: var(--glass-bg-strong);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--mina-radius-xl);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: calc(100vh - var(--mina-space-16));
        }
        
        .transcription-header {
            background: linear-gradient(135deg, var(--mina-neutral-900), var(--mina-neutral-800));
            color: white;
            padding: var(--mina-space-6);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .transcription-content {
            flex: 1;
            padding: var(--mina-space-6);
            overflow-y: auto;
            scroll-behavior: smooth;
            position: relative;
        }
        
        /* Unified Transcript Display */
        .transcript-window {
            min-height: 400px;
            background: var(--mina-bg-primary);
            border: 1px solid var(--mina-border-primary);
            border-radius: var(--mina-radius-lg);
            padding: var(--mina-space-6);
            position: relative;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        
        .transcript-segment {
            margin-bottom: var(--mina-space-4);
            padding: var(--mina-space-4);
            border-radius: var(--mina-radius-md);
            transition: all var(--mina-transition-fast);
            border-left: 4px solid transparent;
        }
        
        .transcript-segment.interim {
            background: var(--mina-bg-secondary);
            border-left-color: var(--mina-warning);
            opacity: 0.8;
            animation: interim-glow 2s infinite;
        }
        
        .transcript-segment.final {
            background: var(--mina-bg-tertiary);
            border-left-color: var(--mina-success);
            transform: scale(1.01);
        }
        
        @keyframes interim-glow {
            0%, 100% { box-shadow: 0 0 0 rgba(245, 158, 11, 0); }
            50% { box-shadow: 0 0 10px rgba(245, 158, 11, 0.3); }
        }
        
        .transcript-text {
            font-size: var(--mina-font-size-lg);
            line-height: 1.6;
            color: var(--mina-text-primary);
            margin-bottom: var(--mina-space-2);
        }
        
        .transcript-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: var(--mina-font-size-sm);
            color: var(--mina-text-muted);
        }
        
        .confidence-bar {
            width: 60px;
            height: 4px;
            background: var(--mina-bg-secondary);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--mina-danger), var(--mina-warning), var(--mina-success));
            transition: width 300ms ease-out;
        }
        
        /* Empty State */
        .transcript-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            text-align: center;
            color: var(--mina-text-muted);
        }
        
        .transcript-empty-icon {
            font-size: 4rem;
            margin-bottom: var(--mina-space-4);
            opacity: 0.5;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: var(--mina-space-3);
            margin-top: var(--mina-space-6);
        }
        
        .action-button {
            flex: 1;
            padding: var(--mina-space-3) var(--mina-space-4);
            border: 1px solid var(--mina-border-primary);
            border-radius: var(--mina-radius-md);
            background: var(--mina-bg-primary);
            color: var(--mina-text-primary);
            cursor: pointer;
            transition: all var(--mina-transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--mina-space-2);
        }
        
        .action-button:hover {
            border-color: var(--mina-primary);
            background: var(--mina-bg-secondary);
            transform: translateY(-1px);
        }
        
        /* Responsive Design */
        @media (max-width: 1024px) {
            .recording-layout {
                grid-template-columns: 1fr;
                gap: var(--mina-space-6);
                padding: var(--mina-space-4);
            }
            
            .control-panel {
                position: static;
            }
            
            .record-button {
                width: 100px;
                height: 100px;
                font-size: 2rem;
            }
        }
        
        /* Loading States */
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--mina-bg-secondary);
            border-top: 2px solid var(--mina-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Connection Status */
        .connection-status {
            display: flex;
            align-items: center;
            gap: var(--mina-space-2);
            padding: var(--mina-space-3);
            border-radius: var(--mina-radius-md);
            font-size: var(--mina-font-size-sm);
            margin-bottom: var(--mina-space-4);
        }
        
        .connection-status.connected {
            background: rgba(16, 185, 129, 0.1);
            color: var(--mina-success-dark);
        }
        
        .connection-status.disconnected {
            background: rgba(239, 68, 68, 0.1);
            color: var(--mina-danger-dark);
        }
        
        .connection-status.connecting {
            background: rgba(245, 158, 11, 0.1);
            color: var(--mina-warning-dark);
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }
        
        .status-indicator.pulse {
            animation: status-pulse 2s infinite;
        }
        
        @keyframes status-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <!-- Dark Mode Toggle -->
    <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark mode">
        <i data-feather="sun" id="themeIcon"></i>
    </button>

    <div class="recording-layout">
        <!-- Control Panel -->
        <div class="control-panel">
            <!-- Navigation -->
            <div style="margin-bottom: var(--mina-space-6);">
                <a href="{{ url_for('dashboard.index') }}" style="display: flex; align-items: center; gap: var(--mina-space-2); color: var(--mina-text-secondary); text-decoration: none; font-size: var(--mina-font-size-sm);">
                    <i data-feather="arrow-left" style="width: 16px; height: 16px;"></i>
                    Back to Dashboard
                </a>
            </div>
            
            <!-- Header -->
            <div style="text-align: center; margin-bottom: var(--mina-space-8);">
                <h1 style="font-size: var(--mina-font-size-2xl); font-weight: var(--mina-font-weight-bold); color: var(--mina-text-primary); margin-bottom: var(--mina-space-2); font-family: var(--mina-font-family-display);">
                    Live Recording
                </h1>
                <p style="color: var(--mina-text-muted); font-size: var(--mina-font-size-sm);">
                    Real-time transcription powered by AI
                </p>
            </div>
            
            <!-- Connection Status -->
            <div class="connection-status disconnected" id="connectionStatus">
                <div class="status-indicator pulse" id="statusIndicator"></div>
                <span id="statusText">Connecting...</span>
            </div>
            
            <!-- Record Button -->
            <div class="record-button-container">
                <button class="record-button" id="recordButton" aria-label="Start recording">
                    <i data-feather="mic" id="recordIcon"></i>
                </button>
                <div style="margin-top: var(--mina-space-4); font-size: var(--mina-font-size-lg); font-weight: var(--mina-font-weight-semibold); color: var(--mina-text-primary);" id="recordingTimer">
                    00:00
                </div>
            </div>
            
            <!-- Status Grid -->
            <div class="status-grid">
                <div class="status-card">
                    <div class="status-value" id="segmentCount">0</div>
                    <div class="status-label">Segments</div>
                </div>
                <div class="status-card">
                    <div class="status-value" id="wordCount">0</div>
                    <div class="status-label">Words</div>
                </div>
                <div class="status-card">
                    <div class="status-value" id="confidenceScore">--%</div>
                    <div class="status-label">Confidence</div>
                </div>
                <div class="status-card">
                    <div class="status-value" id="latencyMs">--ms</div>
                    <div class="status-label">Latency</div>
                </div>
            </div>
            
            <!-- Audio Visualizer -->
            <div class="audio-visualizer">
                <div style="font-size: var(--mina-font-size-sm); color: var(--mina-text-muted); margin-bottom: var(--mina-space-3); text-align: center;">
                    Audio Level
                </div>
                <div class="waveform" id="audioWaveform">
                    <!-- Waveform bars will be generated by JavaScript -->
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="action-button" id="clearButton" title="Clear transcript">
                    <i data-feather="trash-2" style="width: 16px; height: 16px;"></i>
                    Clear
                </button>
                <button class="action-button" id="copyButton" title="Copy transcript">
                    <i data-feather="copy" style="width: 16px; height: 16px;"></i>
                    Copy
                </button>
                <button class="action-button" id="downloadButton" title="Download transcript">
                    <i data-feather="download" style="width: 16px; height: 16px;"></i>
                    Save
                </button>
            </div>
        </div>
        
        <!-- Transcription Panel -->
        <div class="transcription-panel">
            <!-- Header -->
            <div class="transcription-header">
                <div>
                    <h2 style="font-size: var(--mina-font-size-xl); font-weight: var(--mina-font-weight-semibold); margin-bottom: var(--mina-space-1); font-family: var(--mina-font-family-display);">
                        <i data-feather="file-text" style="width: 20px; height: 20px; margin-right: var(--mina-space-2);"></i>
                        Live Transcript
                    </h2>
                    <p style="font-size: var(--mina-font-size-sm); opacity: 0.8; margin: 0;">
                        Real-time speech-to-text transcription
                    </p>
                </div>
                <div style="display: flex; gap: var(--mina-space-3); align-items: center;">
                    <button class="action-button" id="autoScrollToggle" title="Toggle auto-scroll" style="background: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.2); color: white;">
                        <i data-feather="arrow-down" style="width: 16px; height: 16px;"></i>
                    </button>
                    <button class="action-button" id="fullscreenToggle" title="Toggle fullscreen" style="background: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.2); color: white;">
                        <i data-feather="maximize" style="width: 16px; height: 16px;"></i>
                    </button>
                </div>
            </div>
            
            <!-- Content -->
            <div class="transcription-content">
                <div class="transcript-window" id="transcriptWindow">
                    <div class="transcript-empty" id="emptyState">
                        <div class="transcript-empty-icon">
                            <i data-feather="mic-off"></i>
                        </div>
                        <h3 style="font-size: var(--mina-font-size-lg); margin-bottom: var(--mina-space-2); color: var(--mina-text-primary);">
                            Ready to Record
                        </h3>
                        <p style="font-size: var(--mina-font-size-sm); margin-bottom: var(--mina-space-4);">
                            Click the record button to start capturing your voice
                        </p>
                        <div style="display: flex; gap: var(--mina-space-3); flex-wrap: wrap; justify-content: center;">
                            <span style="background: rgba(99, 102, 241, 0.1); color: var(--mina-primary); padding: var(--mina-space-1) var(--mina-space-3); border-radius: var(--mina-radius-full); font-size: var(--mina-font-size-xs); font-weight: var(--mina-font-weight-semibold);">
                                Real-time Processing
                            </span>
                            <span style="background: rgba(16, 185, 129, 0.1); color: var(--mina-success-dark); padding: var(--mina-space-1) var(--mina-space-3); border-radius: var(--mina-radius-full); font-size: var(--mina-font-size-xs); font-weight: var(--mina-font-weight-semibold);">
                                High Accuracy
                            </span>
                            <span style="background: rgba(245, 158, 11, 0.1); color: var(--mina-warning-dark); padding: var(--mina-space-1) var(--mina-space-3); border-radius: var(--mina-radius-full); font-size: var(--mina-font-size-xs); font-weight: var(--mina-font-weight-semibold);">
                                Multi-language
                            </span>
                        </div>
                    </div>
                    
                    <!-- Transcript segments will be dynamically added here -->
                    <div id="transcriptSegments"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" style="position: fixed; top: var(--mina-space-6); right: var(--mina-space-6); background: var(--glass-bg-strong); backdrop-filter: var(--glass-blur); border: 1px solid var(--glass-border); border-radius: var(--mina-radius-lg); padding: var(--mina-space-4); color: var(--mina-text-primary); font-size: var(--mina-font-size-sm); z-index: 1000; transform: translateX(100%); transition: transform var(--mina-transition-base); display: none;">
        <div id="toastMessage"></div>
    </div>

    <script>
        // Premium Recording Interface JavaScript
        class PremiumRecordingInterface {
            constructor() {
                this.isRecording = false;
                this.isPaused = false;
                this.autoScroll = true;
                this.socket = null;
                this.mediaRecorder = null;
                this.audioContext = null;
                this.analyser = null;
                this.recordingStartTime = null;
                this.timerInterval = null;
                this.currentSegmentId = null;
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.setupAudioVisualization();
                this.connectWebSocket();
                this.updateTheme();
            }
            
            setupEventListeners() {
                // Record button
                document.getElementById('recordButton').addEventListener('click', () => {
                    this.toggleRecording();
                });
                
                // Action buttons
                document.getElementById('clearButton').addEventListener('click', () => {
                    this.clearTranscript();
                });
                
                document.getElementById('copyButton').addEventListener('click', () => {
                    this.copyTranscript();
                });
                
                document.getElementById('downloadButton').addEventListener('click', () => {
                    this.downloadTranscript();
                });
                
                document.getElementById('autoScrollToggle').addEventListener('click', () => {
                    this.toggleAutoScroll();
                });
                
                document.getElementById('fullscreenToggle').addEventListener('click', () => {
                    this.toggleFullscreen();
                });
                
                // Theme toggle
                document.getElementById('themeToggle').addEventListener('click', () => {
                    this.toggleTheme();
                });
            }
            
            setupAudioVisualization() {
                const waveform = document.getElementById('audioWaveform');
                // Create 20 waveform bars
                for (let i = 0; i < 20; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'waveform-bar';
                    bar.style.height = '4px';
                    waveform.appendChild(bar);
                }
            }
            
            connectWebSocket() {
                if (typeof io === 'undefined') {
                    this.showToast('Socket.IO not loaded', 'error');
                    return;
                }
                
                this.socket = io('/transcription');
                
                this.socket.on('connect', () => {
                    this.updateConnectionStatus('connected', 'Connected');
                });
                
                this.socket.on('disconnect', () => {
                    this.updateConnectionStatus('disconnected', 'Disconnected');
                });
                
                this.socket.on('transcription_result', (data) => {
                    this.handleTranscriptionResult(data);
                });
                
                this.socket.on('error', (error) => {
                    this.showToast('Connection error: ' + error, 'error');
                });
            }
            
            async toggleRecording() {
                if (this.isRecording) {
                    await this.stopRecording();
                } else {
                    await this.startRecording();
                }
            }
            
            async startRecording() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true,
                            sampleRate: 48000,  // Higher sample rate
                            channelCount: 1     // Mono for better processing
                        } 
                    });
                    
                    this.setupAudioContext(stream);
                    this.setupMediaRecorder(stream);
                    
                    this.mediaRecorder.start(1500); // 1.5 second chunks for continuous transcription
                    this.isRecording = true;
                    this.recordingStartTime = Date.now();
                    this.startTimer();
                    
                    this.updateRecordButton();
                    this.hideEmptyState();
                    this.showToast('Recording started', 'success');
                    
                    // Start session
                    this.socket.emit('start_session', {
                        language: 'en',
                        enhance_audio: true
                    });
                    
                } catch (error) {
                    this.showToast('Failed to start recording: ' + error.message, 'error');
                }
            }
            
            async stopRecording() {
                if (this.mediaRecorder && this.isRecording) {
                    this.mediaRecorder.stop();
                    this.isRecording = false;
                    this.stopTimer();
                    
                    this.updateRecordButton();
                    this.showToast('Recording stopped', 'info');
                    
                    // End session and finalize transcript
                    this.socket.emit('end_session');
                    this.finalizeTranscript();
                }
            }
            
            setupAudioContext(stream) {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                this.analyser = this.audioContext.createAnalyser();
                const source = this.audioContext.createMediaStreamSource(stream);
                source.connect(this.analyser);
                
                this.analyser.fftSize = 256;
                this.startAudioVisualization();
            }
            
            setupMediaRecorder(stream) {
                // Use the most compatible format
                this.mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus',
                    audioBitsPerSecond: 128000
                });
                
                this.mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0 && this.socket) {
                        // Send each chunk immediately for continuous transcription
                        const reader = new FileReader();
                        reader.onload = () => {
                            // Send raw ArrayBuffer, not base64 encoded
                            this.socket.emit('audio_data', reader.result);
                        };
                        reader.readAsArrayBuffer(event.data);
                    }
                };
            }
            
            startAudioVisualization() {
                const bufferLength = this.analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                const bars = document.querySelectorAll('.waveform-bar');
                
                const animate = () => {
                    if (!this.isRecording) return;
                    
                    this.analyser.getByteFrequencyData(dataArray);
                    
                    bars.forEach((bar, index) => {
                        const value = dataArray[Math.floor(index * bufferLength / bars.length)];
                        const height = Math.max(4, (value / 255) * 60);
                        bar.style.height = height + 'px';
                    });
                    
                    requestAnimationFrame(animate);
                };
                
                animate();
            }
            
            handleTranscriptionResult(data) {
                const { transcript, is_final, confidence, latency_ms, segment_id } = data;
                
                if (transcript && transcript.trim()) {
                    if (is_final) {
                        // Replace interim with final transcript
                        this.addFinalTranscript(transcript, confidence, latency_ms, segment_id);
                    } else {
                        // Show interim transcript
                        this.addInterimTranscript(transcript, confidence, latency_ms, segment_id);
                    }
                    
                    this.updateStats(confidence, latency_ms);
                }
            }
            
            addInterimTranscript(text, confidence, latency, segmentId) {
                const container = document.getElementById('transcriptSegments');
                
                // Remove existing interim segment with same ID
                const existingInterim = document.querySelector(`[data-segment-id="${segmentId}"].interim`);
                if (existingInterim) {
                    existingInterim.remove();
                }
                
                const segment = this.createTranscriptSegment(text, confidence, latency, segmentId, false);
                container.appendChild(segment);
                
                this.currentSegmentId = segmentId;
                this.scrollToBottom();
            }
            
            addFinalTranscript(text, confidence, latency, segmentId) {
                const container = document.getElementById('transcriptSegments');
                
                // Remove interim segment with same ID
                const existingInterim = document.querySelector(`[data-segment-id="${segmentId}"].interim`);
                if (existingInterim) {
                    existingInterim.remove();
                }
                
                const segment = this.createTranscriptSegment(text, confidence, latency, segmentId, true);
                container.appendChild(segment);
                
                this.scrollToBottom();
                this.updateWordCount();
            }
            
            createTranscriptSegment(text, confidence, latency, segmentId, isFinal) {
                const segment = document.createElement('div');
                segment.className = `transcript-segment ${isFinal ? 'final' : 'interim'}`;
                segment.setAttribute('data-segment-id', segmentId);
                
                const confidencePercent = Math.round((confidence || 0.85) * 100);
                
                segment.innerHTML = `
                    <div class="transcript-text">${text}</div>
                    <div class="transcript-meta">
                        <div style="display: flex; align-items: center; gap: var(--mina-space-2);">
                            <span style="font-size: var(--mina-font-size-xs);">Confidence:</span>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: ${confidencePercent}%"></div>
                            </div>
                            <span style="font-size: var(--mina-font-size-xs);">${confidencePercent}%</span>
                        </div>
                        <div style="font-size: var(--mina-font-size-xs);">
                            ${latency ? `${latency}ms` : ''} â€¢ ${new Date().toLocaleTimeString()}
                        </div>
                    </div>
                `;
                
                return segment;
            }
            
            finalizeTranscript() {
                // Convert all interim segments to final
                const interimSegments = document.querySelectorAll('.transcript-segment.interim');
                interimSegments.forEach(segment => {
                    segment.classList.remove('interim');
                    segment.classList.add('final');
                });
                
                this.showToast('Transcript finalized', 'success');
            }
            
            updateStats(confidence, latency) {
                if (confidence) {
                    document.getElementById('confidenceScore').textContent = Math.round(confidence * 100) + '%';
                }
                
                if (latency) {
                    document.getElementById('latencyMs').textContent = latency + 'ms';
                }
                
                // Update segment count
                const finalSegments = document.querySelectorAll('.transcript-segment.final').length;
                document.getElementById('segmentCount').textContent = finalSegments;
            }
            
            updateWordCount() {
                const allText = Array.from(document.querySelectorAll('.transcript-text')).map(el => el.textContent).join(' ');
                const wordCount = allText.split(/\s+/).filter(word => word.length > 0).length;
                document.getElementById('wordCount').textContent = wordCount;
            }
            
            startTimer() {
                this.timerInterval = setInterval(() => {
                    if (this.recordingStartTime) {
                        const elapsed = Date.now() - this.recordingStartTime;
                        const minutes = Math.floor(elapsed / 60000);
                        const seconds = Math.floor((elapsed % 60000) / 1000);
                        document.getElementById('recordingTimer').textContent = 
                            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    }
                }, 1000);
            }
            
            stopTimer() {
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
            }
            
            updateRecordButton() {
                const button = document.getElementById('recordButton');
                const icon = document.getElementById('recordIcon');
                
                if (this.isRecording) {
                    button.classList.add('recording');
                    icon.setAttribute('data-feather', 'square');
                } else {
                    button.classList.remove('recording');
                    icon.setAttribute('data-feather', 'mic');
                }
                
                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
            }
            
            updateConnectionStatus(status, text) {
                const statusEl = document.getElementById('connectionStatus');
                const indicatorEl = document.getElementById('statusIndicator');
                const textEl = document.getElementById('statusText');
                
                statusEl.className = `connection-status ${status}`;
                textEl.textContent = text;
                
                if (status === 'connecting') {
                    indicatorEl.classList.add('pulse');
                } else {
                    indicatorEl.classList.remove('pulse');
                }
            }
            
            hideEmptyState() {
                document.getElementById('emptyState').style.display = 'none';
            }
            
            showEmptyState() {
                document.getElementById('emptyState').style.display = 'flex';
            }
            
            scrollToBottom() {
                if (this.autoScroll) {
                    const transcriptWindow = document.getElementById('transcriptWindow');
                    transcriptWindow.scrollTop = transcriptWindow.scrollHeight;
                }
            }
            
            toggleAutoScroll() {
                this.autoScroll = !this.autoScroll;
                const button = document.getElementById('autoScrollToggle');
                const icon = button.querySelector('i');
                
                icon.setAttribute('data-feather', this.autoScroll ? 'arrow-down' : 'pause');
                button.title = this.autoScroll ? 'Disable auto-scroll' : 'Enable auto-scroll';
                
                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
                
                this.showToast(`Auto-scroll ${this.autoScroll ? 'enabled' : 'disabled'}`, 'info');
            }
            
            toggleFullscreen() {
                const transcriptionPanel = document.querySelector('.transcription-panel');
                
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                } else {
                    transcriptionPanel.requestFullscreen();
                }
            }
            
            clearTranscript() {
                if (confirm('Are you sure you want to clear the transcript? This action cannot be undone.')) {
                    document.getElementById('transcriptSegments').innerHTML = '';
                    this.showEmptyState();
                    document.getElementById('segmentCount').textContent = '0';
                    document.getElementById('wordCount').textContent = '0';
                    document.getElementById('confidenceScore').textContent = '--%';
                    this.showToast('Transcript cleared', 'info');
                }
            }
            
            copyTranscript() {
                const segments = document.querySelectorAll('.transcript-text');
                const text = Array.from(segments).map(el => el.textContent).join(' ');
                
                navigator.clipboard.writeText(text).then(() => {
                    this.showToast('Transcript copied to clipboard', 'success');
                }).catch(() => {
                    this.showToast('Failed to copy transcript', 'error');
                });
            }
            
            downloadTranscript() {
                const segments = document.querySelectorAll('.transcript-text');
                const text = Array.from(segments).map(el => el.textContent).join(' ');
                
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `transcript_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showToast('Transcript downloaded', 'success');
            }
            
            toggleTheme() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('mina-theme', newTheme);
                
                this.updateTheme();
            }
            
            updateTheme() {
                const theme = localStorage.getItem('mina-theme') || 'light';
                const themeIcon = document.getElementById('themeIcon');
                
                document.documentElement.setAttribute('data-theme', theme);
                themeIcon.setAttribute('data-feather', theme === 'light' ? 'moon' : 'sun');
                
                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
            }
            
            showToast(message, type = 'info') {
                const toast = document.getElementById('toast');
                const toastMessage = document.getElementById('toastMessage');
                
                toastMessage.textContent = message;
                toast.style.display = 'block';
                toast.style.transform = 'translateX(0)';
                
                setTimeout(() => {
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        toast.style.display = 'none';
                    }, 300);
                }, 3000);
            }
        }
        
        // Initialize the interface when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize feather icons
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
            
            // Initialize the premium recording interface
            window.recordingInterface = new PremiumRecordingInterface();
        });
    </script>
</body>
</html>