<!-- Debug Panel - Development Only -->
{% if config.SHOW_DEBUG_PANEL %}
<div id="debugPanel" class="position-fixed bottom-0 end-0 m-3" style="z-index: 9999;">
    <div class="card border-warning" style="width: 300px;">
        <div class="card-header bg-warning text-dark py-2">
            <div class="d-flex justify-content-between align-items-center">
                <small class="fw-bold">ðŸ”§ Debug Panel</small>
                <button class="btn-close btn-close-dark" type="button" onclick="toggleDebugPanel()"></button>
            </div>
        </div>
        <div class="card-body p-2" id="debugPanelBody">
            <div class="row g-1">
                <div class="col-12">
                    <small class="text-muted">WebSocket Status:</small>
                    <div id="debugWSStatus" class="badge bg-secondary">Unknown</div>
                </div>
                <div class="col-6">
                    <small class="text-muted">Chunks Queued:</small>
                    <div id="debugChunksQueued" class="fw-bold">0</div>
                </div>
                <div class="col-6">
                    <small class="text-muted">Chunks Dropped:</small>
                    <div id="debugChunksDropped" class="fw-bold">0</div>
                </div>
                <div class="col-6">
                    <small class="text-muted">Avg Latency:</small>
                    <div id="debugAvgLatency" class="fw-bold">0ms</div>
                </div>
                <div class="col-6">
                    <small class="text-muted">Interim Count:</small>
                    <div id="debugInterimCount" class="fw-bold">0</div>
                </div>
                <div class="col-6">
                    <small class="text-muted">Final Count:</small>
                    <div id="debugFinalCount" class="fw-bold">0</div>
                </div>
                <div class="col-6">
                    <small class="text-muted">Session ID:</small>
                    <div id="debugSessionId" class="small text-truncate">None</div>
                </div>
            </div>
            <hr class="my-2">
            <div class="d-grid gap-1">
                <button class="btn btn-outline-primary btn-sm" onclick="debugClearMetrics()">Clear Metrics</button>
                <button class="btn btn-outline-secondary btn-sm" onclick="debugExportLogs()">Export Logs</button>
            </div>
        </div>
    </div>
</div>

<script>
// Debug panel functionality
let debugMetrics = {
    chunksQueued: 0,
    chunksDropped: 0,
    interimCount: 0,
    finalCount: 0,
    latencies: [],
    wsConnected: false
};

function toggleDebugPanel() {
    const panel = document.getElementById('debugPanel');
    const body = document.getElementById('debugPanelBody');
    if (body.style.display === 'none') {
        body.style.display = 'block';
    } else {
        body.style.display = 'none';
    }
}

function updateDebugMetrics() {
    document.getElementById('debugWSStatus').textContent = debugMetrics.wsConnected ? 'Connected' : 'Disconnected';
    document.getElementById('debugWSStatus').className = debugMetrics.wsConnected ? 'badge bg-success' : 'badge bg-danger';
    
    document.getElementById('debugChunksQueued').textContent = debugMetrics.chunksQueued;
    document.getElementById('debugChunksDropped').textContent = debugMetrics.chunksDropped;
    document.getElementById('debugInterimCount').textContent = debugMetrics.interimCount;
    document.getElementById('debugFinalCount').textContent = debugMetrics.finalCount;
    
    const avgLatency = debugMetrics.latencies.length > 0 
        ? Math.round(debugMetrics.latencies.reduce((a, b) => a + b, 0) / debugMetrics.latencies.length)
        : 0;
    document.getElementById('debugAvgLatency').textContent = avgLatency + 'ms';
}

function debugClearMetrics() {
    debugMetrics = {
        chunksQueued: 0,
        chunksDropped: 0,
        interimCount: 0,
        finalCount: 0,
        latencies: [],
        wsConnected: debugMetrics.wsConnected
    };
    updateDebugMetrics();
}

function debugExportLogs() {
    const logs = {
        timestamp: new Date().toISOString(),
        metrics: debugMetrics,
        userAgent: navigator.userAgent,
        url: window.location.href
    };
    
    const blob = new Blob([JSON.stringify(logs, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `mina-debug-${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

// Hook into recording events to update metrics
if (window.addEventListener) {
    // Update debug panel every 2 seconds
    setInterval(updateDebugMetrics, 2000);
    
    // Hook into socket events if available
    document.addEventListener('DOMContentLoaded', () => {
        if (window.socket) {
            socket.on('connect', () => {
                debugMetrics.wsConnected = true;
            });
            
            socket.on('disconnect', () => {
                debugMetrics.wsConnected = false;
            });
            
            socket.on('interim_transcript', () => {
                debugMetrics.interimCount++;
            });
            
            socket.on('final_transcript', () => {
                debugMetrics.finalCount++;
            });
        }
    });
}

// Minimize panel by default
document.addEventListener('DOMContentLoaded', () => {
    const body = document.getElementById('debugPanelBody');
    if (body) body.style.display = 'none';
});
</script>
</div>
{% endif %}