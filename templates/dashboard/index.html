{% extends "base.html" %}

{% block title %}Dashboard - {{ super() }}{% endblock %}

{% block head %}
    <!-- Chart.js for premium data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    
    <!-- Core Dashboard CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/design-tokens.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/typography.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    
    <!-- Feather Icons loaded via base.html -->
{% endblock %}

{% block content %}
    <div class="dashboard-layout">
        <!-- Premium Dashboard Header with Glass Effect -->
        <div class="dashboard-header">
            <div class="header-content">
                <h1 class="dashboard-title">
                    <i class="fas fa-tachometer-alt me-3"></i>
                    Dashboard
                </h1>
                <p class="dashboard-subtitle">Real-time meeting insights and transcription analytics</p>
            </div>
            <button class="btn btn-primary" id="refresh-dashboard">
                <i class="fas fa-sync-alt me-2"></i>
                Refresh Data
            </button>
        </div>

        <!-- Premium Stats Grid with Interactive Cards -->
        <div class="stats-grid">
            <div class="stat-card" data-stat="active-sessions">
                <div class="stat-card-content">
                    <div class="stat-value" id="active-sessions">0</div>
                    <div class="stat-label">
                        <i class="fas fa-microphone stat-icon"></i>
                        Active Sessions
                    </div>
                </div>
            </div>
            
            <div class="stat-card" data-stat="total-hours">
                <div class="stat-card-content">
                    <div class="stat-value" id="total-hours">0</div>
                    <div class="stat-label">
                        <i class="fas fa-clock stat-icon"></i>
                        Hours Recorded
                    </div>
                </div>
            </div>
            
            <div class="stat-card" data-stat="success-rate">
                <div class="stat-card-content">
                    <div class="stat-value" id="success-rate">0%</div>
                    <div class="stat-label">
                        <i class="fas fa-chart-line stat-icon"></i>
                        Success Rate
                    </div>
                </div>
            </div>
            
            <div class="stat-card" data-stat="avg-confidence">
                <div class="stat-card-content">
                    <div class="stat-value" id="avg-confidence">0%</div>
                    <div class="stat-label">
                        <i class="fas fa-star stat-icon"></i>
                        Avg Confidence
                    </div>
                </div>
            </div>
        </div>

        <!-- Premium Content Grid Layout -->
        <div class="content-grid">
            <!-- Main Content Section -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Quick Actions</h2>
                    <button class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-expand-alt me-1"></i>
                        View All
                    </button>
                </div>
                <div class="section-content">
                    <div class="action-grid">
                        <a href="/live" class="btn btn-primary mb-3 d-flex align-items-center">
                            <i class="fas fa-circle text-danger me-3"></i>
                            <div>
                                <div class="fw-semibold">Start Live Recording</div>
                                <small class="opacity-75">Begin a new transcription session</small>
                            </div>
                        </a>
                        
                        <a href="{{ url_for('dashboard.meetings') }}" class="btn btn-outline-secondary mb-3 d-flex align-items-center">
                            <i class="fas fa-users me-3"></i>
                            <div>
                                <div class="fw-semibold">View Meetings</div>
                                <small class="opacity-75">Browse your recorded sessions</small>
                            </div>
                        </a>
                        
                        <a href="{{ url_for('dashboard.analytics') }}" class="btn btn-outline-secondary mb-3 d-flex align-items-center">
                            <i class="fas fa-chart-bar me-3"></i>
                            <div>
                                <div class="fw-semibold">Analytics</div>
                                <small class="opacity-75">View detailed insights</small>
                            </div>
                        </a>
                        
                        <a href="/settings" class="btn btn-outline-secondary d-flex align-items-center">
                            <i class="fas fa-cog me-3"></i>
                            <div>
                                <div class="fw-semibold">Settings</div>
                                <small class="opacity-75">Configure your preferences</small>
                            </div>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Sidebar Content Section -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">System Status</h2>
                    <span class="status-live">
                        <i class="fas fa-circle"></i>
                        Live
                    </span>
                </div>
                <div class="section-content">
                    <div class="status-item mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Transcription Service</span>
                            <span class="status-completed">Active</span>
                        </div>
                    </div>
                    <div class="status-item mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>WebSocket Connection</span>
                            <span class="status-completed">Connected</span>
                        </div>
                    </div>
                    <div class="status-item mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>AI Processing</span>
                            <span class="status-completed">Ready</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity Section -->
        <div class="content-section mt-4">
            <div class="section-header">
                <h2 class="section-title">Recent Activity</h2>
                <a href="{{ url_for('dashboard.meetings') }}" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-history me-1"></i>
                    View All
                </a>
            </div>
            <div class="section-content">
                <div class="activity-list" id="recent-activity">
                    <div class="d-flex align-items-center justify-content-center py-5">
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin fa-2x mb-3 text-muted"></i>
                            <p class="text-muted">Loading recent activity...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        // Note: Using Font Awesome icons consistently - no initialization needed
        
        class MinaDashboard {
            constructor() {
                this.init();
            }
            
            init() {
                this.loadStats();
                this.loadRecentActivity();
                this.setupRefreshButton();
            }
            
            async loadStats() {
                try {
                    const response = await fetch('/api/analytics/trends?days=30');
                    const data = await response.json();
                    
                    if (data.success) {
                        this.updateStatsDisplay(data.trends);
                    }
                } catch (error) {
                    console.error('Failed to load dashboard stats:', error);
                }
            }
            
            updateStatsDisplay(stats) {
                // Update active sessions
                const activeSessions = stats.meetings?.total || 0;
                this.animateValue(document.getElementById('active-sessions'), 0, activeSessions);
                
                // Update total hours
                const totalHours = stats.transcription_hours?.total || 0;
                this.animateValue(document.getElementById('total-hours'), 0, totalHours);
                
                // Update success rate
                const successRate = stats.success_rate?.total || 0;
                this.animateValue(document.getElementById('success-rate'), 0, successRate, '%');
                
                // Update average confidence
                const avgConfidence = stats.avg_confidence?.total || 0;
                this.animateValue(document.getElementById('avg-confidence'), 0, avgConfidence, '%');
            }
            
            animateValue(element, start, end, suffix = '') {
                if (!element) return;
                
                const duration = 1000;
                const range = end - start;
                const increment = range / (duration / 16);
                let current = start;
                
                const timer = setInterval(() => {
                    current += increment;
                    if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                        current = end;
                        clearInterval(timer);
                    }
                    element.textContent = Math.round(current) + suffix;
                }, 16);
            }
            
            async loadRecentActivity() {
                try {
                    // Load recent sessions as activity from real API
                    const activityContainer = document.getElementById('recent-activity');
                    
                    // Fetch real recent sessions from backend
                    const response = await fetch('/api/meetings?limit=5');
                    const data = await response.json();
                    
                    if (data.success && data.meetings && data.meetings.length > 0) {
                        const activities = data.meetings.map(session => ({
                            type: 'session',
                            title: session.title || `Session ${session.session_id?.substring(0, 8)}`,
                            time: this.formatRelativeTime(session.created_at || session.start_time),
                            status: session.status || 'completed',
                            duration: session.duration_seconds ? `${Math.round(session.duration_seconds / 60)}min` : ''
                        }));
                        
                        // SECURITY: Build DOM nodes safely to prevent XSS instead of using innerHTML
                        activityContainer.innerHTML = ''; // Clear container
                        activities.forEach(activity => {
                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'activity-item';
                            
                            const iconDiv = document.createElement('div');
                            iconDiv.className = 'activity-icon';
                            iconDiv.innerHTML = '<i class="fas fa-microphone"></i>';
                            
                            const contentDiv = document.createElement('div');
                            contentDiv.className = 'activity-content';
                            
                            const titleH4 = document.createElement('h4');
                            titleH4.textContent = activity.title; // Safe: textContent prevents XSS
                            
                            const metaP = document.createElement('p');
                            metaP.textContent = `${activity.time} • ${activity.status}${activity.duration ? ` • ${activity.duration}` : ''}`; // Safe: textContent prevents XSS
                            
                            contentDiv.appendChild(titleH4);
                            contentDiv.appendChild(metaP);
                            itemDiv.appendChild(iconDiv);
                            itemDiv.appendChild(contentDiv);
                            activityContainer.appendChild(itemDiv);
                        });
                    } else {
                        // Show empty state when no sessions - build DOM safely
                        activityContainer.innerHTML = ''; // Clear container
                        const emptyDiv = document.createElement('div');
                        emptyDiv.className = 'activity-item';
                        
                        const emptyIconDiv = document.createElement('div');
                        emptyIconDiv.className = 'activity-icon';
                        emptyIconDiv.innerHTML = '<i class="fas fa-info-circle"></i>';
                        
                        const emptyContentDiv = document.createElement('div');
                        emptyContentDiv.className = 'activity-content';
                        
                        const emptyTitleH4 = document.createElement('h4');
                        emptyTitleH4.textContent = 'No recent activity';
                        
                        const emptyDescP = document.createElement('p');
                        emptyDescP.textContent = 'Start your first recording session to see activity here';
                        
                        emptyContentDiv.appendChild(emptyTitleH4);
                        emptyContentDiv.appendChild(emptyDescP);
                        emptyDiv.appendChild(emptyIconDiv);
                        emptyDiv.appendChild(emptyContentDiv);
                        activityContainer.appendChild(emptyDiv);
                    }
                } catch (error) {
                    console.error('Failed to load recent activity:', error);
                    // Show error state - build DOM safely
                    const activityContainer = document.getElementById('recent-activity');
                    activityContainer.innerHTML = ''; // Clear container
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'activity-item';
                    
                    const errorIconDiv = document.createElement('div');
                    errorIconDiv.className = 'activity-icon';
                    errorIconDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                    
                    const errorContentDiv = document.createElement('div');
                    errorContentDiv.className = 'activity-content';
                    
                    const errorTitleH4 = document.createElement('h4');
                    errorTitleH4.textContent = 'Unable to load recent activity';
                    
                    const errorDescP = document.createElement('p');
                    errorDescP.textContent = 'Please try refreshing the page';
                    
                    errorContentDiv.appendChild(errorTitleH4);
                    errorContentDiv.appendChild(errorDescP);
                    errorDiv.appendChild(errorIconDiv);
                    errorDiv.appendChild(errorContentDiv);
                    activityContainer.appendChild(errorDiv);
                }
            }
            
            // Helper function to format relative time
            formatRelativeTime(timestamp) {
                if (!timestamp) return 'Unknown time';
                
                const now = new Date();
                const time = new Date(timestamp);
                const diffInSeconds = Math.floor((now - time) / 1000);
                
                if (diffInSeconds < 60) {
                    return 'Just now';
                } else if (diffInSeconds < 3600) {
                    const minutes = Math.floor(diffInSeconds / 60);
                    return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
                } else if (diffInSeconds < 86400) {
                    const hours = Math.floor(diffInSeconds / 3600);
                    return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
                } else {
                    const days = Math.floor(diffInSeconds / 86400);
                    return `${days} day${days !== 1 ? 's' : ''} ago`;
                }
            }
            
            setupRefreshButton() {
                const refreshBtn = document.getElementById('refresh-dashboard');
                refreshBtn?.addEventListener('click', () => {
                    refreshBtn.style.transform = 'rotate(360deg)';
                    setTimeout(() => {
                        refreshBtn.style.transform = 'rotate(0deg)';
                    }, 500);
                    
                    this.loadStats();
                    this.loadRecentActivity();
                });
            }
        }

        // Initialize dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new MinaDashboard();
        });
    </script>
{% endblock %}