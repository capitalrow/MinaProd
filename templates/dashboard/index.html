{% extends "base.html" %}

{% block title %}Dashboard - {{ super() }}{% endblock %}

{% block head %}
    <!-- Chart.js for premium data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    
    <!-- Core Dashboard CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/design-tokens.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/typography.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    
    <!-- Feather Icons loaded via base.html -->
{% endblock %}

{% block content %}
    <div class="dashboard-layout">
        <!-- Premium Dashboard Header with Glass Effect -->
        <div class="dashboard-header">
            <div class="header-content">
                <h1 class="dashboard-title">
                    <i class="fas fa-tachometer-alt me-3"></i>
                    Dashboard
                </h1>
                <p class="dashboard-subtitle">Real-time meeting insights and transcription analytics</p>
            </div>
            <button class="btn btn-primary" id="refresh-dashboard">
                <i class="fas fa-sync-alt me-2"></i>
                Refresh Data
            </button>
        </div>

        <!-- Premium Stats Grid with Interactive Cards -->
        <div class="stats-grid">
            <div class="stat-card" data-stat="active-sessions">
                <div class="stat-card-content">
                    <div class="stat-value" id="active-sessions">0</div>
                    <div class="stat-label">
                        <i class="fas fa-microphone stat-icon"></i>
                        Active Sessions
                    </div>
                </div>
            </div>
            
            <div class="stat-card" data-stat="total-hours">
                <div class="stat-card-content">
                    <div class="stat-value" id="total-hours">0</div>
                    <div class="stat-label">
                        <i class="fas fa-clock stat-icon"></i>
                        Hours Recorded
                    </div>
                </div>
            </div>
            
            <div class="stat-card" data-stat="success-rate">
                <div class="stat-card-content">
                    <div class="stat-value" id="success-rate">0%</div>
                    <div class="stat-label">
                        <i class="fas fa-chart-line stat-icon"></i>
                        Success Rate
                    </div>
                </div>
            </div>
            
            <div class="stat-card" data-stat="avg-confidence">
                <div class="stat-card-content">
                    <div class="stat-value" id="avg-confidence">0%</div>
                    <div class="stat-label">
                        <i class="fas fa-star stat-icon"></i>
                        Avg Confidence
                    </div>
                </div>
            </div>
        </div>

        <!-- Premium Content Grid Layout -->
        <div class="content-grid">
            <!-- Main Content Section -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Quick Actions</h2>
                    <button class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-expand-alt me-1"></i>
                        View All
                    </button>
                </div>
                <div class="section-content">
                    <div class="action-grid">
                        <a href="/live" class="btn btn-primary mb-3 d-flex align-items-center">
                            <i class="fas fa-circle text-danger me-3"></i>
                            <div>
                                <div class="fw-semibold">Start Live Recording</div>
                                <small class="opacity-75">Begin a new transcription session</small>
                            </div>
                        </a>
                        
                        <a href="{{ url_for('dashboard.meetings') }}" class="btn btn-outline-secondary mb-3 d-flex align-items-center">
                            <i class="fas fa-users me-3"></i>
                            <div>
                                <div class="fw-semibold">View Meetings</div>
                                <small class="opacity-75">Browse your recorded sessions</small>
                            </div>
                        </a>
                        
                        <a href="{{ url_for('dashboard.analytics') }}" class="btn btn-outline-secondary mb-3 d-flex align-items-center">
                            <i class="fas fa-chart-bar me-3"></i>
                            <div>
                                <div class="fw-semibold">Analytics</div>
                                <small class="opacity-75">View detailed insights</small>
                            </div>
                        </a>
                        
                        <a href="/settings" class="btn btn-outline-secondary d-flex align-items-center">
                            <i class="fas fa-cog me-3"></i>
                            <div>
                                <div class="fw-semibold">Settings</div>
                                <small class="opacity-75">Configure your preferences</small>
                            </div>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Sidebar Content Section -->
            <div class="content-section">
                <div class="section-header">
                    <h2 class="section-title">System Status</h2>
                    <span class="status-live">
                        <i class="fas fa-circle"></i>
                        Live
                    </span>
                </div>
                <div class="section-content">
                    <div class="status-item mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Transcription Service</span>
                            <span class="status-completed">Active</span>
                        </div>
                    </div>
                    <div class="status-item mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>WebSocket Connection</span>
                            <span class="status-completed">Connected</span>
                        </div>
                    </div>
                    <div class="status-item mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>AI Processing</span>
                            <span class="status-completed">Ready</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity Section -->
        <div class="content-section mt-4">
            <div class="section-header">
                <h2 class="section-title">Recent Activity</h2>
                <a href="{{ url_for('dashboard.meetings') }}" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-history me-1"></i>
                    View All
                </a>
            </div>
            <div class="section-content">
                <div class="activity-list" id="recent-activity">
                    <div class="d-flex align-items-center justify-content-center py-5">
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin fa-2x mb-3 text-muted"></i>
                            <p class="text-muted">Loading recent activity...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        // Initialize Feather icons
        feather.replace();
        
        class MinaDashboard {
            constructor() {
                this.init();
            }
            
            init() {
                this.loadStats();
                this.loadRecentActivity();
                this.setupRefreshButton();
            }
            
            async loadStats() {
                try {
                    const response = await fetch('/api/analytics/trends?days=30');
                    const data = await response.json();
                    
                    if (data.success) {
                        this.updateStatsDisplay(data.trends);
                    }
                } catch (error) {
                    console.error('Failed to load dashboard stats:', error);
                }
            }
            
            updateStatsDisplay(stats) {
                // Update active sessions
                const activeSessions = stats.meetings?.total || 0;
                this.animateValue(document.getElementById('active-sessions'), 0, activeSessions);
                
                // Update total hours
                const totalHours = stats.transcription_hours?.total || 0;
                this.animateValue(document.getElementById('total-hours'), 0, totalHours);
                
                // Update success rate
                const successRate = stats.success_rate?.total || 0;
                this.animateValue(document.getElementById('success-rate'), 0, successRate, '%');
                
                // Update average confidence
                const avgConfidence = stats.avg_confidence?.total || 0;
                this.animateValue(document.getElementById('avg-confidence'), 0, avgConfidence, '%');
            }
            
            animateValue(element, start, end, suffix = '') {
                if (!element) return;
                
                const duration = 1000;
                const range = end - start;
                const increment = range / (duration / 16);
                let current = start;
                
                const timer = setInterval(() => {
                    current += increment;
                    if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                        current = end;
                        clearInterval(timer);
                    }
                    element.textContent = Math.round(current) + suffix;
                }, 16);
            }
            
            async loadRecentActivity() {
                try {
                    // Load recent sessions as activity
                    const activityContainer = document.getElementById('recent-activity');
                    
                    // Mock recent activity for now
                    const activities = [
                        { type: 'session', title: 'Morning Standup', time: '2 hours ago', status: 'completed' },
                        { type: 'session', title: 'Client Review', time: '4 hours ago', status: 'completed' },
                        { type: 'session', title: 'Team Planning', time: '1 day ago', status: 'completed' }
                    ];
                    
                    activityContainer.innerHTML = activities.map(activity => `
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class="fas fa-microphone"></i>
                            </div>
                            <div class="activity-content">
                                <h4>${activity.title}</h4>
                                <p>${activity.time} â€¢ ${activity.status}</p>
                            </div>
                        </div>
                    `).join('');
                } catch (error) {
                    console.error('Failed to load recent activity:', error);
                }
            }
            
            setupRefreshButton() {
                const refreshBtn = document.getElementById('refresh-dashboard');
                refreshBtn?.addEventListener('click', () => {
                    refreshBtn.style.transform = 'rotate(360deg)';
                    setTimeout(() => {
                        refreshBtn.style.transform = 'rotate(0deg)';
                    }, 500);
                    
                    this.loadStats();
                    this.loadRecentActivity();
                });
            }
        }

        // Initialize dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new MinaDashboard();
        });
    </script>
{% endblock %}