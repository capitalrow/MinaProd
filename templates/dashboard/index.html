{% extends "base.html" %}

{% block title %}Dashboard - {{ super() }}{% endblock %}

{% block head %}
    <!-- Chart.js for premium data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    
    <!-- Core Dashboard CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/design-tokens.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/typography.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    
    <script src="https://unpkg.com/feather-icons"></script>
{% endblock %}

{% block content %}
    <div class="main-content">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div class="header-content">
                <h1 class="dashboard-title">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </h1>
                <button class="btn btn-primary" id="refresh-dashboard">
                    <i class="fas fa-sync-alt"></i>
                    Refresh
                </button>
            </div>
        </div>

        <!-- Dashboard Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-microphone"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-number" id="active-sessions">0</h3>
                    <p class="stat-label">Active Sessions</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-number" id="total-hours">0</h3>
                    <p class="stat-label">Hours Recorded</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-number" id="success-rate">0%</h3>
                    <p class="stat-label">Success Rate</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-star"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-number" id="avg-confidence">0%</h3>
                    <p class="stat-label">Avg Confidence</p>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="dashboard-section">
            <h2 class="section-title">Quick Actions</h2>
            <div class="action-grid">
                <a href="/live" class="action-card primary">
                    <div class="action-icon">
                        <i class="fas fa-circle text-danger"></i>
                    </div>
                    <div class="action-content">
                        <h3>Start Live Recording</h3>
                        <p>Begin a new transcription session</p>
                    </div>
                </a>
                
                <a href="{{ url_for('dashboard.meetings') }}" class="action-card">
                    <div class="action-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="action-content">
                        <h3>View Meetings</h3>
                        <p>Browse your recorded sessions</p>
                    </div>
                </a>
                
                <a href="{{ url_for('dashboard.analytics') }}" class="action-card">
                    <div class="action-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <div class="action-content">
                        <h3>Analytics</h3>
                        <p>View detailed insights</p>
                    </div>
                </a>
                
                <a href="/settings" class="action-card">
                    <div class="action-icon">
                        <i class="fas fa-cog"></i>
                    </div>
                    <div class="action-content">
                        <h3>Settings</h3>
                        <p>Configure your preferences</p>
                    </div>
                </a>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="dashboard-section">
            <h2 class="section-title">Recent Activity</h2>
            <div class="activity-list" id="recent-activity">
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading recent activity...</p>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        // Initialize Feather icons
        feather.replace();
        
        class MinaDashboard {
            constructor() {
                this.init();
            }
            
            init() {
                this.loadStats();
                this.loadRecentActivity();
                this.setupRefreshButton();
            }
            
            async loadStats() {
                try {
                    const response = await fetch('/api/analytics/trends?days=30');
                    const data = await response.json();
                    
                    if (data.success) {
                        this.updateStatsDisplay(data.trends);
                    }
                } catch (error) {
                    console.error('Failed to load dashboard stats:', error);
                }
            }
            
            updateStatsDisplay(stats) {
                // Update active sessions
                const activeSessions = stats.meetings?.total || 0;
                this.animateValue(document.getElementById('active-sessions'), 0, activeSessions);
                
                // Update total hours
                const totalHours = stats.transcription_hours?.total || 0;
                this.animateValue(document.getElementById('total-hours'), 0, totalHours);
                
                // Update success rate
                const successRate = stats.success_rate?.total || 0;
                this.animateValue(document.getElementById('success-rate'), 0, successRate, '%');
                
                // Update average confidence
                const avgConfidence = stats.avg_confidence?.total || 0;
                this.animateValue(document.getElementById('avg-confidence'), 0, avgConfidence, '%');
            }
            
            animateValue(element, start, end, suffix = '') {
                if (!element) return;
                
                const duration = 1000;
                const range = end - start;
                const increment = range / (duration / 16);
                let current = start;
                
                const timer = setInterval(() => {
                    current += increment;
                    if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                        current = end;
                        clearInterval(timer);
                    }
                    element.textContent = Math.round(current) + suffix;
                }, 16);
            }
            
            async loadRecentActivity() {
                try {
                    // Load recent sessions as activity
                    const activityContainer = document.getElementById('recent-activity');
                    
                    // Mock recent activity for now
                    const activities = [
                        { type: 'session', title: 'Morning Standup', time: '2 hours ago', status: 'completed' },
                        { type: 'session', title: 'Client Review', time: '4 hours ago', status: 'completed' },
                        { type: 'session', title: 'Team Planning', time: '1 day ago', status: 'completed' }
                    ];
                    
                    activityContainer.innerHTML = activities.map(activity => `
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class="fas fa-microphone"></i>
                            </div>
                            <div class="activity-content">
                                <h4>${activity.title}</h4>
                                <p>${activity.time} â€¢ ${activity.status}</p>
                            </div>
                        </div>
                    `).join('');
                } catch (error) {
                    console.error('Failed to load recent activity:', error);
                }
            }
            
            setupRefreshButton() {
                const refreshBtn = document.getElementById('refresh-dashboard');
                refreshBtn?.addEventListener('click', () => {
                    refreshBtn.style.transform = 'rotate(360deg)';
                    setTimeout(() => {
                        refreshBtn.style.transform = 'rotate(0deg)';
                    }, 500);
                    
                    this.loadStats();
                    this.loadRecentActivity();
                });
            }
        }

        // Initialize dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new MinaDashboard();
        });
    </script>
{% endblock %}