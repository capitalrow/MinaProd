{% extends "base.html" %}

{% block title %}Dashboard - Mina{% endblock %}

{% block extra_css %}
<style>
.dashboard-container {
    min-height: calc(100vh - var(--header-height));
    padding: var(--space-8) 0;
}

.dashboard-header {
    margin-bottom: var(--space-8);
    animation: fadeInUp 0.6s ease-out;
}

.welcome-title {
    font-size: var(--font-size-4xl);
    font-weight: var(--font-weight-bold);
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: var(--space-2);
}

.welcome-subtitle {
    color: var(--color-text-secondary);
    font-size: var(--font-size-lg);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--space-6);
    margin-bottom: var(--space-8);
}

.stat-card {
    background: var(--glass-bg);
    backdrop-filter: var(--backdrop-blur);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-2xl);
    padding: var(--space-6);
    transition: all var(--transition-base);
    position: relative;
    overflow: hidden;
    animation: fadeInUp 0.6s ease-out;
    animation-fill-mode: both;
}

.stat-card:nth-child(1) { animation-delay: 0.1s; }
.stat-card:nth-child(2) { animation-delay: 0.2s; }
.stat-card:nth-child(3) { animation-delay: 0.3s; }

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--gradient-primary);
    opacity: 0;
    transition: opacity var(--transition-base);
}

.stat-card:hover {
    transform: translateY(-4px);
    border-color: var(--color-primary);
}

.stat-card:hover::before {
    opacity: 1;
}

.stat-icon {
    width: 64px;
    height: 64px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-xl);
    margin-bottom: var(--space-4);
    position: relative;
    overflow: hidden;
}

.stat-icon::before {
    content: '';
    position: absolute;
    inset: 0;
    background: inherit;
    opacity: 0.1;
    filter: blur(20px);
}

.stat-content {
    position: relative;
}

.stat-label {
    font-size: var(--font-size-sm);
    color: var(--color-text-tertiary);
    font-weight: var(--font-weight-medium);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-2);
}

.stat-value {
    font-size: var(--font-size-4xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-text-primary);
    line-height: 1;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-6);
    animation: fadeInUp 0.6s ease-out 0.4s;
    animation-fill-mode: both;
}

.section-title {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
}

.section-link {
    color: var(--color-primary);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: var(--space-1);
    transition: gap var(--transition-base);
}

.section-link:hover {
    gap: var(--space-2);
}

.meetings-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
}

.meeting-card {
    background: var(--glass-bg);
    backdrop-filter: var(--backdrop-blur);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-xl);
    padding: var(--space-6);
    transition: all var(--transition-base);
    cursor: pointer;
    position: relative;
    overflow: hidden;
    animation: fadeInUp 0.6s ease-out;
    animation-fill-mode: both;
}

.meeting-card:nth-child(1) { animation-delay: 0.5s; }
.meeting-card:nth-child(2) { animation-delay: 0.6s; }
.meeting-card:nth-child(3) { animation-delay: 0.7s; }

.meeting-card::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: var(--gradient-primary);
    opacity: 0;
    transition: opacity var(--transition-base);
}

.meeting-card:hover {
    transform: translateX(8px);
    border-color: var(--color-primary);
}

.meeting-card:hover::before {
    opacity: 1;
}

.meeting-title {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
    margin-bottom: var(--space-2);
}

.meeting-date {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-3);
}

.meeting-summary {
    font-size: var(--font-size-sm);
    color: var(--color-text-tertiary);
    line-height: var(--line-height-relaxed);
}

.empty-state {
    background: var(--glass-bg);
    backdrop-filter: var(--backdrop-blur);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-2xl);
    padding: var(--space-12);
    text-align: center;
    animation: fadeInUp 0.6s ease-out 0.5s;
    animation-fill-mode: both;
}

.empty-state-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto var(--space-6);
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--glass-bg);
    border-radius: var(--radius-full);
    border: 2px solid var(--glass-border);
}

.empty-state-title {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
    margin-bottom: var(--space-2);
}

.empty-state-description {
    font-size: var(--font-size-base);
    color: var(--color-text-tertiary);
    margin-bottom: var(--space-6);
}

.tasks-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    margin-top: var(--space-6);
}

.task-card {
    background: var(--glass-bg);
    backdrop-filter: var(--backdrop-blur);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
    transition: all var(--transition-base);
    animation: fadeInUp 0.6s ease-out;
    animation-fill-mode: both;
}

.task-card:nth-child(1) { animation-delay: 0.5s; }
.task-card:nth-child(2) { animation-delay: 0.6s; }
.task-card:nth-child(3) { animation-delay: 0.7s; }
.task-card:nth-child(4) { animation-delay: 0.8s; }
.task-card:nth-child(5) { animation-delay: 0.9s; }

.task-card:hover {
    border-color: var(--color-primary);
    transform: translateX(4px);
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .welcome-title {
        font-size: var(--font-size-3xl);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container dashboard-container">
    <div class="dashboard-header">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="welcome-title">Welcome back, {{ current_user.username }}!</h1>
                <p class="welcome-subtitle">Here's what's happening with your meetings</p>
            </div>
            <a href="{{ url_for('pages.live') }}" class="btn btn-primary">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                </svg>
                Start Recording
            </a>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon" style="background: var(--gradient-primary);">
                <svg width="32" height="32" fill="white" viewBox="0 0 24 24">
                    <path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
            </div>
            <div class="stat-content">
                <p class="stat-label">Total Meetings</p>
                <p class="stat-value">{{ total_meetings|default(0) }}</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon" style="background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);">
                <svg width="32" height="32" fill="none" stroke="white" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                </svg>
            </div>
            <div class="stat-content">
                <p class="stat-label">Action Items</p>
                <p class="stat-value">{{ total_tasks|default(0) }}</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);">
                <svg width="32" height="32" fill="none" stroke="white" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
            </div>
            <div class="stat-content">
                <p class="stat-label">Hours Saved</p>
                <p class="stat-value">{{ hours_saved|default(0) }}</p>
            </div>
        </div>
    </div>

    <div class="section-header">
        <h2 class="section-title">Recent Meetings</h2>
        <a href="{{ url_for('dashboard.meetings') }}" class="section-link">
            View all
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
        </a>
    </div>

    {% if recent_meetings and recent_meetings|length > 0 %}
    <div class="meetings-list">
        {% for meeting in recent_meetings %}
        <div class="meeting-card" 
             data-meeting-id="{{ meeting.id }}" 
             data-meeting-title="{{ meeting.title or 'Untitled Meeting' }}"
             {% if meeting.session and meeting.session.external_id %}data-session-id="{{ meeting.session.external_id }}"{% endif %}>
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <h3 class="meeting-title">{{ meeting.title or 'Untitled Meeting' }}</h3>
                    <p class="meeting-date">{{ meeting.created_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
                    {% if meeting.summary %}
                    <p class="meeting-summary">{{ meeting.summary[:150] }}{% if meeting.summary|length > 150 %}...{% endif %}</p>
                    {% endif %}
                </div>
                <div class="flex items-center gap-3">
                    {% if meeting.duration %}
                    <span class="badge badge-primary">{{ (meeting.duration / 60)|round|int }} min</span>
                    {% endif %}
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="opacity: 0.5;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">
            <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
        </div>
        <h3 class="empty-state-title">No meetings yet</h3>
        <p class="empty-state-description">Start recording your first meeting to see it here</p>
        <a href="{{ url_for('pages.live') }}" class="btn btn-primary">Start Recording</a>
    </div>
    {% endif %}

    {% if user_tasks and user_tasks|length > 0 %}
    <div style="margin-top: var(--space-8);">
        <div class="section-header" style="animation-delay: 0.8s;">
            <h2 class="section-title">Your Tasks</h2>
            <a href="{{ url_for('dashboard.tasks') }}" class="section-link">
                View all
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </a>
        </div>

        <div class="tasks-list">
            {% for task in user_tasks[:5] %}
            <div class="task-card">
                <div class="flex items-center gap-3">
                    <input type="checkbox" class="checkbox" {% if task.status == 'completed' %}checked{% endif %}>
                    <div class="flex-1">
                        <p class="font-medium {% if task.status == 'completed' %}text-tertiary{% endif %}">{{ task.description }}</p>
                        {% if task.meeting %}
                        <p class="text-tertiary text-xs mt-1">From: {{ task.meeting.title or 'Untitled Meeting' }}</p>
                        {% endif %}
                    </div>
                    {% if task.priority %}
                    <span class="badge badge-{% if task.priority == 'high' %}error{% elif task.priority == 'medium' %}warning{% else %}primary{% endif %}">
                        {{ task.priority }}
                    </span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
/**
 * Dashboard Real-time WebSocket Integration
 * CROWNâ´ Event Handling for Live Updates
 */

(function() {
    'use strict';
    
    // Get workspace ID from user context
    const WORKSPACE_ID = {{ current_user.workspace_id }};
    
    // Cache DOM elements
    const statElements = {
        totalMeetings: document.querySelector('.stat-card:nth-child(1) .stat-value'),
        actionItems: document.querySelector('.stat-card:nth-child(2) .stat-value'),
        hoursSaved: document.querySelector('.stat-card:nth-child(3) .stat-value')
    };
    
    const meetingsListEl = document.querySelector('.meetings-list');
    const emptyStateEl = document.querySelector('.empty-state');
    
    /**
     * Initialize WebSocket connection
     */
    function initWebSocket() {
        console.log('ðŸš€ Initializing dashboard WebSocket...');
        
        // Initialize WebSocket manager with dashboard namespace
        window.wsManager.init(WORKSPACE_ID, ['dashboard']);
        
        // Listen for connection status changes
        window.wsManager.on('connection_status', (data) => {
            if (data.connected && data.namespace === 'dashboard') {
                console.log('âœ… Dashboard connected to real-time updates');
                showConnectionStatus('connected');
            } else {
                console.warn('âš ï¸ Dashboard disconnected from real-time updates');
                showConnectionStatus('disconnected');
            }
        });
        
        // Listen for session_update:created events
        window.wsManager.on('session_update:created', handleNewSession);
        
        // Listen for dashboard_refresh events
        window.wsManager.on('dashboard_refresh', handleDashboardRefresh);
        
        // Listen for task_update events (for action items counter)
        window.wsManager.on('task_update', handleTaskUpdate);
        
        console.log('ðŸ“¡ Dashboard WebSocket listeners registered');
    }
    
    /**
     * Handle new session created event
     * @param {Object} data - Event data containing session/meeting info
     */
    function handleNewSession(data) {
        console.log('ðŸ“¬ New session created event received:', data);
        
        const sessionData = data.data || data;
        
        // Update total meetings counter with animation
        updateCounter(statElements.totalMeetings, 1, 'increment');
        
        // Insert new meeting card at top of list
        insertMeetingCard(sessionData);
        
        // Remove empty state if present
        if (emptyStateEl) {
            emptyStateEl.style.opacity = '0';
            setTimeout(() => {
                emptyStateEl.style.display = 'none';
            }, 300);
        }
        
        // Show notification
        showNotification('New meeting recorded', 'A new meeting has been added to your dashboard');
    }
    
    /**
     * Handle dashboard refresh event
     * @param {Object} data - Event data with updated statistics
     */
    function handleDashboardRefresh(data) {
        console.log('ðŸ”„ Dashboard refresh event received:', data);
        
        const stats = data.data || data;
        
        // Update all counters
        if (stats.total_meetings !== undefined) {
            updateCounter(statElements.totalMeetings, stats.total_meetings, 'set');
        }
        if (stats.total_tasks !== undefined) {
            updateCounter(statElements.actionItems, stats.total_tasks, 'set');
        }
        if (stats.hours_saved !== undefined) {
            updateCounter(statElements.hoursSaved, stats.hours_saved, 'set');
        }
    }
    
    /**
     * Handle task update event
     * @param {Object} data - Event data with task information
     */
    function handleTaskUpdate(data) {
        console.log('âœ… Task update event received:', data);
        
        const taskData = data.data || data;
        
        // Update action items counter based on task action
        if (taskData.action === 'created') {
            updateCounter(statElements.actionItems, 1, 'increment');
        } else if (taskData.action === 'deleted') {
            updateCounter(statElements.actionItems, -1, 'increment');
        }
    }
    
    /**
     * Update counter with animation
     * @param {HTMLElement} element - Counter element
     * @param {number} value - New value or increment/decrement amount
     * @param {string} mode - 'set', 'increment', or 'decrement'
     */
    function updateCounter(element, value, mode = 'set') {
        if (!element) return;
        
        const currentValue = parseInt(element.textContent) || 0;
        let newValue;
        
        if (mode === 'set') {
            newValue = value;
        } else if (mode === 'increment') {
            newValue = currentValue + value;
        } else if (mode === 'decrement') {
            newValue = currentValue - value;
        }
        
        // Add shimmer animation
        element.parentElement.parentElement.classList.add('stat-card-shimmer');
        
        // Animate counter change
        animateCounter(element, currentValue, newValue, 500);
        
        // Remove shimmer after animation
        setTimeout(() => {
            element.parentElement.parentElement.classList.remove('stat-card-shimmer');
        }, 1000);
    }
    
    /**
     * Animate counter from current to new value
     * @param {HTMLElement} element - Counter element
     * @param {number} start - Start value
     * @param {number} end - End value
     * @param {number} duration - Animation duration in ms
     */
    function animateCounter(element, start, end, duration) {
        const startTime = Date.now();
        const difference = end - start;
        
        function update() {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            // Easing function (ease-out cubic)
            const eased = 1 - Math.pow(1 - progress, 3);
            const current = Math.round(start + (difference * eased));
            
            element.textContent = current;
            
            if (progress < 1) {
                requestAnimationFrame(update);
            }
        }
        
        update();
    }
    
    /**
     * Insert new meeting card at top of list
     * @param {Object} meetingData - Meeting data from event
     */
    function insertMeetingCard(meetingData) {
        if (!meetingsListEl) {
            // If meetings list doesn't exist, create it
            createMeetingsList();
        }
        
        const meeting = meetingData.meeting || meetingData;
        
        // Create meeting card HTML (with session ID support for morph transitions)
        const sessionId = meeting.session_id || meeting.external_id || null;
        const cardHTML = `
            <div class="meeting-card new-card" 
                 data-meeting-id="${meeting.id}" 
                 data-meeting-title="${escapeHtml(meeting.title || 'Untitled Meeting')}"
                 ${sessionId ? `data-session-id="${sessionId}"` : ''}
                 style="animation: slideInFromTop 0.5s ease-out;">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h3 class="meeting-title">${escapeHtml(meeting.title || 'Untitled Meeting')}</h3>
                        <p class="meeting-date">${formatDate(meeting.created_at || new Date())}</p>
                        ${meeting.summary ? `<p class="meeting-summary">${escapeHtml(meeting.summary.substring(0, 150))}${meeting.summary.length > 150 ? '...' : ''}</p>` : ''}
                    </div>
                    <div class="flex items-center gap-3">
                        ${meeting.duration ? `<span class="badge badge-primary">${Math.round(meeting.duration / 60)} min</span>` : ''}
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="opacity: 0.5;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </div>
                </div>
            </div>
        `;
        
        // Insert at top of list
        meetingsListEl.insertAdjacentHTML('afterbegin', cardHTML);
        
        // Get the newly inserted card and attach event listeners
        const newCard = meetingsListEl.querySelector('.new-card');
        if (newCard) {
            // Attach click handler for morph transition
            newCard.addEventListener('click', handleCardClick);
            // Attach hover handler for prefetch
            newCard.addEventListener('mouseenter', handleCardHover);
            newCard.style.cursor = 'pointer';
            
            // Remove new-card class after animation
            setTimeout(() => {
                newCard.classList.remove('new-card');
            }, 500);
        }
    }
    
    /**
     * Create meetings list if it doesn't exist
     */
    function createMeetingsList() {
        const container = document.querySelector('.dashboard-container');
        const sectionHeader = document.querySelector('.section-header');
        
        if (sectionHeader && !meetingsListEl) {
            const listHTML = '<div class="meetings-list"></div>';
            sectionHeader.insertAdjacentHTML('afterend', listHTML);
            // Update reference
            meetingsListEl = document.querySelector('.meetings-list');
        }
    }
    
    /**
     * Show connection status indicator
     * @param {string} status - 'connected' or 'disconnected'
     */
    function showConnectionStatus(status) {
        // Add visual indicator in navbar or corner
        const indicator = document.createElement('div');
        indicator.className = `connection-indicator ${status}`;
        indicator.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            transition: all 0.3s ease;
            ${status === 'connected' ? 'background: #10b981; color: white;' : 'background: #ef4444; color: white;'}
        `;
        indicator.textContent = status === 'connected' ? 'ðŸŸ¢ Live' : 'ðŸ”´ Offline';
        
        document.body.appendChild(indicator);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
            indicator.style.opacity = '0';
            setTimeout(() => indicator.remove(), 300);
        }, 3000);
    }
    
    /**
     * Show notification toast
     * @param {string} title - Notification title
     * @param {string} message - Notification message
     */
    function showNotification(title, message) {
        const notification = document.createElement('div');
        notification.className = 'notification-toast';
        notification.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            max-width: 400px;
            padding: 16px;
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            animation: slideInFromRight 0.3s ease-out;
        `;
        
        notification.innerHTML = `
            <div style="display: flex; gap: 12px; align-items: start;">
                <div style="flex-shrink: 0; width: 40px; height: 40px; background: var(--gradient-primary); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                    <svg width="20" height="20" fill="white" viewBox="0 0 24 24">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <div style="flex: 1;">
                    <p style="font-weight: 600; margin-bottom: 4px;">${escapeHtml(title)}</p>
                    <p style="font-size: 14px; color: var(--color-text-secondary);">${escapeHtml(message)}</p>
                </div>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            notification.style.animation = 'slideOutToRight 0.3s ease-out';
            setTimeout(() => notification.remove(), 300);
        }, 5000);
    }
    
    /**
     * Format date to readable string
     * @param {string|Date} date - Date to format
     * @returns {string} Formatted date string
     */
    function formatDate(date) {
        const d = new Date(date);
        return d.toLocaleString('en-US', { 
            month: 'long', 
            day: 'numeric', 
            year: 'numeric',
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
        });
    }
    
    /**
     * Escape HTML to prevent XSS
     * @param {string} text - Text to escape
     * @returns {string} Escaped text
     */
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initWebSocket);
    } else {
        initWebSocket();
    }
    
    // Add CSS for new animations
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideInFromTop {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInFromRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideOutToRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(20px);
            }
        }
        
        @keyframes shimmer {
            0% {
                background-position: -200% center;
            }
            100% {
                background-position: 200% center;
            }
        }
        
        .stat-card-shimmer::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            background-size: 200% 100%;
            animation: shimmer 1s ease-in-out;
            pointer-events: none;
        }
    `;
    document.head.appendChild(style);
    
})();

/**
 * Cinematic Morph Transition for Meeting Cards
 * CROWNâ´ UX Requirement: Smooth morphing animation from card to detail view
 */
(function() {
    'use strict';
    
    /**
     * Initialize morph transitions for meeting cards
     */
    function initMorphTransitions() {
        const meetingCards = document.querySelectorAll('.meeting-card');
        
        meetingCards.forEach(card => {
            card.addEventListener('click', handleCardClick);
            card.addEventListener('mouseenter', handleCardHover);
            card.style.cursor = 'pointer';
        });
        
        console.log(`ðŸŽ¬ Initialized morph transitions for ${meetingCards.length} meeting cards`);
    }
    
    /**
     * Handle meeting card hover for session prefetch
     * @param {Event} event - Hover event
     */
    const prefetchedSessions = new Set();
    function handleCardHover(event) {
        const card = event.currentTarget;
        const sessionId = card.dataset.sessionId;
        const meetingTitle = card.dataset.meetingTitle;
        
        // Skip if no session ID (meeting without linked session)
        if (!sessionId) {
            return;
        }
        
        // Skip if already prefetched
        if (prefetchedSessions.has(sessionId)) {
            return;
        }
        
        // Mark as prefetched
        prefetchedSessions.add(sessionId);
        
        console.log('ðŸ”® Prefetching session:', sessionId);
        
        // Broadcast session_prefetch event
        try {
            if (window.wsManager) {
                window.wsManager.emit('session_prefetch', {
                    session_id: sessionId,
                    meeting_title: meetingTitle,
                    timestamp: Date.now()
                });
            }
        } catch (e) {
            console.warn('Failed to broadcast session_prefetch:', e);
        }
        
        // Prefetch session data via fetch (use session detail endpoint)
        fetch(`/sessions/${sessionId}?format=json`)
            .then(response => {
                if (response.ok) {
                    console.log('âœ… Session data prefetched:', sessionId);
                    // Store in sessionStorage for faster loading
                    return response.json();
                }
            })
            .then(data => {
                if (data) {
                    try {
                        sessionStorage.setItem(`session_${sessionId}`, JSON.stringify({
                            data,
                            timestamp: Date.now()
                        }));
                    } catch (e) {
                        console.warn('Failed to cache session data:', e);
                    }
                }
            })
            .catch(err => {
                console.warn('Failed to prefetch session:', err);
            });
    }
    
    /**
     * Handle meeting card click with cinematic morph animation
     * @param {Event} event - Click event
     */
    function handleCardClick(event) {
        event.preventDefault();
        
        const card = event.currentTarget;
        const meetingId = card.dataset.meetingId;
        const meetingTitle = card.dataset.meetingTitle;
        const sessionId = card.dataset.sessionId;
        
        // If no session ID, fallback to legacy meeting detail page without animation
        if (!sessionId) {
            console.log('âš ï¸ No session ID, using legacy meeting detail view for meeting:', meetingId);
            window.location.href = `/dashboard/meeting/${meetingId}`;
            return;
        }
        
        console.log('ðŸŽ¬ Starting morph transition for session:', sessionId);
        
        // Create clone for animation
        const clone = card.cloneNode(true);
        const rect = card.getBoundingClientRect();
        
        // Style clone as fixed overlay
        Object.assign(clone.style, {
            position: 'fixed',
            top: `${rect.top}px`,
            left: `${rect.left}px`,
            width: `${rect.width}px`,
            height: `${rect.height}px`,
            margin: '0',
            zIndex: '9999',
            pointerEvents: 'none'
        });
        
        document.body.appendChild(clone);
        
        // Hide original card
        gsap.to(card, {
            opacity: 0,
            duration: 0.3
        });
        
        // Create overlay backdrop
        const overlay = document.createElement('div');
        Object.assign(overlay.style, {
            position: 'fixed',
            top: '0',
            left: '0',
            right: '0',
            bottom: '0',
            backgroundColor: 'rgba(0, 0, 0, 0)',
            zIndex: '9998',
            pointerEvents: 'none'
        });
        document.body.appendChild(overlay);
        
        // Animate backdrop fade in
        gsap.to(overlay, {
            backgroundColor: 'rgba(0, 0, 0, 0.5)',
            duration: 0.4
        });
        
        // Calculate target dimensions (centered, full-width container)
        const targetWidth = Math.min(window.innerWidth - 64, 1200);
        const targetHeight = window.innerHeight - 128;
        const targetLeft = (window.innerWidth - targetWidth) / 2;
        const targetTop = 64;
        
        // Cinematic morph animation using GSAP
        const timeline = gsap.timeline({
            onComplete: () => {
                // Navigate to refined session view after animation
                window.location.href = `/sessions/${sessionId}/refined`;
            }
        });
        
        timeline
            .to(clone, {
                top: targetTop,
                left: targetLeft,
                width: targetWidth,
                height: targetHeight,
                borderRadius: '24px',
                duration: 0.6,
                ease: 'power3.inOut'
            })
            .to(clone, {
                opacity: 0,
                duration: 0.2
            }, '-=0.1');
        
        // Store transition data for potential use on detail page
        try {
            sessionStorage.setItem('morphTransition', JSON.stringify({
                meetingId,
                meetingTitle,
                fromDashboard: true,
                timestamp: Date.now()
            }));
        } catch (e) {
            console.warn('Failed to store transition data:', e);
        }
    }
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initMorphTransitions);
    } else {
        initMorphTransitions();
    }
    
})();
</script>
{% endblock %}
