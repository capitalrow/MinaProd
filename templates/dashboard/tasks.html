{% extends "base.html" %}

{% block title %}Tasks - Mina{% endblock %}

{% block extra_css %}
<style>
.tasks-container {
    min-height: calc(100vh - var(--header-height));
    padding: var(--space-8) 0;
    max-width: 1200px;
}

.tasks-header {
    margin-bottom: var(--space-6);
    animation: fadeInUp 0.6s ease-out;
}

.tasks-title {
    font-size: var(--font-size-4xl);
    font-weight: var(--font-weight-bold);
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: var(--space-2);
}

.tasks-subtitle {
    color: var(--color-text-secondary);
    font-size: var(--font-size-lg);
}

.task-filters {
    display: flex;
    gap: var(--space-3);
    padding: var(--space-4);
    background: var(--glass-bg);
    backdrop-filter: var(--backdrop-blur);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-xl);
    margin-bottom: var(--space-6);
    animation: fadeInUp 0.6s ease-out 0.1s;
    animation-fill-mode: both;
}

.filter-tab {
    padding: var(--space-2) var(--space-4);
    background: transparent;
    border: 1px solid transparent;
    border-radius: var(--radius-lg);
    color: var(--color-text-secondary);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-base);
}

.filter-tab:hover {
    color: var(--color-text-primary);
    background: var(--color-surface-hover);
}

.filter-tab.active {
    color: var(--color-primary);
    background: rgba(99, 102, 241, 0.1);
    border-color: var(--color-primary);
}

.task-card {
    background: var(--glass-bg);
    backdrop-filter: var(--backdrop-blur);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-xl);
    padding: var(--space-5);
    transition: all var(--transition-base);
    animation: fadeInUp 0.6s ease-out;
    animation-fill-mode: both;
    position: relative;
    overflow: hidden;
}

.task-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: var(--color-primary);
    opacity: 0;
    transition: opacity var(--transition-base);
}

.task-card:hover {
    transform: translateY(-2px);
    border-color: var(--color-primary);
    box-shadow: 0 8px 24px rgba(99, 102, 241, 0.15);
}

.task-card:hover::before {
    opacity: 1;
}

.task-card.completed {
    opacity: 0.7;
}

.task-card.completed:hover {
    opacity: 0.9;
}

.task-checkbox {
    width: 20px;
    height: 20px;
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-base);
    flex-shrink: 0;
    margin-top: 2px;
}

.task-checkbox:hover {
    border-color: var(--color-primary);
}

.task-checkbox:checked {
    background: var(--color-primary);
    border-color: var(--color-primary);
}

.task-title {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    margin-bottom: var(--space-2);
    color: var(--color-text-primary);
    cursor: text;
    border-radius: var(--radius-md);
    padding: var(--space-1) var(--space-2);
    margin: -2px -8px var(--space-2) -8px;
    transition: all var(--transition-base);
    position: relative;
}

.task-title:hover {
    background: rgba(99, 102, 241, 0.05);
}

.task-title:focus {
    outline: none;
    background: var(--color-surface);
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
}

.task-title.saving::after {
    content: '';
    display: inline-block;
    width: 12px;
    height: 12px;
    margin-left: 8px;
    border: 2px solid var(--color-primary);
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
}

.task-title.saved::after {
    content: '✓';
    display: inline-block;
    margin-left: 8px;
    color: var(--color-success);
    font-weight: bold;
    animation: fadeIn 0.3s ease-out;
}

.task-card.completed .task-title {
    text-decoration: line-through;
    color: var(--color-text-tertiary);
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.task-meta {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-3);
}

.priority-badge {
    display: inline-flex;
    align-items: center;
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-full);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.priority-high {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(220, 38, 38, 0.15) 100%);
    color: rgb(239, 68, 68);
    border: 1px solid rgba(239, 68, 68, 0.3);
}

.priority-medium {
    background: linear-gradient(135deg, rgba(249, 115, 22, 0.15) 0%, rgba(234, 88, 12, 0.15) 100%);
    color: rgb(249, 115, 22);
    border: 1px solid rgba(249, 115, 22, 0.3);
}

.priority-low {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(22, 163, 74, 0.15) 100%);
    color: rgb(34, 197, 94);
    border: 1px solid rgba(34, 197, 94, 0.3);
}

.due-date-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-1) var(--space-3);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-full);
    font-size: var(--font-size-xs);
    color: var(--color-text-tertiary);
}

.empty-state {
    background: var(--glass-bg);
    backdrop-filter: var(--backdrop-blur);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-xl);
    padding: var(--space-12);
    text-align: center;
    animation: fadeInUp 0.6s ease-out 0.2s;
    animation-fill-mode: both;
}

.empty-state-icon {
    width: 64px;
    height: 64px;
    margin: 0 auto var(--space-4);
    color: var(--color-text-tertiary);
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Stagger animation delays */
.task-card:nth-child(1) { animation-delay: 0.2s; }
.task-card:nth-child(2) { animation-delay: 0.25s; }
.task-card:nth-child(3) { animation-delay: 0.3s; }
.task-card:nth-child(4) { animation-delay: 0.35s; }
.task-card:nth-child(5) { animation-delay: 0.4s; }
.task-card:nth-child(6) { animation-delay: 0.45s; }

@media (max-width: 768px) {
    .tasks-title {
        font-size: var(--font-size-3xl);
    }
    
    .task-filters {
        flex-wrap: wrap;
    }
    
    .tasks-header {
        flex-direction: column;
        align-items: flex-start !important;
        gap: var(--space-4);
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/tasks-cache.js') }}" nonce="{{ g.csp_nonce }}"></script>
{% endblock %}

{% block content %}
<div class="container tasks-container">
    <!-- Header -->
    <div class="tasks-header flex justify-between items-center">
        <div>
            <h1 class="tasks-title">Action Items</h1>
            <p class="tasks-subtitle">Track and manage tasks from your meetings</p>
        </div>
        <button class="btn btn-primary" id="newTaskBtn">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            New Task
        </button>
    </div>

    <!-- Filters -->
    <div class="task-filters">
        <button class="filter-tab active" data-filter="all">
            All Tasks
            <span class="ml-2 px-2 py-0.5 rounded-full text-xs" style="background: rgba(99, 102, 241, 0.2);">
                {{ tasks|length if tasks else 0 }}
            </span>
        </button>
        <button class="filter-tab" data-filter="pending">
            Pending
            <span class="ml-2 px-2 py-0.5 rounded-full text-xs" style="background: rgba(249, 115, 22, 0.2);">
                {{ tasks|selectattr('completed', 'equalto', false)|list|length if tasks else 0 }}
            </span>
        </button>
        <button class="filter-tab" data-filter="completed">
            Completed
            <span class="ml-2 px-2 py-0.5 rounded-full text-xs" style="background: rgba(34, 197, 94, 0.2);">
                {{ tasks|selectattr('completed', 'equalto', true)|list|length if tasks else 0 }}
            </span>
        </button>
    </div>

    <!-- Task List -->
    {% if tasks and tasks|length > 0 %}
    <div style="display: flex; flex-direction: column; gap: var(--space-4);">
        {% for task in tasks %}
        <div class="task-card{% if task.completed %} completed{% endif %}" data-status="{% if task.completed %}completed{% else %}pending{% endif %}" data-task-id="{{ task.id }}">
            <div class="flex items-start gap-4">
                <input type="checkbox" {% if task.completed %}checked{% endif %} class="task-checkbox" data-task-id="{{ task.id }}">
                <div class="flex-1">
                    <h3 class="task-title" contenteditable="true" data-original-title="{{ task.title or task.description }}">{{ task.title or task.description }}</h3>
                    <p class="task-meta">
                        <svg class="inline-block w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        From: <span class="font-medium">{{ task.meeting_title|default('Unknown meeting') }}</span>
                    </p>
                    <div class="flex gap-2 flex-wrap">
                        <span class="priority-badge priority-{{ task.priority|default('medium')|lower }}">
                            {{ task.priority|default('medium') }}
                        </span>
                        {% if task.due_date %}
                        <span class="due-date-badge">
                            <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            {{ task.due_date }}
                        </span>
                        {% else %}
                        <span class="due-date-badge">
                            <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            No due date
                        </span>
                        {% endif %}
                        {% if task.assignee %}
                        <span class="due-date-badge">
                            <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                            </svg>
                            {{ task.assignee }}
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="empty-state">
        <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
        </svg>
        <h3 class="text-xl font-semibold mb-2">No tasks yet</h3>
        <p class="text-secondary mb-6">Tasks from your meetings will appear here</p>
        <button class="btn btn-primary" id="createFirstTaskBtn">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            Create your first task
        </button>
    </div>
    {% endif %}
</div>

<!-- Task Creation Modal -->
<div id="taskModal" class="modal-overlay" style="display: none;">
    <div class="modal-container">
        <div class="modal-header">
            <h2 class="modal-title">Create New Task</h2>
            <button class="modal-close" id="closeModalBtn">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <form id="taskForm" class="modal-body">
            <div class="form-group">
                <label for="taskTitle" class="form-label">
                    Task Title <span class="text-red-500">*</span>
                </label>
                <input 
                    type="text" 
                    id="taskTitle" 
                    name="title" 
                    class="form-input" 
                    placeholder="e.g., Review project proposal"
                    required
                    autocomplete="off"
                >
                <span class="form-error" id="titleError"></span>
            </div>
            
            <div class="form-group">
                <label for="taskDescription" class="form-label">Description</label>
                <textarea 
                    id="taskDescription" 
                    name="description" 
                    class="form-input" 
                    rows="3"
                    placeholder="Add more details about this task..."
                ></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="taskPriority" class="form-label">Priority</label>
                    <select id="taskPriority" name="priority" class="form-input">
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="taskDueDate" class="form-label">Due Date</label>
                    <input 
                        type="date" 
                        id="taskDueDate" 
                        name="due_date" 
                        class="form-input"
                    >
                </div>
            </div>
            
            <div class="form-group">
                <label for="taskAssignee" class="form-label">Assigned To</label>
                <input 
                    type="text" 
                    id="taskAssignee" 
                    name="assignee" 
                    class="form-input" 
                    placeholder="Enter name or email"
                    autocomplete="off"
                >
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelTaskBtn">
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary" id="createTaskBtn">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Create Task
                </button>
            </div>
        </form>
    </div>
</div>

<style nonce="{{ g.csp_nonce }}">
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(8px);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.2s ease-out;
}

.modal-container {
    background: var(--glass-bg);
    backdrop-filter: var(--backdrop-blur);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-2xl);
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: slideInFromBottom 0.3s ease-out;
}

.modal-header {
    padding: var(--space-6);
    border-bottom: 1px solid var(--glass-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-title {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-text-primary);
}

.modal-close {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-lg);
    border: 1px solid var(--color-border);
    background: transparent;
    color: var(--color-text-secondary);
    cursor: pointer;
    transition: all var(--transition-base);
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-close:hover {
    background: var(--color-surface-hover);
    color: var(--color-text-primary);
}

.modal-body {
    padding: var(--space-6);
    max-height: calc(90vh - 180px);
    overflow-y: auto;
}

.modal-footer {
    padding: var(--space-6);
    border-top: 1px solid var(--glass-border);
    display: flex;
    gap: var(--space-3);
    justify-content: flex-end;
}

.form-group {
    margin-bottom: var(--space-5);
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-4);
}

.form-label {
    display: block;
    margin-bottom: var(--space-2);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-primary);
    font-size: var(--font-size-sm);
}

.form-input {
    width: 100%;
    padding: var(--space-3);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    color: var(--color-text-primary);
    font-size: var(--font-size-base);
    transition: all var(--transition-base);
}

.form-input:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.form-input::placeholder {
    color: var(--color-text-tertiary);
}

.form-error {
    display: block;
    margin-top: var(--space-1);
    font-size: var(--font-size-sm);
    color: #ef4444;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideInFromBottom {
    from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

@keyframes slideOutToBottom {
    from {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
    to {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
    }
}

@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .modal-container {
        width: 95%;
    }
}
</style>

<script nonce="{{ g.csp_nonce }}">
/**
 * Tasks Page - Real-time WebSocket Integration
 * CROWN⁴ Event Handling for Live Task Updates
 */

(function() {
    'use strict';
    
    // Get workspace ID from user context (safe null handling)
    const WORKSPACE_ID = {{ current_user.workspace_id|tojson }};
    
    /**
     * Open task creation modal
     */
    window.openTaskModal = function() {
        const modal = document.getElementById('taskModal');
        const form = document.getElementById('taskForm');
        
        // Reset form
        form.reset();
        document.getElementById('titleError').textContent = '';
        
        // Show modal with animation
        modal.style.display = 'flex';
        
        // Focus on title input
        setTimeout(() => {
            document.getElementById('taskTitle').focus();
        }, 100);
    };
    
    /**
     * Close task creation modal
     */
    window.closeTaskModal = function() {
        const modal = document.getElementById('taskModal');
        const container = modal.querySelector('.modal-container');
        
        // Fade out animation
        container.style.animation = 'slideOutToBottom 0.3s ease-out';
        
        setTimeout(() => {
            modal.style.display = 'none';
            container.style.animation = '';
        }, 300);
    };
    
    /**
     * Handle task form submission
     */
    async function handleTaskFormSubmit(event) {
        event.preventDefault();
        
        const form = event.target;
        const submitBtn = document.getElementById('createTaskBtn');
        const titleInput = document.getElementById('taskTitle');
        const titleError = document.getElementById('titleError');
        
        // Validate title
        const title = titleInput.value.trim();
        if (!title || title.length < 3) {
            titleError.textContent = 'Title must be at least 3 characters';
            titleInput.focus();
            return;
        }
        
        // Clear error
        titleError.textContent = '';
        
        // Disable submit button
        submitBtn.disabled = true;
        submitBtn.innerHTML = `
            <svg class="animate-spin" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" opacity="0.25"></circle>
                <path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Creating...
        `;
        
        // Gather form data
        const formData = {
            title: title,
            description: document.getElementById('taskDescription').value.trim() || null,
            priority: document.getElementById('taskPriority').value,
            due_date: document.getElementById('taskDueDate').value || null,
            assigned_to_name: document.getElementById('taskAssignee').value.trim() || null,
            status: 'todo',
            extracted_by_ai: false
        };
        
        try {
            // Send to server
            const response = await fetch('/api/tasks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Failed to create task');
            }
            
            const newTask = await response.json();
            
            // Save to cache
            await tasksCache.saveTask(newTask);
            
            // Close modal
            window.closeTaskModal();
            
            // The WebSocket handler will add the task to the DOM
            // But if WebSocket is slow, add it optimistically
            setTimeout(() => {
                const existingCard = document.querySelector(`[data-task-id="${newTask.id}"]`);
                if (!existingCard) {
                    handleTaskCreated({ task: newTask });
                }
            }, 500);
            
            // Show success notification
            showNotification('Task created', `"${title}" has been added to your tasks`);
            
        } catch (error) {
            console.error('Failed to create task:', error);
            titleError.textContent = error.message || 'Failed to create task';
            
            showNotification('Error', error.message || 'Failed to create task');
        } finally {
            // Re-enable submit button
            submitBtn.disabled = false;
            submitBtn.innerHTML = `
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                Create Task
            `;
        }
    }
    
    // Cache DOM elements
    const filterCounts = {
        all: document.querySelector('.filter-tab[data-filter="all"] .px-2'),
        pending: document.querySelector('.filter-tab[data-filter="pending"] .px-2'),
        completed: document.querySelector('.filter-tab[data-filter="completed"] .px-2')
    };
    
    const tasksContainer = document.querySelector('.tasks-container > div:last-of-type');
    const emptyStateEl = document.querySelector('.empty-state');
    
    /**
     * Initialize WebSocket connection for tasks page
     */
    function initTasksWebSocket() {
        console.log('🚀 Initializing tasks WebSocket...');
        
        // Initialize WebSocket manager with tasks namespace
        if (!window.wsManager) {
            console.error('❌ WebSocket manager not found');
            return;
        }
        
        // Connect to tasks namespace
        window.wsManager.connect('tasks');
        
        // Listen for task_update events
        window.wsManager.on('task_update', handleTaskUpdate);
        
        console.log('📡 Tasks WebSocket listeners registered');
    }
    
    /**
     * Handle task update event
     * @param {Object} data - Event data with task information
     */
    function handleTaskUpdate(data) {
        console.log('✅ Task update event received:', data);
        
        const taskData = data.data || data;
        const action = taskData.action; // 'created', 'updated', 'deleted', 'completed'
        
        switch (action) {
            case 'created':
                handleTaskCreated(taskData);
                break;
            case 'updated':
                handleTaskUpdated(taskData);
                break;
            case 'deleted':
                handleTaskDeleted(taskData);
                break;
            case 'completed':
                handleTaskCompleted(taskData);
                break;
        }
        
        // Update filter counts
        updateFilterCounts();
    }
    
    /**
     * Handle new task created
     * @param {Object} taskData - Task data
     */
    async function handleTaskCreated(taskData) {
        const task = taskData.task || taskData;
        
        // Save to cache
        try {
            await tasksCache.saveTask(task);
            console.log('💾 Task saved to cache:', task.id);
        } catch (error) {
            console.error('Failed to save task to cache:', error);
        }
        
        // Check if task already exists in DOM (avoid duplicates)
        const existingCard = document.querySelector(`[data-task-id="${task.id}"]`);
        if (existingCard) {
            console.log('Task already exists in DOM, skipping:', task.id);
            return;
        }
        
        // Remove empty state if present
        if (emptyStateEl && emptyStateEl.style.display !== 'none') {
            emptyStateEl.style.opacity = '0';
            setTimeout(() => {
                emptyStateEl.style.display = 'none';
            }, 300);
        }
        
        // Create task card HTML
        const cardHTML = createTaskCardHTML(task);
        
        // Insert at top of list
        if (tasksContainer && !emptyStateEl.parentElement.contains(emptyStateEl)) {
            tasksContainer.insertAdjacentHTML('afterbegin', cardHTML);
            
            // Attach event listeners to new card
            attachTaskCardListeners();
        }
        
        // Show notification
        showNotification('New task created', task.title || task.description || 'A new task has been added');
    }
    
    /**
     * Handle task updated
     * @param {Object} taskData - Task data
     */
    function handleTaskUpdated(taskData) {
        const task = taskData.task || taskData;
        const taskCard = document.querySelector(`[data-task-id="${task.id}"]`);
        
        if (taskCard) {
            // Update task title (prefer title over description)
            const titleEl = taskCard.querySelector('.task-title');
            if (titleEl) {
                const newTitle = task.title || task.description || 'Untitled Task';
                titleEl.textContent = newTitle;
                titleEl.dataset.originalTitle = newTitle;
            }
            
            // Update priority badge
            const priorityBadge = taskCard.querySelector('.priority-badge');
            if (priorityBadge && task.priority) {
                priorityBadge.className = `priority-badge priority-${task.priority.toLowerCase()}`;
                priorityBadge.textContent = task.priority;
            }
            
            // Add update animation
            taskCard.style.animation = 'taskUpdate 0.5s ease-out';
            setTimeout(() => {
                taskCard.style.animation = '';
            }, 500);
        }
    }
    
    /**
     * Handle task deleted
     * @param {Object} taskData - Task data
     */
    function handleTaskDeleted(taskData) {
        const task = taskData.task || taskData;
        const taskCard = document.querySelector(`[data-task-id="${task.id}"]`);
        
        if (taskCard) {
            // Fade out and remove
            taskCard.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
            taskCard.style.opacity = '0';
            taskCard.style.transform = 'translateX(-20px)';
            
            setTimeout(() => {
                taskCard.remove();
                
                // Show empty state if no tasks left
                const remainingTasks = document.querySelectorAll('.task-card').length;
                if (remainingTasks === 0 && emptyStateEl) {
                    emptyStateEl.style.display = 'block';
                    emptyStateEl.style.opacity = '1';
                }
            }, 300);
        }
    }
    
    /**
     * Handle task completed
     * @param {Object} taskData - Task data
     */
    function handleTaskCompleted(taskData) {
        const task = taskData.task || taskData;
        const taskCard = document.querySelector(`[data-task-id="${task.id}"]`);
        
        if (taskCard) {
            const checkbox = taskCard.querySelector('.task-checkbox');
            
            if (task.completed) {
                taskCard.classList.add('completed');
                taskCard.dataset.status = 'completed';
                if (checkbox) checkbox.checked = true;
            } else {
                taskCard.classList.remove('completed');
                taskCard.dataset.status = 'pending';
                if (checkbox) checkbox.checked = false;
            }
            
            // Add completion animation
            if (task.completed) {
                taskCard.style.animation = 'taskComplete 0.5s ease-out';
                setTimeout(() => {
                    taskCard.style.animation = '';
                }, 500);
            }
        }
    }
    
    /**
     * Create task card HTML
     * @param {Object} task - Task data
     * @returns {string} HTML string
     */
    function createTaskCardHTML(task) {
        const priority = task.priority || 'medium';
        const completed = task.status === 'done' || task.completed || false;
        const status = completed ? 'completed' : 'pending';
        
        return `
            <div class="task-card ${completed ? 'completed' : ''}" 
                 data-status="${status}" 
                 data-task-id="${task.id}"
                 style="animation: slideInFromTop 0.5s ease-out;">
                <div class="flex items-start gap-4">
                    <input type="checkbox" ${completed ? 'checked' : ''} class="task-checkbox" data-task-id="${task.id}">
                    <div class="flex-1">
                        <h3 class="task-title" contenteditable="true" data-original-title="${escapeHtml(task.title || task.description || 'Untitled Task')}">${escapeHtml(task.title || task.description || 'Untitled Task')}</h3>
                        <p class="task-meta">
                            <svg class="inline-block w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            From: <span class="font-medium">${escapeHtml(task.meeting_title || 'Unknown meeting')}</span>
                        </p>
                        <div class="flex gap-2 flex-wrap">
                            <span class="priority-badge priority-${priority.toLowerCase()}">
                                ${priority}
                            </span>
                            ${task.due_date ? `
                                <span class="due-date-badge">
                                    <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    ${task.due_date}
                                </span>
                            ` : `
                                <span class="due-date-badge">
                                    <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    No due date
                                </span>
                            `}
                            ${task.assignee ? `
                                <span class="due-date-badge">
                                    <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                    </svg>
                                    ${escapeHtml(task.assignee)}
                                </span>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    /**
     * Update filter counts
     */
    function updateFilterCounts() {
        const allTasks = document.querySelectorAll('.task-card').length;
        const pendingTasks = document.querySelectorAll('.task-card[data-status="pending"]').length;
        const completedTasks = document.querySelectorAll('.task-card[data-status="completed"]').length;
        
        if (filterCounts.all) filterCounts.all.textContent = allTasks;
        if (filterCounts.pending) filterCounts.pending.textContent = pendingTasks;
        if (filterCounts.completed) filterCounts.completed.textContent = completedTasks;
    }
    
    /**
     * Attach event listeners to task cards
     */
    function attachTaskCardListeners() {
        // Reattach filter tab listeners
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const filter = tab.dataset.filter;
                
                // Update active tab
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Filter tasks
                document.querySelectorAll('.task-card').forEach(card => {
                    if (filter === 'all') {
                        card.style.display = 'block';
                    } else {
                        const status = card.dataset.status;
                        card.style.display = status === filter ? 'block' : 'none';
                    }
                });
            });
        });
        
        // Reattach checkbox listeners with optimistic updates
        document.querySelectorAll('.task-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', async function() {
                const taskCard = this.closest('.task-card');
                const taskId = this.dataset.taskId || taskCard.dataset.taskId;
                const completed = this.checked;
                
                // Optimistic UI update
                if (completed) {
                    taskCard.classList.add('completed');
                    taskCard.dataset.status = 'completed';
                    taskCard.style.animation = 'taskComplete 0.5s ease-out';
                } else {
                    taskCard.classList.remove('completed');
                    taskCard.dataset.status = 'pending';
                }
                
                // Update filter counts
                updateFilterCounts();
                
                // Send update to server
                try {
                    const response = await fetch(`/api/tasks/${taskId}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            status: completed ? 'done' : 'todo'
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to update task');
                    }
                    
                    const updatedTask = await response.json();
                    
                    // Update cache
                    await tasksCache.saveTask(updatedTask);
                    
                    console.log('✅ Task updated on server:', taskId);
                } catch (error) {
                    console.error('Failed to update task:', error);
                    
                    // Rollback UI on error
                    this.checked = !completed;
                    if (completed) {
                        taskCard.classList.remove('completed');
                        taskCard.dataset.status = 'pending';
                    } else {
                        taskCard.classList.add('completed');
                        taskCard.dataset.status = 'completed';
                    }
                    updateFilterCounts();
                    
                    // Queue for sync when back online
                    await tasksCache.queueSync('update_task', {
                        task_id: taskId,
                        data: { status: completed ? 'done' : 'todo' }
                    });
                    
                    showNotification('Update queued', 'Will sync when connection is restored');
                }
            });
        });
        
        // Attach inline editing listeners to task titles
        attachInlineEditingListeners();
    }
    
    /**
     * Debounce utility function
     * @param {Function} func - Function to debounce
     * @param {number} wait - Milliseconds to wait
     * @returns {Function} Debounced function
     */
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    /**
     * Attach inline editing listeners to task titles
     */
    function attachInlineEditingListeners() {
        document.querySelectorAll('.task-title[contenteditable="true"]').forEach(titleEl => {
            // Store original value on focus
            titleEl.addEventListener('focus', function() {
                this.dataset.originalTitle = this.textContent;
            });
            
            // Handle Enter key to blur (save)
            titleEl.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.blur();
                }
                // Handle Escape to cancel
                if (e.key === 'Escape') {
                    e.preventDefault();
                    this.textContent = this.dataset.originalTitle;
                    this.blur();
                }
            });
            
            // Auto-save on blur with debounce
            titleEl.addEventListener('blur', debounce(async function() {
                const newTitle = this.textContent.trim();
                const originalTitle = this.dataset.originalTitle;
                
                // Skip if unchanged or empty
                if (!newTitle || newTitle === originalTitle) {
                    if (!newTitle) {
                        this.textContent = originalTitle;
                    }
                    return;
                }
                
                const taskCard = this.closest('.task-card');
                const taskId = taskCard.dataset.taskId;
                
                // Show saving indicator
                this.classList.add('saving');
                
                try {
                    const response = await fetch(`/api/tasks/${taskId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            title: newTitle
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to update task title');
                    }
                    
                    const result = await response.json();
                    const updatedTask = result.task || result;
                    
                    // Update cache
                    await tasksCache.saveTask(updatedTask);
                    
                    // Update original title
                    this.dataset.originalTitle = newTitle;
                    
                    // Show saved indicator
                    this.classList.remove('saving');
                    this.classList.add('saved');
                    
                    setTimeout(() => {
                        this.classList.remove('saved');
                    }, 2000);
                    
                    console.log('✅ Task title updated:', taskId, newTitle);
                    
                } catch (error) {
                    console.error('Failed to update task title:', error);
                    
                    // Rollback on error
                    this.textContent = originalTitle;
                    this.classList.remove('saving');
                    
                    // Queue for sync when back online
                    await tasksCache.queueSync('update_task', {
                        task_id: taskId,
                        data: { title: newTitle }
                    });
                    
                    showNotification('Update queued', 'Will sync when connection is restored');
                }
            }, 300));
        });
    }
    
    /**
     * Show notification toast
     * @param {string} title - Notification title
     * @param {string} message - Notification message
     */
    function showNotification(title, message) {
        const notification = document.createElement('div');
        notification.className = 'notification-toast';
        notification.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            max-width: 400px;
            padding: 16px;
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            animation: slideInFromRight 0.3s ease-out;
        `;
        
        notification.innerHTML = `
            <div style="display: flex; gap: 12px; align-items: start;">
                <div style="flex-shrink: 0; width: 40px; height: 40px; background: var(--gradient-primary); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                    <svg width="20" height="20" fill="white" viewBox="0 0 24 24">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <div style="flex: 1;">
                    <p style="font-weight: 600; margin-bottom: 4px;">${escapeHtml(title)}</p>
                    <p style="font-size: 14px; color: var(--color-text-secondary);">${escapeHtml(message)}</p>
                </div>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            notification.style.animation = 'slideOutToRight 0.3s ease-out';
            setTimeout(() => notification.remove(), 300);
        }, 5000);
    }
    
    /**
     * Escape HTML to prevent XSS
     * @param {string} text - Text to escape
     * @returns {string} Escaped text
     */
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            initTasksWebSocket();
            attachTaskCardListeners();
            
            // Attach modal form submit handler
            const taskForm = document.getElementById('taskForm');
            if (taskForm) {
                taskForm.addEventListener('submit', handleTaskFormSubmit);
            }
            
            // Attach button click handlers
            const newTaskBtn = document.getElementById('newTaskBtn');
            const createFirstTaskBtn = document.getElementById('createFirstTaskBtn');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const cancelTaskBtn = document.getElementById('cancelTaskBtn');
            
            if (newTaskBtn) {
                newTaskBtn.addEventListener('click', window.openTaskModal);
            }
            if (createFirstTaskBtn) {
                createFirstTaskBtn.addEventListener('click', window.openTaskModal);
            }
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', window.closeTaskModal);
            }
            if (cancelTaskBtn) {
                cancelTaskBtn.addEventListener('click', window.closeTaskModal);
            }
            
            // Close modal on Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('taskModal');
                    if (modal && modal.style.display !== 'none') {
                        window.closeTaskModal();
                    }
                }
            });
            
            // Close modal on overlay click
            const modal = document.getElementById('taskModal');
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        window.closeTaskModal();
                    }
                });
            }
        });
    } else {
        initTasksWebSocket();
        attachTaskCardListeners();
        
        // Attach modal form submit handler
        const taskForm = document.getElementById('taskForm');
        if (taskForm) {
            taskForm.addEventListener('submit', handleTaskFormSubmit);
        }
        
        // Attach button click handlers
        const newTaskBtn = document.getElementById('newTaskBtn');
        const createFirstTaskBtn = document.getElementById('createFirstTaskBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelTaskBtn = document.getElementById('cancelTaskBtn');
        
        if (newTaskBtn) {
            newTaskBtn.addEventListener('click', window.openTaskModal);
        }
        if (createFirstTaskBtn) {
            createFirstTaskBtn.addEventListener('click', window.openTaskModal);
        }
        if (closeModalBtn) {
            closeModalBtn.addEventListener('click', window.closeTaskModal);
        }
        if (cancelTaskBtn) {
            cancelTaskBtn.addEventListener('click', window.closeTaskModal);
        }
        
        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modal = document.getElementById('taskModal');
                if (modal && modal.style.display !== 'none') {
                    window.closeTaskModal();
                }
            }
        });
        
        // Close modal on overlay click
        const modal = document.getElementById('taskModal');
        if (modal) {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    window.closeTaskModal();
                }
            });
        }
    }
    
    // Add CSS for animations
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideInFromTop {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInFromRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideOutToRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(20px);
            }
        }
        
        @keyframes taskUpdate {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.02);
                box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
            }
        }
        
        @keyframes taskComplete {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(0.98);
            }
            100% {
                transform: scale(1);
            }
        }
    `;
    document.head.appendChild(style);
    
})();
</script>
{% endblock %}
