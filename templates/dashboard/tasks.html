{% extends "base.html" %}

{% block title %}Tasks - Mina{% endblock %}

{% block extra_css %}
<style>
.tasks-container {
    min-height: calc(100vh - var(--header-height));
    padding: var(--space-8) 0;
    max-width: 1200px;
}

.tasks-header {
    margin-bottom: var(--space-6);
    animation: fadeInUp 0.6s ease-out;
}

.tasks-title {
    font-size: var(--font-size-4xl);
    font-weight: var(--font-weight-bold);
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: var(--space-2);
}

.tasks-subtitle {
    color: var(--color-text-secondary);
    font-size: var(--font-size-lg);
}

.connection-banner {
    padding: var(--space-3) var(--space-4);
    background: var(--glass-bg);
    backdrop-filter: var(--backdrop-blur);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-lg);
    margin-bottom: var(--space-4);
    display: flex;
    align-items: center;
    gap: var(--space-3);
    font-size: var(--font-size-sm);
    transition: all var(--transition-base);
}

.connection-banner.offline {
    background: rgba(239, 68, 68, 0.1);
    border-color: rgba(239, 68, 68, 0.5);
    color: #ef4444;
}

.connection-banner.reconnecting {
    background: rgba(249, 115, 22, 0.1);
    border-color: rgba(249, 115, 22, 0.5);
    color: #f97316;
}

.connection-banner.online {
    background: rgba(34, 197, 94, 0.1);
    border-color: rgba(34, 197, 94, 0.5);
    color: #22c55e;
}

.connection-status-icon::before {
    content: '‚óè';
    margin-right: var(--space-2);
}

.task-filters {
    display: flex;
    gap: var(--space-3);
    padding: var(--space-4);
    background: var(--glass-bg);
    backdrop-filter: var(--backdrop-blur);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-xl);
    margin-bottom: var(--space-6);
    animation: fadeInUp 0.6s ease-out 0.1s;
    animation-fill-mode: both;
}

.filter-tab {
    padding: var(--space-2) var(--space-4);
    background: transparent;
    border: 1px solid transparent;
    border-radius: var(--radius-lg);
    color: var(--color-text-secondary);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-base);
}

.filter-tab:hover {
    color: var(--color-text-primary);
    background: var(--color-surface-hover);
}

.filter-tab.active {
    color: var(--color-primary);
    background: rgba(99, 102, 241, 0.1);
    border-color: var(--color-primary);
}

.task-card {
    background: var(--glass-bg);
    backdrop-filter: var(--backdrop-blur);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-xl);
    padding: var(--space-5);
    transition: all var(--transition-base);
    animation: fadeInUp 0.6s ease-out;
    animation-fill-mode: both;
    position: relative;
    overflow: hidden;
}

.task-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: var(--color-primary);
    opacity: 0;
    transition: opacity var(--transition-base);
}

.task-card:hover {
    transform: translateY(-2px);
    border-color: var(--color-primary);
    box-shadow: 0 8px 24px rgba(99, 102, 241, 0.15);
}

.task-card:hover::before {
    opacity: 1;
}

.task-card.completed {
    opacity: 0.7;
}

.task-card.completed:hover {
    opacity: 0.9;
}

.task-checkbox {
    width: 20px;
    height: 20px;
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-base);
    flex-shrink: 0;
    margin-top: 2px;
}

.task-checkbox:hover {
    border-color: var(--color-primary);
}

.task-checkbox:checked {
    background: var(--color-primary);
    border-color: var(--color-primary);
}

.task-title {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    margin-bottom: var(--space-2);
    color: var(--color-text-primary);
}

.task-card.completed .task-title {
    text-decoration: line-through;
    color: var(--color-text-tertiary);
}

.task-meta {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-3);
}

.priority-badge {
    display: inline-flex;
    align-items: center;
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-full);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.priority-high {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(220, 38, 38, 0.15) 100%);
    color: rgb(239, 68, 68);
    border: 1px solid rgba(239, 68, 68, 0.3);
}

.priority-medium {
    background: linear-gradient(135deg, rgba(249, 115, 22, 0.15) 0%, rgba(234, 88, 12, 0.15) 100%);
    color: rgb(249, 115, 22);
    border: 1px solid rgba(249, 115, 22, 0.3);
}

.priority-low {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(22, 163, 74, 0.15) 100%);
    color: rgb(34, 197, 94);
    border: 1px solid rgba(34, 197, 94, 0.3);
}

.due-date-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-1) var(--space-3);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-full);
    font-size: var(--font-size-xs);
    color: var(--color-text-tertiary);
    cursor: pointer;
    transition: all var(--transition-base);
}

.due-date-badge:hover,
.priority-badge:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}

.due-date-add {
    border-style: dashed;
    opacity: 0.7;
}

.due-date-add:hover {
    opacity: 1;
    border-color: var(--color-primary);
    color: var(--color-primary);
}

.assignee-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-1) var(--space-3);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-full);
    font-size: var(--font-size-xs);
    color: var(--color-text-tertiary);
    cursor: pointer;
    transition: all var(--transition-base);
}

.assignee-badge:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}

.assignee-add {
    border-style: dashed;
    opacity: 0.7;
}

.assignee-add:hover {
    opacity: 1;
    border-color: var(--color-primary);
    color: var(--color-primary);
}

.ai-proposal {
    border: 2px solid var(--color-primary);
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05));
}

.ai-proposal-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-2) var(--space-3);
    background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
    color: white;
    border-radius: var(--radius-full);
    font-size: var(--font-size-xs);
    font-weight: 600;
    margin-right: var(--space-3);
}

.ai-proposal-actions {
    display: flex;
    gap: var(--space-2);
    margin-top: var(--space-3);
}

.btn-accept-proposal,
.btn-reject-proposal {
    padding: var(--space-2) var(--space-4);
    border: none;
    border-radius: var(--radius-lg);
    font-size: var(--font-size-sm);
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-base);
}

.btn-accept-proposal {
    background: var(--color-success);
    color: white;
}

.btn-accept-proposal:hover {
    background: var(--color-success-dark);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
}

.btn-reject-proposal {
    background: var(--color-surface);
    color: var(--color-text-secondary);
    border: 1px solid var(--color-border);
}

.btn-reject-proposal:hover {
    background: var(--color-error);
    color: white;
    border-color: var(--color-error);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

.btn-accept-proposal:disabled,
.btn-reject-proposal:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.inline-edit-select,
.inline-edit-input {
    padding: var(--space-1) var(--space-2);
    border: 2px solid var(--color-primary);
    border-radius: var(--radius-md);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
    background: var(--color-surface);
    color: var(--color-text-primary);
    outline: none;
    transition: all var(--transition-base);
}

.inline-edit-select:focus,
.inline-edit-input:focus {
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.priority-select {
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.transcript-link-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-1) var(--space-3);
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.1));
    border: 1px solid rgba(34, 197, 94, 0.4);
    border-radius: var(--radius-full);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
    color: rgb(34, 197, 94);
    text-decoration: none;
    transition: all var(--transition-base);
    cursor: pointer;
}

.transcript-link-badge:hover {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(16, 185, 129, 0.2));
    border-color: rgb(34, 197, 94);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
}

.transcript-link-badge:active {
    transform: translateY(0);
}

.bulk-action-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-4) var(--space-6);
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1));
    border: 1px solid rgba(99, 102, 241, 0.3);
    border-radius: var(--radius-lg);
    animation: slideDown 0.3s ease-out;
    margin-bottom: var(--space-4);
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.bulk-action-info {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-primary);
}

#bulk-selected-count {
    font-weight: var(--font-weight-bold);
    color: rgb(99, 102, 241);
}

.bulk-action-buttons {
    display: flex;
    gap: var(--space-2);
}

.bulk-action-btn {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-4);
    background: white;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-secondary);
    cursor: pointer;
    transition: all var(--transition-base);
}

.bulk-action-btn:hover {
    background: var(--color-surface-hover);
    color: var(--color-text-primary);
    border-color: rgb(99, 102, 241);
    transform: translateY(-1px);
}

.bulk-action-btn-cancel {
    background: var(--color-surface);
    color: var(--color-text-tertiary);
}

.bulk-action-btn-cancel:hover {
    background: rgba(239, 68, 68, 0.1);
    color: rgb(239, 68, 68);
    border-color: rgb(239, 68, 68);
}

.bulk-select-checkbox {
    width: 18px;
    height: 18px;
    border-radius: var(--radius-sm);
    border: 2px solid var(--color-border);
    cursor: pointer;
    transition: all var(--transition-base);
    flex-shrink: 0;
}

.bulk-select-checkbox:checked {
    background: rgb(99, 102, 241);
    border-color: rgb(99, 102, 241);
}

.bulk-select-checkbox:hover {
    border-color: rgb(99, 102, 241);
}

.task-card.bulk-selected {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(168, 85, 247, 0.05));
    border-color: rgba(99, 102, 241, 0.4);
}

.empty-state {
    background: var(--glass-bg);
    backdrop-filter: var(--backdrop-blur);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-xl);
    padding: var(--space-12);
    text-align: center;
    animation: fadeInUp 0.6s ease-out 0.2s;
    animation-fill-mode: both;
}

.empty-state-icon {
    width: 64px;
    height: 64px;
    margin: 0 auto var(--space-4);
    color: var(--color-text-tertiary);
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Stagger animation delays */
.task-card:nth-child(1) { animation-delay: 0.2s; }
.task-card:nth-child(2) { animation-delay: 0.25s; }
.task-card:nth-child(3) { animation-delay: 0.3s; }
.task-card:nth-child(4) { animation-delay: 0.35s; }
.task-card:nth-child(5) { animation-delay: 0.4s; }
.task-card:nth-child(6) { animation-delay: 0.45s; }

/* Task Action Buttons */
.task-actions {
    display: flex;
    gap: var(--space-1);
    align-items: center;
}

.task-action-btn {
    background: transparent;
    border: none;
    color: var(--color-text-tertiary);
    cursor: pointer;
    padding: var(--space-2);
    border-radius: var(--radius-lg);
    transition: all var(--transition-base);
    opacity: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.task-card:hover .task-action-btn {
    opacity: 1;
}

.task-action-btn:active {
    transform: scale(0.95);
}

.task-merge-btn:hover {
    background: rgba(168, 85, 247, 0.1);
    color: rgb(168, 85, 247);
    transform: scale(1.1);
}

.task-snooze-btn:hover {
    background: rgba(99, 102, 241, 0.1);
    color: rgb(99, 102, 241);
    transform: scale(1.1);
}

.task-delete-btn:hover {
    background: rgba(239, 68, 68, 0.1);
    color: rgb(239, 68, 68);
    transform: scale(1.1);
}

/* Label Management */
.task-labels {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    align-items: center;
}

.label-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-1) var(--space-2);
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1));
    border: 1px solid rgba(99, 102, 241, 0.3);
    border-radius: var(--radius-full);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-secondary);
    animation: labelSlideIn 0.3s ease-out;
}

.label-badge.label-count {
    background: var(--color-surface);
    border-color: var(--color-border);
    cursor: help;
}

.label-remove-btn {
    background: transparent;
    border: none;
    color: inherit;
    cursor: pointer;
    padding: 2px;
    border-radius: 50%;
    transition: all var(--transition-base);
    opacity: 0.6;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.label-remove-btn:hover {
    opacity: 1;
    background: rgba(239, 68, 68, 0.2);
    color: rgb(239, 68, 68);
    transform: scale(1.2);
}

.label-remove-btn:active {
    transform: scale(0.9);
}

.label-add-btn {
    background: transparent;
    border: 1px dashed var(--color-border);
    color: var(--color-text-tertiary);
    cursor: pointer;
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-full);
    font-size: var(--font-size-xs);
    transition: all var(--transition-base);
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
}

.label-add-btn:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
    background: rgba(99, 102, 241, 0.05);
    transform: translateY(-1px);
}

.label-add-btn:active {
    transform: translateY(0) scale(0.98);
}

.label-add-btn-empty {
    padding: var(--space-2) var(--space-4);
    border-style: solid;
}

@keyframes labelSlideIn {
    from {
        opacity: 0;
        transform: translateX(-10px) scale(0.8);
    }
    to {
        opacity: 1;
        transform: translateX(0) scale(1);
    }
}

@keyframes labelSlideOut {
    from {
        opacity: 1;
        transform: scale(1);
    }
    to {
        opacity: 0;
        transform: scale(0.8);
    }
}

@keyframes fadeOut {
    from {
        opacity: 1;
        transform: scale(1);
    }
    to {
        opacity: 0;
        transform: scale(0.95);
    }
}

/* Snooze Modal */
.snooze-options {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-3);
}

.snooze-option-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-4);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all var(--transition-base);
    color: var(--color-text-primary);
    font-weight: var(--font-weight-medium);
}

.snooze-option-btn:hover {
    background: rgba(99, 102, 241, 0.05);
    border-color: var(--color-primary);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
}

.snooze-option-btn:active {
    transform: translateY(0) scale(0.98);
}

.snooze-option-btn svg {
    color: var(--color-primary);
}

/* Merge Modal */
.merge-task-list {
    max-height: 400px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.merge-task-option {
    padding: var(--space-4);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all var(--transition-base);
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.merge-task-option:hover {
    background: rgba(168, 85, 247, 0.05);
    border-color: rgb(168, 85, 247);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(168, 85, 247, 0.2);
}

.merge-task-option:active {
    transform: translateY(0) scale(0.98);
}

.merge-task-option-title {
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
}

.merge-task-option-meta {
    font-size: var(--font-size-sm);
    color: var(--color-text-tertiary);
    display: flex;
    gap: var(--space-4);
}

/* Task Creation Modal - Crown+ Glassmorphism */
.task-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    animation: fadeIn 0.2s ease-out;
}

.task-modal-overlay.active {
    display: flex;
}

.task-modal {
    background: var(--glass-bg);
    backdrop-filter: var(--backdrop-blur);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-2xl);
    padding: var(--space-6);
    max-width: 500px;
    width: 90%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.task-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-6);
}

.task-modal-title {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.task-modal-close {
    background: transparent;
    border: none;
    color: var(--color-text-secondary);
    cursor: pointer;
    padding: var(--space-2);
    border-radius: var(--radius-lg);
    transition: all var(--transition-base);
}

.task-modal-close:hover {
    background: var(--color-surface-hover);
    color: var(--color-text-primary);
}

.task-form-group {
    margin-bottom: var(--space-5);
}

.task-form-label {
    display: block;
    font-weight: var(--font-weight-medium);
    margin-bottom: var(--space-2);
    color: var(--color-text-primary);
    font-size: var(--font-size-sm);
}

.task-form-label.required::after {
    content: '*';
    color: rgb(239, 68, 68);
    margin-left: 4px;
}

.task-form-input,
.task-form-textarea,
.task-form-select {
    width: 100%;
    padding: var(--space-3);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    color: var(--color-text-primary);
    font-size: var(--font-size-base);
    transition: all var(--transition-base);
}

.task-form-input:focus,
.task-form-textarea:focus,
.task-form-select:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.task-form-textarea {
    resize: vertical;
    min-height: 80px;
    font-family: inherit;
}

.task-form-actions {
    display: flex;
    gap: var(--space-3);
    justify-content: flex-end;
    margin-top: var(--space-6);
}

.task-form-btn {
    padding: var(--space-3) var(--space-5);
    border-radius: var(--radius-lg);
    font-weight: var(--font-weight-medium);
    cursor: pointer;
    transition: all var(--transition-base);
    border: none;
}

.task-form-btn-cancel {
    background: var(--color-surface);
    color: var(--color-text-secondary);
    border: 1px solid var(--color-border);
}

.task-form-btn-cancel:hover {
    background: var(--color-surface-hover);
    color: var(--color-text-primary);
}

.task-form-btn-create {
    background: var(--gradient-primary);
    color: white;
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
}

.task-form-btn-create:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
}

.task-form-btn-create:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes scaleIn {
    from {
        opacity: 0;
        transform: scale(0.9);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

@media (max-width: 768px) {
    .tasks-title {
        font-size: var(--font-size-3xl);
    }
    
    .task-filters {
        flex-wrap: wrap;
    }
    
    .tasks-header {
        flex-direction: column;
        align-items: flex-start !important;
        gap: var(--space-4);
    }
    
    .task-modal {
        width: 95%;
        padding: var(--space-5);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container tasks-container">
    <!-- Header -->
    <div class="tasks-header flex justify-between items-center">
        <div>
            <h1 class="tasks-title">Action Items</h1>
            <p class="tasks-subtitle">Track and manage tasks from your meetings</p>
        </div>
        <button class="btn btn-primary">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            New Task
        </button>
    </div>

    <!-- Offline/Status Banner -->
    <div id="connection-banner" class="connection-banner" style="display: none;">
        <span class="connection-status-icon"></span>
        <span class="connection-message"></span>
        <span class="pending-count"></span>
    </div>

    <!-- Filters -->
    <div class="task-filters">
        <button class="filter-tab active" data-filter="all">
            All Tasks
            <span class="ml-2 px-2 py-0.5 rounded-full text-xs" style="background: rgba(99, 102, 241, 0.2);" data-counter="all">
                {{ tasks|length if tasks else 0 }}
            </span>
        </button>
        <button class="filter-tab" data-filter="pending">
            Pending
            <span class="ml-2 px-2 py-0.5 rounded-full text-xs" style="background: rgba(249, 115, 22, 0.2);" data-counter="pending">
                {{ tasks|selectattr('completed', 'equalto', false)|list|length if tasks else 0 }}
            </span>
        </button>
        <button class="filter-tab" data-filter="completed">
            Completed
            <span class="ml-2 px-2 py-0.5 rounded-full text-xs" style="background: rgba(34, 197, 94, 0.2);" data-counter="completed">
                {{ tasks|selectattr('completed', 'equalto', true)|list|length if tasks else 0 }}
            </span>
        </button>
    </div>

    <!-- Bulk Action Toolbar (appears when tasks selected) -->
    <div id="bulk-action-toolbar" class="bulk-action-toolbar" style="display: none;">
        <div class="bulk-action-info">
            <span id="bulk-selected-count">0</span> tasks selected
        </div>
        <div class="bulk-action-buttons">
            <button class="bulk-action-btn" id="bulk-complete-btn">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Complete
            </button>
            <button class="bulk-action-btn" id="bulk-delete-btn">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
                Delete
            </button>
            <button class="bulk-action-btn" id="bulk-label-btn">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                </svg>
                Add Label
            </button>
            <button class="bulk-action-btn bulk-action-btn-cancel" id="bulk-cancel-btn">
                Cancel
            </button>
        </div>
    </div>

    <!-- Task List Container (CROWN‚Å¥.5 Required Structure) -->
    <div id="tasks-list-container" style="display: flex; flex-direction: column; gap: var(--space-4);">
        {% if tasks and tasks|length > 0 %}
            {% for task in tasks %}
            <div class="task-card{% if task.completed %} completed{% endif %}" 
                 data-task-id="{{ task.id }}"
                 data-status="{% if task.completed %}completed{% else %}pending{% endif %}"
                 data-priority="{{ task.priority|default('medium')|lower }}">
                <div class="flex items-start gap-4">
                    <input type="checkbox" class="bulk-select-checkbox" data-task-id="{{ task.id }}">
                    <input type="checkbox" {% if task.completed %}checked{% endif %} class="task-checkbox">
                    <div class="flex-1">
                        <h3 class="task-title">{{ task.description }}</h3>
                        <p class="task-meta">
                            <svg class="inline-block w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            From: <span class="font-medium">{{ task.meeting_title|default('Unknown meeting') }}</span>
                        </p>
                        <div class="flex gap-2 flex-wrap">
                            <span class="priority-badge priority-{{ task.priority|default('medium')|lower }}">
                                {{ task.priority|default('medium') }}
                            </span>
                            {% if task.due_date %}
                            <span class="due-date-badge">
                                <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                {{ task.due_date }}
                            </span>
                            {% else %}
                            <span class="due-date-badge">
                                <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                No due date
                            </span>
                            {% endif %}
                            {% if task.assignee %}
                            <span class="due-date-badge">
                                <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                {{ task.assignee }}
                            </span>
                            {% endif %}
                            {% if task.transcript_span %}
                            <a href="/transcript?meeting_id={{ task.meeting_id }}&start_ms={{ task.transcript_span.start_ms }}&end_ms={{ task.transcript_span.end_ms }}" 
                               class="transcript-link-badge" 
                               data-task-id="{{ task.id }}"
                               title="Jump to transcript">
                                <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"/>
                                </svg>
                                Jump to transcript
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    <div class="task-actions">
                        <button class="task-action-btn task-merge-btn" title="Merge with another task">
                            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                            </svg>
                        </button>
                        <button class="task-action-btn task-snooze-btn" title="Snooze task">
                            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </button>
                        <button class="task-action-btn task-delete-btn" title="Delete task">
                            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% endif %}
    </div>

    <!-- Empty State (CROWN‚Å¥.5 Required ID) -->
    <div id="tasks-empty-state" class="empty-state" style="{% if tasks and tasks|length > 0 %}display: none;{% endif %}">
        <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
        </svg>
        <h3 class="text-xl font-semibold mb-2">No tasks yet</h3>
        <p class="text-secondary mb-6">Tasks from your meetings will appear here</p>
        <button class="btn btn-primary" id="empty-state-create-btn">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            Create your first task
        </button>
    </div>
</div>

<!-- Task Creation Modal (Crown+ Glassmorphism) -->
<div id="task-modal-overlay" class="task-modal-overlay">
    <div class="task-modal">
        <div class="task-modal-header">
            <h2 class="task-modal-title">Create New Task</h2>
            <button class="task-modal-close" id="task-modal-close">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <form id="task-create-form">
            <!-- Title (Required) -->
            <div class="task-form-group">
                <label class="task-form-label required" for="task-title">Task Title</label>
                <input 
                    type="text" 
                    id="task-title" 
                    class="task-form-input" 
                    placeholder="What needs to be done?"
                    required
                    autocomplete="off"
                >
            </div>
            
            <!-- Description (Optional) -->
            <div class="task-form-group">
                <label class="task-form-label" for="task-description">Description</label>
                <textarea 
                    id="task-description" 
                    class="task-form-textarea" 
                    placeholder="Add more details..."
                ></textarea>
            </div>
            
            <!-- Priority -->
            <div class="task-form-group">
                <label class="task-form-label" for="task-priority">Priority</label>
                <select id="task-priority" class="task-form-select">
                    <option value="low">Low</option>
                    <option value="medium" selected>Medium</option>
                    <option value="high">High</option>
                    <option value="urgent">Urgent</option>
                </select>
            </div>
            
            <!-- Due Date (Optional) -->
            <div class="task-form-group">
                <label class="task-form-label" for="task-due-date">Due Date</label>
                <input 
                    type="date" 
                    id="task-due-date" 
                    class="task-form-input"
                >
            </div>
            
            <!-- Assignee (Optional) -->
            <div class="task-form-group">
                <label class="task-form-label" for="task-assignee">Assignee</label>
                <input 
                    type="text" 
                    id="task-assignee" 
                    class="task-form-input" 
                    placeholder="Who's responsible?"
                    autocomplete="off"
                >
            </div>
            
            <!-- Actions -->
            <div class="task-form-actions">
                <button type="button" class="task-form-btn task-form-btn-cancel" id="task-form-cancel">
                    Cancel
                </button>
                <button type="submit" class="task-form-btn task-form-btn-create" id="task-form-submit">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: inline-block; margin-right: 8px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Create Task
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Snooze Duration Picker Modal -->
<div id="snooze-modal-overlay" class="task-modal-overlay" style="display: none;">
    <div class="task-modal" style="max-width: 400px;">
        <div class="task-modal-header">
            <h2 class="task-modal-title">Snooze Task</h2>
            <button class="task-modal-close" id="snooze-modal-close">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <div style="padding: var(--space-6); padding-top: 0;">
            <p class="text-secondary mb-4" id="snooze-task-title">Snooze this task until...</p>
            
            <div class="snooze-options">
                <button class="snooze-option-btn" data-duration="1h">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span>1 Hour</span>
                </button>
                <button class="snooze-option-btn" data-duration="4h">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span>4 Hours</span>
                </button>
                <button class="snooze-option-btn" data-duration="tomorrow">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <span>Tomorrow</span>
                </button>
                <button class="snooze-option-btn" data-duration="1w">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <span>1 Week</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Merge Task Selector Modal -->
<div id="merge-modal-overlay" class="task-modal-overlay" style="display: none;">
    <div class="task-modal" style="max-width: 600px;">
        <div class="task-modal-header">
            <h2 class="task-modal-title">Merge Tasks</h2>
            <button class="task-modal-close" id="merge-modal-close">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <div style="padding: var(--space-6); padding-top: 0;">
            <p class="text-secondary mb-4" id="merge-task-title">Select a task to merge with:</p>
            
            <div id="merge-task-list" class="merge-task-list">
                <!-- Task options will be populated dynamically -->
            </div>
            
            <div class="mt-6 text-sm text-secondary">
                <p><strong>Note:</strong> The selected task will be merged into the current task. All labels, dates, and metadata will be combined.</p>
            </div>
        </div>
    </div>
</div>

<script nonce="{{ g.csp_nonce }}">
/**
 * Tasks Page - Real-time WebSocket Integration
 * CROWN‚Å¥ Event Handling for Live Task Updates
 */

(function() {
    'use strict';
    
    // Get user context for WebSocket authentication
    window.CURRENT_USER_ID = {{ current_user.id if current_user.is_authenticated else 'null' }};
    window.WORKSPACE_ID = {{ current_user.workspace_id if current_user.workspace_id else 'null' }};
    window.CURRENT_SESSION_ID = null; // Will be set dynamically when session is active
    
    const WORKSPACE_ID = window.WORKSPACE_ID;
    
    // Cache DOM elements
    const filterCounts = {
        all: document.querySelector('.filter-tab[data-filter="all"] .px-2'),
        pending: document.querySelector('.filter-tab[data-filter="pending"] .px-2'),
        completed: document.querySelector('.filter-tab[data-filter="completed"] .px-2')
    };
    
    const tasksContainer = document.querySelector('.tasks-container > div:last-of-type');
    const emptyStateEl = document.querySelector('.empty-state');
    
    /**
     * Initialize WebSocket connection for tasks page
     */
    function initTasksWebSocket() {
        console.log('üöÄ Initializing tasks WebSocket...');
        
        // Initialize WebSocket manager with tasks namespace
        if (!window.wsManager) {
            console.error('‚ùå WebSocket manager not found');
            return;
        }
        
        // Connect to tasks namespace
        window.wsManager.connect('tasks');
        
        // Listen for task_update events
        window.wsManager.on('task_update', handleTaskUpdate);
        
        console.log('üì° Tasks WebSocket listeners registered');
    }
    
    /**
     * Handle task update event
     * @param {Object} data - Event data with task information
     */
    function handleTaskUpdate(data) {
        console.log('‚úÖ Task update event received:', data);
        
        const taskData = data.data || data;
        const action = taskData.action; // 'created', 'updated', 'deleted', 'completed'
        
        switch (action) {
            case 'created':
                handleTaskCreated(taskData);
                break;
            case 'updated':
                handleTaskUpdated(taskData);
                break;
            case 'deleted':
                handleTaskDeleted(taskData);
                break;
            case 'completed':
                handleTaskCompleted(taskData);
                break;
        }
    }
    
    /**
     * Handle new task created
     * @param {Object} taskData - Task data
     */
    function handleTaskCreated(taskData) {
        const task = taskData.task || taskData;
        
        // Remove empty state if present
        if (emptyStateEl && emptyStateEl.style.display !== 'none') {
            emptyStateEl.style.opacity = '0';
            setTimeout(() => {
                emptyStateEl.style.display = 'none';
            }, 300);
        }
        
        // Create task card HTML
        const cardHTML = createTaskCardHTML(task);
        
        // Insert at top of list
        if (tasksContainer && !emptyStateEl.parentElement.contains(emptyStateEl)) {
            tasksContainer.insertAdjacentHTML('afterbegin', cardHTML);
        }
        
        // Show notification
        showNotification('New task created', task.description || 'A new task has been added');
    }
    
    /**
     * Handle task updated
     * @param {Object} taskData - Task data
     */
    function handleTaskUpdated(taskData) {
        const task = taskData.task || taskData;
        const taskCard = document.querySelector(`[data-task-id="${task.id}"]`);
        
        if (taskCard) {
            // Update task title
            const titleEl = taskCard.querySelector('.task-title');
            if (titleEl) titleEl.textContent = task.description || 'Untitled Task';
            
            // Update priority badge
            const priorityBadge = taskCard.querySelector('.priority-badge');
            if (priorityBadge && task.priority) {
                priorityBadge.className = `priority-badge priority-${task.priority.toLowerCase()}`;
                priorityBadge.textContent = task.priority;
            }
            
            // Add update animation
            taskCard.style.animation = 'taskUpdate 0.5s ease-out';
            setTimeout(() => {
                taskCard.style.animation = '';
            }, 500);
        }
    }
    
    /**
     * Handle task deleted
     * @param {Object} taskData - Task data
     */
    function handleTaskDeleted(taskData) {
        const task = taskData.task || taskData;
        const taskCard = document.querySelector(`[data-task-id="${task.id}"]`);
        
        if (taskCard) {
            // Fade out and remove
            taskCard.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
            taskCard.style.opacity = '0';
            taskCard.style.transform = 'translateX(-20px)';
            
            setTimeout(() => {
                taskCard.remove();
                
                // Show empty state if no tasks left
                const remainingTasks = document.querySelectorAll('.task-card').length;
                if (remainingTasks === 0 && emptyStateEl) {
                    emptyStateEl.style.display = 'block';
                    emptyStateEl.style.opacity = '1';
                }
            }, 300);
        }
    }
    
    /**
     * Handle task completed
     * @param {Object} taskData - Task data
     */
    function handleTaskCompleted(taskData) {
        const task = taskData.task || taskData;
        const taskCard = document.querySelector(`[data-task-id="${task.id}"]`);
        
        if (taskCard) {
            const checkbox = taskCard.querySelector('.task-checkbox');
            
            if (task.completed) {
                taskCard.classList.add('completed');
                taskCard.dataset.status = 'completed';
                if (checkbox) checkbox.checked = true;
            } else {
                taskCard.classList.remove('completed');
                taskCard.dataset.status = 'pending';
                if (checkbox) checkbox.checked = false;
            }
            
            // Add completion animation
            if (task.completed) {
                taskCard.style.animation = 'taskComplete 0.5s ease-out';
                setTimeout(() => {
                    taskCard.style.animation = '';
                }, 500);
            }
        }
    }
    
    /**
     * Create task card HTML
     * @param {Object} task - Task data
     * @returns {string} HTML string
     */
    function createTaskCardHTML(task) {
        const priority = task.priority || 'medium';
        const completed = task.completed || false;
        const status = completed ? 'completed' : 'pending';
        
        return `
            <div class="task-card ${completed ? 'completed' : ''}" 
                 data-status="${status}" 
                 data-task-id="${task.id}"
                 style="animation: slideInFromTop 0.5s ease-out;">
                <div class="flex items-start gap-4">
                    <input type="checkbox" ${completed ? 'checked' : ''} class="task-checkbox">
                    <div class="flex-1">
                        <h3 class="task-title">${escapeHtml(task.description || 'Untitled Task')}</h3>
                        <p class="task-meta">
                            <svg class="inline-block w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            From: <span class="font-medium">${escapeHtml(task.meeting_title || 'Unknown meeting')}</span>
                        </p>
                        <div class="flex gap-2 flex-wrap">
                            <span class="priority-badge priority-${priority.toLowerCase()}">
                                ${priority}
                            </span>
                            ${task.due_date ? `
                                <span class="due-date-badge">
                                    <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    ${task.due_date}
                                </span>
                            ` : `
                                <span class="due-date-badge">
                                    <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    No due date
                                </span>
                            `}
                            ${task.assignee ? `
                                <span class="due-date-badge">
                                    <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                    </svg>
                                    ${escapeHtml(task.assignee)}
                                </span>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    /**
     * Setup filter tab handlers (CROWN‚Å¥.5 Architecture)
     * Proper implementation: Update viewState ‚Üí Fetch filtered tasks ‚Üí Re-render
     */
    function setupFilterTabs() {
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', async () => {
                const filter = tab.dataset.filter;
                
                console.log(`üîç Filter changed to: ${filter}`);
                
                // Update active tab visual state
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Update viewState in cache (persist filter preference)
                if (window.taskCache) {
                    await window.taskCache.setViewState({ activeFilter: filter });
                }
                
                // Fetch filtered tasks from cache
                const allTasks = await window.taskCache.getAllTasks();
                let filteredTasks = allTasks;
                
                if (filter === 'pending') {
                    filteredTasks = allTasks.filter(t => t.status === 'todo' || t.status === 'in_progress');
                } else if (filter === 'completed') {
                    filteredTasks = allTasks.filter(t => t.status === 'completed' || t.status === 'done');
                }
                
                console.log(`üìä Rendering ${filteredTasks.length} of ${allTasks.length} tasks (filter: ${filter})`);
                
                // Re-render with filtered tasks using TaskBootstrap
                if (window.taskBootstrap) {
                    await window.taskBootstrap.renderTasks(filteredTasks);
                    
                    // Update counters (always uses ALL tasks from cache)
                    await window.taskBootstrap.updateCounters(filteredTasks);
                }
            });
        });
    }
    
    /**
     * Show notification toast
     * @param {string} title - Notification title
     * @param {string} message - Notification message
     */
    function showNotification(title, message) {
        const notification = document.createElement('div');
        notification.className = 'notification-toast';
        notification.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            max-width: 400px;
            padding: 16px;
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            animation: slideInFromRight 0.3s ease-out;
        `;
        
        notification.innerHTML = `
            <div style="display: flex; gap: 12px; align-items: start;">
                <div style="flex-shrink: 0; width: 40px; height: 40px; background: var(--gradient-primary); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                    <svg width="20" height="20" fill="white" viewBox="0 0 24 24">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <div style="flex: 1;">
                    <p style="font-weight: 600; margin-bottom: 4px;">${escapeHtml(title)}</p>
                    <p style="font-size: 14px; color: var(--color-text-secondary);">${escapeHtml(message)}</p>
                </div>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            notification.style.animation = 'slideOutToRight 0.3s ease-out';
            setTimeout(() => notification.remove(), 300);
        }, 5000);
    }
    
    /**
     * Escape HTML to prevent XSS
     * @param {string} text - Text to escape
     * @returns {string} Escaped text
     */
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            initTasksWebSocket();
            setupFilterTabs();
        });
    } else {
        initTasksWebSocket();
        setupFilterTabs();
    }
    
    // Add CSS for animations
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideInFromTop {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInFromRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideOutToRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(20px);
            }
        }
        
        @keyframes taskUpdate {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.02);
                box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
            }
        }
        
        @keyframes taskComplete {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(0.98);
            }
            100% {
                transform: scale(1);
            }
        }
    `;
    document.head.appendChild(style);
    
})();
</script>

<!-- CROWN‚Å¥.5 Frontend Modules -->
<script src="{{ url_for('static', filename='js/crown-telemetry.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script src="{{ url_for('static', filename='js/quiet-state-manager.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script src="{{ url_for('static', filename='js/emotional-animations.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script src="{{ url_for('static', filename='js/task-cache.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script src="{{ url_for('static', filename='js/task-bootstrap.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script src="{{ url_for('static', filename='js/task-optimistic-ui.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script src="{{ url_for('static', filename='js/task-inline-editing.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script src="{{ url_for('static', filename='js/task-offline-queue.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script src="{{ url_for('static', filename='js/task-multi-tab-sync.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script src="{{ url_for('static', filename='js/task-websocket-handlers.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script src="{{ url_for('static', filename='js/task-virtual-list.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script src="{{ url_for('static', filename='js/task-proposal-ui.js') }}" nonce="{{ g.csp_nonce }}"></script>
<script src="{{ url_for('static', filename='js/task-keyboard-shortcuts.js') }}" nonce="{{ g.csp_nonce }}"></script>

<script nonce="{{ g.csp_nonce }}">
/**
 * CROWN‚Å¥.5 Tasks Page Initialization
 * Integrates all frontend modules for enterprise-grade task management
 */
(async function() {
    'use strict';
    
    console.log('üöÄ Initializing CROWN‚Å¥.5 Tasks Page...');
    
    // Initialize CROWN Telemetry FIRST (before other modules)
    if (window.CROWNTelemetry) {
        const CROWNTelemetryClass = window.CROWNTelemetry;
        const workspaceId = window.WORKSPACE_ID || 1;
        window.crownTelemetry = new CROWNTelemetryClass(workspaceId);
        await window.crownTelemetry.init();
        console.log('üìä CROWN Telemetry initialized');
        
        // Replace class with instance for backwards compatibility
        window.CROWNTelemetry = window.crownTelemetry;
    } else {
        console.warn('‚ö†Ô∏è CROWNTelemetry class not found');
    }
    
    // Wait for all modules to load
    const waitForModules = () => {
        return new Promise((resolve) => {
            const check = () => {
                if (window.taskCache && window.taskBootstrap && window.optimisticUI && 
                    window.offlineQueue && window.multiTabSync && window.tasksWS && 
                    window.taskVirtualList && window.taskShortcuts && window.TaskInlineEditing) {
                    resolve();
                } else {
                    setTimeout(check, 50);
                }
            };
            check();
        });
    };
    
    await waitForModules();
    console.log('‚úÖ All CROWN‚Å¥.5 modules loaded');
    
    window.taskInlineEditing = new window.TaskInlineEditing(window.optimisticUI);
    console.log('‚úèÔ∏è Inline editing initialized');
    
    window.taskProposalUI = new window.TaskProposalUI(window.optimisticUI);
    console.log('‚ú® AI proposal UI initialized');
    
    // Initialize cache-first bootstrap
    try {
        const startTime = performance.now();
        await window.taskBootstrap.bootstrap();
        const bootstrapTime = performance.now() - startTime;
        console.log(`‚ö° Bootstrap completed in ${bootstrapTime.toFixed(2)}ms`);
        
        // Log performance metrics
        if (bootstrapTime < 200) {
            console.log('üéØ CROWN‚Å¥.5 Target Met: <200ms first paint');
        } else {
            console.warn(`‚ö†Ô∏è Bootstrap slower than target: ${bootstrapTime.toFixed(2)}ms > 200ms`);
        }
    } catch (error) {
        console.error('‚ùå Bootstrap failed:', error);
    }
    
    // Modal elements
    const modalOverlay = document.getElementById('task-modal-overlay');
    const modalClose = document.getElementById('task-modal-close');
    const modalCancel = document.getElementById('task-form-cancel');
    const taskForm = document.getElementById('task-create-form');
    
    // Open modal function
    function openTaskModal() {
        modalOverlay.classList.add('active');
        document.getElementById('task-title').focus();
        // Reset form
        taskForm.reset();
    }
    
    // Close modal function
    function closeTaskModal() {
        modalOverlay.classList.remove('active');
    }
    
    // Setup task creation buttons
    const createButtons = document.querySelectorAll('.btn-primary');
    createButtons.forEach(btn => {
        if (btn.textContent.includes('New Task') || btn.textContent.includes('Create')) {
            btn.addEventListener('click', () => {
                openTaskModal();
            });
        }
    });
    
    // Empty state create button
    const emptyStateBtn = document.getElementById('empty-state-create-btn');
    if (emptyStateBtn) {
        emptyStateBtn.addEventListener('click', () => {
            openTaskModal();
        });
    }
    
    // Close modal handlers
    modalClose.addEventListener('click', closeTaskModal);
    modalCancel.addEventListener('click', closeTaskModal);
    modalOverlay.addEventListener('click', (e) => {
        if (e.target === modalOverlay) {
            closeTaskModal();
        }
    });
    
    // Keyboard shortcut - ESC to close
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modalOverlay.classList.contains('active')) {
            closeTaskModal();
        }
    });
    
    // Handle form submission
    taskForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const title = document.getElementById('task-title').value.trim();
        const description = document.getElementById('task-description').value.trim();
        const priority = document.getElementById('task-priority').value;
        const dueDate = document.getElementById('task-due-date').value;
        const assignee = document.getElementById('task-assignee').value.trim();
        
        if (!title) {
            alert('Please enter a task title');
            return;
        }
        
        try {
            const submitBtn = document.getElementById('task-form-submit');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating...';
            
            await window.optimisticUI.createTask({
                title: title,
                description: description || null,
                status: 'todo',
                priority: priority,
                due_date: dueDate || null,
                assignee: assignee || null
            });
            
            console.log('‚úÖ Task created');
            closeTaskModal();
            
            // Reset button
            submitBtn.disabled = false;
            submitBtn.innerHTML = `
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: inline-block; margin-right: 8px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                Create Task
            `;
        } catch (error) {
            console.error('‚ùå Failed to create task:', error);
            alert('Failed to create task. Please try again.');
            
            // Reset button
            const submitBtn = document.getElementById('task-form-submit');
            submitBtn.disabled = false;
            submitBtn.innerHTML = `
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: inline-block; margin-right: 8px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                Create Task
            `;
        }
    });
    
    // Wire up task checkboxes for status toggle (using event delegation)
    const tasksListContainer = document.getElementById('tasks-list-container');
    if (tasksListContainer) {
        tasksListContainer.addEventListener('change', async (e) => {
            if (e.target.classList.contains('task-checkbox')) {
                const taskCard = e.target.closest('.task-card');
                const taskId = taskCard.dataset.taskId;
                const isCompleted = e.target.checked;
                
                console.log(`üìù Toggling task ${taskId} to ${isCompleted ? 'completed' : 'pending'}`);
                
                try {
                    await window.optimisticUI.updateTask(taskId, {
                        completed: isCompleted,
                        status: isCompleted ? 'done' : 'todo'
                    });
                    console.log('‚úÖ Task status updated');
                } catch (error) {
                    console.error('‚ùå Failed to update task:', error);
                    // Revert checkbox on error
                    e.target.checked = !isCompleted;
                    alert('Failed to update task. Please try again.');
                }
            }
        });
        
        // Wire up delete buttons (using event delegation)
        tasksListContainer.addEventListener('click', async (e) => {
            const deleteBtn = e.target.closest('.task-delete-btn');
            if (deleteBtn) {
                const taskCard = deleteBtn.closest('.task-card');
                const taskId = taskCard.dataset.taskId;
                const taskTitle = taskCard.querySelector('.task-title').textContent;
                
                if (confirm(`Are you sure you want to delete "${taskTitle}"?`)) {
                    console.log(`üóëÔ∏è Deleting task ${taskId}`);
                    
                    try {
                        await window.optimisticUI.deleteTask(taskId);
                        console.log('‚úÖ Task deleted');
                    } catch (error) {
                        console.error('‚ùå Failed to delete task:', error);
                        alert('Failed to delete task. Please try again.');
                    }
                }
                return;
            }
            
            // Wire up label remove buttons (using event delegation)
            const labelRemoveBtn = e.target.closest('.label-remove-btn');
            if (labelRemoveBtn) {
                e.stopPropagation();
                const taskId = labelRemoveBtn.dataset.taskId;
                const label = labelRemoveBtn.dataset.label;
                
                console.log(`üè∑Ô∏è Removing label "${label}" from task ${taskId}`);
                
                try {
                    await window.optimisticUI.removeLabel(taskId, label);
                    console.log('‚úÖ Label removed');
                } catch (error) {
                    console.error('‚ùå Failed to remove label:', error);
                    alert('Failed to remove label. Please try again.');
                }
                return;
            }
            
            // Wire up label add buttons (using event delegation)
            const labelAddBtn = e.target.closest('.label-add-btn');
            if (labelAddBtn) {
                e.stopPropagation();
                const taskId = labelAddBtn.dataset.taskId;
                
                const label = prompt('Enter label name:');
                if (label && label.trim()) {
                    const trimmedLabel = label.trim();
                    console.log(`üè∑Ô∏è Adding label "${trimmedLabel}" to task ${taskId}`);
                    
                    try {
                        await window.optimisticUI.addLabel(taskId, trimmedLabel);
                        console.log('‚úÖ Label added');
                    } catch (error) {
                        console.error('‚ùå Failed to add label:', error);
                        alert('Failed to add label. Please try again.');
                    }
                }
                return;
            }
            
            // Wire up transcript link tracking (using event delegation)
            const transcriptLink = e.target.closest('.transcript-link-badge');
            if (transcriptLink) {
                const taskId = transcriptLink.dataset.taskId;
                
                // Track the jump-to-transcript event
                console.log(`üîó Jumping to transcript from task ${taskId}`);
                
                // Send event to server for tracking (non-blocking)
                fetch(`/api/tasks/${taskId}/track-transcript-jump`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin'
                }).catch(error => {
                    console.warn('Failed to track transcript jump:', error);
                });
                
                // Let the link navigate naturally (don't preventDefault)
                return;
            }
            
            // Wire up merge buttons (using event delegation)
            const mergeBtn = e.target.closest('.task-merge-btn');
            if (mergeBtn) {
                e.stopPropagation();
                const taskCard = mergeBtn.closest('.task-card');
                const taskId = taskCard.dataset.taskId;
                const taskTitle = taskCard.querySelector('.task-title').textContent;
                
                // Store task ID for merge modal
                window._mergeTargetTaskId = taskId;
                
                // Update modal title
                const mergeTitle = document.getElementById('merge-task-title');
                if (mergeTitle) {
                    mergeTitle.textContent = `Select a task to merge into "${taskTitle}":`;
                }
                
                // Populate merge task list with all other tasks
                const mergeTaskList = document.getElementById('merge-task-list');
                if (mergeTaskList) {
                    mergeTaskList.innerHTML = '';
                    
                    // Get all task cards except the current one
                    const allTaskCards = document.querySelectorAll('.task-card');
                    const otherTasks = Array.from(allTaskCards).filter(card => card.dataset.taskId !== taskId);
                    
                    if (otherTasks.length === 0) {
                        mergeTaskList.innerHTML = '<p class="text-secondary">No other tasks available to merge with.</p>';
                    } else {
                        otherTasks.forEach(card => {
                            const otherTaskId = card.dataset.taskId;
                            const otherTaskTitle = card.querySelector('.task-title').textContent;
                            const otherTaskPriority = card.dataset.priority || 'medium';
                            const otherTaskStatus = card.dataset.status || 'pending';
                            
                            const optionHTML = `
                                <div class="merge-task-option" data-task-id="${otherTaskId}">
                                    <div class="merge-task-option-title">${otherTaskTitle}</div>
                                    <div class="merge-task-option-meta">
                                        <span>Priority: ${otherTaskPriority}</span>
                                        <span>Status: ${otherTaskStatus}</span>
                                    </div>
                                </div>
                            `;
                            mergeTaskList.insertAdjacentHTML('beforeend', optionHTML);
                        });
                    }
                }
                
                // Show merge modal
                const mergeModal = document.getElementById('merge-modal-overlay');
                if (mergeModal) {
                    mergeModal.style.display = 'flex';
                }
                return;
            }
            
            // Wire up snooze buttons (using event delegation)
            const snoozeBtn = e.target.closest('.task-snooze-btn');
            if (snoozeBtn) {
                e.stopPropagation();
                const taskCard = snoozeBtn.closest('.task-card');
                const taskId = taskCard.dataset.taskId;
                const taskTitle = taskCard.querySelector('.task-title').textContent;
                
                // Store task ID for snooze modal
                window._snoozeTaskId = taskId;
                
                // Update modal title
                const snoozeTitle = document.getElementById('snooze-task-title');
                if (snoozeTitle) {
                    snoozeTitle.textContent = `Snooze "${taskTitle}" until...`;
                }
                
                // Show snooze modal
                const snoozeModal = document.getElementById('snooze-modal-overlay');
                if (snoozeModal) {
                    snoozeModal.style.display = 'flex';
                }
                return;
            }
        });
    }
    
    // Snooze modal handlers
    const snoozeModalOverlay = document.getElementById('snooze-modal-overlay');
    const snoozeModalClose = document.getElementById('snooze-modal-close');
    
    if (snoozeModalClose) {
        snoozeModalClose.addEventListener('click', () => {
            snoozeModalOverlay.style.display = 'none';
        });
    }
    
    if (snoozeModalOverlay) {
        snoozeModalOverlay.addEventListener('click', (e) => {
            if (e.target === snoozeModalOverlay) {
                snoozeModalOverlay.style.display = 'none';
            }
        });
        
        // Wire up snooze duration buttons
        const snoozeOptions = document.querySelectorAll('.snooze-option-btn');
        snoozeOptions.forEach(btn => {
            btn.addEventListener('click', async () => {
                const duration = btn.dataset.duration;
                const taskId = window._snoozeTaskId;
                
                if (!taskId) return;
                
                // Calculate snoozed_until timestamp
                const now = new Date();
                let snoozedUntil;
                
                switch (duration) {
                    case '1h':
                        snoozedUntil = new Date(now.getTime() + 60 * 60 * 1000);
                        break;
                    case '4h':
                        snoozedUntil = new Date(now.getTime() + 4 * 60 * 60 * 1000);
                        break;
                    case 'tomorrow':
                        snoozedUntil = new Date(now);
                        snoozedUntil.setDate(snoozedUntil.getDate() + 1);
                        snoozedUntil.setHours(9, 0, 0, 0);
                        break;
                    case '1w':
                        snoozedUntil = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
                        break;
                    default:
                        return;
                }
                
                console.log(`‚è∞ Snoozing task ${taskId} until ${snoozedUntil}`);
                
                try {
                    await window.optimisticUI.snoozeTask(taskId, snoozedUntil);
                    console.log('‚úÖ Task snoozed');
                    snoozeModalOverlay.style.display = 'none';
                    
                    if (window.showToast) {
                        window.showToast('Task snoozed successfully', 'success');
                    }
                } catch (error) {
                    console.error('‚ùå Failed to snooze task:', error);
                    alert('Failed to snooze task. Please try again.');
                }
            });
        });
    }
    
    // Merge modal handlers
    const mergeModalOverlay = document.getElementById('merge-modal-overlay');
    const mergeModalClose = document.getElementById('merge-modal-close');
    
    if (mergeModalClose) {
        mergeModalClose.addEventListener('click', () => {
            mergeModalOverlay.style.display = 'none';
        });
    }
    
    if (mergeModalOverlay) {
        mergeModalOverlay.addEventListener('click', (e) => {
            if (e.target === mergeModalOverlay) {
                mergeModalOverlay.style.display = 'none';
            }
        });
        
        // Wire up merge task option clicks (using event delegation)
        mergeModalOverlay.addEventListener('click', async (e) => {
            const mergeOption = e.target.closest('.merge-task-option');
            if (mergeOption) {
                const sourceTaskId = mergeOption.dataset.taskId;
                const targetTaskId = window._mergeTargetTaskId;
                
                if (!sourceTaskId || !targetTaskId) return;
                
                if (confirm('Are you sure you want to merge these tasks? This cannot be undone.')) {
                    console.log(`üîÄ Merging task ${sourceTaskId} into ${targetTaskId}`);
                    
                    try {
                        await window.optimisticUI.mergeTasks(sourceTaskId, targetTaskId);
                        console.log('‚úÖ Tasks merged');
                        mergeModalOverlay.style.display = 'none';
                        
                        if (window.showToast) {
                            window.showToast('Tasks merged successfully', 'success');
                        }
                    } catch (error) {
                        console.error('‚ùå Failed to merge tasks:', error);
                        alert('Failed to merge tasks. Please try again.');
                    }
                }
            }
        });
    }
    
    // Monitor online/offline status
    window.addEventListener('online', () => {
        console.log('üåê Back online - triggering sync');
        if (window.showToast) {
            window.showToast('Connection restored', 'info');
        }
    });
    
    window.addEventListener('offline', () => {
        console.log('üìµ Offline - operations will be queued');
        if (window.showToast) {
            window.showToast('Offline mode - changes will sync when online', 'warning');
        }
    });
    
    // Bulk Selection State
    const bulkSelection = new Set();
    const bulkToolbar = document.getElementById('bulk-action-toolbar');
    const bulkSelectedCount = document.getElementById('bulk-selected-count');
    
    function updateBulkToolbar() {
        const count = bulkSelection.size;
        if (count > 0) {
            bulkToolbar.style.display = 'flex';
            bulkSelectedCount.textContent = count;
        } else {
            bulkToolbar.style.display = 'none';
        }
    }
    
    // Bulk selection checkbox handler (using event delegation)
    document.addEventListener('change', (e) => {
        if (e.target.classList.contains('bulk-select-checkbox')) {
            const taskId = e.target.dataset.taskId;
            const taskCard = e.target.closest('.task-card');
            
            if (e.target.checked) {
                bulkSelection.add(taskId);
                taskCard.classList.add('bulk-selected');
            } else {
                bulkSelection.delete(taskId);
                taskCard.classList.remove('bulk-selected');
            }
            
            updateBulkToolbar();
            console.log(`üì¶ Bulk selection: ${bulkSelection.size} tasks selected`);
        }
    });
    
    // Bulk cancel button
    const bulkCancelBtn = document.getElementById('bulk-cancel-btn');
    if (bulkCancelBtn) {
        bulkCancelBtn.addEventListener('click', () => {
            // Uncheck all bulk selection checkboxes
            document.querySelectorAll('.bulk-select-checkbox:checked').forEach(checkbox => {
                checkbox.checked = false;
                const taskCard = checkbox.closest('.task-card');
                if (taskCard) {
                    taskCard.classList.remove('bulk-selected');
                }
            });
            bulkSelection.clear();
            updateBulkToolbar();
        });
    }
    
    // Bulk complete button
    const bulkCompleteBtn = document.getElementById('bulk-complete-btn');
    if (bulkCompleteBtn) {
        bulkCompleteBtn.addEventListener('click', async () => {
            const taskIds = Array.from(bulkSelection);
            if (taskIds.length === 0) return;
            
            console.log(`‚úÖ Bulk completing ${taskIds.length} tasks`);
            
            try {
                // Optimistic UI: mark all as completed
                taskIds.forEach(taskId => {
                    const taskCard = document.querySelector(`.task-card[data-task-id="${taskId}"]`);
                    if (taskCard) {
                        taskCard.classList.add('completed');
                        const checkbox = taskCard.querySelector('.task-checkbox');
                        if (checkbox) checkbox.checked = true;
                    }
                });
                
                // Send bulk update to server
                const response = await fetch('/api/tasks/bulk/complete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ task_ids: taskIds })
                });
                
                if (!response.ok) throw new Error('Bulk complete failed');
                
                const result = await response.json();
                console.log('‚úÖ Bulk complete successful:', result);
                
                // Clear selection
                document.querySelectorAll('.bulk-select-checkbox:checked').forEach(checkbox => {
                    checkbox.checked = false;
                    const taskCard = checkbox.closest('.task-card');
                    if (taskCard) {
                        taskCard.classList.remove('bulk-selected');
                    }
                });
                bulkSelection.clear();
                updateBulkToolbar();
                
                if (window.showToast) {
                    window.showToast(`${taskIds.length} tasks completed`, 'success');
                }
                
            } catch (error) {
                console.error('‚ùå Bulk complete failed:', error);
                
                // Rollback optimistic UI
                taskIds.forEach(taskId => {
                    const taskCard = document.querySelector(`.task-card[data-task-id="${taskId}"]`);
                    if (taskCard) {
                        taskCard.classList.remove('completed');
                        const checkbox = taskCard.querySelector('.task-checkbox');
                        if (checkbox) checkbox.checked = false;
                    }
                });
                
                alert('Failed to complete tasks. Please try again.');
            }
        });
    }
    
    // Bulk delete button
    const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
    if (bulkDeleteBtn) {
        bulkDeleteBtn.addEventListener('click', async () => {
            const taskIds = Array.from(bulkSelection);
            if (taskIds.length === 0) return;
            
            if (!confirm(`Are you sure you want to delete ${taskIds.length} tasks? This cannot be undone.`)) {
                return;
            }
            
            console.log(`üóëÔ∏è Bulk deleting ${taskIds.length} tasks`);
            
            // Save original cards for rollback
            const savedCards = new Map();
            
            try {
                // Optimistic UI: remove all cards
                taskIds.forEach(taskId => {
                    const taskCard = document.querySelector(`.task-card[data-task-id="${taskId}"]`);
                    if (taskCard) {
                        savedCards.set(taskId, taskCard.cloneNode(true));
                        taskCard.style.animation = 'fadeOut 0.3s ease-out';
                        setTimeout(() => taskCard.remove(), 300);
                    }
                });
                
                // Send bulk delete to server
                const response = await fetch('/api/tasks/bulk/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ task_ids: taskIds })
                });
                
                if (!response.ok) throw new Error('Bulk delete failed');
                
                const result = await response.json();
                console.log('‚úÖ Bulk delete successful:', result);
                
                // Clear selection
                bulkSelection.clear();
                updateBulkToolbar();
                
                if (window.showToast) {
                    window.showToast(`${taskIds.length} tasks deleted`, 'success');
                }
                
            } catch (error) {
                console.error('‚ùå Bulk delete failed:', error);
                
                // Rollback: restore cards
                const container = document.getElementById('tasks-list-container');
                savedCards.forEach((card, taskId) => {
                    container.appendChild(card);
                });
                
                alert('Failed to delete tasks. Please try again.');
            }
        });
    }
    
    // Bulk label button
    const bulkLabelBtn = document.getElementById('bulk-label-btn');
    if (bulkLabelBtn) {
        bulkLabelBtn.addEventListener('click', async () => {
            const taskIds = Array.from(bulkSelection);
            if (taskIds.length === 0) return;
            
            const label = prompt('Enter label to add to selected tasks:');
            if (!label || label.trim() === '') return;
            
            console.log(`üè∑Ô∏è Bulk adding label "${label}" to ${taskIds.length} tasks`);
            
            try {
                // Optimistic UI: add label to all cards
                taskIds.forEach(taskId => {
                    const taskCard = document.querySelector(`.task-card[data-task-id="${taskId}"]`);
                    if (taskCard) {
                        const labelsContainer = taskCard.querySelector('.task-labels');
                        if (labelsContainer) {
                            const labelBadge = document.createElement('span');
                            labelBadge.className = 'label-badge';
                            labelBadge.innerHTML = `
                                ${label.trim()}
                                <button class="label-remove-btn" data-task-id="${taskId}" data-label="${label.trim()}">√ó</button>
                            `;
                            labelsContainer.appendChild(labelBadge);
                        }
                    }
                });
                
                // Send bulk label update to server
                const response = await fetch('/api/tasks/bulk/label', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ 
                        task_ids: taskIds,
                        label: label.trim()
                    })
                });
                
                if (!response.ok) throw new Error('Bulk label failed');
                
                const result = await response.json();
                console.log('‚úÖ Bulk label successful:', result);
                
                // Clear selection
                document.querySelectorAll('.bulk-select-checkbox:checked').forEach(checkbox => {
                    checkbox.checked = false;
                    const taskCard = checkbox.closest('.task-card');
                    if (taskCard) {
                        taskCard.classList.remove('bulk-selected');
                    }
                });
                bulkSelection.clear();
                updateBulkToolbar();
                
                if (window.showToast) {
                    window.showToast(`Label "${label}" added to ${taskIds.length} tasks`, 'success');
                }
                
            } catch (error) {
                console.error('‚ùå Bulk label failed:', error);
                
                // Rollback: remove added labels
                taskIds.forEach(taskId => {
                    const taskCard = document.querySelector(`.task-card[data-task-id="${taskId}"]`);
                    if (taskCard) {
                        const labelsContainer = taskCard.querySelector('.task-labels');
                        if (labelsContainer) {
                            const addedLabel = labelsContainer.querySelector(`.label-badge:last-child`);
                            if (addedLabel) addedLabel.remove();
                        }
                    }
                });
                
                alert('Failed to add labels. Please try again.');
            }
        });
    }
    
    // Log system stats every 30 seconds
    setInterval(() => {
        const stats = {
            cache: window.taskCache.getStats(),
            virtualList: window.taskVirtualList.getStats(),
            online: navigator.onLine
        };
        console.log('üìä CROWN‚Å¥.5 Stats:', stats);
    }, 30000);
    
    console.log('‚ú® CROWN‚Å¥.5 Tasks Page Ready');
})();
</script>
{% endblock %}
