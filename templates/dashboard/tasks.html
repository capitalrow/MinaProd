{% extends "base.html" %}

{% block title %}Tasks - {{ super() }}{% endblock %}

{% block head %}
    <!-- Crown+ Design System -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/crown-base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/crown-design-system.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/crown-components.css') }}">
    
    <style>
        .tasks-container {
            min-height: 100vh;
            background: var(--bg-primary);
            padding: var(--spacing-6) var(--spacing-4);
        }
        
        .kanban-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-6);
            margin-top: var(--spacing-6);
        }
        
        .kanban-column {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border-radius: var(--radius-xl);
            border: 1px solid var(--border-subtle);
            overflow: hidden;
            min-height: 500px;
        }
        
        .kanban-header {
            padding: var(--spacing-6);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .kanban-title {
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-lg);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
        }
        
        .task-count {
            background: var(--color-accent-vibrant);
            color: white;
            padding: var(--spacing-1) var(--spacing-3);
            border-radius: var(--radius-full);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
        }
        
        .kanban-body {
            padding: var(--spacing-4);
        }
        
        .task-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: var(--spacing-4);
            margin-bottom: var(--spacing-3);
            cursor: move;
            transition: all var(--transition-normal);
        }
        
        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--border-interactive);
        }
        
        .task-title {
            font-weight: var(--font-weight-medium);
            font-size: var(--font-size-base);
            color: var(--text-primary);
            margin-bottom: var(--spacing-2);
        }
        
        .task-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }
        
        .task-priority {
            padding: var(--spacing-1) var(--spacing-3);
            border-radius: var(--radius-md);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
        }
        
        .priority-high { 
            background: rgba(239, 68, 68, 0.1); 
            color: var(--color-error-500); 
        }
        .priority-medium { 
            background: rgba(234, 179, 8, 0.1); 
            color: var(--color-warning-500); 
        }
        .priority-low { 
            background: rgba(34, 197, 94, 0.1); 
            color: var(--color-accent-500); 
        }
        
        .add-task-btn {
            width: 100%;
            padding: var(--spacing-3);
            border: 2px dashed var(--border-subtle);
            background: transparent;
            color: var(--text-secondary);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-2);
            font-size: var(--font-size-sm);
        }
        
        .add-task-btn:hover {
            border-color: var(--color-accent-vibrant);
            color: var(--color-accent-vibrant);
            background: var(--glass-bg-hover);
        }
    </style>
{% endblock %}

{% block content %}
    <div class="main-content">
        <!-- Tasks Header -->
        <div class="dashboard-header">
            <div class="header-content">
                <h1 class="dashboard-title">
                    <i class="fas fa-tasks"></i>
                    Tasks
                </h1>
                <div class="header-actions">
                    <button class="btn btn-outline-primary" id="refresh-tasks">
                        <i class="fas fa-sync-alt"></i>
                        Refresh
                    </button>
                    <button class="btn btn-primary" id="new-task">
                        <i class="fas fa-plus"></i>
                        New Task
                    </button>
                </div>
            </div>
        </div>

        <!-- Tasks Stats -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-list"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-number" id="total-tasks">0</h3>
                    <p class="stat-label">Total Tasks</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-play"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-number" id="todo-tasks">0</h3>
                    <p class="stat-label">To Do</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-spinner"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-number" id="progress-tasks">0</h3>
                    <p class="stat-label">In Progress</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-check"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-number" id="done-tasks">0</h3>
                    <p class="stat-label">Completed</p>
                </div>
            </div>
        </div>

        <!-- Kanban Board -->
        <div class="kanban-board">
            <!-- To Do Column -->
            <div class="kanban-column">
                <div class="kanban-header">
                    <h3 class="kanban-title">
                        <i class="fas fa-list"></i>
                        To Do
                    </h3>
                    <span class="task-count" id="todo-count">0</span>
                </div>
                <div class="kanban-body" id="todo-tasks-container">
                    <button class="add-task-btn" onclick="addTask('todo')">
                        <i class="fas fa-plus"></i>
                        Add Task
                    </button>
                </div>
            </div>
            
            <!-- In Progress Column -->
            <div class="kanban-column">
                <div class="kanban-header">
                    <h3 class="kanban-title">
                        <i class="fas fa-spinner"></i>
                        In Progress
                    </h3>
                    <span class="task-count" id="progress-count">0</span>
                </div>
                <div class="kanban-body" id="progress-tasks-container">
                    <button class="add-task-btn" onclick="addTask('progress')">
                        <i class="fas fa-plus"></i>
                        Add Task
                    </button>
                </div>
            </div>
            
            <!-- Done Column -->
            <div class="kanban-column">
                <div class="kanban-header">
                    <h3 class="kanban-title">
                        <i class="fas fa-check"></i>
                        Done
                    </h3>
                    <span class="task-count" id="done-count">0</span>
                </div>
                <div class="kanban-body" id="done-tasks-container">
                    <button class="add-task-btn" onclick="addTask('done')">
                        <i class="fas fa-plus"></i>
                        Add Task
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        // Initialize Feather icons
        // Note: Using Font Awesome icons consistently - no initialization needed
        
        class TaskManager {
            constructor() {
                this.tasks = [];
                this.init();
            }
            
            init() {
                this.loadTasks();
                this.setupEventListeners();
            }
            
            async loadTasks() {
                try {
                    // Load tasks from API or localStorage
                    const savedTasks = localStorage.getItem('mina-tasks');
                    if (savedTasks) {
                        this.tasks = JSON.parse(savedTasks);
                    } else {
                        // Sample tasks
                        this.tasks = [
                            {
                                id: '1',
                                title: 'Review meeting transcripts from last week',
                                status: 'todo',
                                priority: 'high',
                                createdAt: new Date().toISOString()
                            },
                            {
                                id: '2',
                                title: 'Update transcription settings',
                                status: 'progress',
                                priority: 'medium',
                                createdAt: new Date().toISOString()
                            },
                            {
                                id: '3',
                                title: 'Export monthly analytics report',
                                status: 'done',
                                priority: 'low',
                                createdAt: new Date().toISOString()
                            }
                        ];
                    }
                    
                    this.updateStats();
                    this.renderTasks();
                } catch (error) {
                    console.error('Failed to load tasks:', error);
                }
            }
            
            updateStats() {
                const todoTasks = this.tasks.filter(t => t.status === 'todo').length;
                const progressTasks = this.tasks.filter(t => t.status === 'progress').length;
                const doneTasks = this.tasks.filter(t => t.status === 'done').length;
                
                document.getElementById('total-tasks').textContent = this.tasks.length;
                document.getElementById('todo-tasks').textContent = todoTasks;
                document.getElementById('progress-tasks').textContent = progressTasks;
                document.getElementById('done-tasks').textContent = doneTasks;
                
                document.getElementById('todo-count').textContent = todoTasks;
                document.getElementById('progress-count').textContent = progressTasks;
                document.getElementById('done-count').textContent = doneTasks;
            }
            
            renderTasks() {
                this.renderTasksInColumn('todo', 'todo-tasks-container');
                this.renderTasksInColumn('progress', 'progress-tasks-container');
                this.renderTasksInColumn('done', 'done-tasks-container');
            }
            
            renderTasksInColumn(status, containerId) {
                const container = document.getElementById(containerId);
                const tasks = this.tasks.filter(task => task.status === status);
                
                // Clear existing tasks (keep add button)
                const addButton = container.querySelector('.add-task-btn');
                container.innerHTML = '';
                
                // Render tasks
                tasks.forEach(task => {
                    container.appendChild(this.createTaskElement(task));
                });
                
                // Re-add the add button
                container.appendChild(addButton);
            }
            
            createTaskElement(task) {
                const taskElement = document.createElement('div');
                taskElement.className = 'task-card';
                taskElement.draggable = true;
                taskElement.dataset.taskId = task.id;
                
                taskElement.innerHTML = `
                    <div class="task-title">${task.title}</div>
                    <div class="task-meta">
                        <span class="task-priority priority-${task.priority}">${task.priority}</span>
                        <span>${new Date(task.createdAt).toLocaleDateString()}</span>
                    </div>
                `;
                
                // Add drag and drop event listeners
                taskElement.addEventListener('dragstart', this.handleDragStart.bind(this));
                taskElement.addEventListener('dragend', this.handleDragEnd.bind(this));
                
                return taskElement;
            }
            
            handleDragStart(e) {
                e.dataTransfer.setData('text/plain', e.target.dataset.taskId);
                e.target.style.opacity = '0.5';
            }
            
            handleDragEnd(e) {
                e.target.style.opacity = '1';
            }
            
            setupEventListeners() {
                // Setup drop zones
                ['todo-tasks-container', 'progress-tasks-container', 'done-tasks-container'].forEach(containerId => {
                    const container = document.getElementById(containerId);
                    container.addEventListener('dragover', this.handleDragOver.bind(this));
                    container.addEventListener('drop', this.handleDrop.bind(this));
                });
                
                // New task button
                document.getElementById('new-task').addEventListener('click', () => {
                    this.showNewTaskDialog();
                });
                
                // Refresh button
                document.getElementById('refresh-tasks').addEventListener('click', () => {
                    this.loadTasks();
                });
            }
            
            handleDragOver(e) {
                e.preventDefault();
                e.currentTarget.style.backgroundColor = 'rgba(59, 130, 246, 0.1)';
            }
            
            handleDrop(e) {
                e.preventDefault();
                e.currentTarget.style.backgroundColor = '';
                
                const taskId = e.dataTransfer.getData('text/plain');
                const containerId = e.currentTarget.id;
                let newStatus;
                
                if (containerId === 'todo-tasks-container') newStatus = 'todo';
                else if (containerId === 'progress-tasks-container') newStatus = 'progress';
                else if (containerId === 'done-tasks-container') newStatus = 'done';
                
                this.updateTaskStatus(taskId, newStatus);
            }
            
            updateTaskStatus(taskId, newStatus) {
                const task = this.tasks.find(t => t.id === taskId);
                if (task) {
                    task.status = newStatus;
                    this.saveTasks();
                    this.updateStats();
                    this.renderTasks();
                }
            }
            
            showNewTaskDialog() {
                const title = prompt('Enter task title:');
                if (title) {
                    const priority = prompt('Enter priority (high, medium, low):') || 'medium';
                    this.addTask({
                        title,
                        status: 'todo',
                        priority,
                        createdAt: new Date().toISOString()
                    });
                }
            }
            
            addTask(taskData) {
                const task = {
                    id: Date.now().toString(),
                    ...taskData
                };
                
                this.tasks.push(task);
                this.saveTasks();
                this.updateStats();
                this.renderTasks();
            }
            
            saveTasks() {
                localStorage.setItem('mina-tasks', JSON.stringify(this.tasks));
            }
        }
        
        // Global function for add task buttons
        function addTask(status) {
            const title = prompt('Enter task title:');
            if (title) {
                const priority = prompt('Enter priority (high, medium, low):') || 'medium';
                window.taskManager.addTask({
                    title,
                    status,
                    priority,
                    createdAt: new Date().toISOString()
                });
            }
        }

        // Initialize task manager when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.taskManager = new TaskManager();
        });
    </script>
{% endblock %}