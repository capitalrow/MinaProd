{% extends "base.html" %}

{% block title %}Analytics - Mina{% endblock %}

{% block extra_css %}
<style>
/* Analytics Workspace - Properly Constrained */
.analytics-workspace {
    width: clamp(960px, 90vw, 1440px);
    max-width: 100%;
    min-height: calc(100vh - 64px);
    margin: 0 auto;
    padding: var(--space-8) var(--space-6);
}

.analytics-header {
    margin-bottom: var(--space-6);
    animation: fadeInUp 0.6s ease-out;
}

.analytics-title {
    font-size: var(--font-size-4xl);
    font-weight: var(--font-weight-bold);
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: var(--space-2);
}

.analytics-subtitle {
    color: var(--color-text-secondary);
    font-size: var(--font-size-lg);
}

/* KPI Cards Grid */
.kpi-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-4);
    margin-bottom: var(--space-6);
}

.kpi-card {
    background: var(--glass-bg);
    backdrop-filter: var(--backdrop-blur);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-xl);
    padding: var(--space-6);
    transition: all var(--transition-base);
    animation: fadeInUp 0.6s ease-out;
    animation-fill-mode: both;
    position: relative;
    overflow: hidden;
}

.kpi-card:nth-child(1) { animation-delay: 0.1s; }
.kpi-card:nth-child(2) { animation-delay: 0.2s; }
.kpi-card:nth-child(3) { animation-delay: 0.3s; }
.kpi-card:nth-child(4) { animation-delay: 0.4s; }

.kpi-card:hover {
    transform: translateY(-4px);
    border-color: var(--color-primary);
}

/* Chart Layout Grids */
.charts-primary-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: var(--space-6);
    margin-bottom: var(--space-6);
}

.charts-equal-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-6);
}

.charts-single {
    margin-bottom: var(--space-6);
}

.chart-card {
    background: var(--glass-bg);
    backdrop-filter: var(--backdrop-blur);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-xl);
    padding: var(--space-6);
    animation: fadeInUp 0.6s ease-out;
    animation-fill-mode: both;
}

/* Chart Frame Container for Controlled Sizing */
.chart-frame {
    position: relative;
    width: 100%;
    aspect-ratio: 16 / 9;
}

.chart-frame.chart-doughnut,
.chart-frame.chart-radar {
    aspect-ratio: 1 / 1;
    max-width: 420px;
    min-width: 280px;
    margin: 0 auto;
}

.chart-frame.chart-radar {
    transition: all var(--transition-base);
}

.chart-frame.chart-radar:hover {
    transform: scale(1.02);
}

.chart-frame canvas {
    width: 100% !important;
    height: 100% !important;
}

.analytics-tab {
    padding: var(--space-3) var(--space-4);
    background: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    color: var(--color-text-secondary);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-base);
}

.analytics-tab:hover {
    color: var(--color-text-primary);
    background: var(--color-surface-hover);
}

.analytics-tab.active {
    color: var(--color-primary);
    border-bottom-color: var(--color-primary);
}

.analytics-tab-content {
    display: none;
}

.analytics-tab-content.active {
    display: block;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive Breakpoints */

/* Tablets and smaller desktops (≤1280px) */
@media (max-width: 1280px) {
    .analytics-workspace {
        width: 100%;
    }
    
    .kpi-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

/* Tablets (≤1024px) */
@media (max-width: 1024px) {
    .charts-primary-grid,
    .charts-equal-grid {
        grid-template-columns: 1fr;
    }
}

/* Mobile (≤768px) */
@media (max-width: 768px) {
    .analytics-workspace {
        padding: var(--space-4);
    }
    
    .analytics-title {
        font-size: var(--font-size-2xl);
    }
    
    .kpi-grid {
        grid-template-columns: 1fr;
        gap: var(--space-3);
    }
    
    .analytics-header .flex {
        flex-direction: column;
        gap: var(--space-3);
    }
    
    .analytics-header .flex:last-child {
        width: 100%;
        flex-direction: row;
    }
    
    /* Constrain chart sizes on mobile */
    .chart-card {
        padding: var(--space-4);
    }
    
    /* Responsive circular charts on mobile */
    .chart-frame.chart-radar,
    .chart-frame.chart-doughnut {
        max-width: 340px;
        min-width: 260px;
    }
}

/* Small mobile (≤480px) */
@media (max-width: 480px) {
    .analytics-tab {
        padding: var(--space-2) var(--space-3);
        font-size: 0.875rem;
    }
    
    /* Optimize circular charts for small screens */
    .chart-frame.chart-radar,
    .chart-frame.chart-doughnut {
        max-width: 280px;
        min-width: 240px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="analytics-workspace">
    <!-- Header with Filters -->
    <div class="analytics-header">
        <div class="flex justify-between items-start mb-4">
            <div>
                <h1 class="analytics-title">Analytics</h1>
                <p class="analytics-subtitle">Insights from your meetings and productivity</p>
            </div>
            <div class="flex gap-3">
                <select class="p-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-sm">
                    <option value="7">Last 7 days</option>
                    <option value="30" selected>Last 30 days</option>
                    <option value="90">Last 90 days</option>
                    <option value="365">Last year</option>
                </select>
                <button class="btn btn-outline">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                    Export
                </button>
            </div>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid">
        <div class="kpi-card" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, transparent 100%);">
            <div class="flex justify-between items-start mb-2">
                <p class="text-tertiary text-sm font-medium">Total Meetings</p>
                <span class="px-2 py-1 rounded-full text-xs font-medium" style="background: rgba(34, 197, 94, 0.1); color: var(--color-success);">
                    +12%
                </span>
            </div>
            <p class="text-3xl font-bold mb-1">{{ total_meetings|default(0) }}</p>
            <p class="text-sm text-secondary">↑ 3 more than last month</p>
        </div>
        
        <div class="kpi-card" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, transparent 100%);">
            <div class="flex justify-between items-start mb-2">
                <p class="text-tertiary text-sm font-medium">Action Items</p>
                <span class="px-2 py-1 rounded-full text-xs font-medium" style="background: rgba(34, 197, 94, 0.1); color: var(--color-success);">
                    85%
                </span>
            </div>
            <p class="text-3xl font-bold mb-1">{{ total_tasks|default(0) }}</p>
            <p class="text-sm text-secondary">85% completion rate</p>
        </div>
        
        <div class="kpi-card" style="background: linear-gradient(135deg, rgba(6, 182, 212, 0.1) 0%, transparent 100%);">
            <div class="flex justify-between items-start mb-2">
                <p class="text-tertiary text-sm font-medium">Hours Saved</p>
                <span class="px-2 py-1 rounded-full text-xs font-medium" style="background: rgba(34, 197, 94, 0.1); color: var(--color-success);">
                    +8h
                </span>
            </div>
            <p class="text-3xl font-bold mb-1">{{ hours_saved|default(0) }}</p>
            <p class="text-sm text-secondary">This week vs last week</p>
        </div>
        
        <div class="kpi-card" style="background: linear-gradient(135deg, rgba(236, 72, 153, 0.1) 0%, transparent 100%);">
            <div class="flex justify-between items-start mb-2">
                <p class="text-tertiary text-sm font-medium">Avg Meeting Length</p>
                <span class="px-2 py-1 rounded-full text-xs font-medium" style="background: rgba(249, 115, 22, 0.1); color: var(--color-warning);">
                    →
                </span>
            </div>
            <p class="text-3xl font-bold mb-1">{{ avg_duration|default(45) }}m</p>
            <p class="text-sm text-secondary">Across all meetings</p>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="mb-6">
        <div class="flex gap-1 border-b border-gray-200 dark:border-gray-700">
            <button class="analytics-tab active" data-tab="overview">Overview</button>
            <button class="analytics-tab" data-tab="engagement">Engagement</button>
            <button class="analytics-tab" data-tab="productivity">Productivity</button>
            <button class="analytics-tab" data-tab="insights">Insights</button>
        </div>
    </div>

    <!-- Overview Tab -->
    <div id="tab-overview" class="analytics-tab-content active">
        <div class="charts-primary-grid">
            <div class="chart-card">
                <h2 class="text-lg font-semibold mb-4">Meeting Activity Trend</h2>
                <div class="chart-frame">
                    <canvas id="meetingActivityChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h2 class="text-lg font-semibold mb-4">Task Status</h2>
                <div class="chart-frame chart-doughnut">
                    <canvas id="taskStatusChart"></canvas>
                </div>
            </div>
        </div>

        <div class="charts-equal-grid">
            <div class="chart-card">
                <h2 class="text-lg font-semibold mb-4">Speaker Distribution</h2>
                <div class="chart-frame">
                    <canvas id="speakerChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h2 class="text-lg font-semibold mb-4">Top Topics</h2>
                <div style="display: flex; flex-direction: column; gap: var(--space-3); padding: var(--space-2) 0;">
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium">Product Strategy</span>
                            <span class="text-tertiary">45%</span>
                        </div>
                        <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                            <div class="h-full bg-primary" style="width: 45%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium">Engineering</span>
                            <span class="text-tertiary">30%</span>
                        </div>
                        <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                            <div class="h-full bg-purple-500" style="width: 30%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium">Design Review</span>
                            <span class="text-tertiary">25%</span>
                        </div>
                        <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                            <div class="h-full bg-cyan-500" style="width: 25%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Engagement Tab -->
    <div id="tab-engagement" class="analytics-tab-content">
        <div class="charts-equal-grid">
            <div class="chart-card">
                <h2 class="text-lg font-semibold mb-4">Participation Rate</h2>
                <div class="chart-frame chart-radar">
                    <canvas id="participationChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h2 class="text-lg font-semibold mb-4">Meeting Sentiment</h2>
                <div class="chart-frame">
                    <canvas id="sentimentChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Productivity Tab -->
    <div id="tab-productivity" class="analytics-tab-content">
        <div class="charts-single">
            <div class="chart-card">
                <h2 class="text-lg font-semibold mb-4">Task Completion Over Time</h2>
                <div class="chart-frame">
                    <canvas id="productivityChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Insights Tab -->
    <div id="tab-insights" class="analytics-tab-content">
        <div class="charts-equal-grid">
            <div class="chart-card">
                <h3 class="font-semibold mb-4">Key Insights</h3>
                <div style="display: flex; flex-direction: column; gap: var(--space-3);">
                    <div class="p-3 rounded-lg" style="background: rgba(34, 197, 94, 0.1); border-left: 3px solid var(--color-success);">
                        <p class="font-medium text-sm mb-1">High Completion Rate</p>
                        <p class="text-sm text-secondary">85% of tasks completed on time this month</p>
                    </div>
                    <div class="p-3 rounded-lg" style="background: rgba(249, 115, 22, 0.1); border-left: 3px solid var(--color-warning);">
                        <p class="font-medium text-sm mb-1">Long Meetings Trend</p>
                        <p class="text-sm text-secondary">Average meeting length increased by 12 minutes</p>
                    </div>
                    <div class="p-3 rounded-lg" style="background: rgba(99, 102, 241, 0.1); border-left: 3px solid var(--color-primary);">
                        <p class="font-medium text-sm mb-1">Active Participation</p>
                        <p class="text-sm text-secondary">More balanced speaking time distribution</p>
                    </div>
                </div>
            </div>

            <div class="chart-card">
                <h3 class="font-semibold mb-4">Recommendations</h3>
                <div style="display: flex; flex-direction: column; gap: var(--space-3);">
                    <div class="flex gap-3 items-start">
                        <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div>
                            <p class="font-medium text-sm mb-1">Schedule shorter meetings</p>
                            <p class="text-sm text-secondary">Consider 25-minute or 50-minute blocks</p>
                        </div>
                    </div>
                    <div class="flex gap-3 items-start">
                        <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div>
                            <p class="font-medium text-sm mb-1">Set task deadlines</p>
                            <p class="text-sm text-secondary">3 tasks have no due date assigned</p>
                        </div>
                    </div>
                    <div class="flex gap-3 items-start">
                        <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0"/>
                            </svg>
                        </div>
                        <div>
                            <p class="font-medium text-sm mb-1">Encourage participation</p>
                            <p class="text-sm text-secondary">2 members had minimal speaking time</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script nonce="{{ g.csp_nonce }}">
// Tab switching - runs immediately, doesn't need Chart.js
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.analytics-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const targetTab = tab.dataset.tab;
            
            document.querySelectorAll('.analytics-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.analytics-tab-content').forEach(c => c.classList.remove('active'));
            
            tab.classList.add('active');
            document.getElementById('tab-' + targetTab).classList.add('active');
        });
    });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script nonce="{{ g.csp_nonce }}">
// Chart.js initialization - waits for Chart.js to load
window.addEventListener('load', function() {
    if (typeof Chart === 'undefined') {
        console.error('Chart.js failed to load');
        return;
    }

    // Chart.js default config
    Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--color-text-primary').trim();
    Chart.defaults.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--color-border').trim();
    Chart.defaults.font.family = 'Inter, system-ui, -apple-system, sans-serif';

const primaryColor = 'rgb(99, 102, 241)';
const successColor = 'rgb(34, 197, 94)';
const warningColor = 'rgb(249, 115, 22)';
const purpleColor = 'rgb(139, 92, 246)';
const cyanColor = 'rgb(6, 182, 212)';

// Meeting Activity Chart (Area)
const meetingActivityCtx = document.getElementById('meetingActivityChart');
if (meetingActivityCtx) {
    new Chart(meetingActivityCtx, {
        type: 'line',
        data: {
            labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
            datasets: [{
                label: 'Meetings',
                data: [12, 19, 15, 22],
                borderColor: primaryColor,
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 1.8,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

// Task Status Chart (Donut)
const taskStatusCtx = document.getElementById('taskStatusChart');
if (taskStatusCtx) {
    new Chart(taskStatusCtx, {
        type: 'doughnut',
        data: {
            labels: ['Completed', 'In Progress', 'Pending'],
            datasets: [{
                data: [12, 5, 3],
                backgroundColor: [successColor, warningColor, 'rgb(156, 163, 175)'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 1,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
}

// Speaker Distribution Chart (Bar)
const speakerCtx = document.getElementById('speakerChart');
if (speakerCtx) {
    new Chart(speakerCtx, {
        type: 'bar',
        data: {
            labels: ['You', 'Sarah', 'Mike', 'Alex', 'Others'],
            datasets: [{
                label: 'Speaking Time (min)',
                data: [45, 38, 32, 28, 15],
                backgroundColor: [primaryColor, purpleColor, cyanColor, successColor, warningColor],
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 1.6,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

// Participation Chart
const participationCtx = document.getElementById('participationChart');
if (participationCtx) {
    new Chart(participationCtx, {
        type: 'radar',
        data: {
            labels: ['Contribution', 'Questions Asked', 'Ideas Shared', 'Active Listening', 'Follow-ups'],
            datasets: [{
                label: 'Your Team',
                data: [85, 72, 68, 90, 78],
                borderColor: primaryColor,
                backgroundColor: 'rgba(99, 102, 241, 0.25)',
                pointBackgroundColor: primaryColor,
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                borderWidth: 2.5,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointHoverBackgroundColor: primaryColor,
                pointHoverBorderColor: '#fff',
                pointHoverBorderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 1,
            scales: {
                r: { 
                    beginAtZero: true, 
                    max: 100,
                    ticks: {
                        stepSize: 20,
                        backdropColor: 'transparent'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.15)',
                        lineWidth: 1
                    },
                    angleLines: {
                        color: 'rgba(255, 255, 255, 0.15)',
                        lineWidth: 1
                    },
                    pointLabels: {
                        font: {
                            size: 13,
                            weight: '500'
                        },
                        color: 'rgba(255, 255, 255, 0.9)',
                        padding: 8
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: {
                            size: 12
                        }
                    }
                }
            }
        }
    });
}

// Sentiment Chart
const sentimentCtx = document.getElementById('sentimentChart');
if (sentimentCtx) {
    new Chart(sentimentCtx, {
        type: 'line',
        data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'],
            datasets: [
                {
                    label: 'Positive',
                    data: [75, 80, 72, 85, 88],
                    borderColor: successColor,
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Neutral',
                    data: [20, 15, 23, 12, 10],
                    borderColor: warningColor,
                    backgroundColor: 'rgba(249, 115, 22, 0.1)',
                    fill: true,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 1.6,
            plugins: {
                legend: { position: 'bottom' }
            },
            scales: {
                y: { beginAtZero: true, max: 100 }
            }
        }
    });
}

// Productivity Chart
const productivityCtx = document.getElementById('productivityChart');
if (productivityCtx) {
    new Chart(productivityCtx, {
        type: 'bar',
        data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [
                {
                    label: 'Completed',
                    data: [5, 7, 4, 8, 6, 2, 1],
                    backgroundColor: successColor,
                    stack: 'stack1'
                },
                {
                    label: 'In Progress',
                    data: [2, 3, 2, 1, 2, 1, 0],
                    backgroundColor: warningColor,
                    stack: 'stack1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2.2,
            plugins: {
                legend: { position: 'bottom' }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}
}); // End of window load event
</script>
{% endblock %}
