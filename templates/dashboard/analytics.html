{% extends "base.html" %}

{% block title %}Analytics - Mina{% endblock %}

{% block content %}
<div class="container" style="padding-top: var(--space-6); padding-bottom: var(--space-8); max-width: 1400px;">
    <!-- Header with Filters -->
    <div class="mb-6">
        <div class="flex justify-between items-start mb-4">
            <div>
                <h1 class="text-3xl font-bold mb-1">Analytics</h1>
                <p class="text-secondary">Insights from your meetings and productivity</p>
            </div>
            <div class="flex gap-3">
                <select class="p-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-sm">
                    <option value="7">Last 7 days</option>
                    <option value="30" selected>Last 30 days</option>
                    <option value="90">Last 90 days</option>
                    <option value="365">Last year</option>
                </select>
                <button class="btn btn-outline">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                    Export
                </button>
            </div>
        </div>
    </div>

    <!-- KPI Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-6);">
        <div class="card" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, transparent 100%);">
            <div class="flex justify-between items-start mb-2">
                <p class="text-tertiary text-sm font-medium">Total Meetings</p>
                <span class="px-2 py-1 rounded-full text-xs font-medium" style="background: rgba(34, 197, 94, 0.1); color: var(--color-success);">
                    +12%
                </span>
            </div>
            <p class="text-3xl font-bold mb-1">{{ total_meetings|default(0) }}</p>
            <p class="text-sm text-secondary">↑ 3 more than last month</p>
        </div>
        
        <div class="card" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, transparent 100%);">
            <div class="flex justify-between items-start mb-2">
                <p class="text-tertiary text-sm font-medium">Action Items</p>
                <span class="px-2 py-1 rounded-full text-xs font-medium" style="background: rgba(34, 197, 94, 0.1); color: var(--color-success);">
                    85%
                </span>
            </div>
            <p class="text-3xl font-bold mb-1">{{ total_tasks|default(0) }}</p>
            <p class="text-sm text-secondary">85% completion rate</p>
        </div>
        
        <div class="card" style="background: linear-gradient(135deg, rgba(6, 182, 212, 0.1) 0%, transparent 100%);">
            <div class="flex justify-between items-start mb-2">
                <p class="text-tertiary text-sm font-medium">Hours Saved</p>
                <span class="px-2 py-1 rounded-full text-xs font-medium" style="background: rgba(34, 197, 94, 0.1); color: var(--color-success);">
                    +8h
                </span>
            </div>
            <p class="text-3xl font-bold mb-1">{{ hours_saved|default(0) }}</p>
            <p class="text-sm text-secondary">This week vs last week</p>
        </div>
        
        <div class="card" style="background: linear-gradient(135deg, rgba(236, 72, 153, 0.1) 0%, transparent 100%);">
            <div class="flex justify-between items-start mb-2">
                <p class="text-tertiary text-sm font-medium">Avg Meeting Length</p>
                <span class="px-2 py-1 rounded-full text-xs font-medium" style="background: rgba(249, 115, 22, 0.1); color: var(--color-warning);">
                    →
                </span>
            </div>
            <p class="text-3xl font-bold mb-1">{{ avg_duration|default(45) }}m</p>
            <p class="text-sm text-secondary">Across all meetings</p>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="mb-6">
        <div class="flex gap-1 border-b border-gray-200 dark:border-gray-700">
            <button class="analytics-tab active" data-tab="overview">Overview</button>
            <button class="analytics-tab" data-tab="engagement">Engagement</button>
            <button class="analytics-tab" data-tab="productivity">Productivity</button>
            <button class="analytics-tab" data-tab="insights">Insights</button>
        </div>
    </div>

    <!-- Overview Tab -->
    <div id="tab-overview" class="analytics-tab-content active">
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--space-6); margin-bottom: var(--space-6);">
            <div class="card">
                <h2 class="text-lg font-semibold mb-4">Meeting Activity Trend</h2>
                <canvas id="meetingActivityChart" height="280"></canvas>
            </div>

            <div class="card">
                <h2 class="text-lg font-semibold mb-4">Task Status</h2>
                <canvas id="taskStatusChart" height="280"></canvas>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-6);">
            <div class="card">
                <h2 class="text-lg font-semibold mb-4">Speaker Distribution</h2>
                <canvas id="speakerChart" height="220"></canvas>
            </div>

            <div class="card">
                <h2 class="text-lg font-semibold mb-4">Top Topics</h2>
                <div style="display: flex; flex-direction: column; gap: var(--space-3); padding: var(--space-2) 0;">
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium">Product Strategy</span>
                            <span class="text-tertiary">45%</span>
                        </div>
                        <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                            <div class="h-full bg-primary" style="width: 45%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium">Engineering</span>
                            <span class="text-tertiary">30%</span>
                        </div>
                        <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                            <div class="h-full bg-purple-500" style="width: 30%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium">Design Review</span>
                            <span class="text-tertiary">25%</span>
                        </div>
                        <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                            <div class="h-full bg-cyan-500" style="width: 25%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Engagement Tab -->
    <div id="tab-engagement" class="analytics-tab-content">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-6);">
            <div class="card">
                <h2 class="text-lg font-semibold mb-4">Participation Rate</h2>
                <canvas id="participationChart" height="280"></canvas>
            </div>

            <div class="card">
                <h2 class="text-lg font-semibold mb-4">Meeting Sentiment</h2>
                <canvas id="sentimentChart" height="280"></canvas>
            </div>
        </div>
    </div>

    <!-- Productivity Tab -->
    <div id="tab-productivity" class="analytics-tab-content">
        <div class="card">
            <h2 class="text-lg font-semibold mb-4">Task Completion Over Time</h2>
            <canvas id="productivityChart" height="280"></canvas>
        </div>
    </div>

    <!-- Insights Tab -->
    <div id="tab-insights" class="analytics-tab-content">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-6);">
            <div class="card">
                <h3 class="font-semibold mb-4">Key Insights</h3>
                <div style="display: flex; flex-direction: column; gap: var(--space-3);">
                    <div class="p-3 rounded-lg" style="background: rgba(34, 197, 94, 0.1); border-left: 3px solid var(--color-success);">
                        <p class="font-medium text-sm mb-1">High Completion Rate</p>
                        <p class="text-sm text-secondary">85% of tasks completed on time this month</p>
                    </div>
                    <div class="p-3 rounded-lg" style="background: rgba(249, 115, 22, 0.1); border-left: 3px solid var(--color-warning);">
                        <p class="font-medium text-sm mb-1">Long Meetings Trend</p>
                        <p class="text-sm text-secondary">Average meeting length increased by 12 minutes</p>
                    </div>
                    <div class="p-3 rounded-lg" style="background: rgba(99, 102, 241, 0.1); border-left: 3px solid var(--color-primary);">
                        <p class="font-medium text-sm mb-1">Active Participation</p>
                        <p class="text-sm text-secondary">More balanced speaking time distribution</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 class="font-semibold mb-4">Recommendations</h3>
                <div style="display: flex; flex-direction: column; gap: var(--space-3);">
                    <div class="flex gap-3 items-start">
                        <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div>
                            <p class="font-medium text-sm mb-1">Schedule shorter meetings</p>
                            <p class="text-sm text-secondary">Consider 25-minute or 50-minute blocks</p>
                        </div>
                    </div>
                    <div class="flex gap-3 items-start">
                        <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div>
                            <p class="font-medium text-sm mb-1">Set task deadlines</p>
                            <p class="text-sm text-secondary">3 tasks have no due date assigned</p>
                        </div>
                    </div>
                    <div class="flex gap-3 items-start">
                        <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0"/>
                            </svg>
                        </div>
                        <div>
                            <p class="font-medium text-sm mb-1">Encourage participation</p>
                            <p class="text-sm text-secondary">2 members had minimal speaking time</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.analytics-tab {
    padding: var(--space-3) var(--space-4);
    background: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    color: var(--color-text-secondary);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.analytics-tab:hover {
    color: var(--color-text-primary);
    background: var(--color-surface-hover);
}

.analytics-tab.active {
    color: var(--color-primary);
    border-bottom-color: var(--color-primary);
}

.analytics-tab-content {
    display: none;
}

.analytics-tab-content.active {
    display: block;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Tab switching
document.querySelectorAll('.analytics-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        const targetTab = tab.dataset.tab;
        
        document.querySelectorAll('.analytics-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.analytics-tab-content').forEach(c => c.classList.remove('active'));
        
        tab.classList.add('active');
        document.getElementById('tab-' + targetTab).classList.add('active');
    });
});

// Chart.js default config
Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--color-text-primary').trim();
Chart.defaults.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--color-border').trim();
Chart.defaults.font.family = 'Inter, system-ui, -apple-system, sans-serif';

const primaryColor = 'rgb(99, 102, 241)';
const successColor = 'rgb(34, 197, 94)';
const warningColor = 'rgb(249, 115, 22)';
const purpleColor = 'rgb(139, 92, 246)';
const cyanColor = 'rgb(6, 182, 212)';

// Meeting Activity Chart (Area)
const meetingActivityCtx = document.getElementById('meetingActivityChart');
if (meetingActivityCtx) {
    new Chart(meetingActivityCtx, {
        type: 'line',
        data: {
            labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
            datasets: [{
                label: 'Meetings',
                data: [12, 19, 15, 22],
                borderColor: primaryColor,
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

// Task Status Chart (Donut)
const taskStatusCtx = document.getElementById('taskStatusChart');
if (taskStatusCtx) {
    new Chart(taskStatusCtx, {
        type: 'doughnut',
        data: {
            labels: ['Completed', 'In Progress', 'Pending'],
            datasets: [{
                data: [12, 5, 3],
                backgroundColor: [successColor, warningColor, 'rgb(156, 163, 175)'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
}

// Speaker Distribution Chart (Bar)
const speakerCtx = document.getElementById('speakerChart');
if (speakerCtx) {
    new Chart(speakerCtx, {
        type: 'bar',
        data: {
            labels: ['You', 'Sarah', 'Mike', 'Alex', 'Others'],
            datasets: [{
                label: 'Speaking Time (min)',
                data: [45, 38, 32, 28, 15],
                backgroundColor: [primaryColor, purpleColor, cyanColor, successColor, warningColor],
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

// Participation Chart
const participationCtx = document.getElementById('participationChart');
if (participationCtx) {
    new Chart(participationCtx, {
        type: 'radar',
        data: {
            labels: ['Contribution', 'Questions Asked', 'Ideas Shared', 'Active Listening', 'Follow-ups'],
            datasets: [{
                label: 'Your Team',
                data: [85, 72, 68, 90, 78],
                borderColor: primaryColor,
                backgroundColor: 'rgba(99, 102, 241, 0.2)',
                pointBackgroundColor: primaryColor
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: { beginAtZero: true, max: 100 }
            }
        }
    });
}

// Sentiment Chart
const sentimentCtx = document.getElementById('sentimentChart');
if (sentimentCtx) {
    new Chart(sentimentCtx, {
        type: 'line',
        data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'],
            datasets: [
                {
                    label: 'Positive',
                    data: [75, 80, 72, 85, 88],
                    borderColor: successColor,
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Neutral',
                    data: [20, 15, 23, 12, 10],
                    borderColor: warningColor,
                    backgroundColor: 'rgba(249, 115, 22, 0.1)',
                    fill: true,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            },
            scales: {
                y: { beginAtZero: true, max: 100 }
            }
        }
    });
}

// Productivity Chart
const productivityCtx = document.getElementById('productivityChart');
if (productivityCtx) {
    new Chart(productivityCtx, {
        type: 'bar',
        data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [
                {
                    label: 'Completed',
                    data: [5, 7, 4, 8, 6, 2, 1],
                    backgroundColor: successColor,
                    stack: 'stack1'
                },
                {
                    label: 'In Progress',
                    data: [2, 3, 2, 1, 2, 1, 0],
                    backgroundColor: warningColor,
                    stack: 'stack1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}
</script>
{% endblock %}
