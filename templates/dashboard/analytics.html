{% extends "base.html" %}

{% block title %}Analytics - Mina{% endblock %}

{% block extra_css %}
<style>
/* Analytics Workspace - Properly Constrained */
.analytics-workspace {
    width: clamp(960px, 90vw, 1440px);
    max-width: 100%;
    min-height: calc(100vh - 64px);
    margin: 0 auto;
    padding: var(--space-8) var(--space-6);
}

.analytics-header {
    margin-bottom: var(--space-6);
    animation: fadeInUp 0.6s ease-out;
}

.analytics-title {
    font-size: var(--font-size-4xl);
    font-weight: var(--font-weight-bold);
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: var(--space-2);
}

.analytics-subtitle {
    color: var(--color-text-secondary);
    font-size: var(--font-size-lg);
}

/* KPI Cards Grid */
.kpi-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-4);
    margin-bottom: var(--space-6);
}

.kpi-card {
    background: var(--glass-bg);
    backdrop-filter: var(--backdrop-blur);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-xl);
    padding: var(--space-6);
    transition: all var(--transition-base);
    animation: fadeInUp 0.6s ease-out;
    animation-fill-mode: both;
    position: relative;
    overflow: hidden;
}

.kpi-card:nth-child(1) { animation-delay: 0.1s; }
.kpi-card:nth-child(2) { animation-delay: 0.2s; }
.kpi-card:nth-child(3) { animation-delay: 0.3s; }
.kpi-card:nth-child(4) { animation-delay: 0.4s; }

.kpi-card:hover {
    transform: translateY(-4px);
    border-color: var(--color-primary);
}

/* Chart Layout Grids */
.charts-primary-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: var(--space-6);
    margin-bottom: var(--space-6);
}

.charts-equal-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-6);
}

.charts-single {
    margin-bottom: var(--space-6);
}

.chart-card {
    background: var(--glass-bg);
    backdrop-filter: var(--backdrop-blur);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-xl);
    padding: var(--space-6);
    animation: fadeInUp 0.6s ease-out;
    animation-fill-mode: both;
}

/* Chart Frame Container for Controlled Sizing */
.chart-frame {
    position: relative;
    width: 100%;
    aspect-ratio: 16 / 9;
}

.chart-frame.chart-doughnut,
.chart-frame.chart-radar {
    aspect-ratio: 1 / 1;
    max-width: 420px;
    min-width: 280px;
    margin: 0 auto;
}

.chart-frame.chart-radar {
    transition: all var(--transition-base);
}

.chart-frame.chart-radar:hover {
    transform: scale(1.02);
}

.chart-frame canvas {
    width: 100% !important;
    height: 100% !important;
}

.analytics-tab {
    padding: var(--space-3) var(--space-4);
    background: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    color: var(--color-text-secondary);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-base);
}

.analytics-tab:hover {
    color: var(--color-text-primary);
    background: var(--color-surface-hover);
}

.analytics-tab.active {
    color: var(--color-primary);
    border-bottom-color: var(--color-primary);
}

.analytics-tab-content {
    display: none;
}

.analytics-tab-content.active {
    display: block;
}

/* Date Range Select Styling */
.date-range-select {
    background: var(--glass-bg);
    backdrop-filter: var(--backdrop-blur);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-lg);
    padding: var(--space-2) var(--space-3);
    color: var(--color-text-primary);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-base);
    min-width: 140px;
}

.date-range-select:hover {
    border-color: var(--color-primary);
    background: rgba(99, 102, 241, 0.05);
}

.date-range-select:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.date-range-select option {
    background: var(--color-surface);
    color: var(--color-text-primary);
    padding: var(--space-2);
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive Breakpoints */

/* Tablets and smaller desktops (â‰¤1280px) */
@media (max-width: 1280px) {
    .analytics-workspace {
        width: 100%;
    }
    
    .kpi-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

/* Tablets (â‰¤1024px) */
@media (max-width: 1024px) {
    .charts-primary-grid,
    .charts-equal-grid {
        grid-template-columns: 1fr;
    }
}

/* Mobile (â‰¤768px) */
@media (max-width: 768px) {
    .analytics-workspace {
        padding: var(--space-4);
    }
    
    .analytics-title {
        font-size: var(--font-size-2xl);
    }
    
    .kpi-grid {
        grid-template-columns: 1fr;
        gap: var(--space-3);
    }
    
    .analytics-header .flex {
        flex-direction: column;
        gap: var(--space-3);
    }
    
    .analytics-header .flex:last-child {
        width: 100%;
        flex-direction: row;
    }
    
    .date-range-select {
        flex: 1;
        min-width: 120px;
    }
    
    /* Constrain chart sizes on mobile */
    .chart-card {
        padding: var(--space-4);
    }
    
    /* Responsive circular charts on mobile */
    .chart-frame.chart-radar,
    .chart-frame.chart-doughnut {
        max-width: 340px;
        min-width: 260px;
    }
}

/* Small mobile (â‰¤480px) */
@media (max-width: 480px) {
    .analytics-tab {
        padding: var(--space-2) var(--space-3);
        font-size: 0.875rem;
    }
    
    /* Optimize circular charts for small screens */
    .chart-frame.chart-radar,
    .chart-frame.chart-doughnut {
        max-width: 280px;
        min-width: 240px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="analytics-workspace">
    <!-- Header with Filters -->
    <div class="analytics-header">
        <div class="flex justify-between items-start mb-4">
            <div>
                <h1 class="analytics-title">Analytics</h1>
                <p class="analytics-subtitle">Insights from your meetings and productivity</p>
            </div>
            <div class="flex gap-3">
                <select class="date-range-select">
                    <option value="7">Last 7 days</option>
                    <option value="30" selected>Last 30 days</option>
                    <option value="90">Last 90 days</option>
                    <option value="365">Last year</option>
                </select>
                <button class="btn btn-outline" id="customizeWidgetsBtn">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
                    </svg>
                    Customize
                </button>
                <button class="btn btn-outline">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                    Export
                </button>
            </div>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid">
        <div class="kpi-card" data-widget="kpi-meetings" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, transparent 100%);">
            <div class="flex justify-between items-start mb-2">
                <p class="text-tertiary text-sm font-medium">Total Meetings</p>
                <span class="px-2 py-1 rounded-full text-xs font-medium" style="background: rgba(34, 197, 94, 0.1); color: var(--color-success);">
                    +12%
                </span>
            </div>
            <p class="text-3xl font-bold mb-1">{{ total_meetings|default(0) }}</p>
            <p class="text-sm text-secondary">â†‘ 3 more than last month</p>
        </div>
        
        <div class="kpi-card" data-widget="kpi-tasks" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, transparent 100%);">
            <div class="flex justify-between items-start mb-2">
                <p class="text-tertiary text-sm font-medium">Action Items</p>
                <span class="px-2 py-1 rounded-full text-xs font-medium" style="background: rgba(34, 197, 94, 0.1); color: var(--color-success);">
                    {{ task_completion_rate|default(0) }}%
                </span>
            </div>
            <p class="text-3xl font-bold mb-1">{{ total_tasks|default(0) }}</p>
            <p class="text-sm text-secondary">{{ task_completion_rate|default(0) }}% completion rate</p>
        </div>
        
        <div class="kpi-card" data-widget="kpi-hours" style="background: linear-gradient(135deg, rgba(6, 182, 212, 0.1) 0%, transparent 100%);">
            <div class="flex justify-between items-start mb-2">
                <p class="text-tertiary text-sm font-medium">Hours Saved</p>
                <span class="px-2 py-1 rounded-full text-xs font-medium" style="background: rgba(34, 197, 94, 0.1); color: var(--color-success);">
                    +8h
                </span>
            </div>
            <p class="text-3xl font-bold mb-1">{{ hours_saved|default(0) }}</p>
            <p class="text-sm text-secondary">This week vs last week</p>
        </div>
        
        <div class="kpi-card" data-widget="kpi-duration" style="background: linear-gradient(135deg, rgba(236, 72, 153, 0.1) 0%, transparent 100%);">
            <div class="flex justify-between items-start mb-2">
                <p class="text-tertiary text-sm font-medium">Avg Meeting Length</p>
                <span class="px-2 py-1 rounded-full text-xs font-medium" style="background: rgba(249, 115, 22, 0.1); color: var(--color-warning);">
                    â†’
                </span>
            </div>
            <p class="text-3xl font-bold mb-1">{{ avg_duration|default(45) }}m</p>
            <p class="text-sm text-secondary">Across all meetings</p>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="mb-6">
        <div class="flex gap-1 border-b border-gray-200 dark:border-gray-700">
            <button class="analytics-tab active" data-tab="overview">Overview</button>
            <button class="analytics-tab" data-tab="engagement">Engagement</button>
            <button class="analytics-tab" data-tab="productivity">Productivity</button>
            <button class="analytics-tab" data-tab="insights">Insights</button>
        </div>
    </div>

    <!-- Overview Tab -->
    <div id="tab-overview" class="analytics-tab-content active">
        <div class="charts-primary-grid">
            <div class="chart-card" data-widget="chart-activity">
                <h2 class="text-lg font-semibold mb-4">Meeting Activity Trend</h2>
                <div class="chart-frame">
                    <canvas id="meetingActivityChart"></canvas>
                </div>
            </div>

            <div class="chart-card" data-widget="chart-task-status">
                <h2 class="text-lg font-semibold mb-4">Task Status</h2>
                <div class="chart-frame chart-doughnut">
                    <canvas id="taskStatusChart"></canvas>
                </div>
            </div>
        </div>

        <div class="charts-equal-grid">
            <div class="chart-card" data-widget="chart-speaker">
                <h2 class="text-lg font-semibold mb-4">Speaker Distribution</h2>
                <div class="chart-frame">
                    <canvas id="speakerChart"></canvas>
                </div>
            </div>

            <div class="chart-card" data-widget="chart-topics">
                <h2 class="text-lg font-semibold mb-4">Top Topics</h2>
                <div style="display: flex; flex-direction: column; gap: var(--space-3); padding: var(--space-2) 0;">
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium">Product Strategy</span>
                            <span class="text-tertiary">45%</span>
                        </div>
                        <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                            <div class="h-full bg-primary" style="width: 45%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium">Engineering</span>
                            <span class="text-tertiary">30%</span>
                        </div>
                        <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                            <div class="h-full bg-purple-500" style="width: 30%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium">Design Review</span>
                            <span class="text-tertiary">25%</span>
                        </div>
                        <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                            <div class="h-full bg-cyan-500" style="width: 25%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Engagement Tab -->
    <div id="tab-engagement" class="analytics-tab-content">
        <!-- Speaking Time Analysis (T2.33) -->
        <div class="charts-primary-grid mb-6" data-widget="chart-speaking-time">
            <div class="chart-card">
                <h2 class="text-lg font-semibold mb-1">Speaking Time Distribution</h2>
                <p class="text-sm text-secondary mb-4">Breakdown of talk time across participants</p>
                <div class="chart-frame">
                    <canvas id="speakingTimeBarChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h2 class="text-lg font-semibold mb-1">Speaking Balance</h2>
                <p class="text-sm text-secondary mb-4">Percentage of total meeting time</p>
                <div class="chart-frame chart-doughnut">
                    <canvas id="speakingTimePieChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Detailed Speaking Time Breakdown -->
        <div class="charts-single mb-6">
            <div class="chart-card">
                <h2 class="text-lg font-semibold mb-1">Participant Details</h2>
                <p class="text-sm text-secondary mb-4">Individual speaking metrics and balance indicators</p>
                <div id="speakingTimeDetails" class="flex flex-col gap-4">
                    <!-- Will be populated by JavaScript -->
                    <div class="text-center text-secondary py-8">
                        <svg class="w-12 h-12 mx-auto mb-2 opacity-40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Loading speaking time data...
                    </div>
                </div>
            </div>
        </div>

        <!-- Participation Balance Metrics (T2.34) -->
        <div class="charts-single mb-6" data-widget="chart-participation">
            <div class="chart-card">
                <h2 class="text-lg font-semibold mb-1">Participation Balance Overview</h2>
                <p class="text-sm text-secondary mb-4">Multi-dimensional engagement metrics across all participants</p>
                <div id="participationBalanceMetrics" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Will be populated by JavaScript -->
                    <div class="text-center text-secondary py-8 col-span-full">
                        <svg class="w-12 h-12 mx-auto mb-2 opacity-40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                        Loading participation balance metrics...
                    </div>
                </div>
            </div>
        </div>

        <!-- Participation and Sentiment -->
        <div class="charts-equal-grid" data-widget="chart-sentiment">
            <div class="chart-card">
                <h2 class="text-lg font-semibold mb-4">Participation Rate</h2>
                <div class="chart-frame chart-radar">
                    <canvas id="participationChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h2 class="text-lg font-semibold mb-4">Meeting Sentiment</h2>
                <div class="chart-frame">
                    <canvas id="sentimentChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Productivity Tab -->
    <div id="tab-productivity" class="analytics-tab-content">
        <!-- Action Items Completion (T2.38) -->
        <div class="charts-single mb-6" data-widget="action-items">
            <div class="chart-card">
                <h2 class="text-lg font-semibold mb-1">Action Item Completion Rate</h2>
                <p class="text-sm text-secondary mb-4">Track progress of meeting action items</p>
                <div id="actionItemsCompletion">
                    <div class="text-center text-secondary py-8">
                        <svg class="w-12 h-12 mx-auto mb-2 opacity-40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                        </svg>
                        Select a meeting to view action items
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Topic Trends Timeline (T2.36) -->
        <div class="charts-single mb-6" data-widget="topic-trends">
            <div class="chart-card">
                <h2 class="text-lg font-semibold mb-1">Topic Evolution Timeline</h2>
                <p class="text-sm text-secondary mb-4">How conversation topics developed throughout meetings</p>
                <div id="topicTrendsTimeline">
                    <div class="text-center text-secondary py-8">
                        <svg class="w-12 h-12 mx-auto mb-2 opacity-40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                        </svg>
                        Select a meeting to view topic trends
                    </div>
                </div>
            </div>
        </div>

        <!-- Q&A Tracking (T2.37) -->
        <div class="charts-single mb-6" data-widget="qa-tracking">
            <div class="chart-card">
                <h2 class="text-lg font-semibold mb-1">Question & Answer Tracking</h2>
                <p class="text-sm text-secondary mb-4">Questions asked during meetings and their resolution status</p>
                <div id="qaTracking">
                    <div class="text-center text-secondary py-8">
                        <svg class="w-12 h-12 mx-auto mb-2 opacity-40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Select a meeting to view Q&A analytics
                    </div>
                </div>
            </div>
        </div>

        <div class="charts-single">
            <div class="chart-card">
                <h2 class="text-lg font-semibold mb-4">Task Completion Over Time</h2>
                <div class="chart-frame">
                    <canvas id="productivityChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Insights Tab -->
    <div id="tab-insights" class="analytics-tab-content">
        <div class="charts-equal-grid">
            <div class="chart-card">
                <h3 class="font-semibold mb-4">Key Insights</h3>
                <div style="display: flex; flex-direction: column; gap: var(--space-3);">
                    <div class="p-3 rounded-lg" style="background: rgba(34, 197, 94, 0.1); border-left: 3px solid var(--color-success);">
                        <p class="font-medium text-sm mb-1">High Completion Rate</p>
                        <p class="text-sm text-secondary">85% of tasks completed on time this month</p>
                    </div>
                    <div class="p-3 rounded-lg" style="background: rgba(249, 115, 22, 0.1); border-left: 3px solid var(--color-warning);">
                        <p class="font-medium text-sm mb-1">Long Meetings Trend</p>
                        <p class="text-sm text-secondary">Average meeting length increased by 12 minutes</p>
                    </div>
                    <div class="p-3 rounded-lg" style="background: rgba(99, 102, 241, 0.1); border-left: 3px solid var(--color-primary);">
                        <p class="font-medium text-sm mb-1">Active Participation</p>
                        <p class="text-sm text-secondary">More balanced speaking time distribution</p>
                    </div>
                </div>
            </div>

            <div class="chart-card">
                <h3 class="font-semibold mb-4">Recommendations</h3>
                <div style="display: flex; flex-direction: column; gap: var(--space-3);">
                    <div class="flex gap-3 items-start">
                        <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div>
                            <p class="font-medium text-sm mb-1">Schedule shorter meetings</p>
                            <p class="text-sm text-secondary">Consider 25-minute or 50-minute blocks</p>
                        </div>
                    </div>
                    <div class="flex gap-3 items-start">
                        <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div>
                            <p class="font-medium text-sm mb-1">Set task deadlines</p>
                            <p class="text-sm text-secondary">3 tasks have no due date assigned</p>
                        </div>
                    </div>
                    <div class="flex gap-3 items-start">
                        <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0"/>
                            </svg>
                        </div>
                        <div>
                            <p class="font-medium text-sm mb-1">Encourage participation</p>
                            <p class="text-sm text-secondary">2 members had minimal speaking time</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Widget Customization Modal -->
<div id="widgetCustomizationModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden border border-gray-200 dark:border-gray-700">
        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold">Customize Analytics Dashboard</h2>
                <button id="closeCustomizeModal" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <p class="text-sm text-secondary mt-2">Show or hide widgets to personalize your analytics view</p>
        </div>
        <div class="p-6 overflow-y-auto max-h-[calc(80vh-180px)]">
            <div id="widgetToggles" class="space-y-3">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
        <div class="p-6 border-t border-gray-200 dark:border-gray-700 flex justify-between gap-3">
            <button id="resetWidgetsBtn" class="btn btn-outline">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Reset to Default
            </button>
            <button id="saveWidgetsBtn" class="btn btn-primary">
                Save Preferences
            </button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="/static/js/analytics.js" nonce="{{ g.csp_nonce }}"></script>

<script nonce="{{ g.csp_nonce }}">
/**
 * Analytics Page - Real-time WebSocket Integration
 * CROWNâ´ Event Handling for Live Analytics Updates
 */

(function() {
    'use strict';
    
    // Get workspace ID from user context
    const WORKSPACE_ID = {{ current_user.workspace_id }};
    
    // Cache KPI elements
    const kpiElements = {
        totalMeetings: document.querySelector('.kpi-card:nth-child(1) h3'),
        totalHours: document.querySelector('.kpi-card:nth-child(2) h3'),
        actionItems: document.querySelector('.kpi-card:nth-child(3) h3'),
        avgDuration: document.querySelector('.kpi-card:nth-child(4) h3')
    };
    
    // Store chart instances for updating
    const chartInstances = {};
    
    /**
     * Initialize WebSocket connection for analytics page
     */
    function initAnalyticsWebSocket() {
        console.log('ðŸš€ Initializing analytics WebSocket...');
        
        // Initialize WebSocket manager with analytics namespace
        if (!window.wsManager) {
            console.error('âŒ WebSocket manager not found');
            return;
        }
        
        // Connect to analytics namespace
        window.wsManager.connect('analytics');
        
        // Listen for analytics_refresh events
        window.wsManager.on('analytics_refresh', handleAnalyticsRefresh);
        
        // Listen for session_update events (new meetings affect analytics)
        window.wsManager.on('session_update:created', handleNewSession);
        
        console.log('ðŸ“¡ Analytics WebSocket listeners registered');
    }
    
    /**
     * Handle analytics refresh event
     * @param {Object} data - Event data with updated analytics
     */
    function handleAnalyticsRefresh(data) {
        console.log('ðŸ“Š Analytics refresh event received:', data);
        
        const analyticsData = data.data || data;
        
        // Update KPIs with animation
        if (analyticsData.kpis) {
            updateKPIs(analyticsData.kpis);
        }
        
        // Refresh charts if data provided
        if (analyticsData.charts) {
            refreshCharts(analyticsData.charts);
        }
        
        // Show refresh indicator
        showRefreshIndicator();
    }
    
    /**
     * Handle new session created event
     * @param {Object} data - Event data with session info
     */
    function handleNewSession(data) {
        console.log('ðŸ“¬ New session affects analytics:', data);
        
        // Increment total meetings KPI
        const totalMeetingsEl = kpiElements.totalMeetings;
        if (totalMeetingsEl) {
            const currentValue = parseInt(totalMeetingsEl.textContent) || 0;
            animateCounter(totalMeetingsEl, currentValue, currentValue + 1, 500);
        }
        
        // Show subtle notification
        showAnalyticsNotification('Analytics updated', 'New meeting data has been added');
    }
    
    /**
     * Update KPI values with animation
     * @param {Object} kpis - KPI data object
     */
    function updateKPIs(kpis) {
        // Total Meetings
        if (kpis.total_meetings !== undefined && kpiElements.totalMeetings) {
            const currentValue = parseInt(kpiElements.totalMeetings.textContent) || 0;
            animateCounter(kpiElements.totalMeetings, currentValue, kpis.total_meetings, 500);
            addShimmerEffect(kpiElements.totalMeetings.closest('.kpi-card'));
        }
        
        // Total Hours
        if (kpis.total_hours !== undefined && kpiElements.totalHours) {
            const currentValue = parseFloat(kpiElements.totalHours.textContent) || 0;
            animateCounter(kpiElements.totalHours, currentValue, kpis.total_hours, 500, true);
            addShimmerEffect(kpiElements.totalHours.closest('.kpi-card'));
        }
        
        // Action Items
        if (kpis.action_items !== undefined && kpiElements.actionItems) {
            const currentValue = parseInt(kpiElements.actionItems.textContent) || 0;
            animateCounter(kpiElements.actionItems, currentValue, kpis.action_items, 500);
            addShimmerEffect(kpiElements.actionItems.closest('.kpi-card'));
        }
        
        // Average Duration
        if (kpis.avg_duration !== undefined && kpiElements.avgDuration) {
            const currentText = kpiElements.avgDuration.textContent;
            kpiElements.avgDuration.textContent = kpis.avg_duration;
            addShimmerEffect(kpiElements.avgDuration.closest('.kpi-card'));
        }
    }
    
    /**
     * Refresh chart data
     * @param {Object} chartsData - Chart data updates
     */
    function refreshCharts(chartsData) {
        // This would integrate with the analytics.js chart instances
        // For now, we'll trigger a page refresh if major changes
        console.log('ðŸ”„ Chart data update:', chartsData);
        
        // Show visual feedback
        document.querySelectorAll('.chart-card').forEach(card => {
            addPulseEffect(card);
        });
        
        // In a production implementation, you would update chart.js instances here
        // Example: chartInstances.meetingsByDay.data = chartsData.meetingsByDay
        //          chartInstances.meetingsByDay.update()
    }
    
    /**
     * Animate counter from current to new value
     * @param {HTMLElement} element - Counter element
     * @param {number} start - Start value
     * @param {number} end - End value
     * @param {number} duration - Animation duration in ms
     * @param {boolean} isDecimal - Whether to show decimal places
     */
    function animateCounter(element, start, end, duration, isDecimal = false) {
        const startTime = Date.now();
        const difference = end - start;
        
        function update() {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            // Easing function (ease-out cubic)
            const eased = 1 - Math.pow(1 - progress, 3);
            const current = start + (difference * eased);
            
            if (isDecimal) {
                element.textContent = current.toFixed(1);
            } else {
                element.textContent = Math.round(current);
            }
            
            if (progress < 1) {
                requestAnimationFrame(update);
            }
        }
        
        update();
    }
    
    /**
     * Add shimmer effect to element
     * @param {HTMLElement} element - Element to shimmer
     */
    function addShimmerEffect(element) {
        if (!element) return;
        
        element.classList.add('kpi-shimmer');
        setTimeout(() => {
            element.classList.remove('kpi-shimmer');
        }, 1000);
    }
    
    /**
     * Add pulse effect to element
     * @param {HTMLElement} element - Element to pulse
     */
    function addPulseEffect(element) {
        if (!element) return;
        
        element.style.animation = 'chartPulse 0.5s ease-out';
        setTimeout(() => {
            element.style.animation = '';
        }, 500);
    }
    
    /**
     * Show refresh indicator
     */
    function showRefreshIndicator() {
        const indicator = document.createElement('div');
        indicator.className = 'refresh-indicator';
        indicator.style.cssText = `
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 12px 20px;
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--color-primary);
            border-radius: var(--radius-xl);
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.2);
            color: var(--color-primary);
            font-weight: 600;
            font-size: 14px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: slideInFromRight 0.3s ease-out;
        `;
        
        indicator.innerHTML = `
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="animation: spin 1s linear infinite;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            Analytics refreshing...
        `;
        
        document.body.appendChild(indicator);
        
        // Auto-remove after 2 seconds
        setTimeout(() => {
            indicator.style.animation = 'slideOutToRight 0.3s ease-out';
            setTimeout(() => indicator.remove(), 300);
        }, 2000);
    }
    
    /**
     * Show analytics notification
     * @param {string} title - Notification title
     * @param {string} message - Notification message
     */
    function showAnalyticsNotification(title, message) {
        const notification = document.createElement('div');
        notification.className = 'analytics-notification';
        notification.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            max-width: 400px;
            padding: 16px;
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            animation: slideInFromRight 0.3s ease-out;
        `;
        
        notification.innerHTML = `
            <div style="display: flex; gap: 12px; align-items: start;">
                <div style="flex-shrink: 0; width: 40px; height: 40px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                    <svg width="20" height="20" fill="white" viewBox="0 0 24 24">
                        <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                </div>
                <div style="flex: 1;">
                    <p style="font-weight: 600; margin-bottom: 4px; color: var(--color-text-primary);">${escapeHtml(title)}</p>
                    <p style="font-size: 14px; color: var(--color-text-secondary);">${escapeHtml(message)}</p>
                </div>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remove after 4 seconds
        setTimeout(() => {
            notification.style.animation = 'slideOutToRight 0.3s ease-out';
            setTimeout(() => notification.remove(), 300);
        }, 4000);
    }
    
    /**
     * Escape HTML to prevent XSS
     * @param {string} text - Text to escape
     * @returns {string} Escaped text
     */
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAnalyticsWebSocket);
    } else {
        initAnalyticsWebSocket();
    }
    
    // Add CSS for animations
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideInFromRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideOutToRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(20px);
            }
        }
        
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        
        @keyframes shimmer {
            0% {
                background-position: -200% center;
            }
            100% {
                background-position: 200% center;
            }
        }
        
        @keyframes chartPulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.02);
                box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
            }
        }
        
        .kpi-shimmer::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            background-size: 200% 100%;
            animation: shimmer 1s ease-in-out;
            pointer-events: none;
        }
    `;
    document.head.appendChild(style);
    
})();
</script>
{% endblock %}
