<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <meta name="description" content="Mina - Real-time live transcription powered by OpenAI Whisper">
  <meta name="theme-color" content="#6366f1">
  
  <title>Mina — Live Transcription</title>
  
  <!-- Preconnect to improve performance -->
  <link rel="preconnect" href="https://cdn.socket.io">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  
  <!-- Feather Icons - Load synchronously -->
  <script src="https://unpkg.com/feather-icons"></script>
  
  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  
  <!-- Custom Design System - Production Optimized -->
  <link rel="stylesheet" href="/static/css/design-tokens.css">
  <link rel="stylesheet" href="/static/css/typography.css">
  <link rel="stylesheet" href="/static/css/mobile-excellence.css">
  <link rel="stylesheet" href="/static/css/components.css">
  
  <!-- PWA Meta Tags -->
  <link rel="manifest" href="/static/manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Mina">
  
  <style>
    /* Transition overrides for smooth theme switching */
    * {
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }
    
    /* Enhance Bootstrap components with design tokens */
    .btn {
      transition: all var(--mina-transition-fast);
    }
    
    /* Audio visualization enhancements */
    .audio-visualizer {
      height: 40px;
      background: linear-gradient(90deg, var(--mina-bg-tertiary) 0%, var(--mina-bg-secondary) 100%);
      border-radius: var(--mina-radius-lg);
      position: relative;
      overflow: hidden;
    }
    
    .audio-waveform {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 100%;
      background: linear-gradient(90deg, var(--mina-success) 0%, var(--mina-warning) 70%, var(--mina-danger) 100%);
      width: 0%;
      border-radius: var(--mina-radius-lg);
      transition: width 100ms ease-out;
    }
  </style>
</head>

<body class="bg-body-secondary">
  <!-- Theme Toggle Button -->
  <button class="mina-theme-toggle" id="themeToggle" aria-label="Toggle dark mode">
    <i data-feather="sun" class="mina-theme-toggle__icon" id="themeIcon"></i>
  </button>

  <!-- Live Region for Screen Readers -->
  <div id="liveRegion" class="mina-sr-only" aria-live="polite" aria-atomic="true"></div>

  <div class="mina-container py-4">
    <!-- Header -->
    <header class="text-center mb-5">
      <h1 class="display-4 fw-bold text-primary mb-2">
        <i data-feather="mic" class="me-2"></i>
        Mina
      </h1>
      <p class="lead text-muted">Real-time Live Transcription</p>
    </header>

    <!-- Main Application -->
    <main>
      <!-- Control Panel -->
      <section class="mina-card mb-4" role="region" aria-labelledby="controls-heading">
        <div class="mina-card__header">
          <h2 id="controls-heading" class="mina-card__title">
            <i data-feather="settings" class="me-2"></i>
            Recording Controls
          </h2>
          <div class="mina-flex mina-gap-2">
            <span class="mina-pill" id="wsStatus">
              <span class="mina-pill__indicator"></span>
              Disconnected
            </span>
            <span class="mina-pill" id="micStatus">
              <i data-feather="mic-off" class="me-1"></i>
              Ready
            </span>
          </div>
        </div>

        <div class="mina-card__content">
          <!-- Recording Buttons -->
          <div class="d-flex gap-3 mb-4 flex-wrap">
            <button 
              id="startRecordingBtn" 
              class="mina-btn mina-btn--success mina-btn--lg"
              aria-describedby="start-help"
            >
              <i data-feather="play" class="me-2"></i>
              Start Recording
            </button>
            
            <button 
              id="stopRecordingBtn" 
              class="mina-btn mina-btn--danger mina-btn--lg" 
              disabled
              aria-describedby="stop-help"
            >
              <i data-feather="stop" class="me-2"></i>
              Stop Recording
            </button>

            <button 
              id="clearBtn" 
              class="mina-btn mina-btn--secondary"
              aria-describedby="clear-help"
            >
              <i data-feather="trash-2" class="me-2"></i>
              Clear
            </button>
          </div>

          <!-- Help Text -->
          <div class="small text-muted">
            <p id="start-help" class="mb-1">
              <i data-feather="info" class="me-1"></i>
              Click Start to begin real-time transcription
            </p>
            <p id="stop-help" class="mb-1">
              <i data-feather="info" class="me-1"></i>
              Click Stop to end recording and get final transcript
            </p>
            <p id="clear-help" class="mb-0">
              <i data-feather="info" class="me-1"></i>
              Clear all transcribed text
            </p>
          </div>

          <!-- Audio Level Meter -->
          <div class="mt-4">
            <label class="form-label small fw-medium">Audio Level</label>
            <div class="audio-visualizer">
              <div class="audio-waveform" id="audioWaveform"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Transcription Display -->
      <section class="row g-4 mb-4">
        <div class="col-md-6">
          <div class="mina-card h-100" role="region" aria-labelledby="interim-heading">
            <div class="mina-card__header">
              <h3 id="interim-heading" class="mina-card__title">
                <i data-feather="edit-3" class="me-2"></i>
                Live Transcript
              </h3>
              <span class="mina-pill mina-pill--info">
                <span class="mina-pill__indicator"></span>
                Real-time
              </span>
            </div>
            <div class="mina-card__content">
              <div 
                id="interimText" 
                class="mina-transcript mina-transcript--interim"
                aria-live="polite"
                aria-label="Live transcription text"
              ></div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="mina-card h-100" role="region" aria-labelledby="final-heading">
            <div class="mina-card__header">
              <h3 id="final-heading" class="mina-card__title">
                <i data-feather="check-circle" class="me-2"></i>
                Final Transcript
              </h3>
              <button 
                id="copyBtn" 
                class="mina-btn mina-btn--sm mina-btn--secondary"
                title="Copy to clipboard"
                aria-label="Copy final transcript to clipboard"
              >
                <i data-feather="copy" class="me-1"></i>
                Copy
              </button>
            </div>
            <div class="mina-card__content">
              <div 
                id="finalText" 
                class="mina-transcript mina-transcript--final"
                aria-live="polite"
                aria-label="Final transcription text"
              ></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Session Info & Debug -->
      <section class="row g-4">
        <div class="col-md-8">
          <div class="mina-card" role="region" aria-labelledby="session-heading">
            <div class="mina-card__header">
              <h3 id="session-heading" class="mina-card__title">
                <i data-feather="activity" class="me-2"></i>
                Session Information
              </h3>
            </div>
            <div class="mina-card__content">
              <dl class="row">
                <dt class="col-sm-3">Session ID:</dt>
                <dd class="col-sm-9">
                  <code id="sessionId" class="small"></code>
                </dd>
                <dt class="col-sm-3">Status:</dt>
                <dd class="col-sm-9">
                  <span id="sessionStatus" class="mina-pill">Initializing</span>
                </dd>
                <dt class="col-sm-3">Duration:</dt>
                <dd class="col-sm-9">
                  <span id="sessionDuration">00:00</span>
                </dd>
              </dl>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="mina-card" role="region" aria-labelledby="debug-heading">
            <div class="mina-card__header">
              <h3 id="debug-heading" class="mina-card__title">
                <i data-feather="terminal" class="me-2"></i>
                System Log
              </h3>
              <button 
                id="clearLogBtn" 
                class="mina-btn mina-btn--sm mina-btn--secondary"
                title="Clear log"
              >
                <i data-feather="x"></i>
              </button>
            </div>
            <div class="mina-card__content">
              <div id="debugConsole" class="mina-console" aria-live="polite"></div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="text-center mt-5 py-4 text-muted">
      <p class="mb-0">
        <i data-feather="zap" class="me-1"></i>
        Powered by <strong>OpenAI Whisper</strong> • 
        <i data-feather="shield" class="me-1"></i>
        Secure & Private
      </p>
    </footer>
  </div>

  <!-- Toast Container for Notifications -->
  <div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <i data-feather="bell" class="me-2 text-primary"></i>
        <strong class="me-auto">Mina</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="toastMessage">
        <!-- Toast message will be inserted here -->
      </div>
    </div>
  </div>

  <!-- Scripts - Production Ready Loading -->
  <script>
    // Dependency Management System for Production Reliability
    window.MinaDependencies = {
      loaded: {
        bootstrap: false,
        feather: false,
        socketio: false
      },
      callbacks: [],
      
      checkReady() {
        const allLoaded = this.loaded.bootstrap && this.loaded.feather && this.loaded.socketio;
        if (allLoaded) {
          this.callbacks.forEach(callback => {
            try {
              callback();
            } catch (error) {
              console.error('[Mina] Dependency callback error:', error);
            }
          });
          this.callbacks = [];
        }
        return allLoaded;
      },
      
      onReady(callback) {
        if (this.checkReady()) {
          callback();
        } else {
          this.callbacks.push(callback);
        }
      },
      
      markLoaded(dependency) {
        this.loaded[dependency] = true;
        console.log(`[Mina] ${dependency} loaded successfully`);
        this.checkReady();
      },
      
      loadBootstrapFallback() {
        console.warn('[Mina] Bootstrap CDN failed, loading fallback');
        // Try alternative CDN
        const fallbackScript = document.createElement('script');
        fallbackScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js';
        fallbackScript.onload = () => this.markLoaded('bootstrap');
        fallbackScript.onerror = () => {
          console.error('[Mina] Bootstrap fallback failed, creating minimal implementation');
          // Create minimal Bootstrap Toast implementation
          window.bootstrap = {
            Toast: class {
              constructor(element) {
                this.element = element;
              }
              show() {
                if (this.element) {
                  this.element.style.display = 'block';
                  this.element.classList.add('show');
                  setTimeout(() => {
                    this.element.style.display = 'none';
                    this.element.classList.remove('show');
                  }, 5000);
                }
              }
            }
          };
          this.markLoaded('bootstrap');
        };
        document.head.appendChild(fallbackScript);
      },
      
      loadFeatherFallback() {
        console.warn('[Mina] Feather icons CDN failed, loading fallback');
        // Try alternative CDN
        const fallbackScript = document.createElement('script');
        fallbackScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.29.0/feather.min.js';
        fallbackScript.onload = () => this.markLoaded('feather');
        fallbackScript.onerror = () => {
          console.error('[Mina] Feather fallback failed, creating minimal implementation');
          // Create minimal Feather implementation
          window.feather = {
            replace() {
              // Replace data-feather attributes with Unicode icons
              document.querySelectorAll('[data-feather]').forEach(el => {
                const iconName = el.getAttribute('data-feather');
                const iconMap = {
                  'mic': '🎤', 'mic-off': '🔇', 'zap': '⚡', 'shield': '🛡️',
                  'bell': '🔔', 'moon': '🌙', 'sun': '☀️', 'settings': '⚙️'
                };
                el.innerHTML = iconMap[iconName] || '●';
              });
            }
          };
          this.markLoaded('feather');
        };
        document.head.appendChild(fallbackScript);
      }
    };
    
    // Socket.IO is already loaded in head, mark as ready
    if (typeof io !== 'undefined') {
      window.MinaDependencies.markLoaded('socketio');
    }
  </script>

  <!-- Bootstrap 5 JavaScript with fallback -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" 
          integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" 
          crossorigin="anonymous"
          onload="window.MinaDependencies.markLoaded('bootstrap')"
          onerror="window.MinaDependencies.loadBootstrapFallback()"></script>

  <!-- Feather Icons with fallback -->
  <script src="https://unpkg.com/feather-icons" 
          onload="window.MinaDependencies.markLoaded('feather')"
          onerror="window.MinaDependencies.loadFeatherFallback()"></script>

  <!-- Main Application Script - Waits for Dependencies -->
  <script>
    window.MinaDependencies.onReady(function() {
      console.log('[Mina] All dependencies loaded, initializing application');
      
      // Initialize Feather icons
      if (typeof feather !== 'undefined') {
        feather.replace();
        console.log('[Mina] Feather icons initialized');
      }
      
      // Load and initialize main application
      const script = document.createElement('script');
      script.src = '/static/js/modern-recording-wiring.js';
      script.onload = function() {
        console.log('[Mina] Application initialized successfully');
      };
      script.onerror = function() {
        console.error('[Mina] Failed to load main application script');
      };
      document.head.appendChild(script);
    });
    
    // Fallback timeout for dependency loading
    setTimeout(function() {
      if (!window.MinaDependencies.checkReady()) {
        console.warn('[Mina] Some dependencies failed to load within timeout');
        // Show user-friendly error message
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-warning text-center';
        errorDiv.innerHTML = '⚠️ Some features may not work properly due to loading issues. Please refresh the page.';
        document.body.insertBefore(errorDiv, document.body.firstChild);
      }
    }, 10000); // 10 second timeout
  </script>
</body>
</html>