{% extends "base.html" %}

{% block title %}Live Recording - {{ super() }}{% endblock %}

{% block head %}
    <!-- Crown+ Design System -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/crown-base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/crown-design-system.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/crown-components.css') }}">
    
    <style>
        .live-container {
            min-height: 100vh;
            background: var(--bg-primary);
            padding: var(--spacing-6) var(--spacing-4);
        }
        
        .live-header {
            text-align: center;
            margin-bottom: var(--spacing-8);
        }
        
        .live-title {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            color: var(--text-primary);
            margin-bottom: var(--spacing-2);
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-3);
        }
        
        .live-subtitle {
            font-size: var(--font-size-base);
            color: var(--text-secondary);
        }
        
        .live-grid {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: var(--spacing-6);
            max-width: 1600px;
            margin: 0 auto;
        }
        
        /* Recording Controls */
        .controls-card {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            padding: var(--spacing-8);
            text-align: center;
        }
        
        .record-button {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            border: 4px solid var(--border-subtle);
            background: var(--bg-secondary);
            cursor: pointer;
            position: relative;
            margin: 0 auto var(--spacing-6);
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .record-button:hover {
            transform: scale(1.05);
            border-color: var(--border-interactive);
        }
        
        .record-button.recording {
            border-color: var(--status-error);
            animation: pulse-ring 2s ease-in-out infinite;
        }
        
        .record-button.recording .record-icon {
            color: var(--status-error);
        }
        
        .record-icon {
            font-size: 48px;
            color: var(--text-primary);
            transition: color var(--transition-normal);
        }
        
        @keyframes pulse-ring {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }
            50% {
                box-shadow: 0 0 0 20px rgba(239, 68, 68, 0);
            }
        }
        
        .record-status {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-medium);
            color: var(--text-primary);
            margin-bottom: var(--spacing-4);
        }
        
        .record-timer {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--text-accent);
            font-variant-numeric: tabular-nums;
        }
        
        /* Audio Visualizer */
        .visualizer-card {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            padding: var(--spacing-6);
            margin-bottom: var(--spacing-6);
        }
        
        .visualizer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-4);
        }
        
        .visualizer-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
        }
        
        .audio-visualizer {
            height: 120px;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: var(--spacing-4);
        }
        
        .audio-bar {
            width: 4px;
            background: var(--color-accent-vibrant);
            border-radius: var(--radius-full);
            transition: height 0.1s ease;
        }
        
        /* Transcript */
        .transcript-card {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            padding: var(--spacing-6);
            display: flex;
            flex-direction: column;
            height: calc(100vh - 300px);
            min-height: 400px;
        }
        
        .transcript-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-4);
            padding-bottom: var(--spacing-4);
            border-bottom: 1px solid var(--border-subtle);
        }
        
        .transcript-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
        }
        
        .transcript-actions {
            display: flex;
            gap: var(--spacing-2);
        }
        
        .action-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-subtle);
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-normal);
        }
        
        .action-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-interactive);
        }
        
        .transcript-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-4);
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
        }
        
        .transcript-segment {
            margin-bottom: var(--spacing-4);
            padding: var(--spacing-3);
            background: var(--glass-bg);
            border-radius: var(--radius-md);
            animation: slideIn 0.3s ease;
        }
        
        .segment-meta {
            font-size: var(--font-size-xs);
            color: var(--text-tertiary);
            margin-bottom: var(--spacing-2);
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
        }
        
        .segment-text {
            font-size: var(--font-size-base);
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        .empty-state {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-tertiary);
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: var(--spacing-4);
            opacity: 0.5;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Sidebar */
        .sidebar-card {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            padding: var(--spacing-6);
            margin-bottom: var(--spacing-6);
        }
        
        .sidebar-title {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            color: var(--text-primary);
            margin-bottom: var(--spacing-4);
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-3);
        }
        
        .metric-item {
            padding: var(--spacing-3);
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            text-align: center;
        }
        
        .metric-value {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--text-accent);
            margin-bottom: var(--spacing-1);
        }
        
        .metric-label {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
        }
        
        .status-grid {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-3);
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-3);
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }
        
        .status-label {
            font-size: var(--font-size-sm);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
        }
        
        .status-badge {
            padding: var(--spacing-1) var(--spacing-3);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
            background: var(--status-success-bg);
            color: var(--status-success);
        }
        
        .status-badge.error {
            background: var(--status-error-bg);
            color: var(--status-error);
        }
        
        /* Settings */
        .settings-group {
            margin-bottom: var(--spacing-4);
        }
        
        .settings-label {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            margin-bottom: var(--spacing-2);
            display: block;
        }
        
        .settings-select {
            width: 100%;
            padding: var(--spacing-3);
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: var(--font-size-sm);
        }
        
        .settings-checkbox {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            padding: var(--spacing-3);
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            cursor: pointer;
        }
        
        /* Mobile responsive */
        @media (max-width: 1024px) {
            .live-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .live-container {
                padding: var(--spacing-4) var(--spacing-3);
            }
            
            .record-button {
                width: 120px;
                height: 120px;
            }
            
            .record-icon {
                font-size: 36px;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="live-container">
    <!-- Header -->
    <div class="live-header">
        <h1 class="live-title">
            <i data-feather="mic"></i>
            Live Recording Studio
        </h1>
        <p class="live-subtitle">Professional real-time transcription</p>
    </div>
    
    <div class="live-grid">
        <!-- Main Content -->
        <div>
            <!-- Recording Controls -->
            <div class="controls-card">
                <button class="record-button" id="recordBtn" aria-label="Start/Stop Recording">
                    <i data-feather="mic" class="record-icon" id="recordIcon"></i>
                </button>
                <div class="record-status" id="recordStatus">Ready to Record</div>
                <div class="record-timer" id="recordTimer">00:00</div>
            </div>
            
            <!-- Audio Visualizer -->
            <div class="visualizer-card">
                <div class="visualizer-header">
                    <div class="visualizer-title">
                        <i data-feather="activity" style="width: 20px; height: 20px;"></i>
                        Audio Levels
                    </div>
                    <div class="status-badge" id="audioQuality">Excellent</div>
                </div>
                <div class="audio-visualizer" id="audioVisualizer">
                    <!-- Audio bars will be generated by JavaScript -->
                </div>
            </div>
            
            <!-- Transcript -->
            <div class="transcript-card">
                <div class="transcript-header">
                    <div class="transcript-title">
                        <i data-feather="file-text" style="width: 20px; height: 20px;"></i>
                        Live Transcript
                    </div>
                    <div class="transcript-actions">
                        <button class="action-btn" id="clearBtn" title="Clear transcript" aria-label="Clear transcript">
                            <i data-feather="trash-2" style="width: 16px; height: 16px;"></i>
                        </button>
                        <button class="action-btn" id="copyBtn" title="Copy transcript" aria-label="Copy transcript">
                            <i data-feather="copy" style="width: 16px; height: 16px;"></i>
                        </button>
                        <button class="action-btn" id="downloadBtn" title="Download transcript" aria-label="Download transcript">
                            <i data-feather="download" style="width: 16px; height: 16px;"></i>
                        </button>
                    </div>
                </div>
                <div class="transcript-content" id="transcriptContent">
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i data-feather="mic"></i>
                        </div>
                        <p>Click the record button to start transcribing</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div>
            <!-- Metrics -->
            <div class="sidebar-card">
                <div class="sidebar-title">
                    <i data-feather="bar-chart-2" style="width: 16px; height: 16px;"></i>
                    Metrics
                </div>
                <div class="metrics-grid">
                    <div class="metric-item">
                        <div class="metric-value" id="wordsPerMin">0</div>
                        <div class="metric-label">Words/Min</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="totalWords">0</div>
                        <div class="metric-label">Total Words</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="accuracy">0%</div>
                        <div class="metric-label">Accuracy</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="duration">00:00</div>
                        <div class="metric-label">Duration</div>
                    </div>
                </div>
            </div>
            
            <!-- Status -->
            <div class="sidebar-card">
                <div class="sidebar-title">
                    <i data-feather="activity" style="width: 16px; height: 16px;"></i>
                    Status
                </div>
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-label">
                            <i data-feather="wifi" style="width: 14px; height: 14px;"></i>
                            Connection
                        </div>
                        <div class="status-badge" id="connectionStatus">Connected</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">
                            <i data-feather="volume-2" style="width: 14px; height: 14px;"></i>
                            Audio
                        </div>
                        <div class="status-badge" id="audioStatus">Ready</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">
                            <i data-feather="cpu" style="width: 14px; height: 14px;"></i>
                            AI Engine
                        </div>
                        <div class="status-badge" id="aiStatus">Active</div>
                    </div>
                </div>
            </div>
            
            <!-- Settings -->
            <div class="sidebar-card">
                <div class="sidebar-title">
                    <i data-feather="settings" style="width: 16px; height: 16px;"></i>
                    Settings
                </div>
                <div class="settings-group">
                    <label class="settings-label" for="languageSelect">Language</label>
                    <select class="settings-select" id="languageSelect">
                        <option value="en-US">English (US)</option>
                        <option value="en-GB">English (UK)</option>
                        <option value="es-ES">Spanish</option>
                        <option value="fr-FR">French</option>
                        <option value="de-DE">German</option>
                    </select>
                </div>
                <div class="settings-group">
                    <label class="settings-checkbox">
                        <input type="checkbox" id="autoScroll" checked>
                        <span>Auto-scroll transcript</span>
                    </label>
                </div>
                <div class="settings-group">
                    <label class="settings-checkbox">
                        <input type="checkbox" id="speakerDetection" checked>
                        <span>Speaker detection</span>
                    </label>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Socket.IO Client -->
<script src="https://cdn.socket.io/4.6.0/socket.io.min.js" 
        integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+" 
        crossorigin="anonymous"></script>

<script>
// Initialize Feather icons
if (typeof feather !== 'undefined') {
    feather.replace();
}

// Live Transcription App
class LiveTranscriptionApp {
    constructor() {
        this.isRecording = false;
        this.socket = null;
        this.mediaRecorder = null;
        this.audioContext = null;
        this.analyser = null;
        this.audioStream = null;
        this.startTime = null;
        this.transcriptSegments = [];
        this.wordCount = 0;
        
        this.init();
    }
    
    init() {
        this.setupEventListeners();
        this.initializeSocketIO();
        this.initializeVisualizer();
        this.startTimer();
    }
    
    setupEventListeners() {
        document.getElementById('recordBtn').addEventListener('click', () => this.toggleRecording());
        document.getElementById('clearBtn').addEventListener('click', () => this.clearTranscript());
        document.getElementById('copyBtn').addEventListener('click', () => this.copyTranscript());
        document.getElementById('downloadBtn').addEventListener('click', () => this.downloadTranscript());
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 'r') {
                    e.preventDefault();
                    this.toggleRecording();
                }
            }
        });
    }
    
    initializeSocketIO() {
        if (typeof io !== 'undefined') {
            this.socket = io('/live-transcription');
            
            this.socket.on('connect', () => {
                console.log('Connected to live transcription service');
                this.updateStatus('connectionStatus', 'Connected', 'success');
            });
            
            this.socket.on('disconnect', () => {
                console.log('Disconnected');
                this.updateStatus('connectionStatus', 'Disconnected', 'error');
            });
            
            this.socket.on('transcription_segment', (data) => {
                this.addTranscriptSegment(data);
            });
        } else {
            console.warn('Socket.IO not available');
            this.updateStatus('connectionStatus', 'Offline', 'error');
        }
    }
    
    initializeVisualizer() {
        const visualizer = document.getElementById('audioVisualizer');
        for (let i = 0; i < 40; i++) {
            const bar = document.createElement('div');
            bar.className = 'audio-bar';
            bar.style.height = '8px';
            visualizer.appendChild(bar);
        }
    }
    
    async toggleRecording() {
        if (this.isRecording) {
            this.stopRecording();
        } else {
            await this.startRecording();
        }
    }
    
    async startRecording() {
        try {
            this.audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            // Setup audio context for visualization
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            this.analyser = this.audioContext.createAnalyser();
            const source = this.audioContext.createMediaStreamSource(this.audioStream);
            source.connect(this.analyser);
            this.analyser.fftSize = 256;
            
            // Setup media recorder
            this.mediaRecorder = new MediaRecorder(this.audioStream);
            this.mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0 && this.socket) {
                    this.socket.emit('audio_data', event.data);
                }
            };
            
            this.mediaRecorder.start(100); // Send data every 100ms
            this.isRecording = true;
            this.startTime = Date.now();
            
            // Update UI
            document.getElementById('recordBtn').classList.add('recording');
            document.getElementById('recordStatus').textContent = 'Recording...';
            this.updateStatus('audioStatus', 'Recording', 'error');
            
            // Start visualization
            this.animateVisualizer();
            
        } catch (error) {
            console.error('Error starting recording:', error);
            alert('Could not access microphone. Please check permissions.');
        }
    }
    
    stopRecording() {
        if (this.mediaRecorder) {
            this.mediaRecorder.stop();
        }
        if (this.audioStream) {
            this.audioStream.getTracks().forEach(track => track.stop());
        }
        if (this.audioContext) {
            this.audioContext.close();
        }
        
        this.isRecording = false;
        
        // Update UI
        document.getElementById('recordBtn').classList.remove('recording');
        document.getElementById('recordStatus').textContent = 'Recording Stopped';
        this.updateStatus('audioStatus', 'Ready', 'success');
    }
    
    animateVisualizer() {
        if (!this.isRecording || !this.analyser) return;
        
        const dataArray = new Uint8Array(this.analyser.frequencyBinCount);
        this.analyser.getByteFrequencyData(dataArray);
        
        const bars = document.querySelectorAll('.audio-bar');
        bars.forEach((bar, index) => {
            const value = dataArray[index * 2] || 0;
            const height = (value / 255) * 100;
            bar.style.height = `${Math.max(8, height)}px`;
        });
        
        requestAnimationFrame(() => this.animateVisualizer());
    }
    
    addTranscriptSegment(data) {
        const content = document.getElementById('transcriptContent');
        const emptyState = content.querySelector('.empty-state');
        if (emptyState) {
            emptyState.remove();
        }
        
        const segment = document.createElement('div');
        segment.className = 'transcript-segment';
        
        const meta = document.createElement('div');
        meta.className = 'segment-meta';
        meta.innerHTML = `<i data-feather="user" style="width: 12px; height: 12px;"></i> Speaker · ${new Date().toLocaleTimeString()}`;
        
        const text = document.createElement('div');
        text.className = 'segment-text';
        text.textContent = data.text || '';
        
        segment.appendChild(meta);
        segment.appendChild(text);
        content.appendChild(segment);
        
        // Replace icons
        if (typeof feather !== 'undefined') {
            feather.replace();
        }
        
        // Auto-scroll
        if (document.getElementById('autoScroll').checked) {
            content.scrollTop = content.scrollHeight;
        }
        
        // Update metrics
        this.wordCount += (data.text || '').split(' ').length;
        document.getElementById('totalWords').textContent = this.wordCount;
        
        this.transcriptSegments.push(data);
    }
    
    clearTranscript() {
        if (confirm('Clear transcript?')) {
            document.getElementById('transcriptContent').innerHTML = '<div class="empty-state"><div class="empty-icon"><i data-feather="mic"></i></div><p>Click the record button to start transcribing</p></div>';
            this.transcriptSegments = [];
            this.wordCount = 0;
            document.getElementById('totalWords').textContent = '0';
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        }
    }
    
    copyTranscript() {
        const text = this.transcriptSegments.map(s => s.text).join(' ');
        navigator.clipboard.writeText(text).then(() => {
            alert('Transcript copied!');
        });
    }
    
    downloadTranscript() {
        const text = this.transcriptSegments.map(s => s.text).join('\n\n');
        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `transcript-${new Date().toISOString()}.txt`;
        a.click();
    }
    
    startTimer() {
        setInterval(() => {
            if (this.isRecording && this.startTime) {
                const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('recordTimer').textContent = 
                    `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                document.getElementById('duration').textContent = 
                    `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                
                // Calculate WPM
                if (minutes > 0) {
                    const wpm = Math.floor(this.wordCount / minutes);
                    document.getElementById('wordsPerMin').textContent = wpm;
                }
            }
        }, 1000);
    }
    
    updateStatus(elementId, text, type = 'success') {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = text;
            element.className = 'status-badge';
            if (type === 'error') {
                element.classList.add('error');
            }
        }
    }
}

// Initialize app
const app = new LiveTranscriptionApp();
</script>
{% endblock %}
