{% extends "base.html" %}

{% block title %}Live Recording Studio - {{ super() }}{% endblock %}

{% block head %}
    <!-- Live transcription page uses mina-live.css for styling -->
    <!-- Premium Live CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/premium-live.css') }}">
{% endblock %}

{% block content %}
    <div class="recording-studio live-page">
        <!-- Studio Header -->
        <header class="live-studio-header" role="banner">
            <h1 class="live-brand-title">Mina</h1>
            <p class="live-subtitle">Professional Live Transcription Studio</p>
        </header>
        
        <!-- Recording Controls -->
        <div class="live-recording-controls">
            <button class="live-record-btn" id="recordBtn" onclick="app.toggleRecording()" aria-label="Start/Stop Recording">
                <div class="live-record-icon">
                    <i class="fas fa-microphone" id="recordIcon"></i>
                </div>
                <span id="recordText">Start Recording</span>
            </button>
        </div>

        <!-- Compact Status Bar -->
        <div class="live-status-bar">
            <div class="live-status-compact">
                <div class="live-status-badge" id="connectionStatus">
                    <span class="status-dot"></span>
                    <span class="status-text">Connection</span>
                </div>
                <div class="live-status-badge" id="audioStatus">
                    <span class="status-dot"></span>
                    <span class="status-text">Audio</span>
                </div>
                <div class="live-status-badge" id="transcriptionStatus">
                    <span class="status-dot"></span>
                    <span class="status-text">Transcription</span>
                </div>
                <div class="live-status-badge" id="timerBadge">
                    <i class="fas fa-clock"></i>
                    <span class="status-text" id="sessionTimer">00:00</span>
                </div>
            </div>
        </div>

        <!-- Compact Audio Visualizer -->
        <div class="live-audio-visualizer">
            <div class="live-audio-bars" id="audioBars">
                <!-- Audio bars will be generated by JavaScript -->
            </div>
        </div>

        <!-- Transcript Container -->
        <div class="live-transcript-container">
            <div class="live-transcript-header">
                <h2 class="live-transcript-title">Live Transcript</h2>
                <div class="live-transcript-actions">
                    <button class="live-transcript-btn" onclick="app.clearTranscript()" aria-label="Clear transcript">
                        <i class="fas fa-trash"></i>
                        Clear
                    </button>
                    <button class="live-transcript-btn" onclick="app.exportTranscript()" aria-label="Export transcript">
                        <i class="fas fa-download"></i>
                        Export
                    </button>
                    <button class="live-transcript-btn" onclick="app.copyTranscript()" aria-label="Copy transcript">
                        <i class="fas fa-copy"></i>
                        Copy
                    </button>
                </div>
            </div>
            <div class="live-transcript-content" id="transcriptContent">
                <div class="live-transcript-segment">
                    <div class="live-segment-header">
                        <span class="live-segment-speaker">Speaker</span>
                        <span class="live-segment-timestamp">00:00</span>
                    </div>
                    <p class="live-segment-text">Start speaking to see your live transcription appear here...</p>
                    <div class="live-segment-confidence">
                        <span>Confidence:</span>
                        <div class="live-confidence-bar">
                            <div class="live-confidence-fill" style="width: 0%"></div>
                        </div>
                        <span>0%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Metrics Panel -->
        <div class="live-metrics-panel">
            <div class="live-metric-card">
                <div class="live-metric-value" id="wordsPerMinute">0</div>
                <div class="live-metric-label">Words/Min</div>
                <div class="live-metric-trend up">
                    <i class="fas fa-arrow-up"></i>
                    <span>0%</span>
                </div>
            </div>
            <div class="live-metric-card">
                <div class="live-metric-value" id="totalWords">0</div>
                <div class="live-metric-label">Total Words</div>
            </div>
            <div class="live-metric-card">
                <div class="live-metric-value" id="accuracy">0%</div>
                <div class="live-metric-label">Accuracy</div>
                <div class="live-metric-trend up">
                    <i class="fas fa-arrow-up"></i>
                    <span>95%</span>
                </div>
            </div>
            <div class="live-metric-card">
                <div class="live-metric-value" id="sessionDuration">0:00</div>
                <div class="live-metric-label">Duration</div>
            </div>
        </div>

        <!-- Settings Panel -->
        <div class="live-settings-panel">
            <div class="live-settings-header">
                <h3 class="live-settings-title">Settings</h3>
                <button class="live-settings-toggle" onclick="app.toggleSettings()">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
            <div class="live-settings-grid" id="settingsGrid">
                <div class="live-setting-group">
                    <label class="live-setting-label">Language</label>
                    <select class="live-setting-control" id="languageSelect">
                        <option value="en-US">English (US)</option>
                        <option value="en-GB">English (UK)</option>
                        <option value="es-ES">Spanish</option>
                        <option value="fr-FR">French</option>
                        <option value="de-DE">German</option>
                    </select>
                </div>
                <div class="live-setting-group">
                    <label class="live-setting-label">Auto-scroll</label>
                    <input type="checkbox" class="live-setting-control" id="autoScroll" checked>
                </div>
                <div class="live-setting-group">
                    <label class="live-setting-label">Speaker Detection</label>
                    <input type="checkbox" class="live-setting-control" id="speakerDetection" checked>
                </div>
                <div class="live-setting-group">
                    <label class="live-setting-label">Punctuation</label>
                    <input type="checkbox" class="live-setting-control" id="punctuation" checked>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Actions -->
    <div class="live-floating-actions">
        <button class="live-floating-btn primary" onclick="app.saveSession()" aria-label="Save session">
            <i class="fas fa-save"></i>
        </button>
        <button class="live-floating-btn" onclick="app.shareSession()" aria-label="Share session">
            <i class="fas fa-share-alt"></i>
        </button>
        <button class="live-floating-btn danger" onclick="app.stopSession()" aria-label="Stop session">
            <i class="fas fa-stop"></i>
        </button>
    </div>
{% endblock %}

{% block scripts %}
    <!-- Socket.IO Client Library -->
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js" 
            integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+" 
            crossorigin="anonymous"></script>
    
    <script>
        // Live Transcription App
        class LiveTranscriptionApp {
            constructor() {
                this.isRecording = false;
                this.socket = null;
                this.mediaRecorder = null;
                this.audioContext = null;
                this.analyser = null;
                this.audioStream = null;
                this.sessionStartTime = null;
                this.transcriptSegments = [];
                this.settings = {
                    language: 'en-US',
                    autoScroll: true,
                    speakerDetection: true,
                    punctuation: true
                };
                
                this.init();
            }
            
            init() {
                this.initializeSocketIO();
                this.setupEventListeners();
                this.initializeAudioVisualization();
                this.initializeSettingsPanel();
                this.updateStatus('ready');
                console.log('Live Transcription App initialized');
            }
            
            initializeSettingsPanel() {
                const panel = document.getElementById('settingsGrid');
                if (panel) {
                    panel.style.display = '';
                    panel.setAttribute('role', 'region');
                    panel.setAttribute('aria-hidden', 'true');
                }
                
                const btn = document.querySelector('.live-settings-toggle');
                if (btn) {
                    btn.setAttribute('aria-expanded', 'false');
                    btn.setAttribute('aria-controls', 'settingsGrid');
                }
            }
            
            initializeSocketIO() {
                if (typeof io !== 'undefined') {
                    this.socket = io('/live-transcription');
                    
                    this.socket.on('connect', () => {
                        console.log('Connected to live transcription service');
                        this.updateConnectionStatus('connected');
                    });
                    
                    this.socket.on('disconnect', () => {
                        console.log('Disconnected from live transcription service');
                        this.updateConnectionStatus('disconnected');
                    });
                    
                    this.socket.on('transcription_segment', (data) => {
                        this.handleTranscriptionSegment(data);
                    });
                    
                    this.socket.on('transcription_final', (data) => {
                        this.handleFinalTranscription(data);
                    });
                } else {
                    console.warn('Socket.IO not available, live features disabled');
                }
            }
            
            setupEventListeners() {
                // Settings
                document.getElementById('languageSelect').addEventListener('change', (e) => {
                    this.settings.language = e.target.value;
                });
                
                document.getElementById('autoScroll').addEventListener('change', (e) => {
                    this.settings.autoScroll = e.target.checked;
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch(e.key) {
                            case 'r':
                                e.preventDefault();
                                this.toggleRecording();
                                break;
                            case 's':
                                e.preventDefault();
                                this.saveSession();
                                break;
                            case 'c':
                                e.preventDefault();
                                this.copyTranscript();
                                break;
                        }
                    }
                    
                    if (e.key === 'Escape' && this.isRecording) {
                        this.stopRecording();
                    }
                });
            }
            
            initializeAudioVisualization() {
                const barsContainer = document.getElementById('audioBars');
                barsContainer.innerHTML = '';
                
                for (let i = 0; i < 20; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'live-audio-bar';
                    bar.style.height = '4px';
                    barsContainer.appendChild(bar);
                }
            }
            
            async toggleRecording() {
                if (this.isRecording) {
                    this.stopRecording();
                } else {
                    await this.startRecording();
                }
            }
            
            async startRecording() {
                try {
                    this.audioStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        } 
                    });
                    
                    this.setupAudioProcessing();
                    this.setupMediaRecorder();
                    
                    this.mediaRecorder.start(100); // Send data every 100ms
                    this.isRecording = true;
                    this.sessionStartTime = Date.now();
                    
                    this.updateRecordingUI(true);
                    this.updateStatus('recording');
                    this.startSessionTimer();
                    
                    if (this.socket) {
                        this.socket.emit('start_session', {
                            language: this.settings.language,
                            speaker_detection: this.settings.speakerDetection,
                            punctuation: this.settings.punctuation
                        });
                    }
                    
                    console.log('Recording started');
                } catch (error) {
                    console.error('Error starting recording:', error);
                    this.updateStatus('error');
                }
            }
            
            stopRecording() {
                if (this.mediaRecorder && this.mediaRecorder.state !== 'inactive') {
                    this.mediaRecorder.stop();
                }
                
                if (this.audioStream) {
                    this.audioStream.getTracks().forEach(track => track.stop());
                }
                
                this.isRecording = false;
                this.updateRecordingUI(false);
                this.updateStatus('ready');
                
                if (this.socket) {
                    this.socket.emit('end_session');
                }
                
                console.log('Recording stopped');
            }
            
            setupAudioProcessing() {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                this.analyser = this.audioContext.createAnalyser();
                this.analyser.fftSize = 256;
                
                const source = this.audioContext.createMediaStreamSource(this.audioStream);
                source.connect(this.analyser);
                
                this.visualizeAudio();
            }
            
            setupMediaRecorder() {
                this.mediaRecorder = new MediaRecorder(this.audioStream, {
                    mimeType: 'audio/webm;codecs=opus'
                });
                
                this.mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0 && this.socket) {
                        const reader = new FileReader();
                        reader.onload = () => {
                            this.socket.emit('audio_data', {
                                data: reader.result,
                                timestamp: Date.now()
                            });
                        };
                        reader.readAsArrayBuffer(event.data);
                    }
                };
            }
            
            visualizeAudio() {
                if (!this.isRecording) return;
                
                const dataArray = new Uint8Array(this.analyser.frequencyBinCount);
                this.analyser.getByteFrequencyData(dataArray);
                
                // Check if there's significant audio activity
                const avgVolume = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
                this.updateAudioStatus(avgVolume > 15);
                
                const bars = document.querySelectorAll('.live-audio-bar');
                bars.forEach((bar, index) => {
                    const value = dataArray[index * 2] || 0;
                    const height = Math.max(4, (value / 255) * 60);
                    bar.style.height = height + 'px';
                    
                    if (value > 100) {
                        bar.classList.add('active');
                        setTimeout(() => bar.classList.remove('active'), 100);
                    }
                });
                
                requestAnimationFrame(() => this.visualizeAudio());
            }
            
            handleTranscriptionSegment(data) {
                const transcriptContent = document.getElementById('transcriptContent');
                let segmentElement = document.querySelector(`[data-segment-id="${data.segment_id}"]`);
                
                if (!segmentElement) {
                    segmentElement = this.createSegmentElement(data);
                    transcriptContent.appendChild(segmentElement);
                } else {
                    this.updateSegmentElement(segmentElement, data);
                }
                
                if (this.settings.autoScroll) {
                    segmentElement.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }
                
                this.updateMetrics();
            }
            
            handleFinalTranscription(data) {
                const segmentElement = document.querySelector(`[data-segment-id="${data.segment_id}"]`);
                if (segmentElement) {
                    segmentElement.classList.remove('streaming');
                    segmentElement.classList.add('final');
                    this.updateSegmentElement(segmentElement, data);
                }
                
                this.transcriptSegments.push(data);
            }
            
            createSegmentElement(data) {
                const segment = document.createElement('div');
                segment.className = 'live-transcript-segment streaming';
                segment.setAttribute('data-segment-id', data.segment_id);
                
                segment.innerHTML = `
                    <div class="live-segment-header">
                        <span class="live-segment-speaker">${data.speaker || 'Speaker'}</span>
                        <span class="live-segment-timestamp">${this.formatTimestamp(data.timestamp)}</span>
                    </div>
                    <p class="live-segment-text">${data.text}</p>
                    <div class="live-segment-confidence">
                        <span>Confidence:</span>
                        <div class="live-confidence-bar">
                            <div class="live-confidence-fill" style="width: ${data.confidence * 100}%"></div>
                        </div>
                        <span>${Math.round(data.confidence * 100)}%</span>
                    </div>
                `;
                
                return segment;
            }
            
            updateSegmentElement(element, data) {
                const textElement = element.querySelector('.live-segment-text');
                const confidenceBar = element.querySelector('.live-confidence-fill');
                const confidenceText = element.querySelector('.live-segment-confidence span:last-child');
                
                textElement.textContent = data.text;
                confidenceBar.style.width = `${data.confidence * 100}%`;
                confidenceText.textContent = `${Math.round(data.confidence * 100)}%`;
            }
            
            updateRecordingUI(recording) {
                const recordBtn = document.getElementById('recordBtn');
                const recordIcon = document.getElementById('recordIcon');
                const recordText = document.getElementById('recordText');
                
                if (recording) {
                    recordBtn.classList.add('recording');
                    recordIcon.className = 'fas fa-stop';
                    recordText.textContent = 'Stop Recording';
                } else {
                    recordBtn.classList.remove('recording');
                    recordIcon.className = 'fas fa-microphone';
                    recordText.textContent = 'Start Recording';
                }
            }
            
            updateStatus(status) {
                const statusElement = document.getElementById('transcriptionStatus');
                
                statusElement.classList.remove('active', 'recording', 'processing');
                
                switch(status) {
                    case 'recording':
                    case 'connected':
                        statusElement.classList.add('active');
                        break;
                    case 'processing':
                        statusElement.classList.add('active', 'processing');
                        break;
                }
            }
            
            updateConnectionStatus(status) {
                const connectionElement = document.getElementById('connectionStatus');
                
                if (status === 'connected') {
                    connectionElement.classList.add('active');
                } else {
                    connectionElement.classList.remove('active');
                }
            }
            
            updateAudioStatus(isActive) {
                const audioElement = document.getElementById('audioStatus');
                
                if (isActive) {
                    audioElement.classList.add('active');
                } else {
                    audioElement.classList.remove('active');
                }
            }
            
            startSessionTimer() {
                const timer = document.getElementById('sessionTimer');
                const updateTimer = () => {
                    if (!this.isRecording) return;
                    
                    const elapsed = Date.now() - this.sessionStartTime;
                    const minutes = Math.floor(elapsed / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);
                    timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    setTimeout(updateTimer, 1000);
                };
                updateTimer();
            }
            
            updateMetrics() {
                const wordsPerMinute = document.getElementById('wordsPerMinute');
                const totalWords = document.getElementById('totalWords');
                const accuracy = document.getElementById('accuracy');
                const duration = document.getElementById('sessionDuration');
                
                if (this.transcriptSegments.length > 0) {
                    const totalWordCount = this.transcriptSegments.reduce((acc, segment) => {
                        return acc + (segment.text ? segment.text.split(' ').length : 0);
                    }, 0);
                    
                    const avgConfidence = this.transcriptSegments.reduce((acc, segment) => {
                        return acc + (segment.confidence || 0);
                    }, 0) / this.transcriptSegments.length;
                    
                    totalWords.textContent = totalWordCount;
                    accuracy.textContent = `${Math.round(avgConfidence * 100)}%`;
                    
                    if (this.sessionStartTime) {
                        const elapsedMinutes = (Date.now() - this.sessionStartTime) / 60000;
                        const wpm = Math.round(totalWordCount / Math.max(elapsedMinutes, 0.1));
                        wordsPerMinute.textContent = wpm;
                    }
                }
            }
            
            formatTimestamp(timestamp) {
                const date = new Date(timestamp);
                const minutes = date.getMinutes().toString().padStart(2, '0');
                const seconds = date.getSeconds().toString().padStart(2, '0');
                return `${minutes}:${seconds}`;
            }
            
            // Utility methods
            toggleSettings() {
                const panel = document.getElementById('settingsGrid');
                const btn = document.querySelector('.live-settings-toggle');
                
                if (!panel || !btn) return;
                
                const isOpen = panel.classList.contains('is-open');
                const shouldOpen = !isOpen;
                
                // Update ARIA attributes
                btn.setAttribute('aria-expanded', String(shouldOpen));
                panel.setAttribute('aria-hidden', String(!shouldOpen));
                btn.classList.toggle('is-active', shouldOpen);
                
                // Check for reduced motion preference
                const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
                
                if (prefersReducedMotion) {
                    // Instant toggle for reduced motion
                    panel.classList.toggle('is-open', shouldOpen);
                    if (shouldOpen) {
                        const firstInput = panel.querySelector('input, select, button');
                        if (firstInput) firstInput.focus();
                    }
                    return;
                }
                
                if (shouldOpen) {
                    // Opening animation
                    panel.style.overflow = 'hidden';
                    panel.style.height = '0px';
                    panel.style.opacity = '0';
                    panel.classList.add('is-opening');
                    
                    requestAnimationFrame(() => {
                        const targetHeight = panel.scrollHeight;
                        panel.style.transition = 'height 320ms cubic-bezier(.22,1,.36,1), opacity 240ms ease, transform 320ms cubic-bezier(.22,1,.36,1)';
                        panel.style.height = targetHeight + 'px';
                        panel.style.opacity = '1';
                    });
                    
                    const handleOpenEnd = () => {
                        panel.removeEventListener('transitionend', handleOpenEnd);
                        panel.classList.remove('is-opening');
                        panel.classList.add('is-open');
                        panel.style.height = '';
                        panel.style.transition = '';
                        panel.style.overflow = '';
                        
                        // Move focus to first interactive element
                        const firstInput = panel.querySelector('input, select, button');
                        if (firstInput) firstInput.focus();
                    };
                    
                    panel.addEventListener('transitionend', handleOpenEnd, { once: true });
                } else {
                    // Closing animation
                    const currentHeight = panel.scrollHeight;
                    panel.style.height = currentHeight + 'px';
                    panel.style.overflow = 'hidden';
                    
                    requestAnimationFrame(() => {
                        panel.style.transition = 'height 260ms cubic-bezier(.55,0,.55,.2), opacity 200ms ease, transform 260ms cubic-bezier(.55,0,.55,.2)';
                        panel.style.height = '0px';
                        panel.style.opacity = '0';
                    });
                    
                    const handleCloseEnd = () => {
                        panel.removeEventListener('transitionend', handleCloseEnd);
                        panel.classList.remove('is-open');
                        panel.style.height = '';
                        panel.style.transition = '';
                        panel.style.overflow = '';
                        panel.style.opacity = '';
                        
                        // Return focus to button
                        btn.focus();
                    };
                    
                    panel.addEventListener('transitionend', handleCloseEnd, { once: true });
                }
            }
            
            clearTranscript() {
                if (confirm('Clear all transcript content?')) {
                    document.getElementById('transcriptContent').innerHTML = '';
                    this.transcriptSegments = [];
                }
            }
            
            exportTranscript() {
                const transcript = this.transcriptSegments
                    .map(segment => `[${this.formatTimestamp(segment.timestamp)}] ${segment.speaker || 'Speaker'}: ${segment.text}`)
                    .join('\n');
                
                const blob = new Blob([transcript], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `transcript-${new Date().toISOString().slice(0, 19)}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            }
            
            copyTranscript() {
                const transcript = this.transcriptSegments
                    .map(segment => segment.text)
                    .join(' ');
                
                navigator.clipboard.writeText(transcript).then(() => {
                    console.log('Transcript copied to clipboard');
                }).catch(err => {
                    console.error('Failed to copy transcript:', err);
                });
            }
            
            saveSession() {
                const sessionData = {
                    timestamp: this.sessionStartTime,
                    segments: this.transcriptSegments,
                    settings: this.settings
                };
                
                localStorage.setItem('mina-live-session', JSON.stringify(sessionData));
                console.log('Session saved');
            }
            
            shareSession() {
                if (navigator.share && this.transcriptSegments.length > 0) {
                    const transcript = this.transcriptSegments.map(s => s.text).join(' ');
                    navigator.share({
                        title: 'Mina Live Transcript',
                        text: transcript
                    });
                } else {
                    this.copyTranscript();
                }
            }
            
            stopSession() {
                if (this.isRecording) {
                    this.stopRecording();
                }
                // Additional cleanup if needed
            }
        }
        
        // Initialize app
        const app = new LiveTranscriptionApp();
        window.app = app; // Make accessible globally
        
        // Initialize feather icons
        if (typeof feather !== 'undefined') {
            feather.replace();
        }
    </script>
{% endblock %}