{% extends "base.html" %}

{% block title %}{{ session.title }} - Mina{% endblock %}

{% block head %}
<!-- PREMIUM SESSION DETAIL DESIGN SYSTEM -->
<style>
    /* Session detail specific styles only - backgrounds unified in base.html */

    /* PREMIUM CONTAINER */
    .container {
        position: relative;
        z-index: 10;
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }

    /* PREMIUM CARDS */
    .card {
        background: var(--glass-bg-light);
        backdrop-filter: blur(40px) saturate(180%);
        border-radius: 20px;
        border: 1px solid var(--glass-border);
        box-shadow: 
            0 20px 40px rgba(0, 0, 0, 0.15),
            0 10px 20px rgba(0, 0, 0, 0.1),
            inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    /* PREMIUM BREADCRUMB */
    .breadcrumb {
        background: var(--glass-bg-dark);
        border-radius: 12px;
        padding: 0.75rem 1.5rem;
        margin-bottom: 2rem;
        border: 1px solid var(--glass-border);
    }

    .breadcrumb-item a {
        color: var(--elite-purple-500);
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .breadcrumb-item a:hover {
        color: var(--premium-blue-500);
    }

    /* PREMIUM BADGES */
    .badge {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .bg-success {
        background: linear-gradient(135deg, var(--emerald-500), var(--emerald-600)) !important;
    }

    .bg-primary {
        background: linear-gradient(135deg, var(--elite-purple-500), var(--premium-blue-500)) !important;
    }

    .bg-danger {
        background: linear-gradient(135deg, var(--red-500), var(--red-600)) !important;
    }

    /* PREMIUM BUTTONS */
    .btn {
        border-radius: 12px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-success {
        background: linear-gradient(135deg, var(--emerald-500), var(--emerald-600));
        color: white;
        box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--elite-purple-500), var(--premium-blue-500));
        color: white;
        box-shadow: 0 10px 20px rgba(168, 85, 247, 0.3);
    }

    .btn-outline-primary {
        background: var(--glass-bg-light);
        color: var(--elite-purple-500);
        border: 1px solid var(--glass-border);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    .btn:hover {
        transform: translateY(-2px) scale(1.02);
        box-shadow: 
            0 20px 40px rgba(168, 85, 247, 0.4),
            0 10px 20px rgba(59, 130, 246, 0.3);
    }

    /* PREMIUM TITLES */
    h2 {
        font-size: 2.5rem;
        font-weight: 800;
        background: linear-gradient(135deg, var(--elite-purple-500), var(--premium-blue-600));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 1rem;
    }

    /* RESPONSIVE DESIGN */
    @media (max-width: 768px) {
        .container {
            padding: 1rem;
        }
        .btn-group {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4 animate-fade-in">
    <!-- Premium Session Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('sessions.list_sessions') }}">Sessions</a></li>
                    <li class="breadcrumb-item active" style="color: var(--neutral-600);">{{ session.title }}</li>
                </ol>
            </nav>
            
            <h2 class="mb-2">{{ session.title }}</h2>
            <div class="d-flex align-items-center gap-3">
                {% if session.status == 'active' %}
                    <span class="badge bg-success fs-6">Active</span>
                {% elif session.status == 'completed' %}
                    <span class="badge bg-primary fs-6">Completed</span>
                {% elif session.status == 'error' %}
                    <span class="badge bg-danger fs-6">Error</span>
                {% else %}
                    <span class="badge bg-secondary fs-6">{{ session.status.title() }}</span>
                {% endif %}
                
                <small class="text-muted">
                    ID: <code>{{ session.external_id }}</code>
                </small>
            </div>
        </div>
        <div class="col-md-4 text-end">
            <!-- M4 Share & Export Toolbar -->
            <div class="d-flex gap-2 justify-content-end">
                <!-- Share Button -->
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#shareModal">
                    <i class="fas fa-share-alt"></i> Share
                </button>
                
                <!-- Export Dropdown -->
                <div class="btn-group">
                    <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="fas fa-download"></i> Export
                    </button>
                    <ul class="dropdown-menu">
                        {% if session.status == 'completed' %}
                        <li><a class="dropdown-item" href="/sessions/{{ session.id }}/export.md" download="mina-session-{{ session.id }}.md">
                            <i class="fas fa-file-text me-2"></i>Markdown
                        </a></li>
                        <li><a class="dropdown-item" href="/sessions/{{ session.id }}/export.docx" download="mina-session-{{ session.id }}.docx">
                            <i class="fas fa-file-word me-2"></i>DOCX
                        </a></li>
                        <li><a class="dropdown-item" href="/sessions/{{ session.id }}/export.pdf" download="mina-session-{{ session.id }}.pdf">
                            <i class="fas fa-file-pdf me-2"></i>PDF
                        </a></li>
                        {% else %}
                        <li><span class="dropdown-item text-muted">Complete session to export</span></li>
                        {% endif %}
                    </ul>
                </div>
                
                <!-- New Session Button -->
                <a href="{{ url_for('transcription.live_transcription') }}" class="btn btn-primary">
                    <i class="fas fa-microphone"></i> New Session
                </a>
            </div>
        </div>
    </div>

    <!-- Session Metadata -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Started:</strong><br>
                            <small class="text-muted">
                                {{ session.started_at[:16].replace('T', ' ') if session.started_at else 'N/A' }}
                            </small>
                        </div>
                        <div class="col-md-3">
                            <strong>Completed:</strong><br>
                            <small class="text-muted">
                                {{ session.completed_at[:16].replace('T', ' ') if session.completed_at else 'Not completed' }}
                            </small>
                        </div>
                        <div class="col-md-3">
                            <strong>Segments:</strong><br>
                            <small class="text-muted">{{ segments|length }} total</small>
                        </div>
                        <div class="col-md-3">
                            <strong>Locale:</strong><br>
                            <small class="text-muted">{{ session.locale or 'Not specified' }}</small>
                        </div>
                    </div>
                    
                    {% if session.device_info %}
                    <div class="row mt-3">
                        <div class="col-12">
                            <strong>Device Info:</strong>
                            <div class="mt-2">
                                {% for key, value in session.device_info.items() %}
                                <span class="badge bg-light text-dark me-2">{{ key }}: {{ value }}</span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Transcript Timeline -->
    <div class="row">
        <div class="col-12">
            <h4 class="mb-3">Transcript Timeline</h4>
            
            {% if segments %}
            <div class="card">
                <div class="card-body">
                    <!-- Segment Filter Tabs -->
                    <ul class="nav nav-pills mb-3" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#all-segments">
                                All Segments ({{ segments|length }})
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#final-segments">
                                Final Only ({{ segments|selectattr('is_final')|list|length }})
                            </button>
                        </li>
                    </ul>

                    <!-- All Segments Tab -->
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="all-segments">
                            <div class="transcript-timeline">
                                {% for segment in segments %}
                                <div class="segment-item mb-3 p-3 border rounded {{ 'bg-light' if segment.is_final else 'bg-light bg-opacity-50' }}">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div class="segment-meta">
                                            <span class="badge {{ 'bg-primary' if segment.is_final else 'bg-secondary' }}">
                                                {{ segment.kind.title() }}
                                            </span>
                                            {% if segment.start_time_formatted %}
                                            <small class="text-muted ms-2">
                                                <i class="fas fa-clock"></i> {{ segment.start_time_formatted }}
                                            </small>
                                            {% endif %}
                                            {% if segment.avg_confidence %}
                                            <small class="text-muted ms-2">
                                                <i class="fas fa-signal"></i> {{ (segment.avg_confidence * 100)|round(1) }}%
                                            </small>
                                            {% endif %}
                                        </div>
                                        <small class="text-muted">
                                            {{ segment.created_at[:16].replace('T', ' ') }}
                                        </small>
                                    </div>
                                    <div class="segment-text">
                                        {{ segment.text }}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Final Segments Tab -->
                        <div class="tab-pane fade" id="final-segments">
                            <div class="transcript-timeline">
                                {% set final_segments = segments|selectattr('is_final')|list %}
                                {% if final_segments %}
                                    {% for segment in final_segments %}
                                    <div class="segment-item mb-3 p-3 border rounded bg-light">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div class="segment-meta">
                                                {% if segment.start_time_formatted %}
                                                <small class="text-primary fw-bold">
                                                    <i class="fas fa-clock"></i> {{ segment.start_time_formatted }}
                                                </small>
                                                {% endif %}
                                                {% if segment.avg_confidence %}
                                                <small class="text-muted ms-2">
                                                    <i class="fas fa-signal"></i> {{ (segment.avg_confidence * 100)|round(1) }}%
                                                </small>
                                                {% endif %}
                                            </div>
                                            <small class="text-muted">
                                                {{ segment.created_at[:16].replace('T', ' ') }}
                                            </small>
                                        </div>
                                        <div class="segment-text">
                                            {{ segment.text }}
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="text-center py-4">
                                        <i class="fas fa-info-circle fa-2x text-muted mb-3"></i>
                                        <h5 class="text-muted">No Final Segments</h5>
                                        <p class="text-muted">This session only contains interim transcription results.</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- Empty Transcript State -->
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No Transcript Available</h5>
                    <p class="text-muted">
                        {% if session.status == 'active' %}
                            This session is active but no segments have been transcribed yet.
                        {% else %}
                            This session completed without generating any transcript segments.
                        {% endif %}
                    </p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- M3: AI Summary Section -->
    {% if session.status == 'completed' %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-brain me-2"></i>
                        AI Summary & Insights
                    </h5>
                    <div>
                        <button id="generateSummaryBtn" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-magic me-1"></i>
                            Generate Summary
                        </button>
                        <div id="summaryLoading" class="spinner-border spinner-border-sm text-primary ms-2" role="status" style="display:none;">
                            <span class="visually-hidden">Generating...</span>
                        </div>
                    </div>
                </div>
                
                <div class="card-body" id="summaryContent">
                    <!-- Summary content will be loaded here -->
                    <div id="noSummary" class="text-muted text-center py-4">
                        <i class="fas fa-lightbulb fa-2x mb-3"></i>
                        <p class="mb-0">No summary generated yet. Click "Generate Summary" to analyse this session.</p>
                    </div>
                    
                    <!-- Summary Display -->
                    <div id="summaryDisplay" style="display:none;">
                        <!-- Summary Markdown -->
                        <div id="summaryMd" class="mb-4"></div>
                        
                        <!-- Actions, Decisions, Risks Tabs -->
                        <ul class="nav nav-tabs mb-3" id="insightsTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="actions-tab" data-bs-toggle="tab" data-bs-target="#actions" type="button" role="tab">
                                    <i class="fas fa-tasks me-1"></i>
                                    Actions (<span id="actionsCount">0</span>)
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="decisions-tab" data-bs-toggle="tab" data-bs-target="#decisions" type="button" role="tab">
                                    <i class="fas fa-check-circle me-1"></i>
                                    Decisions (<span id="decisionsCount">0</span>)
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="risks-tab" data-bs-toggle="tab" data-bs-target="#risks" type="button" role="tab">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    Risks (<span id="risksCount">0</span>)
                                </button>
                            </li>
                        </ul>
                        
                        <div class="tab-content" id="insightsTabContent">
                            <!-- Actions Tab -->
                            <div class="tab-pane fade show active" id="actions" role="tabpanel">
                                <div id="actionsList">
                                    <!-- Actions will be populated here -->
                                </div>
                            </div>
                            
                            <!-- Decisions Tab -->
                            <div class="tab-pane fade" id="decisions" role="tabpanel">
                                <div id="decisionsList">
                                    <!-- Decisions will be populated here -->
                                </div>
                            </div>
                            
                            <!-- Risks Tab -->
                            <div class="tab-pane fade" id="risks" role="tabpanel">
                                <div id="risksList">
                                    <!-- Risks will be populated here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Auto-generated badge -->
                        <div class="mt-3">
                            <span class="badge bg-info">
                                <i class="fas fa-robot me-1"></i>
                                Auto-generated insights
                            </span>
                            <small class="text-muted ms-2" id="summaryMeta">
                                <!-- Summary metadata will be shown here -->
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
.segment-item {
    transition: all 0.2s ease;
}

.segment-item:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.segment-text {
    font-size: 1.1em;
    line-height: 1.6;
    color: var(--bs-body-color);
}

.transcript-timeline {
    max-height: 70vh;
    overflow-y: auto;
}

.nav-pills .nav-link.active {
    background-color: var(--bs-primary);
}

.badge {
    font-size: 0.85em;
}
</style>

<script>
// Auto-scroll to export section if linked
if (window.location.hash === '#export') {
    document.getElementById('export').scrollIntoView();
}

// Real-time updates for active sessions
{% if session.status == 'active' %}
setInterval(() => {
    fetch(window.location.pathname + '?format=json')
        .then(response => response.json())
        .then(data => {
            if (data.segments && data.segments.length > {{ segments|length }}) {
                window.location.reload();
            }
        })
        .catch(error => console.error('Error checking for updates:', error));
}, 10000); // Check every 10 seconds
{% endif %}

// M3: Summary functionality
document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generateSummaryBtn');
    const summaryLoading = document.getElementById('summaryLoading');
    const sessionId = {{ session.id }};
    
    // Only initialize if elements exist (completed sessions only)
    if (!generateBtn) return;
    
    // Load existing summary on page load
    loadExistingSummary();
    
    // Generate summary button handler
    generateBtn.addEventListener('click', function() {
        generateSummary();
    });
    
    function loadExistingSummary() {
        fetch(`/sessions/${sessionId}/summary`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.summary) {
                    displaySummary(data.summary);
                }
            })
            .catch(error => {
                console.log('No existing summary found');
            });
    }
    
    function generateSummary() {
        generateBtn.disabled = true;
        summaryLoading.style.display = 'inline-block';
        generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generating...';
        
        fetch(`/sessions/${sessionId}/summarise`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displaySummary(data.summary);
            } else {
                showError('Failed to generate summary: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error generating summary:', error);
            showError('Failed to generate summary. Please try again.');
        })
        .finally(() => {
            generateBtn.disabled = false;
            summaryLoading.style.display = 'none';
            generateBtn.innerHTML = '<i class="fas fa-magic me-1"></i>Generate Summary';
        });
    }
    
    function displaySummary(summary) {
        // Hide no summary message
        document.getElementById('noSummary').style.display = 'none';
        document.getElementById('summaryDisplay').style.display = 'block';
        
        // Update summary markdown (basic parsing)
        const summaryMd = document.getElementById('summaryMd');
        summaryMd.innerHTML = formatMarkdown(summary.summary_md || 'No summary available');
        
        // Update counts and populate tabs
        updateActionsTab(summary.actions || []);
        updateDecisionsTab(summary.decisions || []);
        updateRisksTab(summary.risks || []);
        
        // Update metadata
        const meta = document.getElementById('summaryMeta');
        const createdDate = summary.created_at ? new Date(summary.created_at).toLocaleString() : 'Unknown';
        meta.textContent = `Generated ${createdDate} using ${summary.engine || 'unknown'} engine`;
        
        // Update generate button
        generateBtn.innerHTML = '<i class="fas fa-sync me-1"></i>Regenerate';
    }
    
    function updateActionsTab(actions) {
        const count = document.getElementById('actionsCount');
        const list = document.getElementById('actionsList');
        
        count.textContent = actions.length;
        
        if (actions.length === 0) {
            list.innerHTML = '<p class="text-muted">No actions identified.</p>';
            return;
        }
        
        let html = '';
        actions.forEach((action, index) => {
            const escapedText = escapeHtml(action.text || 'No description');
            html += `
                <div class="border rounded p-3 mb-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <strong>${escapedText}</strong>
                            <div class="mt-1 text-muted small">
                                <i class="fas fa-user me-1"></i>Owner: ${escapeHtml(action.owner || 'Unknown')}
                                <i class="fas fa-calendar ms-3 me-1"></i>Due: ${escapeHtml(action.due || 'Unknown')}
                            </div>
                        </div>
                        <button class="btn btn-outline-secondary btn-sm" onclick="copyToClipboard('${escapedText}')">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
            `;
        });
        list.innerHTML = html;
    }
    
    function updateDecisionsTab(decisions) {
        const count = document.getElementById('decisionsCount');
        const list = document.getElementById('decisionsList');
        
        count.textContent = decisions.length;
        
        if (decisions.length === 0) {
            list.innerHTML = '<p class="text-muted">No decisions identified.</p>';
            return;
        }
        
        let html = '';
        decisions.forEach((decision, index) => {
            const escapedText = escapeHtml(decision.text || 'No description');
            html += `
                <div class="border rounded p-3 mb-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            ${escapedText}
                        </div>
                        <button class="btn btn-outline-secondary btn-sm" onclick="copyToClipboard('${escapedText}')">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
            `;
        });
        list.innerHTML = html;
    }
    
    function updateRisksTab(risks) {
        const count = document.getElementById('risksCount');
        const list = document.getElementById('risksList');
        
        count.textContent = risks.length;
        
        if (risks.length === 0) {
            list.innerHTML = '<p class="text-muted">No risks identified.</p>';
            return;
        }
        
        let html = '';
        risks.forEach((risk, index) => {
            const escapedText = escapeHtml(risk.text || 'No description');
            const escapedMitigation = escapeHtml(risk.mitigation || '');
            html += `
                <div class="border rounded p-3 mb-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-exclamation-triangle text-warning me-2 mt-1"></i>
                                <div>
                                    <strong>${escapedText}</strong>
                                    ${risk.mitigation ? `<div class="mt-2 text-muted small">
                                        <i class="fas fa-shield-alt me-1"></i>
                                        <strong>Mitigation:</strong> ${escapedMitigation}
                                    </div>` : ''}
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-outline-secondary btn-sm" onclick="copyToClipboard('${escapedText}')">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
            `;
        });
        list.innerHTML = html;
    }
    
    function formatMarkdown(md) {
        // Basic markdown parsing for display
        return md
            .replace(/^### (.*$)/gim, '<h5>$1</h5>')
            .replace(/^## (.*$)/gim, '<h4>$1</h4>')
            .replace(/^# (.*$)/gim, '<h3>$1</h3>')
            .replace(/^\- (.*$)/gim, '<li>$1</li>')
            .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
            .replace(/\n/gim, '<br>');
    }
    
    function escapeHtml(text) {
        if (!text) return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }
    
    function showError(message) {
        // Create toast notification for error
        const toast = document.createElement('div');
        toast.className = 'toast-notification error';
        toast.innerHTML = `<i class="fas fa-exclamation-circle me-2"></i>${message}`;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            if (document.body.contains(toast)) {
                document.body.removeChild(toast);
            }
        }, 5000);
    }
});

// Copy to clipboard functionality
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        // Show success feedback
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        toast.innerHTML = '<i class="fas fa-check me-2"></i>Copied to clipboard!';
        document.body.appendChild(toast);
        
        setTimeout(() => {
            if (document.body.contains(toast)) {
                document.body.removeChild(toast);
            }
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy text: ', err);
    });
}
</script>

<style>
.toast-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #28a745;
    color: white;
    padding: 12px 20px;
    border-radius: 5px;
    z-index: 1050;
    animation: fadeInOut 2s ease-in-out;
}

.toast-notification.error {
    background: #dc3545;
}

@keyframes fadeInOut {
    0%, 100% { opacity: 0; transform: translateY(-20px); }
    10%, 90% { opacity: 1; transform: translateY(0); }
}
</style>

<!-- M4 Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shareModalLabel">
                    <i class="fas fa-share-alt me-2"></i>Share Session
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="shareContent">
                    <p class="text-muted">Generate a view-only link to share this session with others.</p>
                    
                    <div class="mb-3">
                        <label for="shareDays" class="form-label">Link expires in:</label>
                        <select class="form-select" id="shareDays">
                            <option value="1">1 day</option>
                            <option value="3">3 days</option>
                            <option value="7" selected>7 days</option>
                            <option value="14">14 days</option>
                            <option value="30">30 days</option>
                        </select>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-success" id="generateShareBtn">
                            <i class="fas fa-link me-2"></i>Generate Share Link
                        </button>
                    </div>
                </div>
                
                <!-- Generated Link Display -->
                <div id="shareResult" style="display: none;">
                    <div class="alert alert-success">
                        <h6 class="alert-heading">
                            <i class="fas fa-check-circle me-2"></i>Share Link Generated!
                        </h6>
                        <p class="mb-3">Anyone with this link can view the session transcript and summary in read-only mode.</p>
                        
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="shareUrl" readonly>
                            <button class="btn btn-outline-primary" type="button" onclick="copyToClipboard(document.getElementById('shareUrl').value)">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                Expires: <span id="shareExpiry"></span>
                            </small>
                            <button type="button" class="btn btn-sm btn-outline-danger" id="deactivateShareBtn">
                                <i class="fas fa-ban me-1"></i>Deactivate
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Error Display -->
                <div id="shareError" style="display: none;">
                    <div class="alert alert-danger">
                        <h6 class="alert-heading">
                            <i class="fas fa-exclamation-triangle me-2"></i>Error
                        </h6>
                        <p id="shareErrorText"></p>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="resetShareModal()">
                            Try Again
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// M4 Share functionality
let currentShareToken = null;

document.getElementById('generateShareBtn').addEventListener('click', function() {
    const days = document.getElementById('shareDays').value;
    const btn = this;
    
    // Show loading state
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
    
    // Generate share link
    fetch(`/sessions/{{ session.id }}/share`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ days: parseInt(days) })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success result
            document.getElementById('shareUrl').value = data.url;
            document.getElementById('shareExpiry').textContent = new Date(Date.now() + data.expires_in_days * 24 * 60 * 60 * 1000).toLocaleDateString();
            currentShareToken = data.token;
            
            document.getElementById('shareContent').style.display = 'none';
            document.getElementById('shareResult').style.display = 'block';
        } else {
            throw new Error(data.error || 'Failed to generate share link');
        }
    })
    .catch(error => {
        // Show error
        document.getElementById('shareErrorText').textContent = error.message;
        document.getElementById('shareContent').style.display = 'none';
        document.getElementById('shareError').style.display = 'block';
    })
    .finally(() => {
        // Reset button
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-link me-2"></i>Generate Share Link';
    });
});

document.getElementById('deactivateShareBtn').addEventListener('click', function() {
    if (!currentShareToken) return;
    
    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Deactivating...';
    
    fetch(`/sessions/{{ session.id }}/share/${currentShareToken}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reset modal
            resetShareModal();
            
            // Show toast notification
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.innerHTML = '<i class="fas fa-check me-2"></i>Share link deactivated!';
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 3000);
        } else {
            throw new Error(data.error || 'Failed to deactivate link');
        }
    })
    .catch(error => {
        console.error('Error deactivating share link:', error);
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-ban me-1"></i>Deactivate';
    });
});

function resetShareModal() {
    document.getElementById('shareContent').style.display = 'block';
    document.getElementById('shareResult').style.display = 'none';
    document.getElementById('shareError').style.display = 'none';
    currentShareToken = null;
}

// Reset modal when it's closed
document.getElementById('shareModal').addEventListener('hidden.bs.modal', resetShareModal);
</script>

{% endblock %}