{% extends "base.html" %}

{% block title %}AI Copilot - Mina{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/copilot.css') }}">
{% endblock %}

{% block content %}
<div class="copilot-workspace">
    <!-- Left Sidebar: Context & Quick Actions -->
    <aside class="copilot-sidebar">
        <div style="padding: var(--space-6); border-bottom: 1px solid var(--color-border);">
            <h2 class="font-semibold mb-4">Context</h2>
            <select class="w-full p-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-sm">
                <option value="all">All Meetings</option>
                <option value="recent">Recent Meetings</option>
                <option value="today">Today's Meetings</option>
                <option value="week">This Week</option>
            </select>
        </div>

        <div style="padding: var(--space-6); border-bottom: 1px solid var(--color-border);">
            <h3 class="text-sm font-semibold mb-3 text-tertiary">Quick Actions</h3>
            <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                <button class="quick-action-btn" data-prompt="What decisions were made today?">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    Today's Decisions
                </button>
                <button class="quick-action-btn" data-prompt="Show me all overdue tasks">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Overdue Tasks
                </button>
                <button class="quick-action-btn" data-prompt="Summarize this week's meetings">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    Weekly Summary
                </button>
                <button class="quick-action-btn" data-prompt="What are the key risks identified?">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    Key Risks
                </button>
            </div>
        </div>

        <div style="flex: 1; overflow-y: auto; padding: var(--space-6);">
            <h3 class="text-sm font-semibold mb-3 text-tertiary">Recent Conversations</h3>
            <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                <div class="conversation-item">
                    <p class="text-sm font-medium truncate">Q3 Budget Discussion</p>
                    <p class="text-xs text-tertiary">2 hours ago</p>
                </div>
                <div class="conversation-item">
                    <p class="text-sm font-medium truncate">Weekly Task Review</p>
                    <p class="text-xs text-tertiary">Yesterday</p>
                </div>
                <div class="conversation-item">
                    <p class="text-sm font-medium truncate">Product Roadmap Query</p>
                    <p class="text-xs text-tertiary">2 days ago</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Center: Chat Interface -->
    <main class="copilot-main">
        <div class="copilot-header">
            <h1 class="copilot-title text-2xl font-bold mb-1">AI Copilot</h1>
            <p class="text-sm text-secondary">Ask questions about your meetings, tasks, and insights</p>
        </div>

        <div id="chat-messages" class="chat-messages-container">
            <!-- Welcome Message -->
            <div class="message-assistant">
                <div class="message-avatar">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                </div>
                <div class="message-content">
                    <p class="mb-2">Hello! I'm your AI Copilot for Mina. I can help you:</p>
                    <ul class="text-sm" style="list-style: disc; margin-left: var(--space-5); display: flex; flex-direction: column; gap: var(--space-1);">
                        <li>Find information from your meetings and transcripts</li>
                        <li>Summarize discussions and extract key decisions</li>
                        <li>Manage tasks and track action items</li>
                        <li>Identify risks, blockers, and follow-ups</li>
                    </ul>
                    <p class="mt-3 text-sm text-secondary">Try asking "What's due today?" or use a quick action from the sidebar.</p>
                </div>
            </div>
        </div>

        <div class="chat-input-container">
            <!-- Suggested Prompts -->
            <div id="suggested-prompts" class="mb-3" style="display: flex; gap: var(--space-2); flex-wrap: wrap;">
                <button class="prompt-chip" data-prompt="What's due today?">What's due today?</button>
                <button class="prompt-chip" data-prompt="Summarize yesterday's meetings">Summarize yesterday</button>
                <button class="prompt-chip" data-prompt="Show action items">Show action items</button>
            </div>

            <form id="chat-form" style="display: flex; gap: var(--space-2); align-items: end;">
                <div style="flex: 1; display: flex; flex-direction: column;">
                    <textarea 
                        id="chat-input" 
                        placeholder="Ask about your meetings, decisions, or action items..." 
                        rows="1"
                        class="w-full p-3"
                        style="max-height: 120px;"
                    ></textarea>
                </div>
                <button type="submit" class="chat-send-btn">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                    </svg>
                </button>
            </form>
        </div>
    </main>

    <!-- Right Sidebar: Insights & Actions -->
    <aside class="copilot-insights">
        <div style="padding: var(--space-6); border-bottom: 1px solid var(--color-border);">
            <h2 class="font-semibold mb-4">Smart Insights</h2>
            <div class="insight-card" style="background: rgba(99, 102, 241, 0.1); border-left: 3px solid var(--color-primary); padding: var(--space-3); border-radius: var(--radius-md);">
                <p class="text-sm font-medium mb-1">3 overdue tasks</p>
                <p class="text-xs text-secondary">From meetings this week</p>
            </div>
        </div>

        <div style="padding: var(--space-6); border-bottom: 1px solid var(--color-border);">
            <h3 class="text-sm font-semibold mb-3">Quick Stats</h3>
            <div style="display: flex; flex-direction: column; gap: var(--space-3);">
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm text-tertiary">Meetings Today</span>
                        <span class="font-semibold">5</span>
                    </div>
                    <div class="h-1 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                        <div class="h-full bg-primary" style="width: 80%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm text-tertiary">Tasks Completed</span>
                        <span class="font-semibold">12/15</span>
                    </div>
                    <div class="h-1 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                        <div class="h-full bg-success" style="width: 80%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div style="padding: var(--space-6);">
            <h3 class="text-sm font-semibold mb-3">Suggested Actions</h3>
            <div id="action-buttons" style="display: flex; flex-direction: column; gap: var(--space-2);">
                <button class="action-btn">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                    </svg>
                    Create Task from Chat
                </button>
                <button class="action-btn">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    Add to Calendar
                </button>
                <button class="action-btn">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                    </svg>
                    Share Insights
                </button>
            </div>
        </div>
    </aside>
</div>

<script>
const chatForm = document.getElementById('chat-form');
const chatInput = document.getElementById('chat-input');
const chatMessages = document.getElementById('chat-messages');
const suggestedPrompts = document.getElementById('suggested-prompts');

// Auto-resize textarea
chatInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

// Send message
async function sendMessage(message) {
    if (!message.trim()) return;

    addUserMessage(message);
    chatInput.value = '';
    chatInput.style.height = 'auto';
    
    hideSuggestedPrompts();
    const loadingId = addLoadingMessage();

    try {
        const response = await fetch('/copilot/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message })
        });

        const data = await response.json();
        removeLoadingMessage(loadingId);
        
        if (data.success) {
            addAssistantMessage(data.response);
        } else {
            addErrorMessage(data.error || 'Failed to get response');
        }
    } catch (error) {
        removeLoadingMessage(loadingId);
        addErrorMessage('Network error. Please try again.');
    }
}

function addUserMessage(text) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message-user';
    messageDiv.innerHTML = `
        <div class="message-avatar">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
        </div>
        <div class="message-content">${escapeHtml(text)}</div>
    `;
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
}

function addAssistantMessage(response) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message-assistant';
    
    let html = `
        <div class="message-avatar">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
            </svg>
        </div>
        <div class="message-content">
            <p>${escapeHtml(response.text)}</p>
    `;
    
    if (response.citations && response.citations.length > 0) {
        html += '<div style="display: flex; flex-wrap: wrap; gap: var(--space-2); margin-top: var(--space-3);">';
        response.citations.forEach(citation => {
            html += `
                <span class="citation-badge">
                    <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    ${escapeHtml(citation.title)}
                </span>
            `;
        });
        html += '</div>';
    }
    
    html += '</div>';
    messageDiv.innerHTML = html;
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
}

function addLoadingMessage() {
    const id = 'loading-' + Date.now();
    const messageDiv = document.createElement('div');
    messageDiv.id = id;
    messageDiv.className = 'loading-message message-assistant';
    messageDiv.innerHTML = `
        <div class="message-avatar">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
            </svg>
        </div>
        <div class="message-content">
            <div style="display: flex; align-items: center; gap: var(--space-2);">
                <span>Thinking</span>
                <div class="loading-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
    `;
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
    return id;
}

function removeLoadingMessage(id) {
    const element = document.getElementById(id);
    if (element) element.remove();
}

function addErrorMessage(text) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message-assistant';
    messageDiv.innerHTML = `
        <div class="message-avatar" style="background: var(--color-error);">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
        </div>
        <div class="message-content" style="border-color: var(--color-error);">
            <p style="color: var(--color-error);">${escapeHtml(text)}</p>
        </div>
    `;
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
}

function hideSuggestedPrompts() {
    suggestedPrompts.style.display = 'none';
}

function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Event Listeners
chatForm.addEventListener('submit', (e) => {
    e.preventDefault();
    sendMessage(chatInput.value);
});

document.querySelectorAll('.quick-action-btn, .prompt-chip').forEach(btn => {
    btn.addEventListener('click', () => {
        const prompt = btn.dataset.prompt || btn.textContent;
        sendMessage(prompt);
    });
});

// Enter to send, Shift+Enter for new line
chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage(chatInput.value);
    }
});
</script>
{% endblock %}
