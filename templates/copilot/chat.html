{% extends "base.html" %}

{% block title %}AI Copilot - {{ super() }}{% endblock %}

{% block head %}
    <!-- Crown+ Design System -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/crown-base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/crown-design-system.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/crown-components.css') }}">
    
    <style>
        .copilot-container {
            min-height: 100vh;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
        }
        
        .copilot-header {
            padding: var(--spacing-6) var(--spacing-4);
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border-bottom: 1px solid var(--border-subtle);
        }
        
        .copilot-title {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-2);
        }
        
        .copilot-subtitle {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }
        
        .copilot-main {
            flex: 1;
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            overflow: hidden;
        }
        
        /* Quick Queries Sidebar */
        .quick-queries-sidebar {
            width: 300px;
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border-right: 1px solid var(--border-subtle);
            padding: var(--spacing-6);
            overflow-y: auto;
        }
        
        .quick-queries-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--text-primary);
            margin-bottom: var(--spacing-4);
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
        }
        
        .query-button {
            width: 100%;
            padding: var(--spacing-3) var(--spacing-4);
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            color: var(--text-primary);
            font-size: var(--font-size-sm);
            text-align: left;
            cursor: pointer;
            transition: all var(--transition-fast);
            margin-bottom: var(--spacing-2);
        }
        
        .query-button:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-interactive);
            transform: translateX(4px);
        }
        
        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
        }
        
        .chat-messages {
            flex: 1;
            padding: var(--spacing-6);
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        
        .message {
            display: flex;
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-6);
            animation: messageSlideIn 0.3s ease-out;
        }
        
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-xl);
            flex-shrink: 0;
        }
        
        .assistant-avatar {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
        }
        
        .user-avatar {
            background: var(--bg-secondary);
            border: 2px solid var(--border-subtle);
        }
        
        .message-content {
            flex: 1;
            max-width: 700px;
        }
        
        .user-message {
            flex-direction: row-reverse;
            margin-left: auto;
        }
        
        .user-message .message-content {
            margin-left: auto;
        }
        
        .message-bubble {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            padding: var(--spacing-4);
            position: relative;
        }
        
        .user-message .message-bubble {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border-color: var(--border-interactive);
        }
        
        .message-text {
            color: var(--text-primary);
            line-height: 1.6;
            margin: 0;
        }
        
        .message-timestamp {
            font-size: var(--font-size-xs);
            color: var(--text-tertiary);
            margin-top: var(--spacing-2);
        }
        
        .message-actions {
            display: flex;
            gap: var(--spacing-2);
            margin-top: var(--spacing-3);
            flex-wrap: wrap;
        }
        
        .action-button {
            padding: var(--spacing-2) var(--spacing-3);
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
        }
        
        .action-button:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-interactive);
            transform: translateY(-1px);
        }
        
        .citations {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-2);
            margin-top: var(--spacing-3);
        }
        
        .citation {
            padding: var(--spacing-1) var(--spacing-3);
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
        }
        
        /* Typing Indicator */
        .typing-indicator {
            display: none;
            padding: var(--spacing-4) var(--spacing-6);
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
            font-style: italic;
        }
        
        .typing-indicator.show {
            display: block;
        }
        
        .loading-dots::after {
            content: '...';
            animation: loadingDots 1.5s infinite;
        }
        
        @keyframes loadingDots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        /* Chat Input */
        .chat-input {
            padding: var(--spacing-4);
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            border-top: 1px solid var(--border-subtle);
        }
        
        .input-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            gap: var(--spacing-3);
            align-items: flex-end;
        }
        
        .input-field {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: var(--spacing-3) var(--spacing-4);
            color: var(--text-primary);
            font-size: var(--font-size-base);
            line-height: 1.5;
            resize: none;
            min-height: 44px;
            max-height: 200px;
            transition: all var(--transition-fast);
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--border-interactive);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .send-button {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
            flex-shrink: 0;
        }
        
        .send-button:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .quick-queries-sidebar {
                display: none;
            }
            
            .copilot-main {
                flex-direction: column;
            }
            
            .chat-messages {
                padding: var(--spacing-4);
            }
            
            .message-content {
                max-width: 100%;
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="copilot-container">
    <div class="copilot-header">
        <h1 class="copilot-title">
            <i class="fas fa-robot" aria-hidden="true"></i>
            AI Copilot
        </h1>
        <p class="copilot-subtitle">Ask me anything about your meetings, tasks, and decisions</p>
    </div>
    
    <div class="copilot-main">
        <!-- Quick Queries Sidebar -->
        <aside class="quick-queries-sidebar">
            <h2 class="quick-queries-title">
                <i class="fas fa-bolt" aria-hidden="true"></i>
                Quick Queries
            </h2>
            <div id="quick-queries-container">
                <button class="query-button">What's due today?</button>
                <button class="query-button">Summarize this week's meetings</button>
                <button class="query-button">Show pending action items</button>
                <button class="query-button">What did we decide about the budget?</button>
                <button class="query-button">List all high-priority tasks</button>
            </div>
        </aside>
        
        <!-- Chat Area -->
        <div class="chat-area">
            <div class="chat-messages" id="chat-messages">
                <div class="message assistant-message">
                    <div class="message-avatar assistant-avatar">🤖</div>
                    <div class="message-content">
                        <div class="message-bubble">
                            <p class="message-text">
                                Hi! I'm your AI Copilot. I can help you with questions about your meetings, tasks, and decisions. 
                                Try asking me things like "What's due today?" or "What did we decide about the budget?"
                            </p>
                            <div class="message-timestamp">Just now</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="typing-indicator" id="typing-indicator">
                AI Copilot is thinking<span class="loading-dots"></span>
            </div>
            
            <div class="chat-input">
                <div class="input-container">
                    <textarea 
                        id="message-input" 
                        class="input-field" 
                        placeholder="Ask me anything about your meetings, tasks, or decisions..." 
                        rows="1"
                        aria-label="Message input"></textarea>
                    <button id="send-button" class="send-button" aria-label="Send message">
                        <i class="fas fa-paper-plane" aria-hidden="true"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// DOM elements
const chatMessages = document.getElementById('chat-messages');
const messageInput = document.getElementById('message-input');
const sendButton = document.getElementById('send-button');
const typingIndicator = document.getElementById('typing-indicator');
const quickQueriesContainer = document.getElementById('quick-queries-container');

// Load quick queries
async function loadQuickQueries() {
    try {
        const response = await fetch('/copilot/api/quick-queries');
        const data = await response.json();
        
        if (data.success && data.queries.length > 0) {
            quickQueriesContainer.innerHTML = '';
            data.queries.forEach(query => {
                const button = document.createElement('button');
                button.className = 'query-button';
                button.textContent = query;
                button.onclick = () => sendMessage(query);
                quickQueriesContainer.appendChild(button);
            });
        }
    } catch (error) {
        console.error('Error loading quick queries:', error);
    }
}

// Auto-resize textarea
messageInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 200) + 'px';
});

// Send message on Enter (Shift+Enter for new line)
messageInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// Send button click
sendButton.addEventListener('click', sendMessage);

// Send message function
async function sendMessage(text = null) {
    const message = text || messageInput.value.trim();
    if (!message) return;
    
    // Clear input if not using predefined text
    if (!text) {
        messageInput.value = '';
        messageInput.style.height = 'auto';
    }
    
    // Add user message to chat
    addMessage(message, 'user');
    
    // Show typing indicator
    showTypingIndicator();
    
    // Disable input
    setInputDisabled(true);
    
    try {
        const response = await fetch('/copilot/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message })
        });
        
        const data = await response.json();
        
        if (data.success) {
            addMessage(data.response.text, 'assistant', data.response);
        } else {
            addMessage('I apologize, but I encountered an error processing your request. Please try again.', 'assistant');
        }
    } catch (error) {
        console.error('Error sending message:', error);
        addMessage('I apologize, but I encountered a network error. Please check your connection and try again.', 'assistant');
    } finally {
        hideTypingIndicator();
        setInputDisabled(false);
        messageInput.focus();
    }
}

// Add message to chat
function addMessage(text, sender, response = null) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    
    const avatar = document.createElement('div');
    avatar.className = `message-avatar ${sender}-avatar`;
    avatar.textContent = sender === 'user' ? '👤' : '🤖';
    
    const content = document.createElement('div');
    content.className = 'message-content';
    
    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';
    
    const messageText = document.createElement('p');
    messageText.className = 'message-text';
    messageText.textContent = text;
    
    const timestamp = document.createElement('div');
    timestamp.className = 'message-timestamp';
    timestamp.textContent = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    
    bubble.appendChild(messageText);
    bubble.appendChild(timestamp);
    content.appendChild(bubble);
    
    // Add action buttons for assistant messages
    if (sender === 'assistant' && response && response.suggested_actions && response.suggested_actions.length > 0) {
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'message-actions';
        
        response.suggested_actions.forEach(action => {
            const button = document.createElement('button');
            button.className = 'action-button';
            button.innerHTML = `<i class="fas fa-${action.icon}" aria-hidden="true"></i> ${action.label}`;
            button.onclick = () => executeAction(action.type, {});
            actionsDiv.appendChild(button);
        });
        
        content.appendChild(actionsDiv);
    }
    
    // Add citations for assistant messages
    if (sender === 'assistant' && response && response.citations && response.citations.length > 0) {
        const citationsDiv = document.createElement('div');
        citationsDiv.className = 'citations';
        
        response.citations.forEach(citation => {
            const citationSpan = document.createElement('span');
            citationSpan.className = 'citation';
            citationSpan.textContent = `${citation.type}: ${citation.title}`;
            citationsDiv.appendChild(citationSpan);
        });
        
        content.appendChild(citationsDiv);
    }
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);
    
    chatMessages.appendChild(messageDiv);
    
    // Scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Execute copilot action
async function executeAction(action, parameters) {
    try {
        const response = await fetch('/copilot/api/execute-action', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ action, parameters })
        });
        
        const data = await response.json();
        
        if (data.success) {
            addMessage(data.result.message || 'Action completed successfully.', 'assistant');
        } else {
            addMessage(`Failed to execute action: ${data.error}`, 'assistant');
        }
    } catch (error) {
        console.error('Error executing action:', error);
        addMessage('Failed to execute action. Please try again.', 'assistant');
    }
}

// Show typing indicator
function showTypingIndicator() {
    typingIndicator.classList.add('show');
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Hide typing indicator
function hideTypingIndicator() {
    typingIndicator.classList.remove('show');
}

// Set input disabled state
function setInputDisabled(disabled) {
    messageInput.disabled = disabled;
    sendButton.disabled = disabled;
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadQuickQueries();
    messageInput.focus();
    
    // Attach quick query buttons
    quickQueriesContainer.querySelectorAll('.query-button').forEach(button => {
        button.onclick = () => sendMessage(button.textContent);
    });
});
</script>
{% endblock %}
