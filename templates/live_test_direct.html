<!DOCTYPE html>
<html>
<head>
    <title>üî¥ LIVE TRANSCRIPTION TEST - Direct Connection</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: monospace; background: #1a1a1a; color: #fff; padding: 20px; }
        .status { font-size: 18px; margin: 10px 0; }
        .transcript { background: #2a2a2a; padding: 20px; margin: 20px 0; min-height: 200px; border-radius: 8px; }
        .controls { margin: 20px 0; }
        .btn { padding: 12px 24px; margin: 5px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; }
        .record { background: #e74c3c; color: white; }
        .stop { background: #34495e; color: white; }
        .error { color: #e74c3c; }
        .success { color: #27ae60; }
    </style>
</head>
<body>
    <h1>üî¥ LIVE TRANSCRIPTION TEST</h1>
    
    <div class="status" id="status">Initializing...</div>
    
    <div class="controls">
        <button class="btn record" id="recordBtn" onclick="startRecording()">üé§ Start Live Test</button>
        <button class="btn stop" id="stopBtn" onclick="stopRecording()" disabled>‚èπÔ∏è Stop</button>
    </div>
    
    <div class="transcript" id="transcript">
        Waiting for audio...
    </div>
    
    <div id="debug"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.4.0/socket.io.min.js"></script>
    <script>
    let socket = null;
    let mediaRecorder = null;
    let isRecording = false;
    let startTime = null;
    let transcriptData = [];
    
    function updateStatus(message, isError = false) {
        const status = document.getElementById('status');
        status.textContent = message;
        status.className = 'status ' + (isError ? 'error' : 'success');
        console.log('Status:', message);
    }
    
    function updateDebug(message) {
        const debug = document.getElementById('debug');
        debug.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
    }
    
    // Initialize Socket.IO connection
    function initSocket() {
        updateStatus('Connecting to transcription service...');
        
        socket = io('/', {
            transports: ['polling', 'websocket'],
            timeout: 10000
        });
        
        socket.on('connect', () => {
            updateStatus('‚úÖ Connected - Ready for live testing');
            updateDebug('Socket.IO connected successfully');
            document.getElementById('recordBtn').disabled = false;
        });
        
        socket.on('connected', (data) => {
            updateDebug('Server handshake: ' + JSON.stringify(data));
        });
        
        socket.on('connect_error', (error) => {
            updateStatus('‚ùå Connection failed: ' + error, true);
            updateDebug('Connection error: ' + error);
        });
        
        socket.on('interim_transcript', (data) => {
            updateTranscript(data.text, false);
            updateDebug('Interim: ' + data.text);
        });
        
        socket.on('final_transcript', (data) => {
            updateTranscript(data.text, true);
            transcriptData.push({
                text: data.text,
                timestamp: Date.now() - startTime,
                final: true
            });
            updateDebug('Final: ' + data.text);
        });
    }
    
    function updateTranscript(text, isFinal) {
        const transcript = document.getElementById('transcript');
        if (isFinal) {
            transcript.innerHTML += '<span style="color: #27ae60;">' + text + '</span> ';
        } else {
            // Update interim text
            transcript.innerHTML = transcript.innerHTML.split('<span style="color: #f39c12;">')[0] + 
                                  '<span style="color: #f39c12;">' + text + '</span>';
        }
        transcript.scrollTop = transcript.scrollHeight;
    }
    
    async function startRecording() {
        if (!socket || !socket.connected) {
            updateStatus('‚ùå Not connected to server', true);
            return;
        }
        
        try {
            updateStatus('üé§ Starting live recording...');
            
            const stream = await navigator.mediaDevices.getUserMedia({
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true,
                    sampleRate: 16000
                }
            });
            
            mediaRecorder = new MediaRecorder(stream, {
                mimeType: 'audio/webm;codecs=opus'
            });
            
            const sessionId = 'live_test_' + Date.now();
            startTime = Date.now();
            transcriptData = [];
            
            document.getElementById('transcript').innerHTML = '';
            updateStatus('üî¥ RECORDING - Speak naturally...');
            
            socket.emit('join_session', { session_id: sessionId });
            
            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0 && socket.connected) {
                    socket.emit('audio_chunk', {
                        session_id: sessionId,
                        audio_data: event.data,
                        timestamp: Date.now()
                    });
                }
            };
            
            mediaRecorder.start(250); // 250ms chunks
            isRecording = true;
            
            document.getElementById('recordBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            
        } catch (error) {
            updateStatus('‚ùå Microphone access denied: ' + error.message, true);
        }
    }
    
    function stopRecording() {
        if (mediaRecorder && isRecording) {
            mediaRecorder.stop();
            mediaRecorder.stream.getTracks().forEach(track => track.stop());
            isRecording = false;
            
            updateStatus('‚èπÔ∏è Recording stopped - Processing final results...');
            
            document.getElementById('recordBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            
            // Generate test report
            setTimeout(() => {
                generateTestReport();
            }, 2000);
        }
    }
    
    function generateTestReport() {
        const totalTime = (Date.now() - startTime) / 1000;
        const finalTranscripts = transcriptData.filter(t => t.final);
        
        updateDebug('=== LIVE TEST COMPLETE ===');
        updateDebug('Duration: ' + totalTime.toFixed(1) + ' seconds');
        updateDebug('Final segments: ' + finalTranscripts.length);
        updateDebug('Total words: ' + finalTranscripts.map(t => t.text.split(' ').length).reduce((a,b) => a+b, 0));
        
        updateStatus('‚úÖ Test complete - Check debug log for results');
    }
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', () => {
        initSocket();
    });
    </script>
</body>
</html>