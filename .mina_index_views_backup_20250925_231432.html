<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Mina</title>
  <link rel="manifest" href="/static/manifest.webmanifest">
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="/static/js/mina.api.js"></script>
  <!-- Real-time socket bridge -->
  <script src="/socket.io/socket.io.js"></script>
  <script defer src="/static/js/mina.socket.js"></script>
  <style>
    html,body{height:100%} .btn{ @apply px-4 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-white}
    .card{ @apply bg-slate-800/60 rounded-2xl p-4 border border-slate-700}
    .input{ @apply w-full bg-slate-900/60 border border-slate-700 rounded-xl p-3 text-slate-100}
    .badge{ @apply px-2 py-0.5 rounded-full text-xs font-medium}
  </style>
  <script src="/static/js/router.js" defer></script>
</head>
<body class="bg-slate-950 text-slate-100">
  <div id="app" class="max-w-3xl mx-auto p-4 space-y-4">
    <header class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-violet-500 to-fuchsia-500"></div>
        <h1 class="text-xl font-semibold">Mina</h1>
      </div>
      <nav class="flex items-center gap-3">
        <a href="#/library" class="text-slate-300 hover:text-white">Library</a>
        <a href="#/live" class="text-slate-300 hover:text-white">Live</a>
        <a href="#/upload" class="text-slate-300 hover:text-white">Upload</a>
        <a href="#/settings" class="text-slate-300 hover:text-white">Settings</a>
        <button id="nav-auth" class="btn hidden">Login</button>
        <div id="nav-user" class="hidden text-sm text-slate-300"></div>
      </nav>
    </header>

    <main id="view"></main>
  </div>

  <script>
    const view = document.getElementById('view');
    const navAuth = document.getElementById('nav-auth');
    const navUser = document.getElementById('nav-user');
    let state = { user:null, convId:null, live:false };

    async function ensureUser() {
      try { const r = await API.auth.me(); state.user = r.user; } catch(e){ state.user = null; }
      navAuth.classList.toggle('hidden', !!state.user);
      navUser.classList.toggle('hidden', !state.user);
      if (state.user) navUser.innerText = state.user.name || state.user.email;
    }

    function guard() {
      const pub = ["login","register","forgot","reset","verify"];
      const [, path] = location.hash.split("/");
      if (!state.user && (!path || !pub.includes(path))) { location.hash="#/login"; return false; }
      return true;
    }

    // ---------- Auth views ----------
    function renderLogin() {
      view.innerHTML = `
        <div class="card space-y-4">
          <h2 class="text-lg font-semibold">Log in</h2>
          <input id="login-email" class="input" placeholder="Email"/>
          <input id="login-password" class="input" placeholder="Password" type="password"/>
          <div class="flex gap-2">
            <button id="btn-login" class="btn">Login</button>
            <a href="#/register" class="text-sky-400">Create account</a>
            <a href="#/forgot" class="text-sky-400">Forgot password?</a>
          </div>
        </div>`;
      document.getElementById('btn-login').onclick = async ()=>{
        try{ await API.auth.login(login-email.value, login-password.value); location.hash="#/library"; }
        catch(e){ alert("Login failed: "+e.message); }
      };
    }

    function renderRegister() {
      view.innerHTML = `
        <div class="card space-y-4">
          <h2 class="text-lg font-semibold">Create account</h2>
          <input id="reg-name" class="input" placeholder="Name"/>
          <input id="reg-email" class="input" placeholder="Email"/>
          <input id="reg-password" class="input" placeholder="Password" type="password"/>
          <div class="flex gap-2">
            <button id="btn-register" class="btn">Register</button>
            <a href="#/login" class="text-sky-400">I have an account</a>
          </div>
        </div>`;
      document.getElementById('btn-register').onclick = async ()=>{
        try{ await API.auth.register(reg-email.value, reg-password.value, reg-name.value); alert("Verification email sent (check your inbox)"); location.hash="#/library"; }
        catch(e){ alert("Register failed: "+e.message); }
      };
    }

    function renderForgot() {
      view.innerHTML = `
        <div class="card space-y-4">
          <h2 class="text-lg font-semibold">Reset password</h2>
          <input id="fp-email" class="input" placeholder="Email"/>
          <button id="btn-fp" class="btn">Send reset link</button>
          <div class="text-slate-400 text-sm">You'll receive an email with a reset link.</div>
        </div>`;
      btn-fp.onclick = async ()=>{
        try{ await API.auth.requestReset(fp-email.value); alert("If your email exists, a link was sent."); location.hash="#/login"; }
        catch(e){ alert("Error: "+e.message); }
      };
    }

    function renderReset() {
      const token = new URLSearchParams(location.hash.split("?")[1]).get("token") || "";
      view.innerHTML = `
        <div class="card space-y-4">
          <h2 class="text-lg font-semibold">Choose a new password</h2>
          <input id="rpw" type="password" class="input" placeholder="New password"/>
          <button id="btn-rpw" class="btn">Update password</button>
        </div>`;
      btn-rpw.onclick = async ()=>{
        try{ await API.auth.resetPassword(token, rpw.value); alert("Password updated. Login again."); location.hash="#/login"; }
        catch(e){ alert("Reset failed: "+e.message); }
      };
    }

    function renderVerify() {
      const token = new URLSearchParams(location.hash.split("?")[1]).get("token") || "";
      view.innerHTML = `<div class="card">Verifying…</div>`;
      API.auth.verifyEmail(token).then(()=>{
        view.innerHTML = `<div class="card">Email verified. <a class="text-sky-400" href="#/library">Continue</a></div>`;
      }).catch(()=> view.innerHTML = `<div class="card text-rose-300">Verification failed.</div>`);
    }

    // ---------- Library ----------
    async function renderLibrary() {
      const res = await API.conv.list();
      view.innerHTML = `
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">Library</h2>
          <a href="#/live" class="btn">Start recording</a>
        </div>
        <div class="grid gap-3 mt-3" id="lib-list">
          ${res.items.map(i=>`
            <a class="card block hover:bg-slate-800" href="#/conversation/${i.id}">
              <div class="flex items-center justify-between">
                <div class="font-medium">${i.title}</div>
                <span class="badge bg-slate-700">${i.status}</span>
              </div>
              <div class="text-xs text-slate-400 mt-1">${new Date(i.created_at).toLocaleString()}</div>
            </a>
          `).join("")}
          ${res.items.length===0?`<div class="card text-slate-400">No conversations yet.</div>`:""}
        </div>`;
    }

    // ---------- Live (real WS -> DB) ----------
    function renderLive() {
      state.live=false; state.convId=null;
      view.innerHTML = `
        <div class="flex items-center gap-2">
          <span class="badge bg-emerald-700" id="badge-live">Idle</span>
        </div>
        <div class="card mt-3">
          <div class="flex items-center justify-between mb-2">
            <div class="font-semibold">Transcript</div>
            <span id="live-badge" class="badge bg-slate-700">Waiting…</span>
          </div>
          <div id="txt" class="min-h-[160px] whitespace-pre-wrap"></div>
          <div class="mt-3 flex gap-2">
            <button id="btn-start" class="btn">Start</button>
            <button id="btn-stop" class="btn bg-rose-700 hover:bg-rose-600">Stop</button>
            <button id="btn-save" class="btn bg-violet-700 hover:bg-violet-600">Save & open</button>
          </div>
        </div>`;

      const txt = document.getElementById('txt');

      MinaSocket.connect(); // connects to your /socket.io server

      MinaSocket.onInterim(({text})=>{
        document.getElementById('live-badge').innerText="Receiving…";
        txt.textContent += text || "";
      });
      MinaSocket.onFinal(({text})=>{
        txt.textContent += text || "";
      });
      MinaSocket.onError((e)=>{
        document.getElementById('live-badge').innerText="Error";
      });

      document.getElementById('btn-start').onclick = async ()=>{
        const id = await MinaSocket.startSession("Live session");
        state.convId = id; state.live=true;
        document.getElementById('badge-live').innerText="Recording…";
        document.getElementById('live-badge').innerText="Connected";
      };

      document.getElementById('btn-stop').onclick = async ()=>{
        state.live=false;
        await MinaSocket.stopSession();
        document.getElementById('badge-live').innerText="Stopped";
      };

      document.getElementById('btn-save').onclick = ()=>{
        if (!state.convId) return alert("Start first");
        location.hash = `#/conversation/${state.convId}`;
      };
    }

    // ---------- Conversation ----------
    async function renderConversation(id){
      const r = await API.conv.get(id);
      view.innerHTML = `
        <div class="card">
          <div class="flex items-center justify-between">
            <input id="title" class="input font-semibold" value="${r.conversation.title}"/>
            <div class="flex gap-2">
              <button id="btn-share" class="btn">Share</button>
              <button id="btn-export" class="btn">Export .txt</button>
            </div>
          </div>
          <div class="mt-3 whitespace-pre-wrap">${r.segments.map(s=>s.text).join("")}</div>
          <div class="mt-4">
            <h3 class="font-semibold mb-1">Highlights</h3>
            <div class="flex gap-2">
              <input id="hltext" class="input" placeholder="Add highlight"/>
              <button id="btn-add-hl" class="btn">Add</button>
            </div>
            <div id="hllist" class="mt-2 text-sm"></div>
          </div>
          <div class="mt-4">
            <h3 class="font-semibold mb-1">Tasks</h3>
            <div class="flex gap-2">
              <input id="ttext" class="input" placeholder="Add task"/>
              <button id="btn-add-task" class="btn">Add</button>
            </div>
            <div id="tlist" class="mt-2 text-sm"></div>
          </div>
        </div>`;
      document.getElementById('btn-export').onclick = ()=>{
        const blob = new Blob([r.segments.map(s=>s.text).join("")], {type:"text/plain"});
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(r.conversation.title||"conversation")+".txt"; a.click();
      };
      document.getElementById('btn-share').onclick = async ()=>{
        const s = await API.conv.share(id);
        const url = `${location.origin}/s/${s.token}`;
        await navigator.clipboard.writeText(url);
        alert("Share link copied:\n"+url);
      };
      document.getElementById('btn-add-hl').onclick = async ()=>{
        const t = hltext.value.trim(); if(!t) return;
        await API.conv.addHighlight(id, { text:t }); hltext.value=""; loadHL();
      };
      document.getElementById('btn-add-task').onclick = async ()=>{
        const t = ttext.value.trim(); if(!t) return;
        await API.conv.addTask(id, { text:t }); ttext.value=""; loadTasks();
      };
      async function loadHL(){ const r2 = await API.conv.listHighlights(id); hllist.innerHTML = r2.items.map(i=>`<div class="card my-1">${i.text}</div>`).join(""); }
      async function loadTasks(){ const r3 = await API.conv.listTasks(id); tlist.innerHTML = r3.items.map(i=>`<div class="card my-1 flex items-center justify-between"><span>${i.text}</span><span class="badge bg-slate-700">${i.status}</span></div>`).join(""); }
      loadHL(); loadTasks();
    }

    // ---------- Upload ----------
    function renderUpload(){
      view.innerHTML = `
        <div class="card space-y-4">
          <h2 class="text-lg font-semibold">Upload audio/video</h2>
          <input id="file" type="file" accept=".mp3,.wav,.m4a,.mp4,.webm,.ogg,.aac,.flac" class="block"/>
          <button id="btn-up" class="btn">Upload</button>
          <div id="upmsg" class="text-sm text-slate-400"></div>
        </div>`;
      btn-up.onclick = async ()=>{
        const f = file.files[0]; if(!f) return alert("Choose a file");
        try{
          const r = await API.uploadFile(f);
          upmsg.innerText = `Uploaded. Conversation #${r.id}. Opening…`;
          location.hash = `#/conversation/${r.id}`;
        }catch(e){ alert("Upload failed: "+e.message); }
      };
    }

    // ---------- Settings ----------
    function renderSettings() {
      view.innerHTML = `
        <div class="card space-y-4">
          <h2 class="text-lg font-semibold">Settings</h2>
          <div class="grid gap-4">
            <div>
              <div class="text-sm text-slate-400 mb-1">Email</div>
              <input class="input" disabled value="${state.user?.email || ''}"/>
            </div>
            <div>
              <div class="text-sm text-slate-400 mb-1">Name</div>
              <input id="set-name" class="input" placeholder="Your name" value="${state.user?.name||''}"/>
            </div>
            <details class="card">
              <summary class="cursor-pointer">Change password</summary>
              <div class="mt-3 grid gap-2">
                <input id="old-pw" type="password" class="input" placeholder="Current password"/>
                <input id="new-pw" type="password" class="input" placeholder="New password"/>
                <button id="btn-change-pw" class="btn w-max">Update password</button>
              </div>
            </details>
            <div class="flex gap-2">
              <button id="btn-logout" class="btn bg-rose-700 hover:bg-rose-600">Logout</button>
            </div>
          </div>
        </div>`;
      btn-logout.onclick = async ()=>{ try{ await API.auth.logout(); location.hash="#/login"; }catch(e){ alert(e.message);} };
      btn-change-pw.onclick = async ()=>{
        try{ await API.auth.changePassword(old-pw.value, new-pw.value); alert("Password updated");}
        catch(e){ alert("Failed: "+e.message); }
      };
    }

    // ---------- Router ----------
    async function route(){
      await ensureUser();
      const [_, path, arg] = location.hash.split("/");
      if (!guard()) return;
      if (!path || path==="library") return renderLibrary();
      if (path==="login") return renderLogin();
      if (path==="register") return renderRegister();
      if (path==="forgot") return renderForgot();
      if (path==="reset") return renderReset();
      if (path==="verify") return renderVerify();
      if (path==="live") return renderLive();
      if (path==="conversation") return renderConversation(arg);
      if (path==="upload") return renderUpload();
      if (path==="settings") return renderSettings();
      view.innerHTML = `<div class="card">Not found</div>`;
    }
    window.addEventListener("hashchange", route);
    route();
  </script>
</body>
</html>
