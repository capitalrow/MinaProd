# Database Migrations Guide

## Overview

Mina uses **Flask-Migrate** (powered by Alembic) for database schema management. This ensures safe, version-controlled database changes across development, testing, and production environments.

## Quick Start

### Create a New Migration

```bash
# Auto-generate migration from model changes
python manage_migrations.py migrate "Add user preferences table"

# Or use flask-migrate CLI
flask db migrate -m "Add user preferences table"
```

### Apply Migrations

```bash
# Upgrade to latest version
python manage_migrations.py upgrade

# Or use flask-migrate CLI
flask db upgrade
```

### Rollback Migration

```bash
# Downgrade one revision
python manage_migrations.py downgrade

# Or use flask-migrate CLI
flask db downgrade
```

## Migration Workflow

### 1. Modify Models

Edit your models in `models.py`:

```python
# models.py
from app import db

class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    email = db.Column(db.String(120), unique=True, nullable=False)
    # NEW: Add a field
    phone_number = db.Column(db.String(20), nullable=True)
```

### 2. Generate Migration

```bash
python manage_migrations.py migrate "Add phone number to users"
```

This creates a new migration file in `migrations/versions/` like:
- `<revision>_add_phone_number_to_users.py`

### 3. Review Migration

**Always review auto-generated migrations** before applying:

```python
# migrations/versions/xxxx_add_phone_number_to_users.py

def upgrade():
    # ### commands auto generated by Alembic ###
    with op.batch_alter_table('users', schema=None) as batch_op:
        batch_op.add_column(sa.Column('phone_number', sa.String(length=20), nullable=True))
    # ### end Alembic commands ###

def downgrade():
    # ### commands auto generated by Alembic ###
    with op.batch_alter_table('users', schema=None) as batch_op:
        batch_op.drop_column('phone_number')
    # ### end Alembic commands ###
```

### 4. Apply Migration

```bash
# Development
python manage_migrations.py upgrade

# Production (via deployment)
flask db upgrade
```

## Migration Commands

### Using manage_migrations.py

```bash
# Initialize migrations (already done)
python manage_migrations.py init

# Create new migration
python manage_migrations.py migrate "Description of changes"

# Apply migrations
python manage_migrations.py upgrade

# Rollback one revision
python manage_migrations.py downgrade
```

### Using Flask CLI

```bash
# Show current revision
flask db current

# Show migration history
flask db history

# Create migration
flask db migrate -m "Add new field"

# Upgrade to latest
flask db upgrade

# Downgrade one revision
flask db downgrade

# Upgrade/downgrade to specific revision
flask db upgrade <revision>
flask db downgrade <revision>
```

## Common Scenarios

### Adding a Column

```python
# 1. Update model
class User(db.Model):
    bio = db.Column(db.Text, nullable=True)

# 2. Create migration
python manage_migrations.py migrate "Add bio to users"

# 3. Apply
python manage_migrations.py upgrade
```

### Changing Column Type

```python
# 1. Update model
class User(db.Model):
    age = db.Column(db.Integer)  # Was String

# 2. Create migration
python manage_migrations.py migrate "Change age to integer"

# 3. Review and manually adjust if needed
# migrations/versions/xxxx_change_age_to_integer.py
def upgrade():
    # Manual conversion may be required
    op.execute("UPDATE users SET age = CAST(age AS INTEGER)")
    with op.batch_alter_table('users') as batch_op:
        batch_op.alter_column('age', type_=sa.Integer())

# 4. Apply
python manage_migrations.py upgrade
```

### Adding Foreign Key

```python
# 1. Update model
class Task(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'))
    user = db.relationship('User', backref='tasks')

# 2. Create migration
python manage_migrations.py migrate "Add user relationship to tasks"

# 3. Apply
python manage_migrations.py upgrade
```

### Renaming Column

```python
# Manual migration required
def upgrade():
    with op.batch_alter_table('users') as batch_op:
        batch_op.alter_column('old_name', new_column_name='new_name')

def downgrade():
    with op.batch_alter_table('users') as batch_op:
        batch_op.alter_column('new_name', new_column_name='old_name')
```

## Best Practices

### 1. Always Review Auto-Generated Migrations

Alembic's auto-generation is smart but not perfect:

```bash
# After creating migration
cat migrations/versions/<latest>.py

# Check for:
# - Correct column types
# - Proper constraints
# - Data preservation logic
```

### 2. Test Migrations Locally First

```bash
# Apply migration
python manage_migrations.py upgrade

# Test the application
pytest

# If issues, rollback
python manage_migrations.py downgrade
```

### 3. Handle Data Migrations Carefully

For existing data, add manual migration logic:

```python
def upgrade():
    # Add column
    op.add_column('users', sa.Column('status', sa.String(20)))
    
    # Set default for existing rows
    op.execute("UPDATE users SET status = 'active' WHERE status IS NULL")
    
    # Make NOT NULL after setting defaults
    with op.batch_alter_table('users') as batch_op:
        batch_op.alter_column('status', nullable=False)
```

### 4. Use Descriptive Migration Messages

```bash
# ✅ Good
python manage_migrations.py migrate "Add email verification fields to users"

# ❌ Bad
python manage_migrations.py migrate "update users"
```

### 5. One Logical Change Per Migration

```bash
# ✅ Good - separate migrations
python manage_migrations.py migrate "Add user preferences table"
python manage_migrations.py migrate "Add timezone to users"

# ❌ Bad - multiple unrelated changes
python manage_migrations.py migrate "Various updates"
```

### 6. Never Edit Applied Migrations

Once a migration is committed and applied:
- ❌ Don't edit it
- ✅ Create a new migration to fix issues

### 7. Handle Circular Dependencies

For circular foreign keys (e.g., User ↔ Workspace):

```python
def upgrade():
    # Create tables without FKs first
    op.create_table('users', ...)
    op.create_table('workspaces', ...)
    
    # Add FKs after both tables exist
    with op.batch_alter_table('users') as batch_op:
        batch_op.create_foreign_key('fk_users_workspace', 'workspaces', ['workspace_id'], ['id'])
    
    with op.batch_alter_table('workspaces') as batch_op:
        batch_op.create_foreign_key('fk_workspaces_owner', 'users', ['owner_id'], ['id'])
```

See [migrations/versions/6f9f2dd343f5_initial_clean_database_schema.py](../migrations/versions/6f9f2dd343f5_initial_clean_database_schema.py) for an example.

## Production Deployment

### Pre-Deployment Checklist

- [ ] All migrations tested locally
- [ ] Migrations reviewed by team
- [ ] Database backup taken
- [ ] Rollback plan prepared
- [ ] Downtime scheduled (if needed)

### Deployment Steps

1. **Backup Database**
   ```bash
   pg_dump $DATABASE_URL > backup_$(date +%Y%m%d_%H%M%S).sql
   ```

2. **Apply Migrations**
   ```bash
   flask db upgrade
   ```

3. **Verify**
   ```bash
   flask db current
   # Check application health
   curl http://localhost:5000/health
   ```

4. **Rollback (if needed)**
   ```bash
   flask db downgrade
   # Restore from backup if necessary
   ```

### Zero-Downtime Migrations

For large tables, use multi-step migrations:

**Step 1: Add nullable column**
```python
def upgrade():
    op.add_column('users', sa.Column('new_field', sa.String(100), nullable=True))
```

**Step 2: Populate data**
```python
def upgrade():
    op.execute("UPDATE users SET new_field = old_field WHERE new_field IS NULL")
```

**Step 3: Make NOT NULL**
```python
def upgrade():
    with op.batch_alter_table('users') as batch_op:
        batch_op.alter_column('new_field', nullable=False)
```

## CI/CD Integration

Migrations are tested automatically in GitHub Actions:

```yaml
# .github/workflows/ci.yml
- name: Run migrations
  run: |
    flask db upgrade
    
- name: Run tests
  run: |
    pytest
```

## Troubleshooting

### Migration Conflicts

```bash
# Error: Multiple heads detected
flask db heads

# Merge branches
flask db merge heads
```

### Migration Failed Mid-Way

```bash
# Check current state
flask db current

# Manual fix in database
psql $DATABASE_URL

# Mark migration as applied
flask db stamp <revision>

# Or rollback and retry
flask db downgrade
flask db upgrade
```

### Reset Database (Development Only)

```bash
# ⚠️ DESTROYS ALL DATA
flask db downgrade base
flask db upgrade
```

### Alembic Version Mismatch

```bash
# Error: Can't locate revision 
# Fix: Ensure migrations/ is in version control
git pull origin main
flask db upgrade
```

## Migration File Structure

```
migrations/
├── alembic.ini          # Alembic configuration
├── env.py              # Migration environment setup
├── README              # Auto-generated readme
├── script.py.mako      # Migration template
└── versions/           # Migration files
    ├── 6f9f2dd343f5_initial_clean_database_schema.py
    └── <revision>_<description>.py
```

## Advanced Topics

### Custom Migration Templates

Edit `migrations/script.py.mako` to customize migration templates.

### Multiple Databases

For projects with multiple databases:

```python
# config.py
SQLALCHEMY_BINDS = {
    'analytics': 'postgresql://...',
}

# Migration with bind
op.create_table('analytics_events', ..., schema='analytics')
```

### Data-Only Migrations

```python
from alembic import op
from sqlalchemy.sql import table, column

def upgrade():
    # Define table structure for data operations
    users_table = table('users',
        column('id', Integer),
        column('status', String)
    )
    
    # Bulk update
    op.bulk_insert(users_table, [
        {'id': 1, 'status': 'active'},
        {'id': 2, 'status': 'inactive'},
    ])
```

## Resources

- [Flask-Migrate Documentation](https://flask-migrate.readthedocs.io/)
- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [SQLAlchemy Documentation](https://docs.sqlalchemy.org/)

## Support

For migration questions:
1. Check this guide first
2. Review existing migrations in `migrations/versions/`
3. Consult the database administrator
4. Ask in the development channel

---

**Last Updated**: October 2025  
**Version**: 1.0
